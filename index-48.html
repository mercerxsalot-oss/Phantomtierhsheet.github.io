<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PHM — Professional Tiersheet</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;500;600;700;800;900&family=Barlow:wght@300;400;500;600&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
// ═══════════════════════════════════════════
// DISCORD MEMBER IMPORT
// ═══════════════════════════════════════════
function openImportMembers(){
  if(!isAdmin()){toast('No permission.','er');return;}
  document.getElementById('import-json-input').value='';
  const errEl=document.getElementById('import-members-err');
  const okEl=document.getElementById('import-members-ok');
  errEl.style.display='none'; okEl.style.display='none';
  // Show currently loaded count
  const current=lm();
  const count=Object.keys(current).length;
  if(count>0){
    okEl.textContent=`${count} Discord members loaded. Paste new JSON to update.`;
    okEl.style.display='block';
  }
  document.getElementById('import-members-ov').classList.add('open');
}
function closeImportMembers(){
  document.getElementById('import-members-ov').classList.remove('open');
}
function doImportMembers(){
  if(!isAdmin()) return;
  const raw=(document.getElementById('import-json-input').value||'').trim();
  const errEl=document.getElementById('import-members-err');
  const okEl=document.getElementById('import-members-ok');
  errEl.style.display='none'; okEl.style.display='none';
  if(!raw){ errEl.textContent='Please paste the JSON from the bot.'; errEl.style.display='block'; return; }
  let data;
  try{ data=JSON.parse(raw); }
  catch(e){ errEl.textContent='Invalid JSON. Make sure you copied the full output from the bot.'; errEl.style.display='block'; return; }
  if(typeof data!=='object'||Array.isArray(data)){ errEl.textContent='Expected a JSON object. Copy the full output from the bot.'; errEl.style.display='block'; return; }
  const count=Object.keys(data).length;
  if(count===0){ errEl.textContent='No members found in JSON.'; errEl.style.display='block'; return; }
  sm(data);
  okEl.textContent=`Successfully imported ${count} Discord members.`;
  okEl.style.display='block';
  errEl.style.display='none';
  updateMemberSyncInfo();
  toast(`${count} Discord members imported!`,'ok');
}
function clearImportedMembers(){
  if(!isAdmin()) return;
  localStorage.removeItem(MK);
  const errEl=document.getElementById('import-members-err');
  const okEl=document.getElementById('import-members-ok');
  okEl.style.display='none';
  errEl.textContent='Member list cleared.'; errEl.style.display='block';
  updateMemberSyncInfo();
  toast('Discord member list cleared.','ok');
}
function updateMemberSyncInfo(){
  const el=document.getElementById('member-sync-info');
  if(!el) return;
  const count=Object.keys(lm()).length;
  el.textContent=count>0
    ? `${count} Discord members synced — registrations will show real names & avatars`
    : 'No Discord members imported yet — run the bot then click Import Members';
}

</script>
<style>
:root{
  --bg:#050810;--bg1:#080d18;--bg2:#0c1220;--bg3:#111928;
  --card:#0f1828;--card2:#141f32;
  --blue:#1e6fff;--blue2:#1458cc;--blue3:#4d8fff;
  --blueglow:rgba(30,111,255,.35);--bluesoft:rgba(30,111,255,.12);
  --white:#f0f4ff;--gray:#7a8aaa;--gray2:#3d4d6a;
  --border:rgba(30,111,255,.18);--border2:rgba(255,255,255,.06);
  --gold:#f5a623;--silver:#9bb0c9;
  --green:#10b981;--red:#ef4444;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{-webkit-text-size-adjust:100%;}
body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--white);min-height:100vh;overflow-x:hidden;}

/* ── SCREENS ── */
.screen{display:none;}
.screen.active{display:flex;}

/* ── SPLASH ── */
#splash{position:fixed;inset:0;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);z-index:200;}
.sbg{display:none;}
.sbg::after{display:none;}
.sc{position:relative;text-align:center;animation:fup 1s ease;padding:0 24px;}
@keyframes fup{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}

/* Splash logo — circle with spinning ring */
.splash-logo-wrap{position:relative;width:180px;height:180px;margin:0 auto 36px;display:flex;align-items:center;justify-content:center;}
.splash-logo-ring{display:none;}
.splash-logo-ring2{display:none;}
.splash-logo-glow{display:none;}
@keyframes spinring{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes glowpulse{0%,100%{opacity:.5;transform:scale(1);}50%{opacity:1;transform:scale(1.08);}}
.splash-logo{width:180px;height:180px;border-radius:0;overflow:visible;border:none;box-shadow:none;background:transparent;}
.splash-logo img{width:100%;height:100%;object-fit:contain;display:block;}

.stitle{font-family:'Orbitron',monospace;font-size:clamp(42px,10vw,80px);font-weight:900;color:var(--white);letter-spacing:8px;line-height:1;text-shadow:0 0 50px rgba(30,111,255,.5);margin-bottom:10px;}
.ssub{font-family:'Barlow Condensed',sans-serif;font-size:clamp(11px,3vw,15px);font-weight:600;letter-spacing:6px;color:var(--gray);text-transform:uppercase;margin-bottom:52px;}
.btn-enter{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;letter-spacing:5px;text-transform:uppercase;background:var(--blue);color:var(--white);border:none;padding:17px 64px;border-radius:60px;cursor:pointer;transition:all .3s;box-shadow:0 0 30px var(--blueglow);}
.btn-enter:hover,.btn-enter:active{background:var(--blue3);box-shadow:0 0 55px rgba(77,143,255,.6);transform:translateY(-2px);}

/* ── LOADING — fully redesigned ── */
#loading{position:fixed;inset:0;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);z-index:199;}
#loading .sbg{filter:brightness(.06)saturate(.15);}
.load-inner{position:relative;display:flex;flex-direction:column;align-items:center;text-align:center;}

/* Loading logo circle */
.load-logo-wrap{position:relative;width:120px;height:120px;margin:0 auto 32px;display:flex;align-items:center;justify-content:center;}
.load-ring{display:none;}
.load-ring2{display:none;}
.load-glow{display:none;}
.load-logo{width:120px;height:120px;border-radius:0;overflow:visible;border:none;box-shadow:none;background:transparent;}
.load-logo img{width:100%;height:100%;object-fit:contain;display:block;}

/* Loading text + bar */
.load-title{font-family:'Orbitron',monospace;font-size:clamp(18px,4vw,26px);font-weight:900;letter-spacing:6px;color:var(--white);margin-bottom:6px;text-shadow:0 0 20px rgba(30,111,255,.4);}
.load-sub{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:600;letter-spacing:4px;color:var(--gray);text-transform:uppercase;margin-bottom:28px;}
.ltrack{width:200px;height:3px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;position:relative;}
.ltrack::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(77,143,255,.08),transparent);animation:shimmer 1.5s ease-in-out infinite;}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.lfill{height:100%;width:0%;border-radius:3px;background:linear-gradient(90deg,var(--blue),var(--blue3));box-shadow:0 0 8px rgba(30,111,255,.6);transition:width .1s linear;}
.load-pct{font-family:'Orbitron',monospace;font-size:10px;font-weight:700;color:var(--blue3);letter-spacing:2px;margin-top:10px;opacity:.7;}

/* ── NAV LOGO — no circle border ── */
.nav-logo{width:38px;height:38px;flex-shrink:0;border-radius:0;overflow:visible;border:none;box-shadow:none;background:transparent;}
.nav-logo img{width:100%;height:100%;object-fit:contain;display:block;}

/* ── AUTH LOGO — no circle border ── */
.auth-logo{width:84px;height:84px;margin:0 auto 14px;border-radius:0;overflow:visible;border:none;box-shadow:none;background:transparent;}
.auth-logo img{width:100%;height:100%;object-fit:contain;display:block;}

/* ── APP ── */
#app{flex-direction:column;min-height:100vh;}

/* ── NAV ── */
.nav{height:60px;background:linear-gradient(90deg,var(--bg1),var(--bg2));border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;position:sticky;top:0;z-index:60;backdrop-filter:blur(20px);gap:8px;}
.nbrand{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.nbrand-txt{display:flex;flex-direction:column;}
.nbrand-txt h1{font-family:'Barlow Condensed',sans-serif;font-size:clamp(11px,2vw,16px);font-weight:800;letter-spacing:3px;color:var(--white);white-space:nowrap;}
.nbrand-txt p{font-size:9px;color:var(--gray);letter-spacing:2px;text-transform:uppercase;}
@media(max-width:580px){.nbrand-txt p{display:none;}}
.ntabs{display:flex;gap:2px;}
.ntab{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;background:none;border:none;color:var(--gray);padding:7px 12px;border-radius:6px;cursor:pointer;transition:all .2s;white-space:nowrap;}
.ntab:hover{color:var(--white);background:var(--bluesoft);}
.ntab.on{color:var(--blue3);background:var(--bluesoft);}
.nright{display:flex;align-items:center;gap:7px;flex-shrink:0;}

/* ── USER PILL ── */
.upill{display:flex;align-items:center;gap:7px;padding:5px 11px 5px 5px;background:var(--card);border:1px solid var(--border);border-radius:50px;cursor:pointer;transition:all .2s;position:relative;max-width:210px;}
.upill:hover{border-color:var(--blue3);}
.uava{width:27px;height:27px;border-radius:50%;background:var(--blue2);border:2px solid var(--blue3);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:800;flex-shrink:0;overflow:hidden;}
.uava img{width:100%;height:100%;object-fit:cover;}
.uname{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:75px;}
.rbadge{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;padding:2px 7px;border-radius:20px;text-transform:uppercase;flex-shrink:0;}
.rfan{background:rgba(59,130,246,.18);color:#60a5fa;border:1px solid rgba(59,130,246,.3);}
.rplayer{background:rgba(16,185,129,.18);color:#34d399;border:1px solid rgba(16,185,129,.3);}
.radmin{background:rgba(245,158,11,.18);color:#fbbf24;border:1px solid rgba(245,158,11,.3);}
.shield{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;flex-shrink:0;}
.dd{position:absolute;top:calc(100% + 8px);right:0;background:var(--card2);border:1px solid var(--border);border-radius:12px;min-width:175px;overflow:hidden;display:none;z-index:200;box-shadow:0 20px 50px rgba(0,0,0,.5);}
.dd.open{display:block;}
.ddi{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:600;letter-spacing:1px;padding:12px 16px;cursor:pointer;color:var(--gray);display:flex;align-items:center;gap:8px;transition:all .2s;border-bottom:1px solid var(--border2);}
.ddi:last-child{border-bottom:none;}
.ddi svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;flex-shrink:0;}
.ddi:hover{color:var(--white);background:var(--bluesoft);}
.ddi.red:hover{color:#f87171;background:rgba(239,68,68,.1);}
.bsmall{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:7px 15px;border-radius:8px;cursor:pointer;transition:all .2s;border:none;white-space:nowrap;}
.boutline{background:none;color:var(--gray);border:1px solid var(--border2)!important;}
.boutline:hover,.boutline:active{color:var(--white);border-color:var(--blue3)!important;}
.bprimary{background:var(--blue);color:var(--white);box-shadow:0 0 14px var(--blueglow);}
.bprimary:hover,.bprimary:active{background:var(--blue3);}

/* ── PAGES ── */
.page{display:none;flex:1;}
.page.on{display:block;}


/* ── PAGE HERO HEADER ── */
.page-hero{background:linear-gradient(135deg,var(--bg1),var(--bg));border-bottom:1px solid var(--border2);padding:24px 20px 20px;position:relative;overflow:hidden;}
.page-hero::before{content:'';position:absolute;top:-40px;right:-40px;width:200px;height:200px;background:radial-gradient(circle,rgba(30,111,255,.08),transparent 70%);pointer-events:none;}
.page-hero-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;}
.page-hero h2{font-family:'Barlow Condensed',sans-serif;font-size:clamp(17px,4vw,23px);font-weight:900;letter-spacing:4px;text-transform:uppercase;margin-bottom:3px;}
.page-hero p{font-size:11px;color:var(--gray);letter-spacing:2px;text-transform:uppercase;}
.hero-badge{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:800;letter-spacing:2px;text-transform:uppercase;padding:4px 10px;border-radius:20px;background:var(--bluesoft);color:var(--blue3);border:1px solid var(--border);white-space:nowrap;align-self:flex-start;}

/* ── STATS ROW ── */
.srow{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:16px 20px;}
@media(max-width:500px){.srow{grid-template-columns:repeat(2,1fr);}}
.sbox{background:var(--card);border:1px solid var(--border2);border-radius:12px;padding:14px 12px;text-align:center;transition:all .3s;position:relative;overflow:hidden;cursor:default;}
.sbox::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--blue3),transparent);opacity:0;transition:.3s;}
.sbox:hover::before{opacity:1;}
.sbox:hover{border-color:var(--border);transform:translateY(-1px);}
.sn{font-family:'Orbitron',monospace;font-size:clamp(20px,5vw,32px);font-weight:900;color:var(--blue3);line-height:1;margin-bottom:5px;}
.sl{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:3px;color:var(--gray);text-transform:uppercase;}
.sbox-icon{position:absolute;top:10px;right:10px;opacity:.12;}
.sbox-icon svg{width:22px;height:22px;stroke:var(--blue3);fill:none;stroke-width:1.5;}

/* ── CONTROLS ── */
.ctrls{display:flex;align-items:center;gap:8px;padding:0 20px 14px;flex-wrap:wrap;}
.swrap{position:relative;flex:1;min-width:140px;}
.swrap input{width:100%;background:var(--card);border:1px solid var(--border2);border-radius:9px;padding:9px 12px 9px 36px;color:var(--white);font-family:'Barlow',sans-serif;font-size:13px;outline:none;transition:all .2s;}
.swrap input:focus{border-color:var(--blue3);background:var(--card2);}
.swrap input::placeholder{color:var(--gray2);}
.sico{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--gray2);pointer-events:none;line-height:1;display:flex;}
.sico svg{width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2.5;}
.fsel{background:var(--card);border:1px solid var(--border2);border-radius:9px;padding:9px 28px 9px 11px;color:var(--white);font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:600;letter-spacing:1px;outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='11' viewBox='0 0 24 24' fill='none' stroke='%237a8aaa' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 9px center;transition:all .2s;}
.fsel:focus{border-color:var(--blue3);}
.brefresh{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;background:var(--card);color:var(--blue3);border:1px solid var(--blue2);padding:9px 15px;border-radius:9px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px;white-space:nowrap;}
.brefresh:hover,.brefresh:active{background:var(--bluesoft);}

/* ── TIER GRID ── */
.twrap{padding:0 20px 48px;}
.tsec{margin-bottom:30px;}
.thead{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.tpill{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:800;letter-spacing:2.5px;padding:4px 13px;border-radius:40px;text-transform:uppercase;}
.t1p{background:rgba(30,111,255,.18);color:#60a5fa;border:1px solid rgba(30,111,255,.3);}
.t2p{background:rgba(124,58,237,.18);color:#a78bfa;border:1px solid rgba(124,58,237,.3);}
.t3p{background:rgba(16,185,129,.18);color:#34d399;border:1px solid rgba(16,185,129,.3);}
.t4p{background:rgba(245,158,11,.18);color:#fbbf24;border:1px solid rgba(245,158,11,.3);}
.t1c{color:#60a5fa;}.t2c{color:#a78bfa;}.t3c{color:#34d399;}.t4c{color:#fbbf24;}
.tcnt{font-size:11px;color:var(--gray);font-family:'Barlow Condensed',sans-serif;letter-spacing:1px;}
.tdiv{flex:1;height:1px;background:var(--border2);}
.pgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:12px;}
@media(max-width:380px){.pgrid{grid-template-columns:repeat(2,1fr);gap:8px;}}

/* ── PLAYER CARD ── */
/* CRITICAL FIX: pointer-events none on ::before so touch events reach the card */
.pc{background:var(--card);border:1px solid var(--border2);border-radius:16px;padding:20px 14px 14px;text-align:center;cursor:pointer;transition:all .3s;position:relative;overflow:hidden;-webkit-user-select:none;user-select:none;}
.pc::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at top,var(--bluesoft),transparent 65%);opacity:0;transition:.3s;pointer-events:none;}
.pc:hover::before,.pc:active::before{opacity:1;}
.pc:hover,.pc:active{border-color:var(--blue);transform:translateY(-2px);box-shadow:0 12px 36px rgba(30,111,255,.18);}
.pc-nat{position:absolute;top:8px;right:8px;font-size:8px;font-family:'Barlow Condensed',sans-serif;font-weight:800;letter-spacing:1px;color:var(--gray);background:var(--bg3);padding:2px 5px;border-radius:3px;pointer-events:none;}
.pc-ava{width:60px;height:60px;border-radius:50%;margin:0 auto 10px;background:var(--bg3);border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;overflow:hidden;transition:.3s;pointer-events:none;}
.pc:hover .pc-ava,.pc:active .pc-ava{border-color:var(--blue3);}
.pc-ava img{width:100%;height:100%;object-fit:cover;}
.pc-name{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;letter-spacing:.5px;color:var(--white);margin-bottom:3px;pointer-events:none;}
.pc-tier{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;pointer-events:none;}
.pc-rat{font-family:'Orbitron',monospace;font-size:28px;font-weight:900;color:var(--blue3);line-height:1;margin-bottom:3px;pointer-events:none;}
.pc-val{font-size:10px;color:var(--gray);letter-spacing:.5px;margin-bottom:10px;pointer-events:none;}
.pc-pos{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--blue3);background:var(--bluesoft);border:1px solid var(--border);border-radius:20px;padding:2px 8px;display:inline-block;margin-bottom:5px;pointer-events:none;}
/* CRITICAL FIX: admin edit button always visible, larger touch target on mobile */
.pc-edit-btn{display:none;font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;padding:7px 14px;border-radius:8px;border:none;cursor:pointer;background:rgba(30,111,255,.2);color:var(--blue3);border:1px solid rgba(30,111,255,.35);width:100%;transition:all .2s;position:relative;z-index:2;touch-action:manipulation;min-height:34px;}
.pc-edit-btn:hover,.pc-edit-btn:active{background:var(--blue);color:#fff;border-color:var(--blue);}
.pc-edit-btn.vis{display:block;}

/* ── FAN BANNER ── */
.fan-banner{margin:14px 20px 4px;background:linear-gradient(135deg,rgba(30,111,255,.07),rgba(30,111,255,.02));border:1px solid var(--border);border-radius:14px;padding:18px 20px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;}
.fan-banner-ico{width:42px;height:42px;border-radius:50%;background:var(--bluesoft);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.fan-banner-ico svg{width:20px;height:20px;stroke:var(--blue3);fill:none;stroke-width:2;}
.fan-banner-txt h3{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;letter-spacing:2px;color:var(--white);margin-bottom:3px;}
.fan-banner-txt p{font-size:11px;color:var(--gray);line-height:1.5;}
.fan-banner-txt{flex:1;min-width:130px;}

/* ── ANALYTICS ── */
.awrap{padding:20px;}
.asec-title{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:800;letter-spacing:4px;color:var(--blue3);text-transform:uppercase;margin-bottom:18px;}
.agrid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;}
@media(max-width:580px){.agrid{grid-template-columns:1fr;}}
.acard{background:var(--card);border:1px solid var(--border2);border-radius:14px;padding:18px;}
.act{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:3px;color:var(--gray);text-transform:uppercase;margin-bottom:14px;}
.nbars{display:flex;align-items:flex-end;gap:8px;height:110px;padding-top:18px;}
.nbw{display:flex;flex-direction:column;align-items:center;gap:5px;flex:1;}
.nb{width:100%;border-radius:3px 3px 0 0;background:linear-gradient(180deg,var(--blue3),var(--blue2));min-height:3px;position:relative;}
.nbnum{font-family:'Orbitron',monospace;font-size:8px;color:var(--blue3);position:absolute;top:-16px;left:50%;transform:translateX(-50%);white-space:nowrap;}
.nblbl{font-family:'Barlow Condensed',sans-serif;font-size:10px;color:var(--gray);letter-spacing:1px;}
.stabs{display:flex;margin-bottom:12px;border-bottom:1px solid var(--border2);}
.stab{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;background:none;border:none;color:var(--gray);padding:6px 14px 10px;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .2s;}
.stab.on{color:var(--blue3);border-bottom-color:var(--blue3);}
.slist{list-style:none;}
.srow2{display:flex;align-items:center;gap:9px;padding:7px 0;border-bottom:1px solid var(--border2);}
.srow2:last-child{border-bottom:none;}
.srnk{font-family:'Orbitron',monospace;font-size:9px;color:var(--gray2);width:15px;text-align:center;flex-shrink:0;}
.srnk.g{color:var(--gold);}.srnk.s{color:var(--silver);}.srnk.b{color:#a07c50;}
.sava{width:29px;height:29px;border-radius:50%;background:var(--bg3);border:2px solid var(--border2);overflow:hidden;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sava img{width:100%;height:100%;object-fit:cover;}
.snm{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;flex:1;}
.sv{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;color:var(--blue3);}
.mvps{margin-top:20px;}
.mvph{display:flex;align-items:center;gap:8px;margin-bottom:12px;}
.mvpb{width:3px;height:16px;background:var(--blue);border-radius:2px;}
.mvph h3{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--white);}
.mvpr{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.mvpr::-webkit-scrollbar{display:none;}
.mvpc{background:var(--card);border:1px solid var(--border2);border-radius:13px;padding:14px 12px;text-align:center;flex-shrink:0;width:135px;cursor:pointer;transition:all .3s;}
.mvpc:hover,.mvpc:active{border-color:var(--blue);transform:translateY(-2px);}
.mvpava{width:46px;height:46px;border-radius:50%;margin:0 auto 8px;background:var(--bg3);border:2px solid var(--border);overflow:hidden;display:flex;align-items:center;justify-content:center;}
.mvpava img{width:100%;height:100%;object-fit:cover;}
.mvpnm{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;margin-bottom:2px;}
.mvptier{font-family:'Barlow Condensed',sans-serif;font-size:8px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:5px;}
.mvpval{font-size:10px;color:var(--gray);}

/* ── RECENT ACTIVITY ── */
.activity-wrap{margin-top:20px;}
.activity-list{background:var(--card);border:1px solid var(--border2);border-radius:14px;overflow:hidden;}
.act-row{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border2);transition:background .2s;}
.act-row:last-child{border-bottom:none;}
.act-row:hover{background:var(--bg3);}
.act-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.act-txt{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:600;flex:1;}
.act-time{font-size:10px;color:var(--gray);flex-shrink:0;}

/* ── MEMBERS TABLE ── */
.mwrap{padding:20px;}
.mtitle{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:800;letter-spacing:4px;color:var(--blue3);text-transform:uppercase;margin-bottom:18px;}
.mtable{background:var(--card);border:1px solid var(--border2);border-radius:14px;overflow:hidden;}
.mth{background:var(--bg3);display:grid;grid-template-columns:1.6fr 0.9fr 0.8fr 0.9fr 190px;padding:10px 16px;border-bottom:1px solid var(--border2);}
.mthc{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2.5px;color:var(--gray);text-transform:uppercase;}
.mrow{display:grid;grid-template-columns:1.6fr 0.9fr 0.8fr 0.9fr 190px;padding:11px 16px;border-bottom:1px solid var(--border2);align-items:center;transition:background .2s;}
.mrow:last-child{border-bottom:none;}
.mrow:hover{background:var(--bg3);}
.mcell{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px;}
.mava{width:26px;height:26px;border-radius:50%;background:var(--blue2);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;overflow:hidden;flex-shrink:0;}
.mava img{width:100%;height:100%;object-fit:cover;}
.macts{display:flex;gap:4px;justify-content:flex-end;flex-wrap:wrap;}
/* CRITICAL: All admin buttons need large touch targets */
.abtn{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:6px 9px;border-radius:6px;border:none;cursor:pointer;transition:all .2s;touch-action:manipulation;white-space:nowrap;min-height:30px;display:inline-flex;align-items:center;justify-content:center;}
.apromote{background:rgba(16,185,129,.18);color:#34d399;border:1px solid rgba(16,185,129,.3);}
.apromote:hover,.apromote:active{background:var(--green);color:#fff;}
.ademote{background:rgba(239,68,68,.1);color:#f87171;border:1px solid rgba(239,68,68,.2);}
.ademote:hover,.ademote:active{background:var(--red);color:#fff;}
.aedit{background:rgba(30,111,255,.18);color:var(--blue3);border:1px solid rgba(30,111,255,.3);}
.aedit:hover,.aedit:active{background:var(--blue);color:#fff;}
.atier{background:rgba(245,158,11,.15);color:#fbbf24;border:1px solid rgba(245,158,11,.25);}
.atier:hover,.atier:active{background:#f59e0b;color:#000;}
.adelete{background:rgba(239,68,68,.08);color:#f87171;border:1px solid rgba(239,68,68,.15);}
.adelete:hover,.adelete:active{background:var(--red);color:#fff;}
@media(max-width:720px){
  .mth{grid-template-columns:1.4fr 0.9fr 160px;}
  .mrow{grid-template-columns:1.4fr 0.9fr 160px;}
  .mthc:nth-child(3),.mcell:nth-child(3),
  .mthc:nth-child(4),.mcell:nth-child(4){display:none;}
}
@media(max-width:460px){
  .mth{grid-template-columns:1fr 130px;}
  .mrow{grid-template-columns:1fr 130px;}
  .mthc:nth-child(2),.mcell:nth-child(2){display:none;}
  .abtn{font-size:8px;padding:5px 6px;}
}

/* ── MODALS (shared) ── */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(12px);z-index:300;display:none;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;}
.ov.open{display:flex;}
@keyframes mi{from{opacity:0;transform:scale(.96)translateY(10px)}to{opacity:1;transform:scale(1)translateY(0)}}

/* Heatmap modal */
.hmod{background:var(--bg2);border:1px solid var(--border);border-radius:20px;display:flex;width:100%;max-width:620px;overflow:hidden;box-shadow:0 40px 80px rgba(0,0,0,.6);animation:mi .3s ease;margin:auto;}
.hmleft{width:190px;background:var(--card);border-right:1px solid var(--border);padding:26px 18px;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;gap:0;}
.hmava{width:76px;height:76px;border-radius:50%;background:var(--bg3);border:3px solid var(--blue);margin-bottom:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;box-shadow:0 0 22px var(--blueglow);}
.hmava img{width:100%;height:100%;object-fit:cover;}
.hmname{font-family:'Barlow Condensed',sans-serif;font-size:19px;font-weight:900;text-align:center;margin-bottom:2px;}
.hmtier{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:10px;}
.hmrat{font-family:'Orbitron',monospace;font-size:44px;font-weight:900;color:var(--blue3);line-height:1;margin-bottom:5px;text-shadow:0 0 18px var(--blueglow);}
.hmval{font-size:11px;color:var(--gray);margin-bottom:8px;}
.hmpos{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--blue3);background:var(--bluesoft);border:1px solid var(--border);border-radius:20px;padding:2px 10px;display:inline-block;margin-bottom:8px;}
.hmbio{font-size:11px;color:var(--gray);line-height:1.5;text-align:center;padding:8px 6px 0;border-top:1px solid var(--border2);margin-top:6px;font-style:italic;}
.hmright{flex:1;padding:22px 20px;min-width:0;}
.hmhead{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
.hmtitle{font-family:'Orbitron',monospace;font-size:10px;font-weight:700;letter-spacing:3px;}
.cbtn{width:28px;height:28px;background:var(--bg3);border:1px solid var(--border2);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--gray);font-size:13px;transition:all .2s;flex-shrink:0;touch-action:manipulation;}
.cbtn:hover,.cbtn:active{background:rgba(239,68,68,.15);color:#ef4444;border-color:#ef4444;}
.hrow{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.hlbl{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;color:var(--gray);text-transform:uppercase;width:68px;flex-shrink:0;}
.htrack{flex:1;height:6px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.hfill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--blue),var(--blue3));box-shadow:0 0 5px var(--blueglow);transition:width 1s ease;}
.hv{font-family:'Orbitron',monospace;font-size:11px;font-weight:700;color:var(--blue3);width:24px;text-align:right;flex-shrink:0;}
@media(max-width:540px){
  .hmod{flex-direction:column;}
  .hmleft{width:100%;border-right:none;border-bottom:1px solid var(--border);padding:18px;flex-direction:row;gap:14px;justify-content:flex-start;}
  .hmava{margin:0;flex-shrink:0;}
  .hmrat{font-size:32px;}
}

/* Shared modal styles */
.std-mod{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:24px;width:100%;max-width:480px;max-height:88vh;overflow-y:auto;animation:mi .3s ease;-webkit-overflow-scrolling:touch;margin:auto;}
.mod-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:900;letter-spacing:2px;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
@media(max-width:360px){.fgrid{grid-template-columns:1fr;}}
.fg{display:flex;flex-direction:column;gap:4px;}
.fg.full{grid-column:1/-1;}
.flbl{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;color:var(--gray);text-transform:uppercase;}
.finp{background:var(--card);border:1px solid var(--border2);border-radius:8px;padding:9px 11px;color:var(--white);font-family:'Barlow',sans-serif;font-size:13px;outline:none;transition:all .2s;width:100%;}
.finp:focus{border-color:var(--blue3);background:var(--card2);}
.rrow{display:flex;align-items:center;gap:10px;}
.rrow input[type=range]{flex:1;accent-color:var(--blue3);height:20px;cursor:pointer;}
.rv{font-family:'Orbitron',monospace;font-size:10px;color:var(--blue3);width:22px;text-align:right;}
.mod-acts{display:flex;gap:8px;margin-top:18px;justify-content:flex-end;flex-wrap:wrap;}
.mod-acts button,.facts button{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:9px 18px;border-radius:8px;cursor:pointer;transition:all .2s;touch-action:manipulation;min-height:38px;}
.fcancel{background:none;border:1px solid var(--border2);color:var(--gray);}
.fcancel:hover,.fcancel:active{color:var(--white);border-color:var(--blue3);}
.fsave{background:var(--blue);color:#fff;border:none;box-shadow:0 0 14px var(--blueglow);}
.fsave:hover,.fsave:active{background:var(--blue3);}
.stats-label{font-family:'Barlow Condensed',sans-serif;font-size:9px;letter-spacing:2px;color:var(--gray);text-transform:uppercase;margin-bottom:10px;margin-top:6px;}

/* ── AUTH MODAL ── */
.amod{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:30px;width:100%;max-width:370px;animation:mi .3s ease;margin:auto;}
.acrest{text-align:center;margin-bottom:20px;}
.auth-logo{width:80px;height:80px;margin:0 auto 12px;border-radius:18px;overflow:hidden;}
.atitl{font-family:'Orbitron',monospace;font-size:14px;font-weight:700;letter-spacing:2px;text-align:center;margin-bottom:4px;}
.asub{font-size:11px;color:var(--gray);text-align:center;margin-bottom:22px;}
.aerr2{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#f87171;padding:8px 13px;border-radius:8px;font-size:11px;margin-bottom:10px;display:none;}
.aerr2.show{display:block;}
.aok{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);color:#34d399;padding:8px 13px;border-radius:8px;font-size:11px;margin-bottom:10px;display:none;}
.aok.show{display:block;}
.af{margin-bottom:11px;}
.albl{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;color:var(--gray);text-transform:uppercase;display:block;margin-bottom:4px;}
.ainp{width:100%;background:var(--card);border:1px solid var(--border2);border-radius:9px;padding:10px 13px;color:var(--white);font-family:'Barlow',sans-serif;font-size:13px;outline:none;transition:all .2s;}
.ainp:focus{border-color:var(--blue3);background:var(--card2);}
.abtn2{width:100%;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;letter-spacing:4px;text-transform:uppercase;background:var(--blue);color:var(--white);border:none;padding:13px;border-radius:9px;cursor:pointer;margin-top:14px;transition:all .2s;box-shadow:0 0 20px var(--blueglow);touch-action:manipulation;}
.abtn2:hover,.abtn2:active{background:var(--blue3);transform:translateY(-1px);}
.abtn2:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.aswitch{text-align:center;margin-top:13px;font-size:11px;color:var(--gray);}
.aswitch a{color:var(--blue3);cursor:pointer;}
.aswitch a:hover{text-decoration:underline;}
/* Verify step */
.verify-code-wrap{display:flex;gap:8px;align-items:center;margin-bottom:12px;}
.verify-code-wrap .ainp{letter-spacing:8px;font-size:18px;font-family:'Orbitron',monospace;text-align:center;}
.resend-row{display:flex;justify-content:space-between;align-items:center;margin-top:10px;gap:8px;}
.resend-btn{font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;background:rgba(30,111,255,.12);border:1px solid rgba(30,111,255,.35);color:var(--blue3);cursor:pointer;padding:8px 16px;border-radius:8px;transition:all .2s;touch-action:manipulation;min-height:34px;}
.resend-btn:hover:not(:disabled),.resend-btn:active:not(:disabled){background:var(--blue);color:#fff;border-color:var(--blue);}
.resend-btn:disabled{color:var(--gray2);cursor:not-allowed;background:rgba(255,255,255,.03);border-color:var(--border2);}
.resend-countdown{font-family:'Orbitron',monospace;font-size:10px;color:var(--gray);letter-spacing:1px;flex-shrink:0;}

/* ── PENDING BADGE ── */
.rpending{background:rgba(245,158,11,.18);color:#fbbf24;border:1px solid rgba(245,158,11,.35);}
.pending-banner{background:linear-gradient(135deg,rgba(245,158,11,.08),rgba(245,158,11,.03));border:1px solid rgba(245,158,11,.2);border-radius:14px;padding:20px;display:flex;gap:14px;align-items:flex-start;margin-bottom:16px;}
.pending-banner-ico{width:42px;height:42px;background:rgba(245,158,11,.12);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.pending-banner-ico svg{width:22px;height:22px;stroke:#fbbf24;fill:none;stroke-width:2;}
.pending-banner-txt h3{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;letter-spacing:1px;color:#fbbf24;margin-bottom:4px;}
.pending-banner-txt p{font-size:11px;color:rgba(245,158,11,.7);line-height:1.6;}
/* ── DISCORD PREVIEW ── */
.discord-preview{display:flex;align-items:center;gap:12px;background:rgba(88,101,242,.1);border:1px solid rgba(88,101,242,.25);border-radius:10px;padding:10px 13px;margin-top:8px;min-height:60px;}
.discord-preview img{width:38px;height:38px;border-radius:50%;border:2px solid rgba(88,101,242,.4);flex-shrink:0;}
.discord-preview-name{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;color:var(--white);letter-spacing:.5px;}
.discord-preview-tag{font-size:10px;color:rgba(148,153,242,.9);font-family:'Barlow Condensed';letter-spacing:1px;}
.discord-hint{font-size:10px;color:var(--gray);margin-top:4px;font-family:'Barlow Condensed';letter-spacing:.5px;line-height:1.5;}
/* ── APPEAL MODAL ── */
.appeal-mod{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:26px;width:min(95vw,480px);max-height:85vh;overflow-y:auto;}
.appeal-card{background:var(--card2);border:1px solid var(--border2);border-radius:12px;padding:14px;margin-bottom:10px;}
.appeal-user{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;letter-spacing:1px;color:var(--white);margin-bottom:3px;}
.appeal-meta{font-size:10px;color:var(--gray);font-family:'Barlow Condensed';letter-spacing:1px;margin-bottom:8px;}
.appeal-msg{font-size:12px;color:rgba(240,244,255,.7);line-height:1.6;background:rgba(255,255,255,.03);border-radius:8px;padding:10px;margin-bottom:10px;border:1px solid var(--border2);}
.appeal-acts{display:flex;gap:8px;}
.appeal-approve{flex:1;background:rgba(16,185,129,.15);color:#34d399;border:1px solid rgba(16,185,129,.3);border-radius:8px;padding:8px;font-family:'Barlow Condensed';font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;touch-action:manipulation;}
.appeal-approve:hover{background:rgba(16,185,129,.3);}
.appeal-reject{flex:1;background:rgba(239,68,68,.1);color:#f87171;border:1px solid rgba(239,68,68,.2);border-radius:8px;padding:8px;font-family:'Barlow Condensed';font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;touch-action:manipulation;}
.appeal-reject:hover{background:rgba(239,68,68,.2);}
.pending-count-badge{background:#fbbf24;color:#000;font-size:9px;font-weight:900;font-family:'Barlow Condensed';border-radius:10px;padding:1px 5px;margin-left:4px;vertical-align:middle;}

/* ── TOAST ── */
.toast{position:fixed;bottom:22px;right:18px;background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:11px 15px;display:flex;align-items:center;gap:9px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:1px;z-index:600;transform:translateX(130%);transition:transform .4s cubic-bezier(.34,1.56,.64,1);max-width:270px;box-shadow:0 16px 40px rgba(0,0,0,.5);}
@media(max-width:380px){.toast{left:14px;right:14px;max-width:none;bottom:14px;transform:translateY(120%);} .toast.show{transform:translateY(0);}}
.toast.show{transform:translateX(0);}
.tok{border-left:3px solid #34d399;}
.ter{border-left:3px solid #f87171;}
.tico{font-size:13px;font-weight:900;flex-shrink:0;}

/* ── EMPTY STATE ── */
.empty{text-align:center;padding:44px 20px;color:var(--gray);}
.empty .eico{width:40px;height:40px;margin:0 auto 12px;opacity:.25;}
.empty .eico svg{width:100%;height:100%;stroke:var(--blue3);fill:none;stroke-width:1.5;}
.empty h3{font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:700;letter-spacing:2px;margin-bottom:6px;color:var(--white);}
.empty p{font-size:12px;line-height:1.6;}

/* ── TEAMS ── */
.team-card{background:var(--card);border:1px solid var(--border2);border-radius:16px;padding:0;cursor:pointer;transition:all .25s;position:relative;overflow:hidden;display:flex;flex-direction:column;}
.team-card-banner{height:5px;width:100%;flex-shrink:0;}
.team-card-body{padding:16px 14px 14px;display:flex;flex-direction:column;align-items:center;gap:0;flex:1;}
.team-card:hover{border-color:var(--blue);transform:translateY(-3px);box-shadow:0 14px 40px rgba(30,111,255,.2);}
.team-logo-img{width:52px;height:52px;object-fit:contain;margin:0 auto 10px;display:block;}
.team-card-name{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;letter-spacing:.5px;color:var(--white);margin-bottom:2px;text-align:center;line-height:1.2;}
.team-card-city{font-size:9px;color:var(--gray);letter-spacing:1px;margin-bottom:8px;text-transform:uppercase;}
.team-card-footer{display:flex;align-items:center;gap:6px;flex-wrap:wrap;justify-content:center;}
.team-card-badge{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;padding:2px 8px;border-radius:20px;background:var(--bluesoft);color:var(--blue3);border:1px solid var(--border);display:inline-flex;align-items:center;gap:4px;}
.team-card-mgr{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1px;padding:2px 8px;border-radius:20px;background:rgba(139,92,246,.1);color:#a78bfa;border:1px solid rgba(139,92,246,.2);display:inline-flex;align-items:center;gap:3px;}
/* Team modal */
.team-mod-header{position:relative;overflow:hidden;}
.team-mod-color-bar{height:6px;width:100%;}
.team-mod-top{display:flex;align-items:center;gap:18px;padding:22px 22px 16px;}
.team-mod-logo{width:72px;height:72px;object-fit:contain;flex-shrink:0;filter:drop-shadow(0 4px 16px rgba(0,0,0,.4));}
.team-mod-info{flex:1;min-width:0;}
.team-mod-name{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:900;letter-spacing:2px;color:var(--white);line-height:1;margin-bottom:4px;}
.team-mod-sub{font-size:11px;color:var(--gray);letter-spacing:1px;margin-bottom:10px;}
.team-stats-row{display:flex;gap:10px;flex-wrap:wrap;}
.tstat{display:flex;flex-direction:column;align-items:center;background:rgba(255,255,255,.04);border:1px solid var(--border2);border-radius:8px;padding:6px 14px;min-width:54px;}
.tstat-n{font-family:'Orbitron',monospace;font-size:17px;font-weight:900;color:var(--blue3);line-height:1;}
.tstat-l{font-family:'Barlow Condensed',sans-serif;font-size:8px;color:var(--gray);letter-spacing:2px;text-transform:uppercase;margin-top:2px;}
.team-manager-bar{display:flex;align-items:center;gap:10px;padding:10px 22px;background:rgba(139,92,246,.06);border-top:1px solid rgba(139,92,246,.12);border-bottom:1px solid var(--border2);}
.team-mgr-label{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;color:#a78bfa;text-transform:uppercase;}
.team-mgr-name{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:800;color:var(--white);letter-spacing:.5px;}
/* Player rows in team modal */
.tp-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border2);transition:background .2s;border-radius:8px;padding:10px 8px;margin:0 -8px;}
.tp-row:last-child{border-bottom:none;}
.tp-row:hover{background:rgba(255,255,255,.03);}
.tp-ava{width:38px;height:38px;border-radius:50%;background:var(--bg3);border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;overflow:hidden;flex-shrink:0;}
.tp-ava img{width:100%;height:100%;object-fit:cover;}
.tp-info{flex:1;min-width:0;}
.tp-name{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:800;color:var(--white);letter-spacing:.3px;}
.tp-pos{font-size:10px;color:var(--gray);letter-spacing:.5px;margin-top:1px;}
.tp-tier{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;padding:2px 8px;border-radius:20px;flex-shrink:0;}
.tp-rat{font-family:'Orbitron',monospace;font-size:20px;font-weight:900;color:var(--blue3);flex-shrink:0;min-width:36px;text-align:right;}
/* Team name pill on tiersheet */
.team-pill{display:inline-flex;align-items:center;gap:4px;background:rgba(30,111,255,.08);border:1px solid rgba(30,111,255,.15);border-radius:20px;padding:1px 6px;font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:.5px;color:var(--blue3);pointer-events:none;margin-top:3px;}
.team-pill img{width:12px;height:12px;object-fit:contain;}

/* FIFA-style stat hexagon mini stats on player card */
.pc-stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:3px 6px;margin-top:8px;pointer-events:none;}
.pc-stat{display:flex;flex-direction:column;align-items:center;gap:1px;}
.pc-stat-n{font-family:'Orbitron',monospace;font-size:10px;font-weight:900;color:var(--white);line-height:1;}
.pc-stat-l{font-family:'Barlow Condensed',sans-serif;font-size:7px;font-weight:700;letter-spacing:1px;color:var(--gray);text-transform:uppercase;}

/* Enhanced player modal / detail overlay */
.pdet-mod{background:var(--bg2);border:1px solid var(--border);border-radius:20px;width:100%;max-width:640px;overflow:hidden;box-shadow:0 40px 80px rgba(0,0,0,.7);animation:mi .3s ease;margin:auto;}
.pdet-banner{height:6px;width:100%;}
.pdet-header{display:flex;align-items:flex-start;gap:16px;padding:22px 22px 16px;background:linear-gradient(135deg,var(--bg1),var(--bg));}
.pdet-ava{width:90px;height:90px;border-radius:50%;background:var(--bg3);border:3px solid var(--blue);overflow:hidden;display:flex;align-items:center;justify-content:center;box-shadow:0 0 28px var(--blueglow);flex-shrink:0;}
.pdet-ava img{width:100%;height:100%;object-fit:cover;}
.pdet-info{flex:1;min-width:0;}
.pdet-name{font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:900;letter-spacing:1.5px;color:var(--white);line-height:1;margin-bottom:4px;}
.pdet-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
.pdet-ovr{font-family:'Orbitron',monospace;font-size:52px;font-weight:900;color:var(--blue3);line-height:1;text-shadow:0 0 24px var(--blueglow);min-width:70px;text-align:center;flex-shrink:0;}
.pdet-body{padding:0 22px 22px;}
.pdet-section{margin-bottom:20px;}
.pdet-section-title{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:800;letter-spacing:3px;color:var(--blue3);text-transform:uppercase;margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border2);}
.pdet-bio{font-size:12px;color:var(--gray);line-height:1.7;font-style:italic;background:var(--card);border-radius:10px;padding:12px 14px;border-left:3px solid var(--blue);}
.pdet-kv-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
@media(max-width:480px){.pdet-kv-grid{grid-template-columns:1fr;}}
.pdet-kv{background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:10px 14px;display:flex;flex-direction:column;gap:2px;}
.pdet-kv-label{font-family:'Barlow Condensed',sans-serif;font-size:8px;font-weight:700;letter-spacing:2.5px;color:var(--gray);text-transform:uppercase;}
.pdet-kv-val{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;color:var(--white);letter-spacing:.5px;}
.pdet-kv-val.big{font-family:'Orbitron',monospace;font-size:22px;font-weight:900;color:var(--blue3);}
/* FIFA attribute bars */
.fifa-attrs{display:grid;grid-template-columns:1fr 1fr;gap:6px 24px;}
@media(max-width:480px){.fifa-attrs{grid-template-columns:1fr;}}
.fifa-attr{display:flex;align-items:center;gap:8px;}
.fifa-attr-lbl{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;color:var(--gray);text-transform:uppercase;width:62px;flex-shrink:0;}
.fifa-attr-bar{flex:1;height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.fifa-attr-fill{height:100%;border-radius:3px;transition:width 1s ease;}
.fifa-attr-val{font-family:'Orbitron',monospace;font-size:11px;font-weight:900;width:26px;text-align:right;flex-shrink:0;}
/* reset stats modal */
.rstats-mod{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:24px;width:100%;max-width:440px;animation:mi .3s ease;margin:auto;}

/* Best Player badge */
.best-player-badge{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,rgba(245,166,35,.2),rgba(245,166,35,.08));border:1px solid rgba(245,166,35,.4);border-radius:20px;padding:3px 10px;font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:800;letter-spacing:2px;color:#fbbf24;text-transform:uppercase;}
.team-pill img{width:12px;height:12px;object-fit:contain;}

/* ── SCROLLBAR ── */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--blue2);}

/* ══════════════════════════════════════════════
   ADVANCED CHAT SYSTEM — Complete Redesign
═══════════════════════════════════════════════ */
#page-chat.on{display:flex;flex-direction:column;height:calc(100vh - 60px);overflow:hidden;}

/* ── Chat Shell ── */
.chat-shell{display:flex;flex-direction:column;height:100%;overflow:hidden;background:var(--bg);}

/* ── Chat Header ── */
.chat-header{flex-shrink:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));border-bottom:1px solid var(--border2);padding:0 16px;height:56px;display:flex;align-items:center;gap:12px;position:relative;z-index:10;}
.chat-header-icon{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--blue),var(--blue2));display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 0 14px var(--blueglow);}
.chat-header-icon svg{width:18px;height:18px;stroke:#fff;fill:none;stroke-width:2;}
.chat-header-info{flex:1;min-width:0;}
.chat-header-title{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:900;letter-spacing:3px;text-transform:uppercase;color:var(--white);line-height:1;}
.chat-header-meta{display:flex;align-items:center;gap:8px;margin-top:2px;}
.chat-online-pill{display:flex;align-items:center;gap:4px;font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;color:var(--gray);}
.chat-online-dot{width:6px;height:6px;border-radius:50%;background:#10b981;box-shadow:0 0 5px rgba(16,185,129,.7);animation:pulse-dot 2s ease-in-out infinite;}
@keyframes pulse-dot{0%,100%{box-shadow:0 0 5px rgba(16,185,129,.7);}50%{box-shadow:0 0 10px rgba(16,185,129,1);}}
.chat-sep-dot{width:2px;height:2px;border-radius:50%;background:var(--gray2);}
.chat-header-actions{display:flex;gap:6px;align-items:center;flex-shrink:0;}
.chat-hbtn{width:32px;height:32px;border-radius:8px;background:none;border:1px solid var(--border2);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--gray);transition:all .2s;}
.chat-hbtn:hover{color:var(--white);border-color:var(--blue3);background:var(--bluesoft);}
.chat-hbtn svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;}
.chat-hbtn.active{color:var(--blue3);border-color:var(--blue3);background:var(--bluesoft);}

/* ── Online Users Bar ── */
.chat-users-bar{flex-shrink:0;background:var(--bg1);border-bottom:1px solid var(--border2);padding:8px 16px;display:flex;align-items:center;gap:8px;overflow-x:auto;overflow-y:hidden;scrollbar-width:none;transition:all .3s;}
.chat-users-bar::-webkit-scrollbar{display:none;}
.chat-users-bar.hidden{display:none;}
.chat-users-label{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;color:var(--gray2);text-transform:uppercase;white-space:nowrap;flex-shrink:0;}
.chat-user-avatar{position:relative;flex-shrink:0;cursor:default;}
.chat-user-avatar img,.chat-user-avatar .cua-init{width:28px;height:28px;border-radius:50%;border:2px solid #10b981;object-fit:cover;box-shadow:0 0 8px rgba(16,185,129,.4);}
.chat-user-avatar .cua-init{background:var(--bg3);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:800;color:var(--white);}
.chat-user-avatar .cua-dot{position:absolute;bottom:-1px;right:-1px;width:8px;height:8px;border-radius:50%;background:#10b981;border:1.5px solid var(--bg1);}
.chat-user-tooltip{position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--card2);border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--white);white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s;z-index:20;}
.chat-user-avatar:hover .chat-user-tooltip{opacity:1;}

/* ── Search Bar ── */
.chat-search-bar{flex-shrink:0;background:var(--bg1);border-bottom:1px solid var(--border2);padding:8px 16px;display:none;align-items:center;gap:8px;}
.chat-search-bar.show{display:flex;}
.chat-search-inp{flex:1;background:var(--card);border:1px solid var(--border2);border-radius:20px;padding:7px 14px 7px 34px;color:var(--white);font-family:'Barlow',sans-serif;font-size:13px;outline:none;}
.chat-search-inp:focus{border-color:var(--blue3);}
.chat-search-ico{position:absolute;left:27px;color:var(--gray2);display:flex;align-items:center;pointer-events:none;}
.chat-search-ico svg{width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2.5;}
.chat-search-wrap{position:relative;flex:1;}
.chat-search-count{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;color:var(--gray);white-space:nowrap;}
.chat-search-close{width:28px;height:28px;background:none;border:none;cursor:pointer;color:var(--gray);display:flex;align-items:center;justify-content:center;}
.chat-search-close svg{width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2.5;}

/* ── Messages Area ── */
.chat-body-inner{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;position:relative;}
.chat-msgs{flex:1;overflow-y:auto;overflow-x:hidden;padding:10px 12px 4px;display:flex;flex-direction:column;gap:2px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;}

/* Day divider */
.chat-day-divider{display:flex;align-items:center;gap:10px;margin:10px 0 6px;}
.chat-day-divider span{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;color:var(--gray2);text-transform:uppercase;white-space:nowrap;padding:3px 8px;background:var(--bg2);border:1px solid var(--border2);border-radius:20px;}
.chat-day-divider::before,.chat-day-divider::after{content:'';flex:1;height:1px;background:var(--border2);}

/* ── Message Rows ── */
.cmsg{display:flex;gap:8px;align-items:flex-end;padding:2px 0;animation:cmsg-in .18s ease;position:relative;}
.cmsg:hover .cactions{opacity:1;pointer-events:auto;}
@keyframes cmsg-in{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.cmsg.own{flex-direction:row-reverse;}
.cmsg.grouped{padding-top:0;}
.cmsg.grouped .cava{visibility:hidden;}
.cmsg.grouped .cmeta{display:none;}

/* Avatar */
.cava{width:32px;height:32px;border-radius:50%;background:var(--bg3);border:2px solid var(--border2);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:var(--white);cursor:pointer;transition:border-color .2s;}
.cava:hover{border-color:var(--blue3);}
.cava img{width:100%;height:100%;object-fit:cover;}

/* Bubble wrapper */
.cwrap{display:flex;flex-direction:column;gap:1px;max-width:72%;}
.cmsg.own .cwrap{align-items:flex-end;}

/* Meta row */
.cmeta{display:flex;align-items:center;gap:5px;margin-bottom:3px;flex-wrap:wrap;}
.cmsg.own .cmeta{flex-direction:row-reverse;}
.csender{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:800;color:var(--white);letter-spacing:.5px;cursor:pointer;}
.csender:hover{color:var(--blue3);}
.chat-role-badge{font-family:'Barlow Condensed',sans-serif;font-size:8px;font-weight:800;letter-spacing:1.5px;padding:1px 5px;border-radius:4px;text-transform:uppercase;}
.chat-role-admin{background:rgba(245,158,11,.2);color:#fbbf24;border:1px solid rgba(245,158,11,.3);}
.chat-role-player{background:rgba(16,185,129,.15);color:#34d399;border:1px solid rgba(16,185,129,.25);}
.chat-team-badge{display:inline-flex;align-items:center;gap:3px;font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;color:var(--gray2);}
.chat-team-badge img{width:12px;height:12px;object-fit:contain;}
.ctime{font-size:9px;color:var(--gray2);font-family:'Barlow Condensed',sans-serif;}
.chat-edited-tag{font-size:8px;color:var(--gray2);font-style:italic;}

/* Bubble */
.cbubble{background:var(--card);border:1px solid var(--border2);border-radius:4px 16px 16px 16px;padding:9px 13px;font-size:13px;color:var(--white);line-height:1.55;word-break:break-word;transition:background .15s;position:relative;}
.cmsg.own .cbubble{background:linear-gradient(135deg,rgba(30,111,255,.25),rgba(30,111,255,.15));border-color:rgba(30,111,255,.4);border-radius:16px 4px 16px 16px;}
.cbubble.highlight{background:rgba(30,111,255,.18)!important;border-color:var(--blue3)!important;transition:background .4s,border-color .4s;}
.cbubble p{margin:0;}

/* Reply quote inside bubble */
.cquote{background:rgba(255,255,255,.04);border-left:2px solid var(--blue3);border-radius:4px 8px 8px 4px;padding:5px 9px;margin-bottom:7px;cursor:pointer;transition:background .15s;}
.cquote:hover{background:rgba(30,111,255,.1);}
.cquote-sender{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:800;color:var(--blue3);letter-spacing:.5px;margin-bottom:1px;}
.cquote-text{font-size:11px;color:var(--gray);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px;}

/* Search highlight */
.chat-search-hl{background:rgba(245,166,35,.3);border-radius:2px;color:var(--white);}

/* Ping mention */
.chat-ping{color:var(--blue3);font-weight:700;background:rgba(30,111,255,.12);border-radius:4px;padding:1px 4px;cursor:pointer;}
.chat-ping:hover{background:rgba(30,111,255,.25);}
.chat-ping.me{background:rgba(30,111,255,.25);color:#93c5fd;}

/* ── Reactions ── */
.chat-reactions{display:flex;flex-wrap:wrap;gap:3px;margin-top:4px;}
.creact-btn{background:var(--card2);border:1px solid var(--border2);border-radius:20px;padding:2px 8px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:3px;color:var(--gray);transition:all .15s;font-family:'Barlow Condensed',sans-serif;}
.creact-btn:hover{border-color:var(--blue3);transform:scale(1.08);}
.creact-btn.mine{background:rgba(30,111,255,.15);border-color:rgba(30,111,255,.5);color:var(--white);}
.creact-btn .rcount{font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--gray);}
.creact-btn.mine .rcount{color:var(--white);}

/* Inline reaction picker */
.chat-react-picker{position:absolute;z-index:200;background:var(--card2);border:1px solid var(--border);border-radius:16px;padding:8px;display:flex;flex-wrap:wrap;gap:3px;width:196px;box-shadow:0 12px 32px rgba(0,0,0,.6);animation:cmsg-in .15s ease;}
.chat-react-picker span{font-size:20px;cursor:pointer;padding:3px;border-radius:6px;transition:transform .1s;}
.chat-react-picker span:hover{transform:scale(1.25);background:rgba(255,255,255,.05);}

/* ── Message Actions (hover) ── */
.cactions{position:absolute;top:-28px;right:0;display:flex;gap:2px;background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:3px 4px;opacity:0;pointer-events:none;transition:opacity .15s;z-index:15;box-shadow:0 4px 16px rgba(0,0,0,.4);}
.cmsg.own .cactions{right:auto;left:0;}
.cact{width:26px;height:26px;border-radius:6px;background:none;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--gray);transition:all .15s;}
.cact:hover{color:var(--white);background:rgba(255,255,255,.08);}
.cact.del:hover{color:#f87171;background:rgba(239,68,68,.12);}
.cact svg{width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2;}

/* ── Media ── */
.chat-media{border-radius:12px;overflow:hidden;margin-top:6px;cursor:pointer;position:relative;max-width:280px;}
.chat-media img{width:100%;display:block;border-radius:12px;transition:opacity .15s;}
.chat-media img:hover{opacity:.88;}
.chat-media video{width:100%;display:block;border-radius:12px;max-height:220px;cursor:default;}
.chat-media-play{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.3);border-radius:12px;}
.chat-media-play svg{width:44px;height:44px;filter:drop-shadow(0 2px 8px rgba(0,0,0,.6));}

/* ── Scroll-to-bottom badge ── */
.chat-scroll-badge{position:absolute;bottom:12px;right:16px;background:var(--blue);color:#fff;border:none;border-radius:20px;padding:6px 14px 6px 10px;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;cursor:pointer;box-shadow:0 4px 16px var(--blueglow);display:none;align-items:center;gap:6px;z-index:20;transition:all .2s;animation:cmsg-in .2s ease;}
.chat-scroll-badge svg{width:12px;height:12px;stroke:#fff;fill:none;stroke-width:2.5;}
.chat-scroll-badge:hover{background:var(--blue3);transform:translateY(-1px);}

/* ── New message separator ── */
.chat-new-sep{display:flex;align-items:center;gap:8px;margin:8px 0;}
.chat-new-sep span{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:800;letter-spacing:2px;color:#34d399;text-transform:uppercase;white-space:nowrap;padding:2px 8px;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.25);border-radius:20px;}
.chat-new-sep::before,.chat-new-sep::after{content:'';flex:1;height:1px;background:rgba(16,185,129,.2);}

/* ── Reply bar (above input) ── */
.chat-reply-bar{flex-shrink:0;background:rgba(30,111,255,.07);border-top:1px solid rgba(30,111,255,.18);padding:6px 14px;display:none;align-items:center;gap:8px;}
.chat-reply-bar.show{display:flex;}
.chat-reply-bar-icon{color:var(--blue3);flex-shrink:0;display:flex;}
.chat-reply-bar-icon svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2.5;}
.chat-reply-preview{flex:1;font-size:11px;color:var(--gray);font-family:'Barlow Condensed',sans-serif;letter-spacing:.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.chat-reply-preview strong{color:var(--blue3);}
.chat-reply-close{width:22px;height:22px;background:none;border:none;cursor:pointer;color:var(--gray);display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .15s;}
.chat-reply-close:hover{color:var(--white);background:rgba(255,255,255,.08);}
.chat-reply-close svg{width:12px;height:12px;stroke:currentColor;fill:none;stroke-width:2.5;}

/* ── Edit bar ── */
.chat-edit-bar{flex-shrink:0;background:rgba(245,166,35,.07);border-top:1px solid rgba(245,166,35,.2);padding:5px 14px;display:none;align-items:center;gap:8px;}
.chat-edit-bar.show{display:flex;}
.chat-edit-bar-lbl{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;color:#fbbf24;}
.chat-edit-cancel-btn{font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;padding:3px 10px;border-radius:6px;border:1px solid rgba(245,166,35,.3);background:none;color:#fbbf24;cursor:pointer;transition:all .15s;}
.chat-edit-cancel-btn:hover{background:rgba(245,166,35,.1);}

/* ── Input area ── */
.chat-input-area{flex-shrink:0;background:var(--bg1);border-top:1px solid var(--border2);padding:8px 12px;padding-bottom:max(8px,env(safe-area-inset-bottom,8px));display:flex;flex-direction:column;gap:5px;}
.chat-typing{height:14px;font-size:10px;color:var(--gray);display:flex;align-items:center;gap:4px;font-family:'Barlow Condensed',sans-serif;}
.typing-dots span{display:inline-block;width:3px;height:3px;border-radius:50%;background:var(--gray);animation:td .9s infinite;margin:0 1px;}
.typing-dots span:nth-child(2){animation-delay:.2s;}
.typing-dots span:nth-child(3){animation-delay:.4s;}
@keyframes td{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-4px)}}
.chat-irow{display:flex;align-items:flex-end;gap:6px;}
.chat-input-main{flex:1;min-width:0;position:relative;}
.chat-input-main textarea{width:100%;background:var(--card);border:1px solid var(--border2);border-radius:22px;padding:9px 42px 9px 14px;color:var(--white);font-family:'Barlow',sans-serif;font-size:14px;outline:none;resize:none;max-height:100px;min-height:40px;line-height:1.45;box-sizing:border-box;-webkit-appearance:none;transition:border-color .2s;}
.chat-input-main textarea:focus{border-color:var(--blue3);}
.chat-input-main textarea::placeholder{color:var(--gray2);}
.chat-char-counter{position:absolute;bottom:8px;right:13px;font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;color:var(--gray2);pointer-events:none;transition:color .2s;}
.chat-char-counter.warn{color:#fbbf24;}
.chat-char-counter.danger{color:#f87171;}
.chat-action-btn{width:40px;height:40px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;}
.chat-action-btn.send{background:var(--blue);box-shadow:0 0 12px var(--blueglow);}
.chat-action-btn.send:hover{background:var(--blue3);transform:scale(1.05);}
.chat-action-btn.send svg{width:16px;height:16px;stroke:#fff;fill:none;stroke-width:2.5;}
.chat-action-btn.icon{background:var(--card);border:1px solid var(--border2);}
.chat-action-btn.icon:hover{border-color:var(--blue3);color:var(--white);}
.chat-action-btn svg{width:17px;height:17px;stroke:var(--gray);fill:none;stroke-width:2;}
.chat-action-btn.icon:hover svg{stroke:var(--white);}

/* Emoji picker */
.cemoji-wrap{position:relative;flex-shrink:0;}
.cemoji-picker{position:absolute;bottom:calc(100% + 8px);right:0;background:var(--card);border:1px solid var(--border2);border-radius:14px;padding:10px;display:none;flex-direction:column;gap:6px;width:224px;z-index:300;box-shadow:0 12px 32px rgba(0,0,0,.6);}
.cemoji-picker.open{display:flex;}
.cemoji-tabs{display:flex;gap:3px;border-bottom:1px solid var(--border2);padding-bottom:6px;}
.cemoji-tab{flex:1;font-size:15px;cursor:pointer;padding:3px;border-radius:5px;text-align:center;transition:background .15s;}
.cemoji-tab:hover,.cemoji-tab.on{background:var(--card2);}
.cemoji-grid{display:flex;flex-wrap:wrap;gap:2px;}
.cemoji-grid span{font-size:19px;cursor:pointer;padding:3px;border-radius:5px;transition:transform .1s;}
.cemoji-grid span:hover{transform:scale(1.2);background:var(--card2);}

/* Ping dropdown */
.ping-dropdown{position:absolute;bottom:calc(100% + 8px);left:0;background:var(--card2);border:1px solid var(--border);border-radius:12px;overflow:hidden;z-index:100;min-width:200px;max-height:200px;overflow-y:auto;box-shadow:0 8px 24px rgba(0,0,0,.5);}
.ping-option{padding:9px 14px;cursor:pointer;display:flex;align-items:center;gap:8px;font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;color:var(--white);transition:background .15s;border-bottom:1px solid var(--border2);}
.ping-option:last-child{border-bottom:none;}
.ping-option:hover{background:var(--bluesoft);}
.ping-option .po-ava{width:26px;height:26px;border-radius:50%;object-fit:cover;flex-shrink:0;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:10px;overflow:hidden;}
.ping-option .po-ava img{width:100%;height:100%;object-fit:cover;}
.ping-option .po-role{font-size:9px;font-weight:700;letter-spacing:1px;color:var(--gray);}

/* ── Locked / access states ── */
.chat-locked{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:16px;padding:40px 24px;text-align:center;}
.chat-locked-ico{width:60px;height:60px;background:var(--card);border:1px solid var(--border2);border-radius:16px;display:flex;align-items:center;justify-content:center;}
.chat-locked-ico svg{width:26px;height:26px;stroke:var(--gray);fill:none;stroke-width:1.5;}
.chat-locked h3{font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:900;letter-spacing:2px;color:var(--white);margin:0;}
.chat-locked p{font-size:12px;color:var(--gray);line-height:1.7;max-width:280px;margin:0;}

/* Email verify */
.chat-otp-box{background:var(--card);border:1px solid var(--border2);border-radius:20px;padding:28px 24px;max-width:360px;width:100%;display:flex;flex-direction:column;align-items:center;gap:14px;}
.chat-otp-input{font-family:'Orbitron',monospace;font-size:26px;letter-spacing:8px;text-align:center;background:var(--bg);border:2px solid rgba(30,111,255,.4);border-radius:12px;padding:12px 8px;color:var(--blue3);outline:none;width:100%;box-sizing:border-box;transition:border-color .2s;}
.chat-otp-input:focus{border-color:var(--blue3);}

/* ── RESPONSIVE NAV ── */
@media(max-width:460px){
  .nav{padding:0 11px;height:54px;}
  .ntab{font-size:10px;padding:6px 8px;letter-spacing:1px;}
  .bsmall{font-size:10px;padding:6px 11px;}
  .nbrand-txt h1{font-size:10px;letter-spacing:2px;}
}
@media(max-width:340px){
  .ntabs{display:none;}
}
</style>
</head>
<body>

<!-- PHM SVG LOGO (inline, always works) -->
<svg style="display:none" id="phm-svg-def">
  <symbol id="phm-icon" viewBox="0 0 100 100">
    <defs>
      <linearGradient id="lg1" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#4d8fff"/>
        <stop offset="100%" style="stop-color:#1e6fff"/>
      </linearGradient>
      <linearGradient id="lg2" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#f0f4ff"/>
        <stop offset="100%" style="stop-color:#9bb0c9"/>
      </linearGradient>
    </defs>
    <!-- Shield outline -->
    <path d="M50 6 L88 20 L88 52 C88 72 70 88 50 94 C30 88 12 72 12 52 L12 20 Z" fill="url(#lg1)" opacity="0.9"/>
    <path d="M50 12 L83 24 L83 52 C83 69 67 83 50 88 C33 83 17 69 17 52 L17 24 Z" fill="#070d1a" opacity="0.7"/>
    <path d="M50 18 L78 29 L78 51 C78 65 65 77 50 82 C35 77 22 65 22 51 L22 29 Z" fill="url(#lg1)" opacity="0.25"/>
    <!-- P H M letters -->
    <text x="50" y="62" text-anchor="middle" font-family="'Barlow Condensed',sans-serif" font-weight="900" font-size="26" letter-spacing="1" fill="url(#lg2)">PHM</text>
    <!-- Top accent line -->
    <line x1="30" y1="38" x2="70" y2="38" stroke="#4d8fff" stroke-width="1.5" opacity="0.5"/>
  </symbol>
</svg>

<!-- SPLASH -->
<div id="splash" class="screen active">
  <div class="sbg"></div>
  <div class="sc">
    <div class="splash-logo-wrap">
      <div class="splash-logo-ring"></div>
      <div class="splash-logo-ring2"></div>
      <div class="splash-logo-glow"></div>
      <div class="splash-logo" id="splash-logo-circle">
        <img id="splash-img" alt="PHM" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:50%;">
      </div>
    </div>
    <h1 class="stitle">PHM</h1>
    <p class="ssub">The Ultimate Player Tiersheet</p>
    <button class="btn-enter" onclick="goLoad()">ENTER TIERSHEET</button>
  </div>
</div>

<!-- LOADING -->
<div id="loading" class="screen">
  <div class="sbg"></div>
  <div class="load-inner">
    <div class="load-logo-wrap">
      <div class="load-glow"></div>
      <div class="load-ring2"></div>
      <div class="load-ring"></div>
      <div class="load-logo" id="load-logo-circle">
        <img id="load-img" alt="PHM" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:50%;">
      </div>
    </div>
    <div class="load-title">PHM</div>
    <div class="load-sub">LOADING PROFESSIONAL DATA...</div>
    <div class="ltrack"><div class="lfill" id="lf"></div></div>
    <div class="load-pct" id="lpct">0%</div>
  </div>
</div>

<!-- APP -->
<div id="app" class="screen" style="flex-direction:column;">
  <nav class="nav">
    <div class="nbrand">
      <div class="nav-logo" id="nav-logo-circle">
        <img id="nav-img" alt="PHM" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:50%;">
      </div>
      <div class="nbrand-txt">
        <h1>PHM TIERSHEET</h1>
        <p>Professional Rankings</p>
      </div>
    </div>
    <div class="ntabs">
      <button class="ntab on" onclick="goPage('tiersheet',this)">Tiersheet</button>
      <button class="ntab" onclick="goPage('analytics',this)">Analytics</button>
      <button class="ntab" onclick="goPage('teams',this)">Teams</button>
      <button class="ntab" id="ctab" onclick="goPage('chat',this)">Chat</button>
      <button class="ntab" id="mtab" style="display:none" onclick="goPage('members',this)">Members</button>
    </div>
    <div class="nright" id="nright">
      <button class="bsmall boutline" onclick="openAuth('login')">Sign In</button>
      <button class="bsmall bprimary" onclick="openAuth('register')">Register</button>
    </div>
  </nav>

  <div style="flex:1;overflow-y:auto;overflow-x:hidden;">

    <!-- TIERSHEET PAGE -->
    <div id="page-tiersheet" class="page on">
      <div class="page-hero">
        <div class="page-hero-top">
          <div>
            <h2>PHM Professional Tiersheet</h2>
            <p>Registered players ranked by tier &amp; performance</p>
          </div>
          <span class="hero-badge" id="season-badge"></span>
        </div>
      </div>
      <div class="srow">
        <div class="sbox">
          <div class="sbox-icon"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div>
          <div class="sn" id="st-p">0</div><div class="sl">Players</div>
        </div>
        <div class="sbox">
          <div class="sbox-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></div>
          <div class="sn" id="st-s">0</div><div class="sl">Showing</div>
        </div>
        <div class="sbox">
          <div class="sbox-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4m0 4h.01"/></svg></div>
          <div class="sn" id="st-g">0</div><div class="sl">Goals</div>
        </div>
        <div class="sbox">
          <div class="sbox-icon"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
          <div class="sn" id="st-m">0</div><div class="sl">Members</div>
        </div>
      </div>
      <div id="fan-area"></div>
      <div class="ctrls">
        <div class="swrap">
          <span class="sico"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></span>
          <input type="text" placeholder="Search players…" id="srch" oninput="doFilter()">
        </div>
        <select class="fsel" id="f-tier" onchange="doFilter()">
          <option value="">All Tiers</option>
          <option>Tier 1</option><option>Tier 2</option><option>Tier 3</option><option>Tier 4</option>
        </select>
        <select class="fsel" id="f-nation" onchange="doFilter()">
          <option value="">All Nations</option>
        </select>
        <button class="brefresh" onclick="refreshAll()">&#8635; Refresh</button>
      </div>
      <div class="twrap" id="twrap"></div>
    </div>

    <!-- ANALYTICS PAGE -->
    <div id="page-analytics" class="page">
      <div class="page-hero">
        <h2>Analytics</h2>
        <p>Player performance &amp; league statistics</p>
      </div>
      <div class="awrap">
        <div class="asec-title">League Overview</div>
        <div class="agrid">
          <div class="acard"><div class="act">Nation Distribution</div><div class="nbars" id="nbars"></div></div>
          <div class="acard">
            <div class="stabs">
              <button class="stab on" onclick="setST('goals',this)">Top Scorers</button>
              <button class="stab" onclick="setST('assists',this)">Top Assists</button>
            </div>
            <ul class="slist" id="slist"></ul>
          </div>
        </div>
        <div class="mvps">
          <div class="mvph"><div class="mvpb"></div><h3>Most Valuable Players</h3></div>
          <div class="mvpr" id="mvpr"></div>
        </div>
      </div>
    </div>

    <!-- MEMBERS PAGE (admin) -->
    <div id="page-members" class="page">
      <div class="page-hero">
        <div class="page-hero-top">
          <div>
            <h2>Member Management</h2>
            <p>Manage roles, tiers &amp; player profiles</p>
          </div>
          <button onclick="openImportMembers()" style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:8px 16px;border-radius:8px;border:1px solid rgba(88,101,242,.4);background:rgba(88,101,242,.12);color:#7289da;cursor:pointer;display:flex;align-items:center;gap:6px;white-space:nowrap;transition:all .2s;" onmouseover="this.style.background='rgba(88,101,242,.22)'" onmouseout="this.style.background='rgba(88,101,242,.12)'">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Import Members
            </button>
        </div>
        <div id="member-sync-info" style="margin-top:10px;font-size:10px;color:var(--gray);font-family:'Barlow Condensed',sans-serif;letter-spacing:1px;"></div>
      </div>
      <div class="mwrap">
        <div class="mtable">
          <div class="mth">
            <div class="mthc">User</div>
            <div class="mthc">Role</div>
            <div class="mthc">Tier</div>
            <div class="mthc">Last Edited</div>
            <div class="mthc" style="text-align:right">Actions</div>
          </div>
          <div id="mrows"></div>
        </div>
      </div>
    </div>

    <!-- TEAMS PAGE -->
    <div id="page-teams" class="page">
      <div class="page-hero">
        <div class="page-hero-top">
          <div>
            <h2>La Liga Teams</h2>
            <p>All 8 clubs · 2024/25 Season</p>
          </div>
          <span class="hero-badge">La Liga · ES</span>
        </div>
      </div>
      <div style="padding:16px 20px 48px;">
        <div id="teams-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;"></div>
      </div>
    </div>

    <!-- CHAT PAGE -->
    <div id="page-chat" class="page">
      <div class="chat-shell">
        <div class="chat-header">
          <div class="chat-header-icon">
            <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          </div>
          <div class="chat-header-info">
            <div class="chat-header-title">Squad Chat</div>
            <div class="chat-header-meta">
              <div class="chat-online-pill">
                <div class="chat-online-dot" id="chat-conn-dot"></div>
                <span id="chat-online-txt">Connecting…</span>
              </div>
              <div class="chat-sep-dot"></div>
              <span id="chat-msg-count" style="font-family:'Barlow Condensed';font-size:10px;font-weight:700;letter-spacing:1px;color:var(--gray2);">0 messages</span>
            </div>
          </div>
          <div class="chat-header-actions">
            <button class="chat-hbtn" id="chat-search-btn" onclick="toggleChatSearch()" title="Search">
              <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            </button>
            <button class="chat-hbtn" id="chat-users-btn" onclick="toggleUsersBar()" title="Online users">
              <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            </button>
          </div>
        </div>
        <div class="chat-users-bar hidden" id="chat-users-bar">
          <span class="chat-users-label">Online:</span>
          <div id="chat-users-list" style="display:flex;gap:6px;align-items:center;"></div>
        </div>
        <div class="chat-search-bar" id="chat-search-bar">
          <div class="chat-search-wrap">
            <div class="chat-search-ico"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></div>
            <input class="chat-search-inp" id="chat-search-inp" placeholder="Search messages…" oninput="onChatSearch(this.value)">
          </div>
          <span class="chat-search-count" id="chat-search-count"></span>
          <button class="chat-search-close" onclick="closeChatSearch()">
            <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <div id="chat-body" class="chat-body-inner"></div>
      </div>
    </div>

  </div>
</div>

<!-- TEAM PROFILE MODAL -->
<div class="ov" id="team-ov" onclick="closeTeam(event)">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:600px;padding:0;overflow:hidden;">
    <div class="team-mod-header">
      <div class="team-mod-color-bar" id="team-color-bar"></div>
      <div class="team-mod-top">
        <img id="team-logo" class="team-mod-logo" src="" alt="">
        <div class="team-mod-info">
          <div class="team-mod-name" id="team-name"></div>
          <div class="team-mod-sub" id="team-sub"></div>
          <div class="team-stats-row" id="team-stats-row"></div>
        </div>
        <div class="cbtn" onclick="closeTeam()" style="align-self:flex-start;flex-shrink:0;">&#10005;</div>
      </div>
      <!-- Manager bar -->
      <div class="team-manager-bar" id="team-manager-bar">
        <span class="team-mgr-label" style="display:flex;align-items:center;gap:5px;"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg> Manager</span>
        <span class="team-mgr-name" id="team-mgr-name">Not set</span>
        <span id="team-mgr-edit" style="display:none;margin-left:auto;">
          <button onclick="openSetManager(currentTeamId)" style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;padding:4px 10px;border-radius:6px;border:1px solid rgba(139,92,246,.3);background:rgba(139,92,246,.1);color:#a78bfa;cursor:pointer;">Edit</button>
        </span>
      </div>
    </div>
    <!-- Players -->
    <div style="padding:18px 22px 24px;max-height:50vh;overflow-y:auto;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;color:var(--blue3);text-transform:uppercase;">Squad</div>
        <div id="team-squad-admin" style="display:none;">
          <button onclick="openAssignPlayer(currentTeamId)" style="font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;padding:5px 12px;border-radius:8px;border:1px solid rgba(30,111,255,.3);background:var(--bluesoft);color:var(--blue3);cursor:pointer;">+ Add Player</button>
        </div>
      </div>
      <div id="team-players"></div>
    </div>
  </div>
</div>

<!-- SET MANAGER MODAL -->
<div class="ov" id="mgr-ov" onclick="if(!event||event.target===this)this.classList.remove('open')">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:360px;">
    <div class="mod-title">
      <span>Set Manager</span>
      <div class="cbtn" onclick="document.getElementById('mgr-ov').classList.remove('open')">&#10005;</div>
    </div>
    <div class="fg" style="margin-bottom:18px;">
      <label class="flbl">Manager Name</label>
      <input class="finp" id="mgr-input" placeholder="e.g. Carlo Ancelotti" maxlength="50" autocomplete="off"
        onkeydown="if(event.key==='Enter')saveManager()">
    </div>
    <div class="mod-acts">
      <button class="fcancel" onclick="document.getElementById('mgr-ov').classList.remove('open')">Cancel</button>
      <button class="fsave" onclick="saveManager()">Save</button>
    </div>
  </div>
</div>

<!-- ASSIGN PLAYER MODAL -->
<div class="ov" id="assign-ov" onclick="if(!event||event.target===this)this.classList.remove('open')">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:400px;">
    <div class="mod-title">
      <span>Add Player to Team</span>
      <div class="cbtn" onclick="document.getElementById('assign-ov').classList.remove('open')">&#10005;</div>
    </div>
    <div class="fg" style="margin-bottom:8px;">
      <label class="flbl">Select Player</label>
      <select class="finp" id="assign-player-select" style="font-size:13px;"></select>
    </div>
    <div id="assign-preview" style="margin-bottom:16px;"></div>
    <div class="mod-acts">
      <button class="fcancel" onclick="document.getElementById('assign-ov').classList.remove('open')">Cancel</button>
      <button class="fsave" onclick="saveAssignPlayer()">Add to Team</button>
    </div>
  </div>
</div>

<!-- PLAYER DETAIL OVERLAY (new FIFA-style) -->
<div class="ov" id="pdet-ov" onclick="closePDet(event)">
  <div class="pdet-mod" onclick="event.stopPropagation()">
    <div class="pdet-banner" id="pdet-banner"></div>
    <div class="pdet-header">
      <div class="pdet-ava" id="pdet-ava"></div>
      <div class="pdet-info">
        <div class="pdet-name" id="pdet-name"></div>
        <div class="pdet-meta" id="pdet-meta"></div>
        <div id="pdet-bio-short" style="font-size:11px;color:var(--gray);font-style:italic;max-width:280px;line-height:1.5;margin-top:4px;"></div>
      </div>
      <div class="pdet-ovr" id="pdet-ovr"></div>
      <div class="cbtn" onclick="closePDet()" style="align-self:flex-start;margin-left:8px;flex-shrink:0;">&#10005;</div>
    </div>
    <div class="pdet-body">
      <!-- Stats row -->
      <div class="pdet-section">
        <div class="pdet-section-title">Match Stats</div>
        <div class="pdet-kv-grid" id="pdet-kvgrid"></div>
      </div>
      <!-- FIFA attrs -->
      <div class="pdet-section">
        <div class="pdet-section-title">Attributes</div>
        <div class="fifa-attrs" id="pdet-attrs"></div>
      </div>
      <!-- Bio full -->
      <div class="pdet-section" id="pdet-bio-wrap" style="display:none;">
        <div class="pdet-section-title">About</div>
        <div class="pdet-bio" id="pdet-bio-full"></div>
      </div>
      <!-- Admin actions -->
      <div id="pdet-admin-acts" style="display:none;margin-top:4px;display:flex;gap:8px;flex-wrap:wrap;"></div>
    </div>
  </div>
</div>

<!-- RESET STATS MODAL -->
<div class="ov" id="rstats-ov" onclick="closeRStatsModal(event)">
  <div class="rstats-mod" onclick="event.stopPropagation()">
    <div class="mod-title">
      <span style="color:#fbbf24;">Reset All Stats</span>
      <div class="cbtn" onclick="closeRStatsModal()">&#10005;</div>
    </div>
    <div style="background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:12px;padding:14px 16px;margin-bottom:18px;">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;color:#fbbf24;letter-spacing:1px;margin-bottom:6px;">RESET PLAYER STATS ONLY</div>
      <div style="font-size:12px;color:rgba(251,191,36,.8);line-height:1.7;">
        This will reset <strong style="color:#fde68a;">Goals, Assists</strong> and all <strong style="color:#fde68a;">Attribute ratings</strong> for every player to default values. User accounts, tiers, teams and profiles are kept intact.<br>
        <span style="font-size:10px;opacity:.7;">This cannot be undone.</span>
      </div>
    </div>
    <div class="fg" style="margin-bottom:16px;">
      <label class="flbl" style="color:#fbbf24;">Type <strong style="color:#fde68a;letter-spacing:2px;">RESET</strong> to confirm</label>
      <input class="finp" id="rstats-confirm-input" type="text" placeholder="RESET" autocomplete="off"
        style="font-family:'Orbitron',monospace;font-size:14px;letter-spacing:4px;text-align:center;border-color:rgba(245,158,11,.3);"
        oninput="checkRStatsInput()">
    </div>
    <div class="mod-acts">
      <button class="fcancel" onclick="closeRStatsModal()">Cancel</button>
      <button id="rstats-confirm-btn" onclick="executeResetStats()" disabled
        style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:9px 18px;border-radius:8px;cursor:not-allowed;background:rgba(245,158,11,.2);color:rgba(251,191,36,.4);border:1px solid rgba(245,158,11,.2);transition:all .3s;min-height:38px;">
        RESET STATS
      </button>
    </div>
  </div>
</div>

<!-- HEATMAP OVERLAY -->
<div class="ov" id="hov" onclick="closeHM(event)">
  <div class="hmod" onclick="event.stopPropagation()">
    <div class="hmleft">
      <div class="hmava" id="hmava"></div>
      <div style="text-align:center;width:100%;">
        <div class="hmname" id="hmname"></div>
        <div class="hmtier" id="hmtier"></div>
        <div class="hmpos" id="hmpos"></div>
        <div id="hmteam" style="display:none;align-items:center;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;color:var(--gray);margin-bottom:6px;"></div>
        <div class="hmrat" id="hmrat"></div>
        <div class="hmval" id="hmval"></div>
        <div class="hmbio" id="hmbio"></div>
      </div>
    </div>
    <div class="hmright">
      <div class="hmhead">
        <div class="hmtitle">PERFORMANCE</div>
        <div class="cbtn" onclick="closeHM()">&#10005;</div>
      </div>
      <div id="hmbars"></div>
    </div>
  </div>
</div>

<!-- EDIT OVERLAY -->
<div class="ov" id="eov" onclick="closeEdit(event)">
  <div class="std-mod" onclick="event.stopPropagation()">
    <div class="mod-title">
      <span id="etitle-txt">Edit Player</span>
      <div class="cbtn" onclick="closeEdit()">&#10005;</div>
    </div>
    <input type="hidden" id="eu-id">
    <div class="fgrid">
      <div class="fg"><label class="flbl">Tier</label>
        <select class="finp" id="ep-tier"><option>Tier 1</option><option>Tier 2</option><option>Tier 3</option><option>Tier 4</option></select></div>
      <div class="fg"><label class="flbl">Nation</label><input class="finp" id="ep-nat" placeholder="ENG" maxlength="4"></div>
      <div class="fg"><label class="flbl">Value (M)</label><input class="finp" id="ep-val" type="number" min="0" step="0.1" placeholder="0.0"></div>
      <div class="fg"><label class="flbl">Goals</label><input class="finp" id="ep-gls" type="number" min="0" placeholder="0"></div>
      <div class="fg"><label class="flbl">Assists</label><input class="finp" id="ep-ast" type="number" min="0" placeholder="0"></div>
      <div class="fg full"><label class="flbl">Avatar URL</label><input class="finp" id="ep-ava" placeholder="https://..." maxlength="300"></div>
      <div class="fg"><label class="flbl">Position</label><input class="finp" id="ep-pos" placeholder="e.g. ST, CAM, GK" maxlength="20"></div>
      <div class="fg full"><label class="flbl">La Liga Team</label>
        <select class="finp" id="ep-team">
          <option value="">— No Team —</option>
          <option value="atleti">Atlético Madrid</option>
          <option value="barca">FC Barcelona</option>
          <option value="osasuna">CA Osasuna</option>
          <option value="girona">Girona FC</option>
          <option value="athletic">Athletic Bilbao</option>
          <option value="real">Real Madrid</option>
          <option value="betis">Real Betis</option>
          <option value="villar">Villarreal CF</option>
        </select>
      </div>
      <div class="fg full"><label class="flbl">Bio / Description</label><textarea class="finp" id="ep-bio" placeholder="Tell your story... achievements, playstyle, career highlights..." maxlength="300" rows="3" style="resize:vertical;min-height:70px;font-family:inherit;font-size:13px;"></textarea></div>
    </div>
    <div class="stats-label">Performance Stats</div>
    <div id="esliders"></div>
    <div class="mod-acts">
      <button class="fcancel" onclick="closeEdit()">Cancel</button>
      <button class="fsave" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- PROMOTE OVERLAY - dynamically filled -->
<div class="ov" id="pov" onclick="if(event.target===this)closePM()">
  <div class="std-mod" onclick="event.stopPropagation()">
    <div class="mod-title">
      <span id="pmod-title-txt">Promote to Player</span>
      <div class="cbtn" onclick="closePM()">&#10005;</div>
    </div>
    <div id="pmod-body"></div>
  </div>
</div>

<!-- MY PROFILE OVERLAY (fan + player: edit avatar & bio only) -->
<div class="ov" id="mpov" onclick="closeMPov(event)">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:420px;">
    <div class="mod-title">
      <span>My Profile</span>
      <div class="cbtn" onclick="closeMPov()">&#10005;</div>
    </div>
    <!-- Avatar preview -->
    <div style="display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:20px;">
      <div id="mp-ava-preview" style="width:80px;height:80px;border-radius:50%;overflow:hidden;background:var(--bg3);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;"></div>
      <span style="font-size:10px;color:var(--gray);letter-spacing:1px;font-family:'Barlow Condensed',sans-serif;">PROFILE PICTURE</span>
    </div>
    <div class="fgrid">
      <!-- Discord ID — auto-pulls avatar + username -->
      <div class="fg full" style="background:rgba(88,101,242,.08);border:1px solid rgba(88,101,242,.25);border-radius:10px;padding:12px;">
        <label class="flbl" style="color:#7289da;">Discord ID <span style="font-size:9px;color:var(--gray);font-weight:400;letter-spacing:0">(auto-syncs your avatar & username)</span></label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input class="finp" id="mp-discord" placeholder="Your 18-digit Discord ID e.g. 123456789012345678" maxlength="20" inputmode="numeric" style="flex:1;" oninput="this.value=this.value.replace(/\D/g,'')">
          <button onclick="previewDiscord()" style="background:rgba(88,101,242,.25);border:1px solid rgba(88,101,242,.5);color:#7289da;border-radius:8px;padding:8px 12px;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;white-space:nowrap;min-height:34px;">SYNC</button>
        </div>
        <div id="mp-discord-preview" style="margin-top:8px;display:none;align-items:center;gap:8px;padding:8px;background:rgba(88,101,242,.1);border-radius:8px;">
          <img id="mp-discord-ava" style="width:32px;height:32px;border-radius:50%;object-fit:cover;" src="" alt="">
          <div>
            <div id="mp-discord-name" style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;color:#7289da;"></div>
            <div style="font-size:10px;color:var(--gray);">Discord profile found</div>
          </div>
        </div>
        <div style="font-size:9px;color:var(--gray);margin-top:6px;line-height:1.5;">How to find your ID: Discord → Settings → Advanced → Enable Developer Mode → right-click your name → Copy User ID</div>
      </div>
      <!-- Username edit (admin only) -->
      <div class="fg full" id="mp-username-wrap">
        <label class="flbl">Username <span style="color:var(--gray2);font-weight:400;">— lowercase, numbers, underscore only</span></label>
        <input class="finp" id="mp-username" type="text" placeholder="your_username" maxlength="20" autocomplete="off"
          oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9_]/g,'').slice(0,20)">
        <div style="font-size:10px;color:var(--gray);margin-top:4px;">This is your display name across the site.</div>
      </div>
      <div class="fg full">
        <label class="flbl">Bio / Description</label>
        <textarea class="finp" id="mp-bio" placeholder="Tell your story... achievements, playstyle, career highlights..." maxlength="300" rows="4" style="resize:vertical;min-height:90px;font-family:inherit;font-size:13px;"></textarea>
        <div style="font-size:10px;color:var(--gray);margin-top:4px;text-align:right;"><span id="mp-bio-count">0</span>/300</div>
      </div>
    </div>
    <div class="mod-acts">
      <button class="fcancel" onclick="closeMPov()">Cancel</button>
      <button class="fsave" onclick="saveMyProfile()">Save Profile</button>
    </div>
  </div>
</div>

<!-- APPEALS MODAL -->
<div class="ov" id="appeal-ov" onclick="if(event.target===this)closeAppeal()">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:460px;">
    <div class="mod-title">
      <span>Submit Appeal</span>
      <div class="cbtn" onclick="closeAppeal()">&#10005;</div>
    </div>
    <div style="background:rgba(30,111,255,.07);border:1px solid rgba(30,111,255,.2);border-radius:10px;padding:14px;margin-bottom:16px;">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:1px;color:var(--blue3);margin-bottom:6px;">WHY SUBMIT AN APPEAL?</div>
      <div style="font-size:12px;color:var(--gray);line-height:1.6;">Your account is pending admin approval. Write a message to the admin explaining who you are. Admin will accept or reject it.</div>
    </div>
    <div class="fgrid">
      <div class="fg full">
        <label class="flbl">Your Discord Username <span style="color:var(--gray);font-size:9px;font-weight:400">(so admin can verify you)</span></label>
        <input class="finp" id="appeal-discord" placeholder="e.g. lysox or lysox#1234" maxlength="40">
      </div>
      <div class="fg full">
        <label class="flbl">Message to Admin</label>
        <textarea class="finp" id="appeal-msg" placeholder="Tell the admin who you are and why you want to join PHM..." maxlength="500" rows="5" style="resize:vertical;min-height:100px;font-family:inherit;font-size:13px;" oninput="document.getElementById('appeal-count').textContent=this.value.length"></textarea>
        <div style="font-size:10px;color:var(--gray);margin-top:4px;text-align:right;"><span id="appeal-count">0</span>/500</div>
      </div>
    </div>
    <div class="mod-acts">
      <button class="fcancel" onclick="closeAppeal()">Cancel</button>
      <button class="fsave" onclick="submitAppeal()">Send Appeal</button>
    </div>
  </div>
</div>

<!-- ADMIN APPEALS REVIEW MODAL -->
<div class="ov" id="appeals-admin-ov" onclick="if(event.target===this)closeAppealsAdmin()">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:600px;max-height:85vh;overflow-y:auto;">
    <div class="mod-title">
      <span>Pending Appeals</span>
      <div class="cbtn" onclick="closeAppealsAdmin()">&#10005;</div>
    </div>
    <div id="appeals-list" style="display:flex;flex-direction:column;gap:12px;padding-top:4px;"></div>
  </div>
</div>

<!-- AUTH OVERLAY -->
<div class="ov" id="aov" onclick="closeAov(event)">
  <div class="amod" onclick="event.stopPropagation()">
    <div class="acrest">
      <div class="auth-logo" id="auth-logo-circle">
        <img id="auth-img" alt="PHM" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:50%;">
      </div>
    </div>
    <div class="aerr2" id="aerr"></div>
    <div class="aok" id="aok"></div>
    <div id="abody"></div>
  </div>
</div>

<!-- APPEALS MODAL (admin only) -->
<div class="ov" id="appeals-ov" onclick="if(event.target===this)closeAppeals()">
  <div class="appeal-mod" onclick="event.stopPropagation()">
    <div class="mod-title" style="margin-bottom:16px;">
      <span>Pending Approvals</span>
      <div class="cbtn" onclick="closeAppeals()">&#10005;</div>
    </div>
    <div id="appeals-body"></div>
  </div>
</div>

<!-- SET FLAG MODAL (admin only) -->
<div class="ov" id="fc-ov" onclick="closeFCov(event)">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:380px;">
    <div class="mod-title">
      <span>Set Country Flag</span>
      <div class="cbtn" onclick="closeFCov()">&#10005;</div>
    </div>

    <div style="font-size:12px;color:var(--gray);margin-bottom:16px;">
      Setting flag for <strong style="color:var(--white);font-family:'Barlow Condensed',sans-serif;font-size:14px;letter-spacing:1px;" id="fc-username"></strong>
    </div>

    <input type="hidden" id="fc-uid">

    <div class="fg" style="margin-bottom:16px;">
      <label class="flbl">Country Code <span style="color:var(--gray2);font-weight:400;">— 2 or 3 letters</span></label>
      <input class="finp" id="fc-input" placeholder="e.g. IRQ · GBR · USA · SAU · FRA" maxlength="3" autocomplete="off"
        style="font-family:'Orbitron',monospace;font-size:16px;letter-spacing:4px;text-align:center;text-transform:uppercase;"
        oninput="this.value=this.value.toUpperCase().replace(/[^A-Z]/g,'');fcPreview()"
        onkeydown="if(event.key==='Enter')saveFlagCode()">
    </div>

    <!-- Live preview -->
    <div style="display:flex;align-items:center;gap:14px;background:var(--card);border:1px solid var(--border2);border-radius:12px;padding:14px 18px;margin-bottom:20px;">
      <div id="fc-flag" style="font-size:42px;line-height:1;flex-shrink:0;">—</div>
      <div id="fc-name" style="font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;letter-spacing:1px;color:var(--gray);">No flag set</div>
    </div>

    <!-- Quick picks -->
    <div style="margin-bottom:18px;">
      <div class="flbl" style="margin-bottom:8px;">Quick pick</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;" id="fc-quickpicks"></div>
    </div>

    <div class="mod-acts">
      <button class="fcancel" onclick="closeFCov()">Cancel</button>
      <button class="fsave" onclick="saveFlagCode()">Set Flag</button>
    </div>
  </div>
</div>

<!-- BAN / DELETE MODAL -->
<div class="ov" id="ban-ov" onclick="closeBanMod(event)">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:420px;">
    <div class="mod-title">
      <span id="ban-mod-title">Ban User</span>
      <div class="cbtn" onclick="closeBanMod()">&#10005;</div>
    </div>
    <input type="hidden" id="ban-uid">
    <input type="hidden" id="ban-mode">

    <!-- User display -->
    <div style="display:flex;align-items:center;gap:12px;background:var(--card);border:1px solid var(--border2);border-radius:10px;padding:12px 14px;margin-bottom:16px;">
      <div style="width:32px;height:32px;background:rgba(239,68,68,.1);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg></div>
      <div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;color:var(--white);letter-spacing:1px;" id="ban-username-display"></div>
        <div style="font-size:10px;color:var(--gray);letter-spacing:1px;margin-top:2px;">Action will take effect immediately</div>
      </div>
    </div>

    <!-- Reason -->
    <div class="fg" style="margin-bottom:12px;">
      <label class="flbl" id="ban-reason-label">Ban Reason</label>
      <textarea class="finp" id="ban-reason" placeholder="e.g. Cheating, toxic behaviour, impersonation..." maxlength="200" rows="3" style="resize:none;font-family:inherit;font-size:13px;"></textarea>
    </div>

    <!-- Duration section -->
    <div id="ban-dur-section">
      <label class="flbl">Ban Duration</label>

      <!-- Permanent toggle -->
      <div style="display:flex;align-items:center;gap:8px;margin:8px 0 10px;">
        <input type="checkbox" id="ban-permanent" onchange="togglePermanent()" style="width:15px;height:15px;accent-color:var(--red);cursor:pointer;">
        <label for="ban-permanent" style="font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;color:var(--gray);cursor:pointer;">Permanent Ban</label>
      </div>

      <!-- Duration picker -->
      <div id="ban-dur-row" style="display:flex;gap:8px;align-items:center;">
        <input type="number" class="finp" id="ban-dur-num" min="1" max="999" value="7" style="width:80px;text-align:center;font-family:'Orbitron',monospace;font-size:14px;">
        <select class="finp" id="ban-dur-type" style="flex:1;">
          <option value="days">Days</option>
          <option value="months">Months</option>
          <option value="years">Years</option>
        </select>
      </div>
    </div>

    <div class="mod-acts" style="margin-top:20px;">
      <button class="fcancel" onclick="closeBanMod()">Cancel</button>
      <button id="ban-save-btn" class="fsave" onclick="executeBanOrDelete()" style="background:#ef4444;box-shadow:0 0 14px rgba(239,68,68,.35);">BAN USER</button>
    </div>
  </div>
</div>

<!-- RESET DATABASE MODAL -->
<div class="ov" id="reset-ov" onclick="closeResetModal(event)">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:400px;">
    <div class="mod-title">
      <span style="color:#f87171;">Reset Database</span>
      <div class="cbtn" onclick="closeResetModal()">&#10005;</div>
    </div>

    <!-- Warning card -->
    <div style="background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);border-radius:12px;padding:16px 18px;margin-bottom:20px;">
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:800;color:#f87171;letter-spacing:1px;margin-bottom:8px;">THIS CANNOT BE UNDONE</div>
      <div style="font-size:12px;color:rgba(248,113,113,.8);line-height:1.7;">
        This will permanently delete:<br>
        <span style="color:#fca5a5;">— All user accounts</span><br>
        <span style="color:#fca5a5;">— All player profiles &amp; stats</span><br>
        <span style="color:#fca5a5;">— All bans &amp; IP records</span><br>
        <span style="color:#fca5a5;">— All sessions &amp; verifications</span>
      </div>
    </div>

    <!-- Confirmation input -->
    <div class="fg" style="margin-bottom:18px;">
      <label class="flbl" style="color:#f87171;">Type <strong style="color:#fca5a5;letter-spacing:2px;">RESET</strong> to confirm</label>
      <input class="finp" id="reset-confirm-input" type="text" placeholder="RESET" autocomplete="off"
        style="font-family:'Orbitron',monospace;font-size:14px;letter-spacing:4px;text-align:center;border-color:rgba(239,68,68,.3);"
        oninput="checkResetInput()">
    </div>

    <div class="mod-acts" style="margin-top:0;">
      <button class="fcancel" onclick="closeResetModal()">Cancel</button>
      <button id="reset-confirm-btn" onclick="executeReset()" disabled
        style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:9px 18px;border-radius:8px;cursor:not-allowed;background:rgba(239,68,68,.2);color:rgba(248,113,113,.4);border:1px solid rgba(239,68,68,.2);transition:all .3s;min-height:38px;">
        RESET ALL DATA
      </button>
    </div>
  </div>
</div>



  <span class="tico" id="tico"></span>
  <span id="tmsg"></span>
</div>

<script>
// ═══════════════════════════════════════════
// LOGO — paste your image URL here if you have one hosted
// If blank or fails, the built-in PHM shield logo shows instead
// ═══════════════════════════════════════════
const LOGO_SRC = 'https://i.imgur.com/kLM7xnX.png';

// Beautiful inline SVG shield logo — always works, no internet needed
const LOGO_SVG = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
  <defs>
    <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#1a3a6e"/>
      <stop offset="100%" stop-color="#0a1628"/>
    </linearGradient>
    <linearGradient id="sh" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#4d8fff"/>
      <stop offset="100%" stop-color="#1e6fff"/>
    </linearGradient>
    <linearGradient id="txt" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#ffffff"/>
      <stop offset="100%" stop-color="#c8d8ff"/>
    </linearGradient>
    <filter id="glow">
      <feGaussianBlur stdDeviation="3" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
  </defs>
  <circle cx="100" cy="100" r="100" fill="url(#bg)"/>
  <circle cx="100" cy="100" r="96" fill="none" stroke="#1e6fff" stroke-width="1" opacity="0.3"/>
  <path d="M100 28 L158 50 L158 98 C158 134 132 162 100 172 C68 162 42 134 42 98 L42 50 Z" fill="url(#sh)" opacity="0.15"/>
  <path d="M100 34 L152 54 L152 98 C152 130 128 156 100 165 C72 156 48 130 48 98 L48 54 Z" fill="none" stroke="url(#sh)" stroke-width="1.5" filter="url(#glow)"/>
  <path d="M100 44 L142 60 L142 98 C142 124 124 146 100 153 C76 146 58 124 58 98 L58 60 Z" fill="url(#sh)" opacity="0.08"/>
  <line x1="68" y1="84" x2="132" y2="84" stroke="#4d8fff" stroke-width="1" opacity="0.5"/>
  <text x="100" y="124" text-anchor="middle" font-family="Arial Black,Arial" font-weight="900" font-size="44" letter-spacing="3" fill="url(#txt)" filter="url(#glow)">PHM</text>
</svg>`)}`;

function applyLogo(src){
  ['splash-img','load-img','nav-img','auth-img'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.src = src;
  });
}

// Try logo URL with multiple extensions, fall back to SVG
(function loadLogo(){
  if(!LOGO_SRC){ applyLogo(LOGO_SVG); return; }
  const exts = ['', '.png', '.jpg'];
  const base = LOGO_SRC.replace(/\.(jpeg|jpg|png|gif|webp)$/i,'');
  let tried = 0;
  function tryNext(){
    if(tried >= exts.length){ applyLogo(LOGO_SVG); return; }
    const url = base + exts[tried++];
    const img = new Image();
    img.onload = () => applyLogo(url);
    img.onerror = tryNext;
    img.src = url + '?_=' + Date.now();
  }
  tryNext();
})();
// ═══════════════════════════════════════════
// EMAILJS CONFIGURATION
// ► Replace these 3 values with your own from emailjs.com (free account)
// ► Service ID: your email service (Gmail, Outlook, etc.)
// ► Template ID: create a template with variables {{to_email}}, {{username}}, {{code}}
// ► Public Key: from Account > API Keys
// ═══════════════════════════════════════════
const EJS_SERVICE  = 'service_d29kdjk';
const EJS_TEMPLATE = 'template_6048sbl';
const EJS_KEY      = 'angZ__SXPWAs4D9F5';


// ═══════════════════════════════════════════
// CONSTANTS & STORAGE
// ═══════════════════════════════════════════
const ADMIN = 'iysox';
const STATS = ['Shooting','Passing','Dribbling','Pace','Defending','Physical'];
const UK = 'phm_users_v8';
const SK = 'phm_sess_v8';
const VK = 'phm_verify_v8';
const IK = 'phm_ips_v8';
const BK = 'phm_bans_v8';
const TK = 'phm_teams_v9';
const CK = 'phm_chat_v1'; // chat messages
const MK = 'phm_discord_members'; // imported from bot: {discordId → {username,displayName,avatarHash,defaultIndex}}

// ── Discord Member List helpers ──
function lm(){ try{ return JSON.parse(localStorage.getItem(MK)||'{}'); }catch(e){ return {}; } }
function sm(data){ localStorage.setItem(MK, JSON.stringify(data)); }

// ── Discord Webhook ──
const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1453353025165856839/EApWgOh15ajQ5VnFMmybwB_6k8hssLsXWWFxsofdHeNPd6ka-aIyekJrdkjFlPCUlFn-';

const hp = s => btoa(unescape(encodeURIComponent(s + '::phm2025')));

// ═══════════════════════════════════════════
// GLOBAL DATABASE — JSONBin.io
// ► Single public bin holds ALL app data
// ► Zero setup · Free · Works from any device/browser
// ► 10,000 reads + writes per month free
// ═══════════════════════════════════════════

// ── YOUR BIN CONFIG — filled in automatically ──
// JBIN_ID: one public bin that stores the entire PHM database
// Get your own free at jsonbin.io → Create Bin → copy the ID
const JBIN_ID  = '69a423d6d0ea881f40e47d93';
const JBIN_KEY = '$2a$10$0asRlNQPIa4HPVPEc0sqxe4TqktrXW4NUI2jDrhiJg0k376qjUVVC';

const JBIN_URL = `https://api.jsonbin.io/v3/b/${JBIN_ID}`;

// In-memory cache — all data lives here after first load
const _cache = {};
let _dbLoaded = false;
let _pendingSave = null; // debounce writes

// ── Read entire DB from JSONBin ──
async function dbFetch(){
  try{
    const r = await Promise.race([
      fetch(`${JBIN_URL}/latest`, {
        headers: { 'X-Master-Key': JBIN_KEY, 'X-Bin-Meta': 'false' }
      }),
      new Promise((_,rej) => setTimeout(() => rej('timeout'), 8000))
    ]);
    if(!r.ok) return null;
    return await r.json();
  }catch(e){ return null; }
}

// ── Write entire DB to JSONBin (debounced 800ms) ──
function dbSave(){
  clearTimeout(_pendingSave);
  _pendingSave = setTimeout(async ()=>{
    try{
      const payload = {
        [UK]:  _cache[UK]  || [],
        [IK]:  _cache[IK]  || {},
        [BK]:  _cache[BK]  || {},
        [TK]:  _cache[TK]  || {},
        [AK]:  _cache[AK]  || [],
        [CK]:  _cache[CK]  || [],
        _saved: Date.now()
      };
      await fetch(JBIN_URL, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': JBIN_KEY
        },
        body: JSON.stringify(payload)
      });
    }catch(e){}
  }, 800);
}

// ── gGet / gSet / gDel — same API used throughout the app ──
async function gGet(key){
  return _cache[key] ?? null;
}
async function gSet(key, val){
  _cache[key] = val;
  dbSave();
}
async function gDel(key){
  delete _cache[key];
  dbSave();
}

// ── Sync wrappers ──
const lu  = () => { const v = _cache[UK]; return Array.isArray(v) ? v : []; };
const su  = a  => { _cache[UK]=a; dbSave(); };
const ls  = () => { try{return JSON.parse(sessionStorage.getItem(SK));}catch{return null;} };
const ss  = u  => { try{ if(u) sessionStorage.setItem(SK,JSON.stringify(u)); else sessionStorage.removeItem(SK); }catch(e){} };
const lv  = () => { try{return JSON.parse(localStorage.getItem(VK))||{};}catch{return{};} };
const sv  = v  => { try{localStorage.setItem(VK,JSON.stringify(v));}catch(e){} };
const li  = () => _cache[IK]  || {};
const si  = d  => { _cache[IK]=d; dbSave(); };
const lb  = () => _cache[BK]  || {};
const sb  = d  => { _cache[BK]=d; dbSave(); };
const lt  = () => _cache[TK]  || {};
const st  = d  => { _cache[TK]=d; dbSave(); };

// ── Bootstrap: load DB on startup ──
let _dataReady = false;
async function loadGlobalData(){
  if(_dataReady) return;
  const db = await dbFetch();
  if(db){
    _cache[UK] = Array.isArray(db[UK]) ? db[UK] : [];
    _cache[IK] = db[IK] && typeof db[IK]==='object' ? db[IK] : {};
    _cache[BK] = db[BK] && typeof db[BK]==='object' ? db[BK] : {};
    _cache[TK] = db[TK] && typeof db[TK]==='object' ? db[TK] : {};
    _cache[AK] = Array.isArray(db[AK]) ? db[AK] : [];
    _cache[CK] = Array.isArray(db[CK]) ? db[CK] : [];
  } else {
    _cache[UK] = JSON.parse(localStorage.getItem(UK)||'[]');
    _cache[IK] = JSON.parse(localStorage.getItem(IK)||'{}');
    _cache[BK] = JSON.parse(localStorage.getItem(BK)||'{}');
    _cache[TK] = JSON.parse(localStorage.getItem(TK)||'{}');
    _cache[AK] = JSON.parse(localStorage.getItem(AK)||'[]');
    _cache[CK] = JSON.parse(localStorage.getItem(CK)||'[]');
  }
  _dataReady = true;
}

// ── Poll every 20s — pulls latest data from JSONBin across all devices ──
async function pollGlobalData(){
  try{
    const db = await dbFetch();
    if(!db) return;
    const fresh = Array.isArray(db[UK]) ? db[UK] : [];
    _cache[UK] = fresh;
    if(db[BK]) _cache[BK] = db[BK];
    if(db[TK]) _cache[TK] = db[TK];
    if(Array.isArray(db[AK])) _cache[AK] = db[AK];
    if(Array.isArray(db[CK])) _cache[CK] = db[CK];
    // Check if pending user got approved
    const s=ls();
    if(s){
      const freshUser = fresh.find(x=>x.id===s.id);
      if(freshUser){
        const wasPending = s.role==='pending';
        const nowApproved = freshUser.role==='fan'||freshUser.role==='player'||freshUser.role==='admin';
        if(wasPending && nowApproved){
          // Update session and show notification
          ss(freshUser);
          renderNav(); refreshAll();
          showApprovalBanner(freshUser.username);
          return;
        }
        // Normal session sync
        ss(freshUser);
      }
    }
    syncSession();
    refreshAll();
    // Only append new chat messages — never full re-render (avoids flicker/scroll jump)
    if(document.getElementById('page-chat')?.classList.contains('on')){
      chatAppendNew();
    }
  }catch(e){}
}
setInterval(pollGlobalData, 20000);

// One-time local cleanup
(function oneTimeFreshStart(){
  const flag = 'phm_init_v8';
  if(!localStorage.getItem(flag)){
    Object.keys(localStorage)
      .filter(k => k.startsWith('phm_') && k !== flag && k !== SK && k !== VK)
      .forEach(k => localStorage.removeItem(k));
    localStorage.setItem(flag,'1');
  }
})();

// ═══════════════════════════════════════════
// DISCORD WEBHOOK LOGGER
// ═══════════════════════════════════════════
async function sendWebhook(embed){
  if(!DISCORD_WEBHOOK||DISCORD_WEBHOOK==='YOUR_DISCORD_WEBHOOK_URL_HERE') return;
  try{
    await fetch(DISCORD_WEBHOOK,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({embeds:[embed]})
    });
  }catch(e){ console.warn('Webhook failed',e); }
}

function fmtTime(ts){
  return new Date(ts).toLocaleString('en-GB',{dateStyle:'short',timeStyle:'medium'});
}

async function logNewAccount(user, rawPass, ipData){
  // Country detection — uses multiple reliable sources simultaneously
  const cc = (ipData.countryCode||ipData.country_code||'').toUpperCase().trim();
  const countryName = ipData.country||'Unknown';
  const flag = countryFlag(cc);
  // City & region for extra context (no IP shown)
  const location = [ipData.city,ipData.region,countryName].filter(Boolean).join(', ');
  await sendWebhook({
    title:'🆕 New Account Registered',
    color:0x1e6fff,
    description:`**${esc(user.username)}** just joined PHM`,
    fields:[
      {name:'👤 Username',   value:`\`${user.username}\``,        inline:true},
      {name:'🎭 Role',       value:`\`${user.role}\``,            inline:true},
      {name:'🕐 Time',       value:`\`${fmtTime(user.createdAt)}\``, inline:true},
      {name:`${flag||'🌍'} Country`, value:`\`${countryName}\` ${cc?'('+cc+')':''}`, inline:true},
      {name:'📍 Location',   value:`\`${location||'Unknown'}\``,  inline:true},
      {name:'📧 Email',      value:`\`${user.email}\``,           inline:true},
    ],
    footer:{text:'PHM Registration System'},
    timestamp: new Date().toISOString()
  });
}

async function logLogin(user, ipData){
  const cc = (ipData.countryCode||ipData.country_code||'').toUpperCase().trim();
  const flag = countryFlag(cc);
  const location = [ipData.city,ipData.region,ipData.country].filter(Boolean).join(', ');
  await sendWebhook({
    title:'🔐 User Login',
    color:0x10b981,
    fields:[
      {name:'👤 Username',   value:`\`${user.username}\``, inline:true},
      {name:'🎭 Role',       value:`\`${user.role}\``,     inline:true},
      {name:'🕐 Time',       value:`\`${fmtTime(Date.now())}\``, inline:true},
      {name:`${flag||'🌍'} Country`, value:`\`${ipData.country||'Unknown'}\` ${cc?'('+cc+')':''}`, inline:true},
      {name:'📍 Location',   value:`\`${location||'Unknown'}\``, inline:true},
    ],
    footer:{text:'PHM Security System'},
    timestamp:new Date().toISOString()
  });
}

async function logSecurityAlert(type, details, ipData){
  const cc = (ipData.countryCode||ipData.country_code||'').toUpperCase().trim();
  const flag = countryFlag(cc);
  const location = [ipData.city,ipData.region,ipData.country].filter(Boolean).join(', ');
  await sendWebhook({
    title:`🚨 SECURITY ALERT — ${type}`,
    color:0xef4444,
    fields:[
      {name:'⚠️ Event',     value:details, inline:false},
      {name:`${flag||'🌍'} Country`, value:`\`${ipData.country||'Unknown'}\` ${cc?'('+cc+')':''}`, inline:true},
      {name:'📍 Location',  value:`\`${location||'Unknown'}\``, inline:true},
      {name:'🕐 Time',      value:`\`${fmtTime(Date.now())}\``, inline:true},
    ],
    footer:{text:'PHM Security System — Automated Block'},
    timestamp:new Date().toISOString()
  });
}

// ═══════════════════════════════════════════
// IP INTELLIGENCE — parallel race, never cache Unknown
// ═══════════════════════════════════════════
const VPN_KEYWORDS = [
  'vpn','proxy','hosting','datacenter','data center','digital ocean','linode',
  'vultr','hetzner','ovh','amazon','google cloud','microsoft azure','cloudflare',
  'mullvad','nordvpn','expressvpn','surfshark','cyberghost','ipvanish','pia ',
  'private internet','hidemyass','tunnelbear','hotspot shield','windscribe',
  'astrill','purevpn','hide.me','protonvpn','torguard','ivpn','perfect privacy',
  'akamai','fastly','aws ','ec2','gce','azure','as13335','as14061','as16509',
];
function detectVPNFromOrg(org){
  if(!org) return false;
  return VPN_KEYWORDS.some(k => org.toLowerCase().includes(k));
}

// Fetch with a hard timeout so no API hangs forever
function fetchWithTimeout(url, ms=6000){
  return Promise.race([
    fetch(url),
    new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms))
  ]);
}

async function tryIPAPI(){
  const r = await fetchWithTimeout('https://ip-api.com/json/?fields=status,message,country,countryCode,regionName,city,isp,org,as,proxy,hosting,query');
  const d = await r.json();
  if(d.status!=='success'||!d.query) throw new Error('bad');
  return {
    ip:d.query, city:d.city, region:d.regionName, country:d.country,
    countryCode:d.countryCode, org:d.isp||d.org||'Unknown', as:d.as||'',
    vpn:d.proxy||d.hosting||detectVPNFromOrg(d.org)||detectVPNFromOrg(d.isp),
    proxy:d.proxy||false, tor:false,
  };
}
async function tryIPWho(){
  const r = await fetchWithTimeout('https://ipwho.is/');
  const d = await r.json();
  if(!d.success||!d.ip) throw new Error('bad');
  return {
    ip:d.ip, city:d.city, region:d.region, country:d.country,
    countryCode:d.country_code, org:d.connection?.isp||'Unknown', as:String(d.connection?.asn||''),
    vpn:d.security?.vpn||d.security?.proxy||d.security?.hosting||detectVPNFromOrg(d.connection?.isp),
    proxy:d.security?.proxy||false, tor:d.security?.tor||false,
  };
}
async function tryIPApiCo(){
  const r = await fetchWithTimeout('https://ipapi.co/json/');
  const d = await r.json();
  if(d.error||!d.ip) throw new Error('bad');
  return {
    ip:d.ip, city:d.city, region:d.region, country:d.country_name,
    countryCode:d.country_code, org:d.org||'Unknown', as:d.asn||'',
    vpn:detectVPNFromOrg(d.org)||detectVPNFromOrg(d.asn),
    proxy:false, tor:false,
  };
}
async function tryIPify(){
  // ipify gives plain IP, then we enrich with ip-api
  const r = await fetchWithTimeout('https://api.ipify.org?format=json');
  const d = await r.json();
  if(!d.ip) throw new Error('bad');
  const r2 = await fetchWithTimeout(`https://ip-api.com/json/${d.ip}?fields=status,country,countryCode,regionName,city,isp,org,as,proxy,hosting,query`);
  const d2 = await r2.json();
  if(d2.status!=='success') throw new Error('bad');
  return {
    ip:d.ip, city:d2.city, region:d2.regionName, country:d2.country,
    countryCode:d2.countryCode, org:d2.isp||d2.org||'Unknown', as:d2.as||'',
    vpn:d2.proxy||d2.hosting||detectVPNFromOrg(d2.org)||detectVPNFromOrg(d2.isp),
    proxy:d2.proxy||false, tor:false,
  };
}

// Race all APIs simultaneously — fastest valid response wins
async function getIPData(){
  // Wrap each so rejections don't crash Promise.any
  const apis = [tryIPAPI, tryIPWho, tryIPApiCo, tryIPify];
  try{
    const result = await Promise.any(apis.map(fn => fn()));
    return result;
  }catch(e){
    // All failed
    return {ip:'Unknown',city:'Unknown',region:'Unknown',country:'Unknown',countryCode:'',org:'Unknown',as:'',vpn:false,proxy:false,tor:false};
  }
}

// Cache IP per session — but NEVER cache Unknown (retry if last attempt failed)
let _cachedIP = null;
async function getIP(){
  if(_cachedIP && _cachedIP.ip !== 'Unknown') return _cachedIP;
  _cachedIP = await getIPData();
  return _cachedIP;
}

// Init EmailJS — keys are live
emailjs.init({ publicKey: EJS_KEY });

function getU(){ const s=ls(); if(!s)return null; return lu().find(x=>x.id===s.id)||null; }
const isAdmin = ()=>{ const u=getU(); return u&&u.role==='admin'; };

// ═══════════════════════════════════════════
// SCREENS
// ═══════════════════════════════════════════
function show(id){ document.getElementById(id).classList.add('active'); }
function hide(id){ document.getElementById(id).classList.remove('active'); }

function goLoad(){
  hide('splash'); show('loading');
  const lf = document.getElementById('lf');
  const lp = document.getElementById('lpct');
  lf.style.cssText='width:0%;transition:none;';
  let pct = 0;
  const interval = setInterval(()=>{
    pct = Math.min(pct + Math.random()*3 + 1, 92);
    if(lp) lp.textContent = Math.floor(pct) + '%';
  }, 40);
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    lf.style.cssText='width:95%;transition:width 2s ease;';
  }));
  // Load global shared data first, then show app
  loadGlobalData().then(()=>{
    clearInterval(interval);
    if(lp) lp.textContent = '100%';
    lf.style.cssText='width:100%;transition:width .3s ease;';
    setTimeout(()=>{ hide('loading'); show('app'); refreshAll(); renderNav(); }, 300);
  }).catch(()=>{
    clearInterval(interval);
    if(lp) lp.textContent = '100%';
    setTimeout(()=>{ hide('loading'); show('app'); refreshAll(); renderNav(); }, 300);
  });
}

// ═══════════════════════════════════════════
// PAGE NAV
// ═══════════════════════════════════════════
let stField='goals';

function goPage(name,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  const pg = document.getElementById('page-'+name);
  if(pg) pg.classList.add('on');
  document.querySelectorAll('.ntab').forEach(t=>t.classList.remove('on'));
  if(el) el.classList.add('on');
  else {
    document.querySelectorAll('.ntab').forEach(t=>{
      if(t.getAttribute('onclick')&&t.getAttribute('onclick').includes(`'${name}'`)) t.classList.add('on');
    });
  }
  if(name==='analytics') renderAnalytics();
  if(name==='members')   { renderMembers(); updateMemberSyncInfo(); }
  if(name==='teams')     renderTeams();
  if(name==='chat')      { ablyConnect(); renderChat(); }
}

// ═══════════════════════════════════════════
// NAV
// ═══════════════════════════════════════════
function renderNav(){
  const u = getU();
  document.getElementById('mtab').style.display = isAdmin()?'':'none';
  const nr = document.getElementById('nright');
  if(!u){
    nr.innerHTML=`<button class="bsmall boutline" onclick="openAuth('login')">Sign In</button><button class="bsmall bprimary" onclick="openAuth('register')">Register</button>`;
    return;
  }
  const rc = u.role==='admin'?'radmin':u.role==='player'?'rplayer':u.role==='pending'?'rpending':'rfan';
  const rl = u.role==='admin'?'Admin':u.role==='player'?'Player':u.role==='pending'?'Pending':'Fan';
  const verifiedBadge = u.emailVerified ? '' : `<span style="font-size:9px;color:#fbbf24;font-family:'Barlow Condensed',sans-serif;letter-spacing:1px;padding:1px 6px;border-radius:10px;background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.25)">Unverified</span>`;
  nr.innerHTML=`
    <div class="upill" onclick="tdd()" id="upill">
      <div class="uava">${avaC(u,24)}</div>
      <span class="uname">${userFlag(u)} ${esc(u.username)}</span>
      ${u.role==='admin'?`<span class="shield" title="Admin"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 11 14 15 10"/></svg></span>`:''}
      <span class="rbadge ${rc}">${rl}</span>
      <div class="dd" id="udd">
        ${isAdmin()?`<div class="ddi" style="color:#fbbf24;" onclick="openAppeals();tdd(false)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>Approve Requests ${lu().filter(x=>x.role==='pending').length>0?`<span class="pending-count-badge">${lu().filter(x=>x.role==='pending').length}</span>`:''}</div>`:''}
        ${isAdmin()?`<div class="ddi" onclick="goPage('members');tdd(false)"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Members</div>`:''}
        ${(u.role==='player'||u.role==='admin')?`<div class="ddi" onclick="openEditModal('${u.id}');tdd(false)"><svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>My Stats</div>`:''}
        <div class="ddi" onclick="openMyProfile();tdd(false)"><svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>My Profile</div>
        ${isAdmin()?`<div class="ddi red" onclick="openResetModal();tdd(false)" style="border-top:1px solid rgba(239,68,68,.15);"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>Reset Database</div>`:''}
        ${isAdmin()?`<div class="ddi" onclick="openRStatsModal();tdd(false)" style="color:#fbbf24;border-top:1px solid rgba(245,158,11,.1);"><svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>Reset All Stats</div>`:''}
        <div class="ddi red" onclick="doLogout()"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Sign Out</div>
      </div>
    </div>`;
}

function avaC(u,sz){
  // Priority: playerProfile avatar → Discord avatar → initial
  const av = u.playerProfile?.avatar || u.avatar;
  const discordAv = u.discordId
    ? `https://cdn.discordapp.com/avatars/${u.discordId}/avatar.png`
    : '';
  const defaultDiscord = u.discordId
    ? `https://cdn.discordapp.com/embed/avatars/${Number(BigInt(u.discordId)%6n)}.png`
    : '';
  const src = (av && av.startsWith('http')) ? av : (discordAv || '');
  const fallbackSrc = discordAv ? defaultDiscord : '';
  const initial = `<span style="font-family:'Barlow Condensed';font-size:${Math.floor(sz*.55)}px;font-weight:800">${u.username[0].toUpperCase()}</span>`;
  if(src){
    const fallback = fallbackSrc
      ? `this.onerror=null;this.src='${fallbackSrc}';`
      : `this.outerHTML='${initial}';`;
    return `<img src="${src}" onerror="${fallback}" style="width:${sz}px;height:${sz}px;border-radius:50%;object-fit:cover;">`;
  }
  return initial;
}

// ── Country code → flag emoji ──
function countryFlag(code){
  if(!code||code.length<2) return '';
  const c = code.toUpperCase().trim();
  // Convert ISO 3166-1 alpha-2 to flag emoji
  // Also support common 3-letter codes → map to 2-letter
  const map3={
    IRQ:'IQ',SAU:'SA',UAE:'AE',EGY:'EG',MAR:'MA',TUN:'TN',DZA:'DZ',LBY:'LY',
    LBN:'LB',SYR:'SY',JOR:'JO',PSE:'PS',YEM:'YE',OMN:'OM',KWT:'KW',BHR:'BH',
    QAT:'QA',GBR:'GB',USA:'US',FRA:'FR',DEU:'DE',ESP:'ES',ITA:'IT',PRT:'PT',
    NLD:'NL',BEL:'BE',CHE:'CH',AUT:'AT',SWE:'SE',NOR:'NO',DNK:'DK',FIN:'FI',
    POL:'PL',RUS:'RU',TUR:'TR',GRC:'GR',ROU:'RO',HRV:'HR',SRB:'RS',BRA:'BR',
    ARG:'AR',COL:'CO',CHL:'CL',MEX:'MX',PER:'PE',VEN:'VE',URY:'UY',PAR:'PY',
    NGA:'NG',GHA:'GH',SEN:'SN',CMR:'CM',CIV:'CI',ZAF:'ZA',KEN:'KE',ETH:'ET',
    TZA:'TZ',UGA:'UG',ZIM:'ZW',JPN:'JP',CHN:'CN',KOR:'KR',IND:'IN',PAK:'PK',
    BGD:'BD',THA:'TH',IDN:'ID',MYS:'MY',PHL:'PH',VNM:'VN',AUS:'AU',NZL:'NZ',
    CAN:'CA',MEX:'MX',AFG:'AF',IRN:'IR',KAZ:'KZ',UZB:'UZ',AZE:'AZ',ARM:'AM',
    GEO:'GE',UKR:'UA',CZE:'CZ',SVK:'SK',HUN:'HU',BGR:'BG',ALB:'AL',MKD:'MK',
  };
  const iso2 = c.length===3 ? (map3[c]||c.slice(0,2)) : c.slice(0,2);
  try{
    return iso2.split('').map(ch=>String.fromCodePoint(0x1F1E6+ch.charCodeAt(0)-65)).join('');
  }catch(e){ return ''; }
}

// ── Get flag for a user (checks countryCode field) ──
function userFlag(u){
  const code = u.countryCode||u.country||'';
  return countryFlag(code);
}

function tdd(v){
  const d=document.getElementById('udd'); if(!d)return;
  if(v===false) d.classList.remove('open');
  else d.classList.toggle('open');
}
document.addEventListener('click',e=>{
  const p=document.getElementById('upill'),d=document.getElementById('udd');
  if(d&&p&&!p.contains(e.target)) d.classList.remove('open');
});
function doLogout(){ ss(null); tdd(false); renderNav(); refreshAll(); toast('Signed out.','ok'); }

// ═══════════════════════════════════════════
// MY PROFILE (fan + player: avatar & bio only)
// ═══════════════════════════════════════════
function openMyProfile(){
  const u=getU(); if(!u){ toast('Please sign in first.','er'); return; }
  const pp=u.playerProfile||{};
  const bio = pp.bio||u.bio||'';
  document.getElementById('mp-username').value = u.username||'';
  document.getElementById('mp-username-wrap').style.display = isAdmin() ? '' : 'none';
  document.getElementById('mp-discord').value = u.discordId||'';
  document.getElementById('mp-bio').value = bio;
  document.getElementById('mp-bio-count').textContent = bio.length;
  // Show discord preview if ID exists
  if(u.discordId){
    const prev = document.getElementById('mp-discord-preview');
    const avaEl = document.getElementById('mp-discord-ava');
    const nameEl = document.getElementById('mp-discord-name');
    const idx2 = Number(BigInt(u.discordId) % 6n);
    avaEl.src = `https://cdn.discordapp.com/avatars/${u.discordId}/avatar.png`;
    avaEl.onerror = () => { avaEl.src = `https://cdn.discordapp.com/embed/avatars/${idx2}.png`; };
    nameEl.textContent = `ID: ${u.discordId}`;
    prev.style.display = 'flex';
  }
  previewMPAva();
  document.getElementById('mpov').classList.add('open');
  document.getElementById('mp-bio').oninput=function(){
    document.getElementById('mp-bio-count').textContent=this.value.length;
  };
}

function saveMyProfile(){
  const u=getU(); if(!u) return;
  const newName = isAdmin()
    ? (document.getElementById('mp-username')?.value||'').trim().toLowerCase().replace(/[^a-z0-9_]/g,'').slice(0,20)
    : u.username;
  if(!newName){ toast('Username cannot be empty.','er'); return; }
  if(isAdmin()){
    const taken = lu().find(x=>x.id!==u.id && x.username===newName);
    if(taken){ toast('That username is already taken.','er'); return; }
  }
  const users=lu();
  const discordId = (document.getElementById('mp-discord')?.value||'').trim().replace(/\D/g,'');
  const bio = document.getElementById('mp-bio').value.trim();
  if(discordId && !/^\d{17,20}$/.test(discordId)){ toast('Discord ID must be 17–20 digits.','er'); return; }
  const idx=users.findIndex(x=>x.id===u.id); if(idx<0) return;
  users[idx].username = newName;
  users[idx].displayName = newName;
  users[idx].discordId = discordId || '';
  if(discordId){
    users[idx].discordAvatar = `https://cdn.discordapp.com/avatars/${discordId}/avatar.png`;
  } else {
    users[idx].discordAvatar = '';
  }
  if(users[idx].playerProfile){
    users[idx].playerProfile.bio = bio;
  } else {
    users[idx].playerProfile = { bio };
  }
  users[idx].bio = bio;
  su(users); ss(users[idx]);
  closeMPov(); renderNav(); refreshAll();
  toast('Profile updated','ok');
}
function closeMPov(e){ if(!e||e.target===document.getElementById('mpov')) document.getElementById('mpov').classList.remove('open'); }
function previewMPAva(){
  const prev=document.getElementById('mp-ava-preview');
  const u=getU();
  const discordId=u?.discordId;
  if(discordId){
    const idx2=Number(BigInt(discordId)%6n);
    prev.innerHTML=`<img src="https://cdn.discordapp.com/avatars/${discordId}/avatar.png" onerror="this.src='https://cdn.discordapp.com/embed/avatars/${idx2}.png'" style="width:100%;height:100%;object-fit:cover;">`;
  } else {
    prev.innerHTML=`<span style="font-size:28px;font-family:'Barlow Condensed',sans-serif;font-weight:800">${u?u.username[0].toUpperCase():'?'}</span>`;
  }
}

// ═══════════════════════════════════════════
// TIERSHEET
// ═══════════════════════════════════════════
let filtered=[];

function updateSeasonBadge(){
  const el=document.getElementById('season-badge'); if(!el)return;
  const now=new Date();
  const month=now.toLocaleString('en-GB',{month:'long'});
  const year=now.getFullYear();
  el.textContent=`Season ${month} ${year}`;
}

function refreshAll(){ updateSeasonBadge(); doFilter(); updateNatFilter(); renderAnalytics(); renderFanArea(); if(document.getElementById('page-teams')?.classList.contains('on')) renderTeams(); }

function renderFanArea(){
  const u=getU(), fa=document.getElementById('fan-area'); if(!fa)return;
  if(u && u.role==='pending'){
    const existingAppeal = la().find(a=>a.userId===u.id);
    const appealStatus = existingAppeal
      ? existingAppeal.status==='pending'
        ? `<span style="font-size:10px;color:#fbbf24;font-family:'Barlow Condensed';letter-spacing:1px;">Appeal submitted — pending review</span>`
        : existingAppeal.status==='rejected'
        ? `<span style="font-size:10px;color:#f87171;font-family:'Barlow Condensed';letter-spacing:1px;">Appeal rejected — you may resubmit</span>`
        : ''
      : '';
    const canAppeal = !existingAppeal || existingAppeal.status==='rejected';
    fa.innerHTML=`<div class="pending-banner" style="margin:14px 20px 4px;">
      <div class="pending-banner-ico"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
      <div class="pending-banner-txt" style="flex:1;">
        <h3>⏳ Account Pending Approval</h3>
        <p>Your account is waiting for admin review. You'll get full access once approved.<br>${appealStatus}</p>
        ${canAppeal ? `<button onclick="openAppeal()" style="margin-top:10px;background:rgba(30,111,255,.15);border:1px solid rgba(30,111,255,.4);color:var(--blue3);border-radius:8px;padding:8px 18px;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;min-height:34px;">SEND APPEAL</button>` : ''}
      </div>
    </div>`;
  } else if(u && u.role==='fan'){
    fa.innerHTML=`<div class="fan-banner">
      <div class="fan-banner-ico"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
      <div class="fan-banner-txt">
        <h3>Fan Account</h3>
        <p>You are registered as a Fan. An admin can promote you to Player.</p>
      </div>
    </div>`;
  } else { fa.innerHTML=''; }
}



function doFilter(){
  const q=(document.getElementById('srch')?.value||'').toLowerCase();
  const t=document.getElementById('f-tier')?.value||'';
  const n=document.getElementById('f-nation')?.value||'';
  const all=lu().filter(u=>u.role==='player'||u.role==='admin');
  filtered=all.filter(u=>{
    const pp=u.playerProfile||{};
    if(q&&!u.username.toLowerCase().includes(q))return false;
    if(t&&(pp.tier||'Tier 4')!==t)return false;
    if(n&&(pp.nation||'')!==n)return false;
    return true;
  });
  renderTiers();
  const allP=lu().filter(u=>u.role==='player'||u.role==='admin');
  document.getElementById('st-p').textContent=allP.length;
  document.getElementById('st-s').textContent=filtered.length;
  document.getElementById('st-g').textContent=allP.reduce((s,u)=>s+(+(u.playerProfile?.goals)||0),0);
  document.getElementById('st-m').textContent=lu().length;
}

function updateNatFilter(){
  const s=document.getElementById('f-nation'); if(!s)return;
  const cur=s.value;
  const ns=[...new Set(lu().filter(u=>u.role==='player'||u.role==='admin').map(u=>u.playerProfile?.nation).filter(Boolean))].sort();
  s.innerHTML='<option value="">All Nations</option>'+ns.map(n=>`<option>${n}</option>`).join('');
  s.value=cur;
}

function renderTiers(){
  const tiers=['Tier 1','Tier 2','Tier 3','Tier 4'];
  const adm=isAdmin();
  let html='';
  tiers.forEach(t=>{
    const ps=filtered.filter(u=>(u.playerProfile?.tier||'Tier 4')===t);
    if(!ps.length)return;
    const c=tcls(t);
    html+=`<div class="tsec">
      <div class="thead">
        <span class="tpill ${c}p">${t}</span>
        <span class="tcnt">${ps.length} player${ps.length!==1?'s':''}</span>
        <div class="tdiv"></div>
      </div>
      <div class="pgrid">${ps.map(u=>pcHTML(u,c,adm)).join('')}</div>
    </div>`;
  });
  if(!html) html=`<div class="empty"><div class="eico"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4m0 4h.01"/></svg></div><h3>No Players Yet</h3><p>Register an account —<br>admin can promote members to Player.</p></div>`;
  document.getElementById('twrap').innerHTML=html;
}

function tcls(t){return t==='Tier 1'?'t1':t==='Tier 2'?'t2':t==='Tier 3'?'t3':'t4';}
function tcol(t){return t==='Tier 1'?'#60a5fa':t==='Tier 2'?'#a78bfa':t==='Tier 3'?'#34d399':'#fbbf24';}

function pcHTML(u,c,adm){
  const pp=u.playerProfile||{}, avg=calcAvg(pp);
  const nat=pp.nation?`<div class="pc-nat">${esc(pp.nation)}</div>`:'';
  const pos=pp.position?`<div class="pc-pos">${esc(pp.position)}</div>`:'';
  const team = pp.team ? LALIGA_TEAMS?.find(t=>t.id===pp.team) : null;
  const teamPill = team
    ? `<div class="team-pill"><img src="${team.logo}" alt="${team.short}" onerror="this.style.display='none'">${team.short}</div>` : '';
  const editBtn = adm
    ? `<div style="display:flex;gap:5px;margin-top:4px;position:relative;z-index:2;" onclick="event.stopPropagation()">
        <button class="pc-edit-btn vis" style="flex:1;" onclick="openEditModal('${u.id}')">Edit Stats</button>
        <button class="pc-edit-btn vis" style="background:rgba(239,68,68,.15);color:#f87171;border-color:rgba(239,68,68,.35);width:auto;padding:7px 10px;" onclick="confirmDeleteUser('${u.id}','${esc(u.username)}')">Del</button>
      </div>`
    : '';
  // FIFA-style mini attribute badges
  const miniStats = `<div class="pc-stats-row">
    ${STATS.map(s=>{
      const v=+(pp[s.toLowerCase()])||60;
      const color = v>=85?'#34d399':v>=70?'#60a5fa':v>=55?'#fbbf24':'#f87171';
      return `<div class="pc-stat"><div class="pc-stat-n" style="color:${color}">${v}</div><div class="pc-stat-l">${s.slice(0,3)}</div></div>`;
    }).join('')}
  </div>`;
  return `<div class="pc" onclick="openPlayerDetail('${u.id}')" style="position:relative;">
    ${nat}
    <div class="pc-ava">${aiHTML(pp,u,52)}</div>
    <div class="pc-name">${userFlag(u)} ${esc(u.username)}</div>
    ${teamPill}
    <div class="pc-tier ${c}c">${pp.tier||'Tier 4'}</div>
    ${pos}
    <div class="pc-rat">${avg}</div>
    <div class="pc-val">${(+(pp.value)||0).toFixed(1)}M · ${pp.goals||0}G ${pp.assists||0}A</div>
    ${miniStats}
    ${editBtn}
  </div>`;
}

function aiHTML(pp,u,sz){
  const av=pp?.avatar;
  if(av&&av.startsWith('http')) return `<img src="${av}" style="width:100%;height:100%;object-fit:cover" onerror="this.outerHTML='<span style=font-family:Barlow+Condensed,sans-serif;font-size:${Math.floor(sz*.5)}px;font-weight:800>${u.username[0].toUpperCase()}</span>'">`;
  return `<span style="font-family:'Barlow Condensed',sans-serif;font-size:${Math.floor(sz*.5)}px;font-weight:800">${u.username[0].toUpperCase()}</span>`;
}

function calcAvg(pp){
  const vs=STATS.map(s=>+(pp[s.toLowerCase()])||60);
  return Math.round(vs.reduce((a,b)=>a+b,0)/vs.length);
}

// ═══════════════════════════════════════════
// ANALYTICS
// ═══════════════════════════════════════════
function renderAnalytics(){
  const pl=lu().filter(u=>u.role==='player'||u.role==='admin');
  const cnt={};
  pl.forEach(u=>{const n=u.playerProfile?.nation;if(n)cnt[n]=(cnt[n]||0)+1;});
  const top=Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const mx=top[0]?.[1]||1;
  const nb=document.getElementById('nbars'); if(!nb)return;
  nb.innerHTML=top.map(([n,c])=>`<div class="nbw"><div class="nb" style="height:${Math.round((c/mx)*100)}px"><span class="nbnum">${c}</span></div><div class="nblbl">${n}</div></div>`).join('')||`<p style="color:var(--gray);font-size:12px;align-self:center">No data yet.</p>`;
  renderSL(pl); renderMVP(pl);
}

function renderSL(pl){
  const sorted=[...pl].sort((a,b)=>(+(b.playerProfile?.[stField])||0)-(+(a.playerProfile?.[stField])||0)).slice(0,5);
  const rc=i=>i===0?'g':i===1?'s':i===2?'b':'';
  const sl=document.getElementById('slist'); if(!sl)return;
  sl.innerHTML=sorted.map((u,i)=>`<li class="srow2" onclick="openPlayerDetail('${u.id}')" style="cursor:pointer;">
    <span class="srnk ${rc(i)}">${i+1}</span>
    <div class="sava">${aiHTML(u.playerProfile||{},u,26)}</div>
    <span class="snm">${esc(u.username)}</span>
    <span class="sv">${u.playerProfile?.[stField]||0}</span>
  </li>`).join('')||`<li style="color:var(--gray);font-size:12px;padding:14px 0">No players yet.</li>`;
}

function setST(f,el){
  stField=f;
  document.querySelectorAll('.stab').forEach(t=>t.classList.remove('on'));
  if(el)el.classList.add('on');
  renderSL(lu().filter(u=>u.role==='player'||u.role==='admin'));
}

function renderMVP(pl){
  const top=[...pl].sort((a,b)=>(+(b.playerProfile?.value)||0)-(+(a.playerProfile?.value)||0)).slice(0,6);
  const mvpr=document.getElementById('mvpr'); if(!mvpr)return;
  mvpr.innerHTML=top.map(u=>{
    const pp=u.playerProfile||{}, c=tcls(pp.tier||'Tier 4');
    return `<div class="mvpc" onclick="openPlayerDetail('${u.id}')">
      <div class="mvpava">${aiHTML(pp,u,40)}</div>
      <div class="mvpnm">${esc(u.username)}</div>
      <div class="mvptier ${c}c">${pp.tier||'Tier 4'}</div>
      <div class="mvpval">${(+(pp.value)||0).toFixed(1)}M</div>
    </div>`;
  }).join('')||`<p style="color:var(--gray);font-size:12px">No players yet.</p>`;
}

// ═══════════════════════════════════════════
// HEATMAP
// ═══════════════════════════════════════════
function openHM(uid){
  const u=lu().find(x=>x.id===uid); if(!u)return;
  const pp=u.playerProfile||{}, avg=calcAvg(pp), c=tcls(pp.tier||'Tier 4');
  document.getElementById('hmava').innerHTML=aiHTML(pp,u,70);
  document.getElementById('hmname').textContent=`${userFlag(u)} ${u.username}`;
  const ht=document.getElementById('hmtier'); ht.className=`hmtier ${c}c`; ht.textContent=pp.tier||'Tier 4';
  const hp2=document.getElementById('hmpos');
  if(pp.position){ hp2.textContent=pp.position; hp2.style.display='inline-block'; }
  else { hp2.style.display='none'; }
  document.getElementById('hmrat').textContent=avg;
  // Team line
  const team = pp.team ? LALIGA_TEAMS?.find(t=>t.id===pp.team) : null;
  const teamLine = document.getElementById('hmteam');
  if(teamLine){
    if(team){
      teamLine.innerHTML=`<img src="${team.logo}" alt="${team.name}" style="width:18px;height:18px;object-fit:contain;vertical-align:middle;margin-right:5px;" onerror="this.style.display='none'">${team.name}`;
      teamLine.style.display='flex';
    } else { teamLine.style.display='none'; }
  }
  document.getElementById('hmval').textContent=`${(+(pp.value)||0).toFixed(1)}M · ${pp.goals||0}G ${pp.assists||0}A`;
  const hb=document.getElementById('hmbio');
  if(pp.bio){ hb.textContent=`"${pp.bio}"`; hb.style.display='block'; }
  else { hb.style.display='none'; }
  document.getElementById('hmbars').innerHTML=STATS.map(s=>{
    const v=+(pp[s.toLowerCase()])||60;
    return `<div class="hrow"><div class="hlbl">${s}</div><div class="htrack"><div class="hfill" style="width:${v}%"></div></div><div class="hv">${v}</div></div>`;
  }).join('');
  document.getElementById('hov').classList.add('open');
}
function closeHM(e){if(!e||e.target===document.getElementById('hov'))document.getElementById('hov').classList.remove('open');}

// ═══════════════════════════════════════════
// PLAYER DETAIL MODAL (FIFA-style)
// ═══════════════════════════════════════════
function openPlayerDetail(uid){
  const u=lu().find(x=>x.id===uid); if(!u)return;
  const pp=u.playerProfile||{}, avg=calcAvg(pp), c=tcls(pp.tier||'Tier 4');
  const tierColor=tcol(pp.tier||'Tier 4');
  const team=pp.team?LALIGA_TEAMS?.find(t=>t.id===pp.team):null;

  // Banner color
  document.getElementById('pdet-banner').style.background=tierColor;
  // Avatar
  document.getElementById('pdet-ava').innerHTML=aiHTML(pp,u,86);
  // Name
  document.getElementById('pdet-name').innerHTML=`${userFlag(u)} ${esc(u.username)}`;
  // OVR
  document.getElementById('pdet-ovr').textContent=avg;
  document.getElementById('pdet-ovr').style.color=tierColor;
  // Meta tags
  const metaParts=[];
  if(pp.tier) metaParts.push(`<span class="rbadge ${c}p" style="font-size:9px;">${pp.tier}</span>`);
  if(pp.position) metaParts.push(`<span class="pc-pos" style="margin:0;">${esc(pp.position)}</span>`);
  if(pp.nation) metaParts.push(`<span style="font-family:'Barlow Condensed';font-size:10px;font-weight:700;color:var(--gray);">${countryFlag(pp.nation)} ${pp.nation}</span>`);
  if(team) metaParts.push(`<span class="team-pill"><img src="${team.logo}" alt="${team.short}" style="width:12px;height:12px;object-fit:contain;" onerror="this.style.display='none'">${team.name}</span>`);
  document.getElementById('pdet-meta').innerHTML=metaParts.join('');
  // Short bio in header
  const bioShort=document.getElementById('pdet-bio-short');
  bioShort.textContent=pp.bio?`"${pp.bio}"`:'';;

  // KV stats grid
  const goals=pp.goals||0, assists=pp.assists||0, value=(+(pp.value)||0).toFixed(1);
  const cs = pp.cleanSheets||0, mvps=pp.mvpCount||0;
  const kvData=[
    ['Goals',goals,'big'],['Assists',assists,'big'],
    ['Value',`${value}M`,''],['MVPs',mvps,''],
    ['Clean Sheets',cs,''],['Overall',avg,'big'],
  ];
  document.getElementById('pdet-kvgrid').innerHTML=kvData.map(([l,v,cls])=>
    `<div class="pdet-kv"><div class="pdet-kv-label">${l}</div><div class="pdet-kv-val ${cls}" style="${cls==='big'?'color:'+tierColor:''}">${v}</div></div>`
  ).join('');

  // FIFA attrs with color-coded bars
  function attrColor(v){ return v>=85?'#34d399':v>=70?'#60a5fa':v>=55?'#fbbf24':'#f87171'; }
  document.getElementById('pdet-attrs').innerHTML=STATS.map(s=>{
    const v=+(pp[s.toLowerCase()])||60;
    const col=attrColor(v);
    return `<div class="fifa-attr">
      <div class="fifa-attr-lbl">${s}</div>
      <div class="fifa-attr-bar"><div class="fifa-attr-fill" style="width:${v}%;background:linear-gradient(90deg,${col}99,${col});box-shadow:0 0 4px ${col}66;"></div></div>
      <div class="fifa-attr-val" style="color:${col}">${v}</div>
    </div>`;
  }).join('');

  // Full bio section
  const bioWrap=document.getElementById('pdet-bio-wrap');
  const bioFull=document.getElementById('pdet-bio-full');
  if(pp.bio&&pp.bio.trim()){
    bioFull.textContent=pp.bio;
    bioWrap.style.display='';
    bioShort.style.display='none';
  } else {
    bioWrap.style.display='none';
    bioShort.style.display='';
  }

  // Admin actions
  const adminActs=document.getElementById('pdet-admin-acts');
  if(isAdmin()){
    adminActs.style.display='flex';
    adminActs.innerHTML=`
      <button class="abtn aedit" onclick="closePDet();setTimeout(()=>openEditModal('${u.id}'),100)">Edit Stats</button>
      <button class="abtn atier" onclick="rotateTier('${u.id}');closePDet();">Rotate Tier</button>
      <button class="abtn ademote" onclick="closePDet();confirmDeleteUser('${u.id}','${esc(u.username)}')">Delete</button>`;
  } else {
    adminActs.style.display='none';
  }

  document.getElementById('pdet-ov').classList.add('open');
}
function closePDet(e){if(!e||e.target===document.getElementById('pdet-ov'))document.getElementById('pdet-ov').classList.remove('open');}

// ═══════════════════════════════════════════
// RESET STATS (goals, assists, attributes)
// ═══════════════════════════════════════════
function openRStatsModal(){
  if(!isAdmin()){toast('No permission.','er');return;}
  document.getElementById('rstats-confirm-input').value='';
  checkRStatsInput();
  document.getElementById('rstats-ov').classList.add('open');
}
function closeRStatsModal(e){
  if(!e||e.target===document.getElementById('rstats-ov'))
    document.getElementById('rstats-ov').classList.remove('open');
}
function checkRStatsInput(){
  const val=document.getElementById('rstats-confirm-input').value.trim();
  const btn=document.getElementById('rstats-confirm-btn');
  const ok=val==='RESET';
  btn.disabled=!ok;
  btn.style.cursor=ok?'pointer':'not-allowed';
  btn.style.background=ok?'#f59e0b':'rgba(245,158,11,.2)';
  btn.style.color=ok?'#000':'rgba(251,191,36,.4)';
  btn.style.border=ok?'none':'1px solid rgba(245,158,11,.2)';
  btn.style.boxShadow=ok?'0 0 20px rgba(245,158,11,.3)':'none';
}
function executeResetStats(){
  if(!isAdmin()) return;
  if(document.getElementById('rstats-confirm-input').value.trim()!=='RESET') return;
  const users=lu();
  const admin=getU();
  users.forEach(u=>{
    if(u.playerProfile){
      u.playerProfile.goals=0;
      u.playerProfile.assists=0;
      u.playerProfile.cleanSheets=0;
      u.playerProfile.mvpCount=0;
      STATS.forEach(s=>{ u.playerProfile[s.toLowerCase()]=60; });
      u.playerProfile.lastEditedAt=Date.now();
      u.playerProfile.lastEditedBy=admin?.username||'admin';
    }
  });
  su(users);
  closeRStatsModal();
  refreshAll();
  toast('All player stats have been reset.','ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:'Stats Reset',
      color:0xf59e0b,
      fields:[
        {name:'By Admin',value:`\`${admin?.username||'admin'}\``,inline:true},
        {name:'Affected',value:`${users.filter(u=>u.playerProfile).length} players`,inline:true},
        
        {name:'Time',value:`\`${fmtTime(Date.now())}\``,inline:true},
      ],
      footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
    });
  });
}

// ═══════════════════════════════════════════
// EDIT PROFILE
// ═══════════════════════════════════════════
function openEditModal(uid){
  if(!isAdmin()&&getU()?.id!==uid){toast('No permission.','er');return;}
  const users=lu();
  const u=users.find(x=>x.id===uid); if(!u)return;
  // Init playerProfile for admin if it doesn't exist yet
  if(!u.playerProfile){
    u.playerProfile={tier:'Tier 1',nation:'',value:0,goals:0,assists:0,avatar:'',position:'',bio:'',shooting:99,passing:99,dribbling:99,pace:99,defending:99,physical:99};
    su(users); ss(u);
  }
  const pp=u.playerProfile||{};
  document.getElementById('etitle-txt').textContent=`Edit: ${u.username}`;
  document.getElementById('eu-id').value=uid;
  document.getElementById('ep-tier').value=pp.tier||'Tier 4';
  document.getElementById('ep-nat').value=pp.nation||'';
  document.getElementById('ep-val').value=pp.value||0;
  document.getElementById('ep-gls').value=pp.goals||0;
  document.getElementById('ep-ast').value=pp.assists||0;
  document.getElementById('ep-ava').value=pp.avatar||'';
  document.getElementById('ep-pos').value=pp.position||'';
  document.getElementById('ep-bio').value=pp.bio||'';
  document.getElementById('ep-team').value=pp.team||'';
  document.getElementById('esliders').innerHTML=buildSliders(pp,'sl');
  document.getElementById('eov').classList.add('open');
}
function closeEdit(e){if(!e||e.target===document.getElementById('eov'))document.getElementById('eov').classList.remove('open');}
function saveEdit(){
  const uid=document.getElementById('eu-id').value;
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0)return;
  const admin=getU();
  users[idx].playerProfile={
    ...(users[idx].playerProfile||{}),
    ...readFields('ep','sl'),
    lastEditedAt: Date.now(),
    lastEditedBy: admin?.username||'admin'
  };
  su(users);
  const cu=getU(); if(cu&&cu.id===uid) ss(users[idx]);
  closeEdit(); refreshAll(); toast('Profile saved!','ok');
}

function buildSliders(pp,pfx){
  return STATS.map(s=>{
    const k=s.toLowerCase(), v=+(pp[k])||60;
    return `<div class="fg" style="margin-bottom:9px"><label class="flbl">${s}</label>
      <div class="rrow"><input type="range" min="0" max="100" value="${v}" id="${pfx}-${k}" oninput="document.getElementById('rv-${pfx}-${k}').textContent=this.value">
      <span class="rv" id="rv-${pfx}-${k}">${v}</span></div></div>`;
  }).join('');
}
function readFields(fp,sp){
  return{
    tier:document.getElementById(`${fp}-tier`).value,
    nation:document.getElementById(`${fp}-nat`).value.toUpperCase().trim(),
    value:parseFloat(document.getElementById(`${fp}-val`).value)||0,
    goals:parseInt(document.getElementById(`${fp}-gls`).value)||0,
    assists:parseInt(document.getElementById(`${fp}-ast`).value)||0,
    avatar:document.getElementById(`${fp}-ava`).value.trim(),
    position:document.getElementById(`${fp}-pos`)?.value.trim()||'',
    bio:document.getElementById(`${fp}-bio`)?.value.trim()||'',
    team:document.getElementById(`${fp}-team`)?.value||'',
    ...Object.fromEntries(STATS.map(s=>[s.toLowerCase(),parseInt(document.getElementById(`${sp}-${s.toLowerCase()}`).value)||60]))
  };
}

// ═══════════════════════════════════════════
// PROMOTE TO PLAYER
// ═══════════════════════════════════════════
function openPromoteModal(userId){
  if(!isAdmin()){toast('No permission.','er');return;}
  const u=lu().find(x=>x.id===userId);
  if(!u){toast('User not found.','er');return;}

  document.getElementById('pmod-title-txt').textContent=`Promote: ${u.username}`;

  const teamOpts = (LALIGA_TEAMS||[]).map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
  const sliders = buildSliders({},'ps');

  document.getElementById('pmod-body').innerHTML=`
    <div style="font-size:12px;color:var(--gray);margin-bottom:16px;">Add <strong style="color:var(--white)">${esc(u.username)}</strong> to the tiersheet as a Player.</div>
    <input type="hidden" id="pu-id" value="${userId}">
    <div class="fgrid">
      <div class="fg"><label class="flbl">Tier</label>
        <select class="finp" id="pp-tier">
          <option>Tier 1</option><option>Tier 2</option><option>Tier 3</option><option selected>Tier 4</option>
        </select></div>
      <div class="fg"><label class="flbl">Nation</label><input class="finp" id="pp-nat" placeholder="ENG" maxlength="4"></div>
      <div class="fg"><label class="flbl">Value (M)</label><input class="finp" id="pp-val" type="number" min="0" step="0.1" placeholder="0.0"></div>
      <div class="fg"><label class="flbl">Goals</label><input class="finp" id="pp-gls" type="number" min="0" placeholder="0"></div>
      <div class="fg"><label class="flbl">Assists</label><input class="finp" id="pp-ast" type="number" min="0" placeholder="0"></div>
      <div class="fg full"><label class="flbl">Avatar URL</label><input class="finp" id="pp-ava" placeholder="https://..." maxlength="300"></div>
      <div class="fg"><label class="flbl">Position</label><input class="finp" id="pp-pos" placeholder="ST, CAM, GK" maxlength="20"></div>
      <div class="fg full"><label class="flbl">La Liga Team</label>
        <select class="finp" id="pp-team"><option value="">— No Team —</option>${teamOpts}</select></div>
      <div class="fg full"><label class="flbl">Bio</label>
        <textarea class="finp" id="pp-bio" placeholder="Playstyle, achievements..." maxlength="300" rows="3" style="resize:vertical;min-height:70px;font-family:inherit;font-size:13px;"></textarea></div>
    </div>
    <div class="stats-label">Performance Stats</div>
    <div>${sliders}</div>
    <div class="mod-acts">
      <button class="fcancel" onclick="closePM()">Cancel</button>
      <button class="fsave" onclick="savePromote()">Promote &amp; Save</button>
    </div>`;

  document.getElementById('pov').classList.add('open');
}

function closePM(){
  document.getElementById('pov').classList.remove('open');
}

function savePromote(){
  const userId=document.getElementById('pu-id')?.value;
  if(!userId){toast('Error: no user selected.','er');return;}
  const users=lu();
  const idx=users.findIndex(x=>x.id===userId);
  if(idx<0){toast('User not found.','er');return;}
  const admin=getU();
  users[idx].role='player';
  users[idx].playerProfile={
    ...readFields('pp','ps'),
    lastEditedAt:Date.now(),
    lastEditedBy:admin?.username||'admin'
  };
  su(users);
  closePM();
  renderMembers();
  refreshAll();
  toast(`${users[idx].username} is now a Player!`,'ok');
}

// ═══════════════════════════════════════════
// MEMBERS TABLE
// ═══════════════════════════════════════════
function renderMembers(){
  if(!isAdmin())return;
  const users=lu(), cur=getU();
  const pending = users.filter(u=>u.role==='pending');
  const active  = users.filter(u=>u.role!=='pending');

  let html = '';

  // ── Pending section ──
  if(pending.length){
    html += `<div style="margin-bottom:8px;">
      <div style="font-family:'Barlow Condensed';font-size:11px;font-weight:700;letter-spacing:2px;color:#fbbf24;text-transform:uppercase;padding:6px 0 8px;border-bottom:1px solid rgba(245,158,11,.2);margin-bottom:8px;">
        ⏳ Pending Approval (${pending.length})
      </div>`;
    html += pending.map(u=>{
      const discordAv = u.discordId ? `https://cdn.discordapp.com/avatars/${u.discordId}/avatar.png` : '';
      const defAv = u.discordId ? `https://cdn.discordapp.com/embed/avatars/${Number(BigInt(u.discordId)%6n)}.png` : '';
      const avatarHtml = discordAv
        ? `<img src="${discordAv}" onerror="this.src='${defAv}'" style="width:28px;height:28px;border-radius:50%;border:2px solid rgba(245,158,11,.4);flex-shrink:0;">`
        : `<div style="width:28px;height:28px;border-radius:50%;background:rgba(245,158,11,.1);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed';font-weight:800;font-size:13px;color:#fbbf24;">${u.username[0].toUpperCase()}</div>`;
      return `<div class="mrow" style="border-left:3px solid #fbbf24;opacity:.9;">
        <div class="mcell" style="gap:8px;">${avatarHtml}<div><div style="font-size:13px;">${esc(u.username)}</div>${u.discordId?`<div style="font-size:9px;color:rgba(88,101,242,.8);font-family:'Barlow Condensed';">Discord: ${u.discordId}</div>`:''}</div></div>
        <div class="mcell"><span class="rbadge rpending">Pending</span></div>
        <div class="mcell" style="font-size:11px;color:var(--gray);">${u.appeal?`"${esc(u.appeal.slice(0,40))}${u.appeal.length>40?'…':''}"`:'-'}</div>
        <div class="mcell"><div style="font-size:11px;color:var(--gray);">${fdate(u.createdAt)}</div></div>
        <div class="mcell" style="justify-content:flex-end;"><div class="macts">
          <button class="abtn" style="background:rgba(16,185,129,.15);color:#34d399;border:1px solid rgba(16,185,129,.3);" onclick="openApproveModal('${u.id}','${esc(u.username)}','${u.discordId||''}');renderMembers();">Approve</button>
          <button class="abtn adelete" onclick="rejectUserWithReason('${u.id}','${esc(u.username)}');renderMembers();">Reject</button>
        </div></div>
      </div>`;
    }).join('');
    html += `</div>`;
  }

  // ── Active members ──
  html += active.map(u=>{
    const rc=u.role==='admin'?'radmin':u.role==='player'?'rplayer':'rfan';
    const rl=u.role==='admin'?'Admin':u.role==='player'?'Player':'Fan';
    const pp=u.playerProfile||{}, self=cur&&cur.id===u.id;
    let acts='';
    if(!self&&u.role!=='admin'){
      if(u.role==='fan'){
        acts+=`<button class="abtn apromote" onclick="openPromoteModal('${u.id}')">+Player</button>`;
        acts+=`<button class="abtn" style="background:rgba(245,158,11,.15);color:#fbbf24;border:1px solid rgba(245,158,11,.25);" onclick="makeAdmin('${u.id}')">+Admin</button>`;
        acts+=`<button class="abtn" style="background:rgba(239,68,68,.08);color:#f87171;border:1px solid rgba(239,68,68,.15);" onclick="openBanModal('${u.id}')">Ban</button>`;
        acts+=`<button class="abtn adelete" onclick="confirmDeleteUser('${u.id}','${esc(u.username)}')">Delete</button>`;
      } else {
        acts+=`<button class="abtn aedit" onclick="openEditModal('${u.id}')">Edit</button>`;
        acts+=`<button class="abtn atier" onclick="rotateTier('${u.id}')">Tier</button>`;
        acts+=`<button class="abtn ademote" onclick="setRole('${u.id}','fan')">Demote</button>`;
        acts+=`<button class="abtn" style="background:rgba(245,158,11,.15);color:#fbbf24;border:1px solid rgba(245,158,11,.25);" onclick="makeAdmin('${u.id}')">+Admin</button>`;
        acts+=`<button class="abtn" style="background:rgba(239,68,68,.08);color:#f87171;border:1px solid rgba(239,68,68,.15);" onclick="openBanModal('${u.id}')">Ban</button>`;
        acts+=`<button class="abtn adelete" onclick="confirmDeleteUser('${u.id}','${esc(u.username)}')">Del</button>`;
      }
    }
    if(!self&&u.role==='admin'){
      if(getU()?.username===ADMIN){
        acts+=`<button class="abtn ademote" onclick="revokeAdmin('${u.id}')">Revoke Admin</button>`;
      }
    }
    if(self) acts=`<button class="abtn aedit" onclick="openEditModal('${u.id}')">Edit Me</button><span style="font-size:10px;color:var(--gray);font-family:'Barlow Condensed';margin-left:4px;">You</span>`;
    const editTs = pp.lastEditedAt || u.lastEditedAt;
    const editBy = pp.lastEditedBy || u.lastEditedBy;
    const editCell = editTs
      ? `<div style="font-size:11px;color:var(--blue3);font-family:'Barlow Condensed';font-weight:600;">${fdatetime(editTs)}</div><div style="font-size:9px;color:var(--gray);letter-spacing:1px;">by ${editBy||'admin'}</div>`
      : `<div style="font-size:11px;color:var(--gray);">Joined ${fdate(u.createdAt)}</div>`;
    const flag = userFlag(u);
    const countryDisplay = u.countryCode ? `<span style="font-size:10px;color:var(--gray);font-family:'Barlow Condensed';">${u.countryCode.toUpperCase()}</span>` : '';
    const ban = isUserBanned(u.username);
    const banBadge = ban ? `<span style="font-size:9px;background:rgba(239,68,68,.15);color:#f87171;border:1px solid rgba(239,68,68,.25);border-radius:10px;padding:1px 6px;font-family:'Barlow Condensed';letter-spacing:1px;cursor:pointer;" title="Click to unban" onclick="unbanUser('${esc(u.username)}')">BANNED</span>` : '';
    const discordBadge = u.discordId ? `<span style="font-size:9px;color:rgba(88,101,242,.9);font-family:'Barlow Condensed';letter-spacing:.5px;"></span>` : '';
    return `<div class="mrow">
      <div class="mcell"><div class="mava">${avaC(u,22)}</div><span>${flag} ${esc(u.username)}${u.role==='admin'?` <span class="shield" title="Admin"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 11 14 15 10"/></svg></span>`:''} ${discordBadge} ${countryDisplay} ${banBadge}</span></div>
      <div class="mcell"><span class="rbadge ${rc}">${rl}</span></div>
      <div class="mcell" style="color:${tcol(pp.tier||'')};">${pp.tier||'—'}</div>
      <div class="mcell">${editCell}</div>
      <div class="mcell" style="justify-content:flex-end"><div class="macts">${acts}<button class="abtn" style="background:rgba(124,58,237,.15);color:#a78bfa;border:1px solid rgba(124,58,237,.3);" onclick="setCountry('${u.id}')">Flag</button>${(u.role==='player'||u.role==='admin')?`<button class="abtn" style="${u.chatEmailVerified?'background:rgba(16,185,129,.15);color:#34d399;border:1px solid rgba(16,185,129,.3);':'background:rgba(239,68,68,.08);color:#f87171;border:1px solid rgba(239,68,68,.2);'}" onclick="toggleChatAccess('${u.id}')">${u.chatEmailVerified?'Chat ✅':'Chat 🔒'}</button>`:''}<button class="abtn" id="locbtn-${u.id}" style="background:rgba(245,158,11,.1);color:#fbbf24;border:1px solid rgba(245,158,11,.25);" onclick="checkMemberLocation('${u.id}','${esc(u.username)}')" title="Send real-time location to Discord">&#128205; Check</button></div></div>
    </div>`;
  }).join('') || `<div class="empty"><div class="eico"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><h3>No Members</h3></div>`;

  document.getElementById('mrows').innerHTML = html;
}

// ══════════════════════════════════════════════
// ADMIN — CHECK MEMBER REAL-TIME LOCATION
// Detects the user's real country/city via IP APIs
// and sends it directly to Discord webhook
// ══════════════════════════════════════════════
async function checkMemberLocation(uid, username){
  if(!isAdmin()){ toast('Admin only.','er'); return; }

  // Update button to loading state
  const btn = document.getElementById('locbtn-'+uid);
  const origHTML = btn ? btn.innerHTML : '';
  if(btn){ btn.disabled = true; btn.innerHTML = '⏳ Fetching…'; btn.style.opacity = '.6'; }

  try {
    const ipData = await getIP();
    const cc     = (ipData.countryCode || ipData.country_code || '').toUpperCase().trim();
    const flag   = countryFlag(cc);
    const loc    = [ipData.city, ipData.region, ipData.country].filter(Boolean).join(', ');

    // Send to Discord
    await sendWebhook({
      title: `📍 Location Check — ${username}`,
      color: 0x1e6fff,
      description: `Admin **${getU()?.username || 'admin'}** ran a location check on **${username}**`,
      fields: [
        { name: `${flag || '🌍'} Country`,  value: `\`${ipData.country || 'Unknown'}\`${cc ? ' (' + cc + ')' : ''}`, inline: true },
        { name: '📍 City / Region',         value: `\`${ipData.city || 'Unknown'}\`, \`${ipData.region || 'Unknown'}\``, inline: true },
        { name: '🕐 Checked At',            value: `\`${fmtTime(Date.now())}\``, inline: true },
        { name: '📡 Full Location',         value: `\`${loc || 'Unknown'}\``, inline: false },
      ],
      footer: { text: 'PHM Admin — Location Check' },
      timestamp: new Date().toISOString()
    });

    // Update member's countryCode in DB if it was missing or outdated
    if(cc || ipData.country){
      const users = lu();
      const idx   = users.findIndex(x => x.id === uid);
      if(idx >= 0){
        if(cc)             users[idx].countryCode = cc;
        if(ipData.country) users[idx].country = ipData.country;
        su(users);
        renderMembers(); refreshAll();
      }
    }

    toast(`📍 Location sent to Discord — ${loc || 'Unknown'}`, 'ok');
  } catch(e) {
    toast('Location check failed.', 'er');
  } finally {
    if(btn){ btn.disabled = false; btn.innerHTML = origHTML; btn.style.opacity = ''; }
  }
}

function toggleChatAccess(uid){
  if(!isAdmin()){ toast('Admin only.','er'); return; }
  const users=lu();
  const idx=users.findIndex(x=>x.id===uid);
  if(idx<0) return;
  const target=users[idx];
  target.chatEmailVerified = !target.chatEmailVerified;
  su(users);
  const me=getU();
  if(me&&me.id===uid) ss(users[idx]);
  renderMembers(); refreshAll();
  const action=target.chatEmailVerified?'GRANTED':'REVOKED';
  toast('Chat access '+action.toLowerCase()+' for '+target.username,'ok');
  sendWebhook({
    title: target.chatEmailVerified ? '💬 Chat Access Granted' : '🔇 Chat Access Revoked',
    color: target.chatEmailVerified ? 0x10b981 : 0xef4444,
    fields:[
      {name:'👤 Player',   value:'`'+target.username+'`', inline:true},
      {name:'🛡️ By Admin', value:'`'+(getU()?.username||'admin')+'`', inline:true},
      {name:'💬 Chat',     value: target.chatEmailVerified ? '\u2705 Access granted (no email needed)' : '🔒 Access revoked', inline:false},
      {name:'🕜 Time',     value:'`'+fmtTime(Date.now())+'`', inline:true},
    ],
    footer:{text:'PHM Chat System'},
    timestamp:new Date().toISOString()
  });
}

function setRole(uid,role){
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0)return;
  const admin=getU();
  const target=users[idx];
  const oldRole=target.role;
  target.role=role;
  target.lastEditedAt=Date.now();
  target.lastEditedBy=admin?.username||'admin';
  if(role==='fan') target.playerProfile=null;
  su(users); renderMembers(); refreshAll();
  toast(`${target.username} is now a ${role==='player'?'Player':'Fan'}`, 'ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:`Role Changed → ${role==='player'?'Player':'Fan'}`,
      color: role==='player'?0x10b981:0x6b7280,
      fields:[
        {name:'Target',   value:`\`${target.username}\``, inline:true},
        {name:'Change',   value:`\`${oldRole}\` → \`${role}\``, inline:true},
        {name:'By Admin',value:`\`${admin?.username||'admin'}\``, inline:true},
        
        {name:'Time',     value:`\`${fmtTime(Date.now())}\``, inline:true},
      ],
      footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
    });
  });
}

function makeAdmin(uid){
  if(!isAdmin()){toast('No permission.','er');return;}
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0)return;
  const admin=getU();
  const target=users[idx];
  if(!confirm(`Grant ADMIN to ${target.username}? They will have full control.`)) return;
  target.role='admin';
  target.lastEditedAt=Date.now();
  target.lastEditedBy=admin?.username||'admin';
  su(users); renderMembers(); refreshAll();
  toast(`${target.username} is now Admin`,'ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:'ADMIN GRANTED',
      color:0xf59e0b,
      fields:[
        {name:'New Admin',  value:`\`${target.username}\``, inline:true},
        {name:'Granted By',value:`\`${admin?.username||'admin'}\``, inline:true},
        {name:'Email',      value:`\`${target.email||'?'}\``, inline:true},
        
        {name:'Location',  value:`\`${ipData.city||'?'}, ${ipData.country||'?'}\``, inline:true},
        {name:'Time',      value:`\`${fmtTime(Date.now())}\``, inline:true},
      ],
      footer:{text:'PHM Admin Log — HIGH PRIORITY'},timestamp:new Date().toISOString()
    });
  });
}

function revokeAdmin(uid){
  if(!isAdmin()){toast('No permission.','er');return;}
  if(getU()?.username!==ADMIN){toast('Only the owner can revoke admin.','er');return;}
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0)return;
  const admin=getU();
  const target=users[idx];
  if(target.id===admin?.id){toast('Cannot revoke your own admin.','er');return;}
  if(!confirm(`Revoke ADMIN from ${target.username}? They will become a Fan.`)) return;
  target.role='fan';
  target.playerProfile=null;
  target.lastEditedAt=Date.now();
  target.lastEditedBy=admin?.username||'admin';
  su(users); renderMembers(); refreshAll();
  toast(`${target.username} admin revoked.`,'ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:'ADMIN REVOKED',
      color:0xef4444,
      fields:[
        {name:'Revoked From', value:`\`${target.username}\``, inline:true},
        {name:'Revoked By',  value:`\`${admin?.username||'admin'}\``, inline:true},
        {name:'Email',        value:`\`${target.email||'?'}\``, inline:true},
        
        {name:'Location',    value:`\`${ipData.city||'?'}, ${ipData.country||'?'}\``, inline:true},
        {name:'Time',        value:`\`${fmtTime(Date.now())}\``, inline:true},
      ],
      footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
    });
  });
}

function confirmDeleteUser(uid, username){
  if(!isAdmin()){toast('No permission.','er');return;}
  openBanOrDeleteModal(uid, username, 'delete');
}

// ═══════════════════════════════════════════
// BAN SYSTEM
// ═══════════════════════════════════════════

function isUserBanned(username){
  const bans = lb();
  const ban = bans[username];
  if(!ban) return null;
  if(ban.permanent) return ban;
  if(Date.now() > ban.until) {
    // Expired ban — remove it
    delete bans[username];
    sb(bans);
    return null;
  }
  return ban;
}

function openBanOrDeleteModal(uid, username, mode){
  // mode: 'ban' | 'delete'
  const mod = document.getElementById('ban-mod');
  const title = document.getElementById('ban-mod-title');
  const saveBtn = document.getElementById('ban-save-btn');
  document.getElementById('ban-uid').value = uid;
  document.getElementById('ban-mode').value = mode;
  document.getElementById('ban-username-display').textContent = username;
  document.getElementById('ban-reason').value = '';
  document.getElementById('ban-dur-type').value = 'days';
  document.getElementById('ban-dur-num').value = '7';
  document.getElementById('ban-permanent').checked = false;
  document.getElementById('ban-dur-row').style.display = '';

  if(mode === 'delete'){
    title.textContent = `Delete User: ${username}`;
    document.getElementById('ban-reason-label').textContent = 'Reason (optional)';
    document.getElementById('ban-dur-section').style.display = 'none';
    saveBtn.textContent = 'DELETE USER';
    saveBtn.style.background = '#ef4444';
  } else {
    title.textContent = `Ban User: ${username}`;
    document.getElementById('ban-reason-label').textContent = 'Ban Reason';
    document.getElementById('ban-dur-section').style.display = '';
    saveBtn.textContent = 'BAN USER';
    saveBtn.style.background = '#ef4444';
  }

  document.getElementById('ban-ov').classList.add('open');
}

function closeBanMod(e){
  if(!e||e.target===document.getElementById('ban-ov'))
    document.getElementById('ban-ov').classList.remove('open');
}

function togglePermanent(){
  const perm = document.getElementById('ban-permanent').checked;
  document.getElementById('ban-dur-row').style.display = perm ? 'none' : '';
}

function executeBanOrDelete(){
  const uid = document.getElementById('ban-uid').value;
  const mode = document.getElementById('ban-mode').value;
  const reason = document.getElementById('ban-reason').value.trim() || 'No reason provided';
  const users = lu();
  const u = users.find(x=>x.id===uid);
  if(!u){toast('User not found.','er');return;}

  if(mode === 'delete'){
    su(users.filter(x=>x.id!==uid));
    document.getElementById('ban-ov').classList.remove('open');
    renderMembers(); refreshAll();
    toast(`${u.username} has been deleted.`,'ok');
    getIP().then(ipData=>{
      sendWebhook({
        title:'User Deleted',
        color:0xef4444,
        fields:[
          {name:'Deleted',    value:`\`${u.username}\``, inline:true},
          {name:'By Admin', value:`\`${getU()?.username||'admin'}\``, inline:true},
          {name:'Email',     value:`\`${u.email||'?'}\``, inline:true},
          {name:'Reason',    value:reason, inline:false},
          
          {name:'Time',     value:`\`${fmtTime(Date.now())}\``, inline:true},
        ],
        footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
      });
    });
    return;
  }

  // BAN
  const perm = document.getElementById('ban-permanent').checked;
  let until = null, durText = 'Permanent';
  if(!perm){
    const num = parseInt(document.getElementById('ban-dur-num').value)||1;
    const durType = document.getElementById('ban-dur-type').value;
    let ms;
    if(durType === 'days') { ms = num * 86400000; durText = `${num} day${num!==1?'s':''}`;  }
    else if(durType === 'months') { ms = num * 30 * 86400000; durText = `${num} month${num!==1?'s':''}`;  }
    else if(durType === 'years') { ms = num * 365 * 86400000; durText = `${num} year${num!==1?'s':''}`;  }
    else { ms = num * 86400000; durText = `${num} day${num!==1?'s':''}`; }
    until = Date.now() + ms;
  }

  const bans = lb();
  bans[u.username] = { reason, until, permanent: perm, bannedAt: Date.now(), bannedBy: getU()?.username||'admin' };
  sb(bans);

  document.getElementById('ban-ov').classList.remove('open');
  renderMembers(); refreshAll();
  toast(`${u.username} banned${perm?'':(` for ${durText}`)}.`,'ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:'User Banned',
      color:0xef4444,
      fields:[
        {name:'Banned',      value:`\`${u.username}\``, inline:true},
        {name:'By Admin',  value:`\`${getU()?.username||'admin'}\``, inline:true},
        {name:'Email',      value:`\`${u.email||'?'}\``, inline:true},
        {name:'Reason',     value:reason, inline:false},
        {name:'Duration',   value:perm?'**Permanent**':`\`${durText}\``, inline:true},
        
        {name:'Time',      value:`\`${fmtTime(Date.now())}\``, inline:true},
      ],
      footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
    });
  });
}

function openBanModal(uid){
  if(!isAdmin()){toast('No permission.','er');return;}
  const u = lu().find(x=>x.id===uid);
  if(!u){toast('User not found.','er');return;}
  openBanOrDeleteModal(uid, u.username, 'ban');
}

function unbanUser(username){
  if(!isAdmin()){toast('No permission.','er');return;}
  const bans = lb();
  delete bans[username];
  sb(bans);
  renderMembers();
  toast(`${username} has been unbanned.`,'ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:'User Unbanned',
      color:0x10b981,
      fields:[
        {name:'Unbanned',   value:`\`${username}\``, inline:true},
        {name:'By Admin', value:`\`${getU()?.username||'admin'}\``, inline:true},
        
        {name:'Time',     value:`\`${fmtTime(Date.now())}\``, inline:true},
      ],
      footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
    });
  });
}


function rotateTier(uid){
  const users=lu(), u=users.find(x=>x.id===uid); if(!u)return;
  const admin=getU();
  const ts=['Tier 1','Tier 2','Tier 3','Tier 4'];
  const old=u.playerProfile?.tier||'Tier 4';
  const next=ts[(ts.indexOf(old)+1)%4];
  if(!u.playerProfile)u.playerProfile={};
  u.playerProfile.tier=next;
  u.playerProfile.lastEditedAt=Date.now();
  u.playerProfile.lastEditedBy=admin?.username||'admin';
  su(users); renderMembers(); refreshAll();
  toast(`${u.username} → ${next}`,'ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:'Tier Changed',
      color:0xf59e0b,
      fields:[
        {name:'Player',    value:`\`${u.username}\``, inline:true},
        {name:'Change',    value:`\`${old}\` → \`${next}\``, inline:true},
        {name:'By Admin',value:`\`${admin?.username||'admin'}\``, inline:true},
        
        {name:'Time',     value:`\`${fmtTime(Date.now())}\``, inline:true},
      ],
      footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
    });
  });
}

function fdate(ts){ if(!ts)return'—'; return new Date(ts).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}); }
function fdatetime(ts){ if(!ts)return'—'; return new Date(ts).toLocaleString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}); }

// Country lookup maps (admin flag setter)
const COUNTRY_NAMES = {
  AF:'Afghanistan',AL:'Albania',DZ:'Algeria',AO:'Angola',AR:'Argentina',AM:'Armenia',AU:'Australia',
  AT:'Austria',AZ:'Azerbaijan',BH:'Bahrain',BD:'Bangladesh',BY:'Belarus',BE:'Belgium',BZ:'Belize',
  BJ:'Benin',BO:'Bolivia',BA:'Bosnia',BW:'Botswana',BR:'Brazil',BN:'Brunei',BG:'Bulgaria',
  BF:'Burkina Faso',BI:'Burundi',KH:'Cambodia',CM:'Cameroon',CA:'Canada',CF:'C. African Rep.',
  TD:'Chad',CL:'Chile',CN:'China',CO:'Colombia',CG:'Congo',HR:'Croatia',CU:'Cuba',CY:'Cyprus',
  CZ:'Czech Republic',DK:'Denmark',DO:'Dominican Rep.',CD:'DR Congo',EC:'Ecuador',EG:'Egypt',
  SV:'El Salvador',ET:'Ethiopia',FI:'Finland',FR:'France',GA:'Gabon',GM:'Gambia',GE:'Georgia',
  DE:'Germany',GH:'Ghana',GR:'Greece',GT:'Guatemala',GN:'Guinea',HT:'Haiti',HN:'Honduras',
  HU:'Hungary',IN:'India',ID:'Indonesia',IR:'Iran',IQ:'Iraq',IE:'Ireland',IL:'Israel',IT:'Italy',
  CI:"Côte d'Ivoire",JM:'Jamaica',JP:'Japan',JO:'Jordan',KZ:'Kazakhstan',KE:'Kenya',KP:'North Korea',
  KR:'South Korea',KW:'Kuwait',KG:'Kyrgyzstan',LA:'Laos',LB:'Lebanon',LY:'Libya',LT:'Lithuania',
  LU:'Luxembourg',MG:'Madagascar',MW:'Malawi',MY:'Malaysia',ML:'Mali',MX:'Mexico',MD:'Moldova',
  MN:'Mongolia',MA:'Morocco',MZ:'Mozambique',MM:'Myanmar',NA:'Namibia',NP:'Nepal',NL:'Netherlands',
  NZ:'New Zealand',NI:'Nicaragua',NE:'Niger',NG:'Nigeria',MK:'North Macedonia',NO:'Norway',
  OM:'Oman',PK:'Pakistan',PS:'Palestine',PA:'Panama',PY:'Paraguay',PE:'Peru',PH:'Philippines',
  PL:'Poland',PT:'Portugal',QA:'Qatar',RO:'Romania',RU:'Russia',RW:'Rwanda',SA:'Saudi Arabia',
  SN:'Senegal',RS:'Serbia',SL:'Sierra Leone',SO:'Somalia',ZA:'South Africa',SS:'South Sudan',
  ES:'Spain',LK:'Sri Lanka',SD:'Sudan',SE:'Sweden',CH:'Switzerland',SY:'Syria',TW:'Taiwan',
  TZ:'Tanzania',TH:'Thailand',TN:'Tunisia',TR:'Turkey',UG:'Uganda',UA:'Ukraine',AE:'UAE',
  GB:'United Kingdom',US:'United States',UY:'Uruguay',UZ:'Uzbekistan',VE:'Venezuela',
  VN:'Vietnam',YE:'Yemen',ZM:'Zambia',ZW:'Zimbabwe',
};
const CODE3TO2 = {
  IRQ:'IQ',SAU:'SA',UAE:'AE',EGY:'EG',MAR:'MA',TUN:'TN',DZA:'DZ',LBY:'LY',LBN:'LB',SYR:'SY',
  JOR:'JO',PSE:'PS',YEM:'YE',OMN:'OM',KWT:'KW',BHR:'BH',QAT:'QA',GBR:'GB',USA:'US',FRA:'FR',
  DEU:'DE',ESP:'ES',ITA:'IT',PRT:'PT',NLD:'NL',BEL:'BE',CHE:'CH',AUT:'AT',SWE:'SE',NOR:'NO',
  DNK:'DK',FIN:'FI',POL:'PL',RUS:'RU',TUR:'TR',GRC:'GR',ROU:'RO',HRV:'HR',SRB:'RS',BRA:'BR',
  ARG:'AR',COL:'CO',CHL:'CL',MEX:'MX',PER:'PE',VEN:'VE',URY:'UY',PAR:'PY',NGA:'NG',GHA:'GH',
  SEN:'SN',CMR:'CM',CIV:'CI',ZAF:'ZA',KEN:'KE',ETH:'ET',TZA:'TZ',UGA:'UG',ZIM:'ZW',JPN:'JP',
  CHN:'CN',KOR:'KR',IND:'IN',PAK:'PK',BGD:'BD',THA:'TH',IDN:'ID',MYS:'MY',PHL:'PH',VNM:'VN',
  AUS:'AU',NZL:'NZ',CAN:'CA',AFG:'AF',IRN:'IR',KAZ:'KZ',UZB:'UZ',AZE:'AZ',ARM:'AM',GEO:'GE',
  UKR:'UA',CZE:'CZ',SVK:'SK',HUN:'HU',BGR:'BG',ALB:'AL',MKD:'MK',
};

// ── Admin sets country code → clean modal ──
function setCountry(uid){
  if(!isAdmin()){toast('No permission.','er');return;}
  const u=lu().find(x=>x.id===uid); if(!u) return;
  document.getElementById('fc-uid').value = uid;
  document.getElementById('fc-username').textContent = u.username;
  document.getElementById('fc-input').value = u.countryCode||'';
  // Build quick pick buttons
  const qp = document.getElementById('fc-quickpicks');
  const codes = ['IRQ','SAU','GBR','USA','FRA','DEU','ESP','TUR','EGY','MAR','NGA','BRA','ARG','JPN','KOR','UAE','QAT','JOR','SYR','LBN'];
  qp.innerHTML = codes.map(c=>`<button type="button"
    onclick="document.getElementById('fc-input').value='${c}';fcPreview()"
    style="font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;padding:5px 10px;border-radius:6px;border:1px solid var(--border2);background:var(--card2);color:var(--gray);cursor:pointer;transition:all .2s;"
    onmouseover="this.style.borderColor='var(--blue3)';this.style.color='var(--white)'"
    onmouseout="this.style.borderColor='var(--border2)';this.style.color='var(--gray)'">${c}</button>`).join('');
  fcPreview();
  document.getElementById('fc-ov').classList.add('open');
  setTimeout(()=>document.getElementById('fc-input').focus(), 100);
}
function closeFCov(e){
  if(!e||e.target===document.getElementById('fc-ov'))
    document.getElementById('fc-ov').classList.remove('open');
}
function fcPreview(){
  const raw = (document.getElementById('fc-input')?.value||'').toUpperCase().trim();
  const flagEl = document.getElementById('fc-flag');
  const nameEl = document.getElementById('fc-name');
  if(!raw){ flagEl.textContent='—'; nameEl.textContent='No flag set'; nameEl.style.color='var(--gray)'; return; }
  const iso2 = raw.length===3 ? (CODE3TO2[raw]||null) : (raw.length===2 ? raw : null);
  if(!iso2){ flagEl.textContent='?'; nameEl.textContent='Unknown code'; nameEl.style.color='#f87171'; return; }
  const flag = countryFlag(iso2);
  const name = COUNTRY_NAMES[iso2]||iso2;
  flagEl.textContent = flag||'?';
  nameEl.textContent = name;
  nameEl.style.color = flag ? 'var(--blue3)' : '#f87171';
}
function saveFlagCode(){
  if(!isAdmin()) return;
  const uid = document.getElementById('fc-uid').value;
  const raw = (document.getElementById('fc-input').value||'').toUpperCase().trim();
  if(!raw){ toast('Enter a country code.','er'); return; }
  const iso2 = raw.length===3 ? (CODE3TO2[raw]||raw) : raw;
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0) return;
  const admin=getU();
  const target=users[idx];
  const old=target.countryCode||'none';
  target.countryCode = iso2;
  target.lastEditedAt = Date.now();
  target.lastEditedBy = admin?.username||'admin';
  su(users);
  const flag = countryFlag(iso2);
  const name = COUNTRY_NAMES[iso2]||iso2;
  document.getElementById('fc-ov').classList.remove('open');
  renderMembers(); refreshAll();
  toast(`${target.username} → ${flag} ${iso2}`,'ok');
  getIP().then(ipData=>{
    sendWebhook({
      title:'Flag Set',
      color:0x8b5cf6,
      fields:[
        {name:'Player',    value:`\`${target.username}\``, inline:true},
        {name:'Flag',    value:`${flag} \`${iso2}\` — ${name}`, inline:true},
        {name:'Change',   value:`\`${old}\` → \`${iso2}\``, inline:true},
        {name:'By Admin',value:`\`${admin?.username||'admin'}\``, inline:true},
        
        {name:'Time',     value:`\`${fmtTime(Date.now())}\``, inline:true},
      ],
      footer:{text:'PHM Admin Log'},timestamp:new Date().toISOString()
    });
  });
}

// ═══════════════════════════════════════════
// AUTH — LOGIN / REGISTER / VERIFY
// ═══════════════════════════════════════════
let authM='login';

function openAuth(mode){ authM=mode; clearAMsgs(); renderABody(); document.getElementById('aov').classList.add('open'); }
function closeAov(e){ if(!e||e.target===document.getElementById('aov')) document.getElementById('aov').classList.remove('open'); }

function clearAMsgs(){
  const er=document.getElementById('aerr'); er.textContent=''; er.classList.remove('show');
  const ok=document.getElementById('aok'); ok.textContent=''; ok.classList.remove('show');
}
function aerrMsg(msg){ const e=document.getElementById('aerr'); e.textContent=msg; e.classList.add('show'); }
function aokMsg(msg){ const e=document.getElementById('aok'); e.textContent=msg; e.classList.add('show'); }

// ── Discord CDN avatar URL from user ID ──
function discordAvatar(discordId, avatarHash){
  if(!discordId) return '';
  if(avatarHash) return `https://cdn.discordapp.com/avatars/${discordId}/${avatarHash}.png?size=128`;
  // Default Discord avatar (based on ID)
  const idx = (BigInt(discordId) >> 22n) % 6n;
  return `https://cdn.discordapp.com/embed/avatars/${idx}.png`;
}

// ── Fetch Discord user data via public widget API ──
async function fetchDiscordUser(discordId){
  if(!discordId || !/^\d{17,20}$/.test(discordId)) return null;
  try{
    const r = await Promise.race([
      fetch(`https://discord.com/api/v9/users/${discordId}`, {headers:{'Authorization':'Bot '}}),
      new Promise((_,rej)=>setTimeout(()=>rej('timeout'),4000))
    ]);
    // Bot token needed for full API — use widget fallback instead
  }catch(e){}
  // Use the public invite/widget workaround — just build avatar URL from ID
  return { id: discordId, avatarUrl: discordAvatar(discordId, null) };
}

// ── Live Discord ID preview in register form ──
async function previewDiscord(){
  const id = (document.getElementById('a-discord')?.value||'').trim();
  const box = document.getElementById('discord-preview-box');
  if(!box) return;
  if(!id){ box.innerHTML=''; return; }
  if(!/^\d{17,20}$/.test(id)){
    box.innerHTML=`<div class="discord-hint" style="color:#f87171;">Discord IDs must be 17–20 digits only</div>`;
    return;
  }
  const avatarUrl = `https://cdn.discordapp.com/avatars/${id}/avatar.png?size=64`;
  const defaultUrl = `https://cdn.discordapp.com/embed/avatars/${Number(BigInt(id)%6n)}.png`;
  box.innerHTML=`<div class="discord-preview">
    <img src="${avatarUrl}" onerror="this.src='${defaultUrl}'" alt="Discord PFP">
    <div>
      <div class="discord-preview-name">Discord User</div>
      <div class="discord-preview-tag">ID: ${id}</div>
      <div class="discord-hint">Avatar will sync automatically</div>
    </div>
  </div>`;
}

// ── Temp state for multi-step registration ──
let _regStep = 1; // 1=discord entry, 2=confirm identity, 3=set password
let _regData  = {}; // holds discordId, username, avatarUrl during registration

function renderABody(){
  const ab=document.getElementById('abody');
  if(authM==='login'){
    ab.innerHTML=`
      <div class="atitl">Welcome Back</div>
      <div class="asub">Sign in with your Discord ID</div>
      <div class="af">
        <label class="albl" style="color:#7289da;">Discord ID</label>
        <input class="ainp" id="a-discord-login" type="text" inputmode="numeric" placeholder="Your 18-digit Discord ID" maxlength="20" autocomplete="off" oninput="this.value=this.value.replace(/\\D/g,'')">
        <div style="font-size:10px;color:var(--gray);margin-top:5px;line-height:1.5;">Discord → Settings → Advanced → Developer Mode ON → right-click your name → Copy User ID</div>
      </div>
      <div class="af"><label class="albl">Password</label><input class="ainp" id="a-pass" type="password" placeholder="••••••••" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <button class="abtn2" onclick="doLogin()">SIGN IN</button>
      <div class="aswitch">No account? <a onclick="openAuth('register')">Register with Discord</a></div>`;

  } else if(authM==='register'){
    if(_regStep===1){
      ab.innerHTML=`
        <div class="atitl">Join PHM</div>
        <div class="asub">Enter your Discord ID to get started</div>
        <div class="af">
          <label class="albl" style="color:#7289da;">Discord ID</label>
          <input class="ainp" id="a-discord" type="text" inputmode="numeric" placeholder="e.g. 123456789012345678" maxlength="20" autocomplete="off"
            oninput="this.value=this.value.replace(/\\D/g,'');liveDiscordPreview(this.value)"
            onkeydown="if(event.key==='Enter')stepLookupDiscord()">
          <div id="discord-preview-box" style="margin-top:10px;"></div>
          <div style="font-size:10px;color:var(--gray);margin-top:8px;line-height:1.5;background:rgba(88,101,242,.06);padding:8px 10px;border-radius:8px;border:1px solid rgba(88,101,242,.15);">
            <strong style="color:#7289da;">How to find your Discord ID:</strong><br>
            Discord → Settings → Advanced → <strong>Enable Developer Mode</strong> → right-click your username → <strong>Copy User ID</strong>
          </div>
        </div>
        <button class="abtn2" onclick="stepLookupDiscord()">CONTINUE →</button>
        <div class="aswitch">Already registered? <a onclick="openAuth('login')">Sign In</a></div>`;

    } else if(_regStep===2){
      const d=_regData;
      const nameDisplay = d.foundInServer ? esc(d.displayName) : `User #${d.discordId.slice(-4)}`;
      ab.innerHTML=`
        <div class="atitl">Is This You?</div>
        <div class="asub">Confirm your Discord account to continue</div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:10px;padding:20px;background:rgba(88,101,242,.08);border:1px solid rgba(88,101,242,.25);border-radius:14px;margin-bottom:16px;">
          <img src="${d.avatarUrl}" onerror="this.src='${d.defaultAvaUrl}'" style="width:80px;height:80px;border-radius:50%;border:3px solid #7289da;object-fit:cover;">
          <div style="text-align:center;">
            <div style="font-family:'Barlow Condensed';font-size:22px;font-weight:800;color:var(--white);letter-spacing:1px;">${nameDisplay}</div>
            <div style="font-size:11px;color:#7289da;margin-top:2px;">ID: ${d.discordId}</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="abtn2" style="background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.4);color:#34d399;flex:1;" onclick="stepConfirmYes()">Yes, that's me</button>
          <button class="abtn2" style="background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.3);color:#f87171;flex:1;" onclick="stepConfirmNo()">Not me</button>
        </div>`;

    } else if(_regStep===3){
      const d=_regData;
      ab.innerHTML=`
        <div class="atitl">Set Your Password</div>
        <div style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:rgba(88,101,242,.08);border:1px solid rgba(88,101,242,.2);border-radius:12px;margin-bottom:16px;">
          <img src="${d.avatarUrl}" onerror="this.src='${d.defaultAvaUrl}'" style="width:44px;height:44px;border-radius:50%;border:2px solid #7289da;object-fit:cover;flex-shrink:0;">
          <div>
            <div style="font-family:'Barlow Condensed';font-size:14px;font-weight:800;color:var(--white);">${esc(d.displayName||'Discord User')}</div>
            <div style="font-size:10px;color:#7289da;">Discord ID: ${d.discordId}</div>
          </div>
        </div>
        <div class="af"><label class="albl">Choose a Password</label><input class="ainp" id="a-pass" type="password" placeholder="Min 6 characters" autocomplete="new-password" onkeydown="if(event.key==='Enter')doReg()"></div>
        <div class="af"><label class="albl">Confirm Password</label><input class="ainp" id="a-pass2" type="password" placeholder="Repeat password" autocomplete="new-password" onkeydown="if(event.key==='Enter')doReg()"></div>
        <div style="font-size:10px;color:rgba(245,158,11,.8);background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);border-radius:8px;padding:9px 12px;margin-bottom:14px;line-height:1.5;">
          After registering your account will be <strong>pending</strong> until admin approves it.
        </div>
        <button class="abtn2" onclick="doReg()">CREATE ACCOUNT</button>
        <div class="aswitch"><a onclick="_regStep=1;renderABody()">← Start Over</a></div>`;
    }
  }
}

// ── Step 1 → 2: Look up Discord avatar from ID ──
async function liveDiscordPreview(id){
  const box=document.getElementById('discord-preview-box'); if(!box) return;
  if(!id||id.length<15){ box.innerHTML=''; return; }
  if(!/^\d{17,20}$/.test(id)){ box.innerHTML=`<div style="font-size:11px;color:#f87171;margin-top:4px;">IDs must be 17–20 digits</div>`; return; }
  const idx2=Number(BigInt(id)%6n);
  const avaUrl=`https://cdn.discordapp.com/avatars/${id}/avatar.png?size=128`;
  const defUrl=`https://cdn.discordapp.com/embed/avatars/${idx2}.png`;
  box.innerHTML=`<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(88,101,242,.1);border:1px solid rgba(88,101,242,.25);border-radius:10px;">
    <img src="${avaUrl}" onerror="this.src='${defUrl}'" style="width:38px;height:38px;border-radius:50%;border:2px solid #7289da;object-fit:cover;flex-shrink:0;">
    <div>
      <div style="font-family:'Barlow Condensed';font-size:13px;font-weight:700;color:#7289da;">Discord ID Found</div>
      <div style="font-size:10px;color:var(--gray);">ID: ${id} — click Continue</div>
    </div>
  </div>`;
}

async function stepLookupDiscord(){
  clearAMsgs();
  const id=(document.getElementById('a-discord')?.value||'').trim();
  if(!id||!/^\d{17,20}$/.test(id)){ aerrMsg('Please enter a valid Discord ID (17–20 digits).'); return; }

  // Check if already registered
  if(lu().find(x=>x.discordId===id)){
    aerrMsg('This Discord ID is already registered. Please sign in instead.');
    return;
  }

  const idx2 = Number(BigInt(id)%6n);
  const defUrl = `https://cdn.discordapp.com/embed/avatars/${idx2}.png`;

  // ── Check imported Discord member list first (exported from bot) ──
  const members = lm();
  const member  = members[id];
  let displayName, avatarUrl, foundInServer;

  if(member){
    // Real data from bot export — show actual name & avatar
    displayName   = member.displayName || member.username || 'Discord User';
    avatarUrl     = member.avatarHash
      ? `https://cdn.discordapp.com/avatars/${id}/${member.avatarHash}.png?size=256`
      : `https://cdn.discordapp.com/embed/avatars/${member.defaultIndex ?? idx2}.png`;
    foundInServer = true;
  } else {
    // Not in imported list — still allow, show generic
    displayName   = 'Discord User';
    avatarUrl     = defUrl;
    foundInServer = false;
  }

  _regData={ discordId:id, displayName, avatarUrl, defaultAvaUrl:defUrl, foundInServer };
  _regStep=2;
  clearAMsgs();
  renderABody();
}

function stepConfirmYes(){ _regStep=3; renderABody(); }
function stepConfirmNo(){ _regStep=1; _regData={}; renderABody(); aokMsg('Enter your correct Discord ID below.'); }

async function doReg(){
  clearAMsgs();
  const p  = (document.getElementById('a-pass')?.value||'');
  const p2 = (document.getElementById('a-pass2')?.value||'');
  const d  = _regData;

  if(!p){ aerrMsg('Please enter a password.'); return; }
  if(p.length<6){ aerrMsg('Password must be at least 6 characters.'); return; }
  if(p!==p2){ aerrMsg('Passwords do not match.'); return; }
  if(!d.discordId){ aerrMsg('Something went wrong. Please start over.'); _regStep=1; renderABody(); return; }

  aokMsg('Checking… please wait.');
  const ipData=await getIP();

  const username = (d.displayName||'user').toLowerCase().replace(/[^a-z0-9_]/g,'_').slice(0,20)||`user_${d.discordId.slice(-4)}`;
  const isAd = (username===ADMIN || d.discordId==='394827165038291746');

  const newUser={
    id:uid(),
    username,
    displayName: (d.foundInServer && d.displayName && d.displayName!=='Discord User') ? d.displayName : username,
    pwh:hp(p),
    discordId:d.discordId,
    discordAvatar:d.avatarUrl,
    role: isAd?'admin':'pending',
    createdAt:Date.now(),
    emailVerified: isAd ? true : false,
    country:ipData.country,
    countryCode:(ipData.countryCode||ipData.country_code||'').toUpperCase().trim(),
    playerProfile: isAd?{tier:'Tier 1',nation:'',value:0,goals:0,assists:0,avatar:'',shooting:99,passing:99,dribbling:99,pace:99,defending:99,physical:99}:null
  };

  const users=lu(); users.push(newUser); su(users);

  if(isAd){
    ss(newUser);
    document.getElementById('aov').classList.remove('open');
    _regStep=1; _regData={};
    renderNav(); refreshAll();
    toast(`Welcome ${d.displayName}! Admin access granted.`,'ok');
    return;
  }

  ss(newUser);
  _regStep=1; _regData={};

  // Show "waiting for approval" screen inside the auth modal
  const ab=document.getElementById('abody');
  if(ab){
    ab.innerHTML=`
      <div style="display:flex;flex-direction:column;align-items:center;gap:14px;padding:10px 0 4px;text-align:center;">
        <div style="width:64px;height:64px;background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.25);border-radius:18px;display:flex;align-items:center;justify-content:center;margin:0 auto;"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
        <div class="atitl" style="margin-bottom:0;">Account Submitted!</div>
        <div class="asub" style="margin-bottom:0;">Your appeal is now being reviewed by an admin.</div>
        <div style="background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);border-radius:14px;padding:18px 20px;width:100%;text-align:left;">
          <div style="font-family:'Barlow Condensed';font-size:13px;font-weight:800;color:#fbbf24;letter-spacing:1px;margin-bottom:8px;">WHAT HAPPENS NEXT?</div>
          <div style="font-size:12px;color:rgba(251,191,36,.85);line-height:1.8;">
            1. Admin will review your registration<br>
            2. You'll get access once they approve it<br>
            3. If rejected, your account will be removed
          </div>
        </div>
        <div style="font-size:11px;color:var(--gray);line-height:1.6;">You can close this window. Sign in later once you've been approved.</div>
        <button class="abtn2" onclick="document.getElementById('aov').classList.remove('open')" style="margin-top:4px;">Close</button>
      </div>`;
  }

  const _regCc = (ipData.countryCode||ipData.country_code||'').toUpperCase().trim();
  const _regFlag = countryFlag(_regCc);
  sendWebhook({
    title:'⏳ New Registration — Pending Approval',
    color:0xfbbf24,
    description:`**${d.displayName}** (Discord ID: \`${d.discordId}\`) is waiting for approval`,
    fields:[
      {name:'👤 Username',  value:`\`${username}\``, inline:true},
      {name:`${_regFlag||'🌍'} Country`, value:`\`${ipData.country||'Unknown'}\`${_regCc?' ('+_regCc+')':''}`, inline:true},
      {name:'🕐 Time',     value:`\`${fmtTime(Date.now())}\``, inline:true},
    ],
    footer:{text:'PHM — Go to Members panel to Approve or Reject'},
    timestamp:new Date().toISOString()
  });

  renderNav(); refreshAll();
  toast('Account created! Waiting for admin approval','ok');
}

async function doLogin(){
  clearAMsgs();
  const discordId=(document.getElementById('a-discord-login')?.value||'').trim();
  const p=(document.getElementById('a-pass')?.value||'');
  if(!discordId||!p){ aerrMsg('Fill in your Discord ID and password.'); return; }
  if(!/^\d{17,20}$/.test(discordId)){ aerrMsg('Discord ID must be 17–20 digits.'); return; }

  const found=lu().find(x=>x.discordId===discordId && x.pwh===hp(p));
  if(!found){
    aerrMsg('Wrong Discord ID or password.');
    const ipData=await getIP();
    await logSecurityAlert('Failed Login',`Wrong login attempt for Discord ID \`${discordId}\`.`,ipData);
    return;
  }

  const activeBan=isUserBanned(found.username);
  if(activeBan){
    const durStr=activeBan.permanent?'Permanently':`Until ${new Date(activeBan.until).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}`;
    const errEl=document.getElementById('aerr');
    errEl.innerHTML=`<div style="display:flex;gap:10px;align-items:flex-start;"><span style="font-size:20px;display:none"><div><div style="font-family:'Barlow Condensed';font-size:14px;font-weight:800;color:#f87171;">Account Banned</div><div style="font-size:11px;color:rgba(248,113,113,.8);line-height:1.6;"><strong style="color:#fca5a5">Reason:</strong> ${esc(activeBan.reason)}<br><strong style="color:#fca5a5">Duration:</strong> ${durStr}</div></div></div>`;
    errEl.classList.add('show'); return;
  }

  if(found.role==='pending'){
    // Let pending users in so they can see their status + appeal
    ss(found); document.getElementById('aov').classList.remove('open');
    renderNav(); refreshAll();
    toast(`Signed in — account pending admin approval`,'ok');
    return;
  }

  // Refresh Discord avatar on every login
  if(found.discordId){
    const users=lu(), idx=users.findIndex(x=>x.id===found.id);
    if(idx>=0){
      users[idx].discordAvatar=`https://cdn.discordapp.com/avatars/${found.discordId}/avatar.png?_=${Date.now()}`;
      su(users); found.discordAvatar=users[idx].discordAvatar;
    }
  }

  // Refresh country on login + update user record
  const ipData=await getIP();
  const loginCc=(ipData.countryCode||ipData.country_code||'').toUpperCase().trim();
  if(loginCc||ipData.country){
    const users2=lu(), idx2=users2.findIndex(x=>x.id===found.id);
    if(idx2>=0){
      if(loginCc) users2[idx2].countryCode=loginCc;
      if(ipData.country) users2[idx2].country=ipData.country;
      su(users2); found.countryCode=users2[idx2].countryCode; found.country=users2[idx2].country;
    }
  }

  ss(found);
  document.getElementById('aov').classList.remove('open');
  renderNav(); refreshAll();
  toast(`Welcome back, ${found.displayName||found.username}${found.role==='admin'?' [Admin]':''}!`,'ok');
  await logLogin(found,ipData);
}

// ═══════════════════════════════════════════
// APPEALS / PENDING APPROVALS PANEL
// ═══════════════════════════════════════════
function openAppeals(){
  if(!isAdmin()){ toast('No permission.','er'); return; }
  renderAppeals();
  document.getElementById('appeals-ov').classList.add('open');
}
function closeAppeals(){ document.getElementById('appeals-ov').classList.remove('open'); }

function renderAppeals(){
  const pending = lu().filter(u=>u.role==='pending');
  const body = document.getElementById('appeals-body');
  if(!pending.length){
    body.innerHTML=`<div class="empty" style="padding:30px 0;"><div style="font-size:32px;margin-bottom:10px;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg></div><h3 style="color:var(--gray);">No Pending Requests</h3><p style="font-size:12px;color:var(--gray2);">All caught up!</p></div>`;
    return;
  }
  body.innerHTML = pending.map(u=>{
    const avatarUrl = u.discordId
      ? `https://cdn.discordapp.com/avatars/${u.discordId}/avatar.png`
      : '';
    const defaultAvatar = u.discordId
      ? `https://cdn.discordapp.com/embed/avatars/${Number(BigInt(u.discordId)%6n)}.png`
      : '';
    const avatarHtml = avatarUrl
      ? `<img src="${avatarUrl}" onerror="this.src='${defaultAvatar}'" style="width:40px;height:40px;border-radius:50%;border:2px solid rgba(88,101,242,.4);margin-right:10px;flex-shrink:0;" alt="">`
      : `<div style="width:40px;height:40px;border-radius:50%;background:var(--card);display:flex;align-items:center;justify-content:center;margin-right:10px;flex-shrink:0;font-size:18px;font-family:'Barlow Condensed',sans-serif;font-weight:800;color:var(--gray);">?</div>`;
    return `<div class="appeal-card">
      <div style="display:flex;align-items:center;margin-bottom:8px;">
        ${avatarHtml}
        <div>
          <div class="appeal-user">${esc(u.username)}</div>
          <div class="appeal-meta">
            ${u.discordId ? `Discord: ${u.discordId} · ` : ''}
            ${fdate(u.createdAt)} · ${u.country||'Unknown'}
          </div>
        </div>
      </div>
      ${u.appeal ? `<div class="appeal-msg">"${esc(u.appeal)}"</div>` : `<div class="appeal-msg" style="color:var(--gray2);font-style:italic;">No message provided</div>`}
      <div class="appeal-acts">
        <button class="appeal-approve" onclick="openApproveModal('${u.id}','${esc(u.username)}','${u.discordId||''}')">Approve</button>
        <button class="appeal-reject" onclick="rejectUserWithReason('${u.id}','${esc(u.username)}')">Reject</button>
      </div>
    </div>`;
  }).join('');
}

// ── Approve Modal state ──
let _approveUserId=null, _approveAppealId=null;

function openApproveModal(userId, username, discordId){
  _approveUserId=userId; _approveAppealId=null;
  const idx2 = discordId ? Number(BigInt(discordId)%6n) : 0;
  const avaUrl = discordId ? `https://cdn.discordapp.com/avatars/${discordId}/avatar.png` : '';
  const defUrl = discordId ? `https://cdn.discordapp.com/embed/avatars/${idx2}.png` : '';
  document.getElementById('approve-username-inp').value = username;
  document.getElementById('approve-pfp-inp').value = avaUrl;
  document.getElementById('approve-discord-label').textContent = discordId ? `Discord ID: ${discordId}` : 'No Discord ID';
  _previewApprovePfp(avaUrl, defUrl, username);
  document.getElementById('approve-ov').classList.add('open');
  setTimeout(()=>document.getElementById('approve-username-inp').focus(),100);
}

function openApproveModalForAppeal(appealId, userId, username, discordId){
  _approveAppealId=appealId;
  openApproveModal(userId, username, discordId);
}

function _previewApprovePfp(url, fallback, username){
  const prev = document.getElementById('approve-pfp-preview');
  if(!prev) return;
  if(url){
    prev.innerHTML=`<img src="${url}" onerror="this.src='${fallback||''}'" style="width:70px;height:70px;border-radius:50%;object-fit:cover;border:3px solid rgba(16,185,129,.5);">`;
  } else {
    prev.innerHTML=`<div style="width:70px;height:70px;border-radius:50%;background:var(--blue2);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed';font-size:28px;font-weight:900;color:var(--white);border:3px solid rgba(16,185,129,.5);">${(username||'?')[0].toUpperCase()}</div>`;
  }
}

function onApprovePfpChange(){
  const url=(document.getElementById('approve-pfp-inp').value||'').trim();
  const uname=document.getElementById('approve-username-inp').value||'?';
  _previewApprovePfp(url,'',uname);
}

function closeApproveModal(){ document.getElementById('approve-ov').classList.remove('open'); }

function confirmApproveUser(){
  const uid=_approveUserId;
  const newName=(document.getElementById('approve-username-inp').value||'').trim().toLowerCase().replace(/[^a-z0-9_]/g,'_').slice(0,20);
  const pfpUrl=(document.getElementById('approve-pfp-inp').value||'').trim();
  if(!newName){ toast('Username cannot be empty.','er'); return; }

  const users=lu(), idx=users.findIndex(x=>x.id===uid);
  if(idx<0){ closeApproveModal(); return; }
  const admin=getU();
  const oldName=users[idx].username;

  users[idx].role='fan';
  users[idx].username=newName;
  users[idx].displayName=newName;
  users[idx].approvedAt=Date.now();
  users[idx].approvedBy=admin?.username||'admin';
  users[idx].approvalNotified=false;
  if(pfpUrl) users[idx].discordAvatar=pfpUrl;

  su(users);
  closeApproveModal();

  // If this came from an appeal, mark it accepted too
  if(_approveAppealId){
    const appeals=la(), aidx=appeals.findIndex(a=>a.id===_approveAppealId);
    if(aidx>=0){ appeals[aidx].status='accepted'; sa(appeals); }
  }

  // Send approval webhook with country
  const _approvedUser=users[idx];
  const _approvedCc=(_approvedUser.countryCode||'').toUpperCase();
  const _approvedFlag=countryFlag(_approvedCc);
  sendWebhook({
    title:'\u2705 Registration Approved',
    color:0x10b981,
    description:`**${newName}** has been approved by **${admin?.username||'admin'}**`,
    fields:[
      {name:'👤 Username',  value:`\`${newName}\`${oldName!==newName?` (was \`${oldName}\`)`:''} `,inline:true},
      {name:'🛡️ Approved By', value:`\`${admin?.username||'admin'}\``,inline:true},
      {name:`${_approvedFlag||'🌍'} Country`, value:`\`${_approvedUser.country||'Unknown'}\`${_approvedCc?' ('+_approvedCc+')':''}`,inline:true},
      {name:'🕐 Time',     value:`\`${fmtTime(Date.now())}\``,inline:true},
    ],
    footer:{text:'PHM Members System'},
    timestamp:new Date().toISOString()
  });

  toast(`${newName} approved`,'ok');
  renderAppeals(); renderAppealsList(); renderMembers(); refreshAll();
}

function approveUser(userId){
  // Fallback direct approve (no modal) – kept for compatibility
  const users=lu(), idx=users.findIndex(x=>x.id===userId);
  if(idx<0) return;
  const admin=getU();
  users[idx].role='fan';
  users[idx].approvedAt=Date.now();
  users[idx].approvedBy=admin?.username||'admin';
  users[idx].approvalNotified=false;
  su(users);
  sendWebhook({title:'Registration Approved',color:0x10b981,fields:[{name:'User',value:`\`${users[idx].username}\``,inline:true},{name:'Approved By',value:`\`${admin?.username||'admin'}\``,inline:true}],timestamp:new Date().toISOString()});
  toast(`${users[idx].username} approved!`,'ok');
  renderAppeals(); renderMembers();
}

function rejectUserWithReason(userId, username){
  // Open a small inline prompt
  const el = document.querySelector(`.appeal-card`);
  // Find the card for this user
  const cards = document.querySelectorAll('.appeal-card');
  let targetCard = null;
  cards.forEach(c=>{ if(c.innerHTML.includes(userId)) targetCard=c; });
  // Simple approach: show reason modal
  openRejectReasonModal(userId, username);
}

let _rejectUserId=null, _rejectUsername='';
function openRejectReasonModal(userId, username){
  _rejectUserId=userId; _rejectUsername=username;
  document.getElementById('rreason-name').textContent=username;
  document.getElementById('rreason-input').value='';
  document.getElementById('rreason-ov').classList.add('open');
}
function closeRejectReason(){ document.getElementById('rreason-ov').classList.remove('open'); }
function confirmRejectUser(){
  const reason=(document.getElementById('rreason-input').value||'').trim()||'Registration not approved.';
  const uid=_rejectUserId;
  const users=lu(), idx=users.findIndex(x=>x.id===uid);
  if(idx<0){ closeRejectReason(); return; }
  const admin=getU();
  const username=users[idx].username;
  // Store rejection info before deleting
  sendWebhook({
    title:'Registration Rejected',
    color:0xef4444,
    fields:[
      {name:'User',value:`\`${username}\``,inline:true},
      {name:'Rejected By',value:`\`${admin?.username||'admin'}\``,inline:true},
      {name:'Reason',value:reason,inline:false},
    ],
    timestamp:new Date().toISOString()
  });
  users.splice(idx,1);
  su(users);
  closeRejectReason();
  toast(`${username} rejected and removed.`,'ok');
  renderAppeals();
  renderMembers();
}

function rejectUser(userId){
  const users=lu(), idx=users.findIndex(x=>x.id===userId);
  if(idx<0) return;
  const admin=getU();
  const username=users[idx].username;
  sendWebhook({
    title:'Registration Rejected',
    color:0xef4444,
    fields:[
      {name:'User',value:`\`${username}\``,inline:true},
      {name:'Rejected By',value:`\`${admin?.username||'admin'}\``,inline:true},
    ],
    timestamp:new Date().toISOString()
  });
  users.splice(idx,1);
  su(users);
  toast(`${username} rejected and removed.`,'ok');
  renderAppeals();
  renderMembers();
}

// ═══════════════════════════════════════════
// APPEALS SYSTEM (written messages from pending users)
// ═══════════════════════════════════════════
const AK = 'phm_appeals_v1';
const la = () => { const v = _cache[AK]; return Array.isArray(v) ? v : []; };
const sa = d  => { _cache[AK]=d; gSet(AK,d); };

function openAppeal(){
  const u=getU(); if(!u){ toast('Please sign in.','er'); return; }
  if(u.role!=='pending'){ toast('Only pending accounts can submit appeals.','er'); return; }
  const existing = la().find(a=>a.userId===u.id && a.status==='pending');
  if(existing){ toast('You already have a pending appeal. Wait for admin review.','er'); return; }
  document.getElementById('appeal-discord').value = u.discordId||'';
  document.getElementById('appeal-msg').value = '';
  document.getElementById('appeal-count').textContent = '0';
  document.getElementById('appeal-ov').classList.add('open');
}
function closeAppeal(){ document.getElementById('appeal-ov').classList.remove('open'); }

async function submitAppeal(){
  const u=getU(); if(!u||u.role!=='pending'){ toast('Not allowed.','er'); return; }
  const dc  = (document.getElementById('appeal-discord')?.value||'').trim();
  const msg = (document.getElementById('appeal-msg')?.value||'').trim();
  if(!msg){ toast('Please write a message.','er'); return; }

  const appeal = {
    id: uid(),
    userId: u.id,
    username: u.username,
    discordTag: dc,
    discordId: u.discordId||'',
    message: msg,
    submittedAt: Date.now(),
    status: 'pending'
  };
  const appeals = la(); appeals.push(appeal); sa(appeals);

  sendWebhook({
    title:'New Appeal Submitted',
    color:0x60a5fa,
    fields:[
      {name:'User',    value:`\`${u.username}\``,        inline:true},
      {name:'Discord', value:`\`${dc||'N/A'}\``,         inline:true},
      {name:'Message', value:msg.slice(0,500),            inline:false},
      {name:'Time',    value:`\`${fmtTime(Date.now())}\``,inline:true},
    ],
    footer:{text:'PHM — Review via Approve Requests'},
    timestamp:new Date().toISOString()
  });

  closeAppeal();
  toast('Appeal submitted — admin will review it','ok');
  renderFanArea();
}

function openAppealsAdmin(){
  if(!isAdmin()){ toast('No permission.','er'); return; }
  renderAppealsList();
  document.getElementById('appeals-admin-ov').classList.add('open');
}
function closeAppealsAdmin(){ document.getElementById('appeals-admin-ov').classList.remove('open'); }

function renderAppealsList(){
  const el = document.getElementById('appeals-list'); if(!el) return;
  const pendingAppeals = la().filter(a=>a.status==='pending');
  if(!pendingAppeals.length){
    el.innerHTML=`<div style="text-align:center;padding:40px;color:var(--gray);font-family:'Barlow Condensed',sans-serif;font-size:14px;letter-spacing:1px;">NO PENDING APPEALS</div>`;
    return;
  }
  el.innerHTML = pendingAppeals.map(a=>{
    const user = lu().find(x=>x.id===a.userId);
    const discordId = a.discordId || user?.discordId || '';
    const ava = discordId
      ? `https://cdn.discordapp.com/avatars/${discordId}/avatar.png`
      : '';
    const defAva = discordId
      ? `https://cdn.discordapp.com/embed/avatars/${Number(BigInt(discordId)%6n)}.png`
      : '';
    const avatarHtml = ava
      ? `<img src="${ava}" onerror="this.src='${defAva}'" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid rgba(88,101,242,.4);">`
      : `<div style="width:40px;height:40px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-family:'Barlow Condensed';font-weight:800;font-size:16px;color:var(--blue3);">${a.username[0].toUpperCase()}</div>`;
    return `<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
        <div style="flex-shrink:0;">${avatarHtml}</div>
        <div style="flex:1;">
          <div style="font-family:'Barlow Condensed';font-size:15px;font-weight:800;color:var(--white);">${esc(a.username)}</div>
          <div style="font-size:10px;color:var(--gray);">${a.discordTag?`${esc(a.discordTag)} · `:''}${fmtTime(a.submittedAt)}</div>
        </div>
        <span style="font-size:9px;background:rgba(245,158,11,.15);color:#fbbf24;border:1px solid rgba(245,158,11,.3);border-radius:20px;padding:3px 10px;font-family:'Barlow Condensed';letter-spacing:1px;">APPEAL</span>
      </div>
      <div style="background:var(--bg2);border-radius:8px;padding:12px;font-size:12px;color:var(--gray);line-height:1.6;margin-bottom:12px;">${esc(a.message)}</div>
      <div style="display:flex;gap:8px;justify-content:flex-end;flex-direction:column;">
        <textarea id="appeal-reject-reason-${a.id}" placeholder="Rejection reason (shown to user)..." maxlength="200" rows="2" style="width:100%;background:var(--card2);border:1px solid var(--border2);border-radius:8px;padding:8px 10px;color:var(--white);font-family:inherit;font-size:11px;resize:none;outline:none;transition:border-color .2s;" onfocus="this.style.borderColor='var(--blue3)'" onblur="this.style.borderColor='var(--border2)'"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end;">
          <button onclick="rejectAppealMsg('${a.id}')" style="background:rgba(239,68,68,.1);color:#f87171;border:1px solid rgba(239,68,68,.25);border-radius:8px;padding:8px 18px;font-family:'Barlow Condensed';font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;min-height:34px;">Reject</button>
          <button onclick="openApproveModalForAppeal('${a.id}','${a.userId}','${esc(a.username)}','${a.discordId||''}')" style="background:rgba(16,185,129,.15);color:#34d399;border:1px solid rgba(16,185,129,.3);border-radius:8px;padding:8px 18px;font-family:'Barlow Condensed';font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;min-height:34px;">Accept &amp; Approve</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function acceptAppealMsg(appealId){
  const appeals=la(), idx=appeals.findIndex(a=>a.id===appealId); if(idx<0) return;
  const appeal=appeals[idx];
  appeals[idx].status='accepted'; sa(appeals);
  // Also approve the user account
  const users=lu(), uidx=users.findIndex(x=>x.id===appeal.userId);
  if(uidx>=0){ users[uidx].role='fan'; users[uidx].approvedAt=Date.now(); users[uidx].approvedBy=getU()?.username||'admin'; su(users); }
  sendWebhook({
    title:'Appeal Accepted — Account Approved',
    color:0x10b981,
    fields:[
      {name:'User',value:`\`${appeal.username}\``,inline:true},
      {name:'By',value:`\`${getU()?.username||'?'}\``,inline:true},
    ],
    timestamp:new Date().toISOString()
  });
  renderAppealsList(); renderAppeals(); renderMembers(); refreshAll();
  toast(`${appeal.username} approved via appeal`,'ok');
}

function rejectAppealMsg(appealId){
  const appeals=la(), idx=appeals.findIndex(a=>a.id===appealId); if(idx<0) return;
  const appeal=appeals[idx];
  const reasonEl=document.getElementById(`appeal-reject-reason-${appealId}`);
  const reason=(reasonEl?.value||'').trim()||'Your registration was not approved.';
  appeals[idx].status='rejected';
  appeals[idx].rejectReason=reason;
  sa(appeals);
  // Store rejection message on user record so they see it when logged in
  const users=lu(), uidx=users.findIndex(x=>x.id===appeal.userId);
  if(uidx>=0){
    users[uidx].rejectionReason=reason;
    users[uidx].rejectedAt=Date.now();
    su(users);
  }
  sendWebhook({
    title:'Appeal Rejected',
    color:0xef4444,
    fields:[
      {name:'User',value:`\`${appeals[idx].username}\``,inline:true},
      {name:'By',value:`\`${getU()?.username||'?'}\``,inline:true},
      {name:'Reason',value:reason,inline:false},
    ],
    timestamp:new Date().toISOString()
  });
  renderAppealsList();
  toast('Appeal rejected.','ok');
}

// ═══════════════════════════════════════════
// DISCORD ID — AVATAR HELPER
// ═══════════════════════════════════════════
async function previewDiscord(){
  const id = (document.getElementById('mp-discord')?.value||'').trim();
  const prev = document.getElementById('mp-discord-preview');
  const avaEl = document.getElementById('mp-discord-ava');
  const nameEl = document.getElementById('mp-discord-name');
  if(!id || !/^\d{17,20}$/.test(id)){ toast('Enter a valid Discord ID (17–20 digits)','er'); return; }
  const idx2 = Number(BigInt(id) % 6n);
  avaEl.src = `https://cdn.discordapp.com/embed/avatars/${idx2}.png`;
  nameEl.textContent = `ID: ${id}`;
  prev.style.display = 'flex';
  toast('Discord ID saved! Your real avatar will load after saving.','ok');
}

// ═══════════════════════════════════════════
// RESET DATABASE
// ═══════════════════════════════════════════
function openResetModal(){
  if(!isAdmin()){toast('No permission.','er');return;}
  document.getElementById('reset-confirm-input').value='';
  checkResetInput();
  document.getElementById('reset-ov').classList.add('open');
}
function closeResetModal(e){
  if(!e||e.target===document.getElementById('reset-ov'))
    document.getElementById('reset-ov').classList.remove('open');
}
function checkResetInput(){
  const val = document.getElementById('reset-confirm-input').value.trim();
  const btn = document.getElementById('reset-confirm-btn');
  const ok = val === 'RESET';
  btn.disabled = !ok;
  btn.style.cursor = ok ? 'pointer' : 'not-allowed';
  btn.style.background = ok ? '#ef4444' : 'rgba(239,68,68,.2)';
  btn.style.color = ok ? '#fff' : 'rgba(248,113,113,.4)';
  btn.style.border = ok ? 'none' : '1px solid rgba(239,68,68,.2)';
  btn.style.boxShadow = ok ? '0 0 20px rgba(239,68,68,.4)' : 'none';
}
function executeReset(){
  if(!isAdmin()) return;
  if(document.getElementById('reset-confirm-input').value.trim() !== 'RESET') return;

  // Wipe global shared storage
  Promise.all([gDel(UK), gDel(IK), gDel(BK), gDel(TK)]).catch(()=>{});

  // Wipe every PHM key from localStorage
  Object.keys(localStorage)
    .filter(k => k.startsWith('phm_'))
    .forEach(k => localStorage.removeItem(k));

  localStorage.setItem('phm_init_v9','1');
  document.getElementById('reset-ov').classList.remove('open');
  ss(null);
  toast('Database wiped. Reloading…','ok');
  setTimeout(()=>{ location.reload(); }, 1500);
}

// ═══════════════════════════════════════════
// TEAMS — LA LIGA 2024/25
// ═══════════════════════════════════════════
const LALIGA_TEAMS = [
  {id:'atleti',  name:'Atlético Madrid',  short:'ATM', city:'Madrid',    logo:'https://crests.football-data.org/78.png',  color:'#CC0000'},
  {id:'barca',   name:'FC Barcelona',     short:'BAR', city:'Barcelona', logo:'https://crests.football-data.org/81.png',  color:'#A50044'},
  {id:'osasuna', name:'CA Osasuna',       short:'OSA', city:'Pamplona',  logo:'https://crests.football-data.org/79.png',  color:'#CC0000'},
  {id:'girona',  name:'Girona FC',        short:'GIR', city:'Girona',    logo:'https://crests.football-data.org/298.png', color:'#CC0000'},
  {id:'athletic',name:'Athletic Bilbao',  short:'ATH', city:'Bilbao',    logo:'https://crests.football-data.org/77.png',  color:'#CC0000'},
  {id:'real',    name:'Real Madrid',      short:'RMA', city:'Madrid',    logo:'https://crests.football-data.org/86.png',  color:'#F8F8F8'},
  {id:'betis',   name:'Real Betis',       short:'BET', city:'Sevilla',   logo:'https://crests.football-data.org/90.png',  color:'#00A650'},
  {id:'villar',  name:'Villarreal CF',    short:'VIL', city:'Villarreal',logo:'https://crests.football-data.org/94.png',  color:'#FFD700'},
];

// Team data stored in localStorage (managers, etc)

let currentTeamId = null;

function getTeamData(teamId){ return lt()[teamId]||{}; }

function renderTeams(){
  const grid = document.getElementById('teams-grid');
  if(!grid) return;
  const tdata = lt();
  grid.innerHTML = LALIGA_TEAMS.map(t => {
    const players = getTeamPlayers(t.id);
    const td = tdata[t.id]||{};
    const mgr = td.manager;
    const playerBadge = players.length > 0
      ? `<span class="team-card-badge">${players.length} players</span>`
      : `<span class="team-card-badge" style="background:rgba(122,138,170,.06);color:var(--gray2);border-color:var(--border2);">No Squad</span>`;
    const mgrBadge = mgr
      ? `<span class="team-card-mgr">${esc(mgr)}</span>` : '';
    return `<div class="team-card" onclick="openTeam('${t.id}')">
      <div class="team-card-banner" style="background:${t.color};"></div>
      <div class="team-card-body">
        <img class="team-logo-img" src="${t.logo}" alt="${t.name}" onerror="this.style.opacity='.3'">
        <div class="team-card-name">${t.name}</div>
        <div class="team-card-city">${t.city}</div>
        <div class="team-card-footer">${playerBadge}${mgrBadge}</div>
      </div>
    </div>`;
  }).join('');
}

function getTeamPlayers(teamId){
  return lu().filter(u => (u.role==='player'||u.role==='admin') && u.playerProfile?.team === teamId);
}

function openTeam(teamId){
  const t = LALIGA_TEAMS.find(x=>x.id===teamId);
  if(!t) return;
  currentTeamId = teamId;
  const players = getTeamPlayers(teamId);
  const td = getTeamData(teamId);

  // Color bar
  document.getElementById('team-color-bar').style.background = t.color;
  document.getElementById('team-logo').src = t.logo;
  document.getElementById('team-logo').alt = t.name;
  document.getElementById('team-name').textContent = t.name;
  document.getElementById('team-sub').textContent = `La Liga  ·  ${t.city}`;

  // Stats
  const totalGoals = players.reduce((s,u)=>s+(+(u.playerProfile?.goals)||0),0);
  const totalAssists = players.reduce((s,u)=>s+(+(u.playerProfile?.assists)||0),0);
  const avgRat = players.length ? Math.round(players.reduce((s,u)=>s+calcAvg(u.playerProfile||{}),0)/players.length) : 0;
  const bestTier = players.length ? (['Tier 1','Tier 2','Tier 3','Tier 4'].find(tr=>players.some(u=>u.playerProfile?.tier===tr))||'—') : '—';
  document.getElementById('team-stats-row').innerHTML = [
    ['Squad', players.length],
    ['Avg OVR', avgRat||'—'],
    ['Goals', totalGoals],
    ['Assists', totalAssists],
    ['Best', bestTier],
  ].map(([l,v])=>`<div class="tstat"><div class="tstat-n">${v}</div><div class="tstat-l">${l}</div></div>`).join('');

  // Manager bar
  const mgr = td.manager||'';
  document.getElementById('team-mgr-name').textContent = mgr || 'Not assigned';
  document.getElementById('team-mgr-name').style.color = mgr ? 'var(--white)' : 'var(--gray)';
  const editBtn = document.getElementById('team-mgr-edit');
  if(editBtn) editBtn.style.display = isAdmin() ? '' : 'none';

  // Admin Add Player button
  const adminBtn = document.getElementById('team-squad-admin');
  if(adminBtn) adminBtn.style.display = isAdmin() ? '' : 'none';

  // Players
  const tp = document.getElementById('team-players');
  if(!players.length){
    tp.innerHTML = `<div style="text-align:center;padding:32px 0;color:var(--gray);">
      <div style="width:40px;height:40px;background:var(--card);border:1px solid var(--border2);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--gray)" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 8v4m0 4h.01"/></svg></div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:800;letter-spacing:1px;margin-bottom:6px;">No Players Yet</div>
      <div style="font-size:12px;">No registered players assigned to ${esc(t.name)}.</div>
    </div>`;
  } else {
    const sorted = [...players].sort((a,b)=>calcAvg(b.playerProfile||{})-calcAvg(a.playerProfile||{}));
    tp.innerHTML = sorted.map((u,i)=>{
      const pp=u.playerProfile||{};
      const avg=calcAvg(pp);
      const c=tcls(pp.tier||'Tier 4');
      const flag=userFlag(u);
      const avaHTML = pp.avatar&&pp.avatar.startsWith('http')
        ? `<img src="${pp.avatar}" onerror="this.outerHTML='<span style=font-size:15px;font-weight:800>${u.username[0].toUpperCase()}</span>'">`
        : `<span style="font-size:15px;font-weight:800;">${u.username[0].toUpperCase()}</span>`;
      const rank = i < 3 ? `<div style="font-size:14px;flex-shrink:0;width:20px;text-align:center;">${['01','02','03'][i]}</div>` : `<div style="font-family:'Barlow Condensed';font-size:11px;color:var(--gray2);flex-shrink:0;width:20px;text-align:center;">${i+1}</div>`;
      const removeBtn = isAdmin() ? `<button onclick="event.stopPropagation();removeFromTeam('${u.id}')" style="font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;padding:3px 8px;border-radius:6px;border:1px solid rgba(239,68,68,.25);background:rgba(239,68,68,.06);color:#f87171;cursor:pointer;letter-spacing:.5px;flex-shrink:0;">Remove</button>` : '';
      const bestBadge = i===0 ? `<span class="best-player-badge">Best</span>` : '';
      // FIFA mini attrs row
      const miniAttrs = STATS.map(s=>{
        const v=+(pp[s.toLowerCase()])||60;
        const col=v>=85?'#34d399':v>=70?'#60a5fa':v>=55?'#fbbf24':'#f87171';
        return `<span style="font-family:'Orbitron',monospace;font-size:9px;font-weight:900;color:${col};background:rgba(0,0,0,.3);padding:1px 4px;border-radius:3px;">${v}</span>`;
      }).join('');
      return `<div class="tp-row" onclick="closeTeam();setTimeout(()=>openPlayerDetail('${u.id}'),200)" style="cursor:pointer;">
        ${rank}
        <div class="tp-ava">${avaHTML}</div>
        <div class="tp-info">
          <div class="tp-name">${flag} ${esc(u.username)} ${bestBadge}</div>
          <div class="tp-pos">${pp.position||'—'}  ·  ${pp.goals||0}G ${pp.assists||0}A  ·  ${(+(pp.value)||0).toFixed(1)}M</div>
          <div style="display:flex;gap:3px;margin-top:4px;flex-wrap:wrap;">${miniAttrs}</div>
        </div>
        <span class="tp-tier ${c}p">${pp.tier||'Tier 4'}</span>
        <div class="tp-rat">${avg}</div>
        ${removeBtn}
      </div>`;
    }).join('');
  }

  document.getElementById('team-ov').classList.add('open');
}

function closeTeam(e){
  if(!e||e.target===document.getElementById('team-ov'))
    document.getElementById('team-ov').classList.remove('open');
}

// ── Manager ──
function openSetManager(teamId){
  if(!isAdmin()){toast('No permission.','er');return;}
  const td = getTeamData(teamId);
  document.getElementById('mgr-input').value = td.manager||'';
  document.getElementById('mgr-ov').classList.add('open');
  setTimeout(()=>document.getElementById('mgr-input').focus(),100);
}
function saveManager(){
  if(!isAdmin()) return;
  const name = document.getElementById('mgr-input').value.trim();
  const tdata = lt();
  if(!tdata[currentTeamId]) tdata[currentTeamId]={};
  tdata[currentTeamId].manager = name;
  st(tdata);
  document.getElementById('mgr-ov').classList.remove('open');
  openTeam(currentTeamId); // refresh
  renderTeams();
  toast(`Manager set: ${name||'removed'}`,'ok');
}

// ── Assign Player ──
function openAssignPlayer(teamId){
  if(!isAdmin()){toast('No permission.','er');return;}
  const all = lu().filter(u=>(u.role==='player'||u.role==='admin'));
  const current = getTeamPlayers(teamId).map(u=>u.id);
  const available = all.filter(u=>!current.includes(u.id));
  const sel = document.getElementById('assign-player-select');
  sel.innerHTML = available.length
    ? available.map(u=>`<option value="${u.id}">${esc(u.username)} (${u.playerProfile?.tier||'Tier 4'} · ${calcAvg(u.playerProfile||{})} OVR${u.playerProfile?.team?' · currently '+((LALIGA_TEAMS.find(t=>t.id===u.playerProfile.team)||{}).short||u.playerProfile.team):''})</option>`).join('')
    : `<option value="">No available players</option>`;
  document.getElementById('assign-ov').classList.add('open');
}
function saveAssignPlayer(){
  if(!isAdmin()) return;
  const uid = document.getElementById('assign-player-select').value;
  if(!uid){toast('Select a player.','er');return;}
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0)return;
  if(!users[idx].playerProfile) users[idx].playerProfile={};
  users[idx].playerProfile.team = currentTeamId;
  users[idx].playerProfile.lastEditedAt = Date.now();
  users[idx].playerProfile.lastEditedBy = getU()?.username||'admin';
  su(users);
  document.getElementById('assign-ov').classList.remove('open');
  openTeam(currentTeamId);
  renderTeams(); refreshAll();
  const t = LALIGA_TEAMS.find(x=>x.id===currentTeamId);
  toast(`${users[idx].username} added to ${t?.name||currentTeamId}`,'ok');
}
function removeFromTeam(uid){
  if(!isAdmin()){toast('No permission.','er');return;}
  const users=lu(); const idx=users.findIndex(x=>x.id===uid); if(idx<0)return;
  const uname = users[idx].username;
  if(!users[idx].playerProfile) return;
  users[idx].playerProfile.team = '';
  users[idx].playerProfile.lastEditedAt = Date.now();
  users[idx].playerProfile.lastEditedBy = getU()?.username||'admin';
  su(users);
  openTeam(currentTeamId);
  renderTeams(); refreshAll();
  toast(`${uname} removed from team`,'ok');
}

// ═══════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════
function uid(){ return Math.random().toString(36).slice(2,10)+Date.now().toString(36); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ═══════════════════════════════════════════
// USERNAME INPUT FORMATTER
// ═══════════════════════════════════════════
function formatUsernameInput(el){
  let v = el.value;
  // Remove emoji and non-ASCII symbols, replace spaces with _
  // Strip emojis and special unicode
  v = v.replace(/[\u{1F000}-\u{1FFFF}]/gu, '')  // emoji ranges
       .replace(/[\u{2600}-\u{26FF}]/gu, '')       // misc symbols
       .replace(/[\u{2700}-\u{27BF}]/gu, '')       // dingbats
       .replace(/[\u{FE00}-\u{FE0F}]/gu, '')       // variation selectors
       .replace(/[\u{1F900}-\u{1F9FF}]/gu, '')     // supplemental symbols
       .replace(/\s+/g, '_')                        // spaces → underscore
       .replace(/[^a-zA-Z0-9_]/g, '')              // remove anything else
       .toLowerCase()
       .slice(0, 20);
  // Avoid double underscores at start
  if(el.value !== v) el.value = v;
}


const _su = su;
// Session auto-refresh: if logged-in user's record changes, update session too
function syncSession(){
  const s=ls(); if(!s) return;
  const fresh=lu().find(x=>x.id===s.id);
  if(fresh) ss(fresh);
}

// ═══════════════════════════════════════════
// ADVANCED CHAT SYSTEM v2
// ═══════════════════════════════════════════

const lc = () => { const v=_cache[CK]; return Array.isArray(v)?v:[]; };
const sc = d  => { _cache[CK]=d; dbSave(); };

// ── State ──
let _renderedMsgIds  = new Set();
let _chatReplyId     = null;
let _chatEditId      = null;
let _chatSearchQuery = '';
let _chatSearchHits  = [];
let _chatSearchIdx   = 0;
let _unreadCount     = 0;
let _firstUnreadId   = null;
let _newSepInserted  = false;

// ── Ably ──
const ABLY_KEY = 'WBblRg.JpGGOA:y-dYwMl4Yij7GqFl1G0HJiQgJEMTZa3ZtNEPFFp047c';
const ABLY_CH  = 'phm-chat-v2';
let _pn = null, _pnConnected = false;
let _typingUsers = {}, _typingTimeout = null;
let _onlineUsers = {};

// ── Emoji sets ──
const EMOJI_SETS = {
  '⚽': ['⚽','🏆','👑','💪','🎯','🔥','😤','🤌','🐐','⭐','🥇','🏅'],
  '😂': ['😂','🤣','😭','😮','❤️','👏','😈','🥶','💀','🤝','😊','🎉'],
};

// ── Access check ──
function canChat(){
  const u=getU();
  if(!u) return false;
  if(u.role!=='player'&&u.role!=='admin') return false;
  if(!u.chatEmailVerified) return false;
  return true;
}

// ════════════════════════════
// EMAIL OTP VERIFY (kept same)
// ════════════════════════════
let _chatOTP = { code:'', expiry:0, email:'', step:1 };
let _chatOTPTimer = null;

function _chatVerifyEmailUI(){
  if(_chatOTP.step===2){
    const s=Math.max(0,Math.floor((_chatOTP.expiry-Date.now())/1000));
    return `<div class="chat-locked">
      <div class="chat-otp-box">
        <div style="font-size:40px">📧</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:900;letter-spacing:2px;color:var(--white);">CHECK YOUR EMAIL</div>
        <div style="font-size:12px;color:var(--gray);text-align:center;">Code sent to <strong style="color:var(--blue3);">${esc(_chatOTP.email)}</strong></div>
        <input id="chat-otp-inp" class="chat-otp-input" type="text" inputmode="numeric" maxlength="6" placeholder="000000"
          oninput="this.value=this.value.replace(/\\D/g,'').slice(0,6)"
          onkeydown="if(event.key==='Enter')chatVerifyOTP()">
        <div id="chat-otp-err" style="font-size:11px;color:#f87171;min-height:14px;text-align:center;"></div>
        <div style="font-size:11px;color:#fbbf24;font-family:'Barlow Condensed';letter-spacing:1px;">⏱ Expires in <span id="chat-otp-secs">${s}</span>s</div>
        <button onclick="chatVerifyOTP()" style="font-family:'Barlow Condensed';font-size:13px;font-weight:800;letter-spacing:3px;text-transform:uppercase;background:var(--blue);color:#fff;border:none;padding:12px 28px;border-radius:10px;cursor:pointer;box-shadow:0 0 20px var(--blueglow);width:100%;">VERIFY & JOIN →</button>
        <div style="display:flex;gap:20px;font-size:11px;">
          <a style="color:var(--gray);cursor:pointer;" onclick="chatEmailVerifyBack()">← Change email</a>
          <a style="color:var(--blue3);cursor:pointer;" onclick="chatResendOTP()">Resend code</a>
        </div>
      </div>
    </div>`;
  }
  return `<div class="chat-locked">
    <div class="chat-otp-box">
      <div class="chat-locked-ico" style="background:rgba(30,111,255,.1);border-color:rgba(30,111,255,.3);">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--blue3)" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      </div>
      <h3>Verify Your Email</h3>
      <p>Enter your email to get a one-time code and unlock squad chat.</p>
      <input id="chat-email-inp" type="email" placeholder="you@example.com"
        style="background:var(--bg);border:1px solid rgba(30,111,255,.3);border-radius:10px;padding:12px 16px;color:var(--white);font-family:'Barlow',sans-serif;font-size:14px;outline:none;width:100%;box-sizing:border-box;text-align:center;"
        onkeydown="if(event.key==='Enter')chatSendOTP()">
      <div id="chat-email-err" style="font-size:11px;color:#f87171;min-height:14px;text-align:center;"></div>
      <button onclick="chatSendOTP()" id="chat-send-otp-btn" style="font-family:'Barlow Condensed';font-size:13px;font-weight:800;letter-spacing:3px;text-transform:uppercase;background:var(--blue);color:#fff;border:none;padding:12px 28px;border-radius:10px;cursor:pointer;box-shadow:0 0 20px var(--blueglow);width:100%;">SEND CODE →</button>
    </div>
  </div>`;
}

function _startChatOTPTimer(){
  clearInterval(_chatOTPTimer);
  const el=()=>document.getElementById('chat-otp-secs');
  let secs=Math.max(0,Math.floor((_chatOTP.expiry-Date.now())/1000));
  if(el()) el().textContent=secs;
  _chatOTPTimer=setInterval(()=>{ secs--; if(el()) el().textContent=Math.max(0,secs); if(secs<=0) clearInterval(_chatOTPTimer); },1000);
}

async function chatSendOTP(){
  const emailInp=document.getElementById('chat-email-inp');
  const errEl=document.getElementById('chat-email-err');
  const btn=document.getElementById('chat-send-otp-btn');
  const email=(emailInp?.value||'').trim().toLowerCase();
  if(errEl) errEl.style.display='none';
  if(!email||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ if(errEl){errEl.textContent='Enter a valid email.';errEl.style.display='block';} return; }
  const u=getU(); if(!u){toast('Please sign in.','er');return;}
  if(btn){btn.disabled=true;btn.textContent='Sending…';}
  const code=Math.floor(100000+Math.random()*900000).toString();
  const expiry=Date.now()+10*60*1000;
  try{
    const result=await emailjs.send(EJS_SERVICE,EJS_TEMPLATE,{to_email:email,username:u.username,code,year:new Date().getFullYear()},{publicKey:EJS_KEY});
    _chatOTP={code,expiry,email,step:2};
    const body=document.getElementById('chat-body');
    if(body){body.innerHTML=_chatVerifyEmailUI();_startChatOTPTimer();}
  }catch(e){
    if(btn){btn.disabled=false;btn.textContent='SEND CODE →';}
    const msg=e?.text||e?.message||JSON.stringify(e)||'Unknown error';
    if(errEl){errEl.textContent='EmailJS error: '+msg;errEl.style.display='block';}
  }
}

async function chatResendOTP(){
  const u=getU(); if(!u) return;
  const code=Math.floor(100000+Math.random()*900000).toString();
  const expiry=Date.now()+10*60*1000;
  try{
    await emailjs.send(EJS_SERVICE,EJS_TEMPLATE,{to_email:_chatOTP.email,username:u.username,code,year:new Date().getFullYear()},{publicKey:EJS_KEY});
    _chatOTP.code=code; _chatOTP.expiry=expiry;
    toast('New code sent!','ok'); _startChatOTPTimer();
  }catch(e){ toast('Resend error: '+(e?.text||e?.message||JSON.stringify(e)),'er'); }
}

function chatEmailVerifyBack(){
  _chatOTP={code:'',expiry:0,email:'',step:1}; clearInterval(_chatOTPTimer);
  const body=document.getElementById('chat-body'); if(body) body.innerHTML=_chatVerifyEmailUI();
}

function chatVerifyOTP(){
  const inp=document.getElementById('chat-otp-inp');
  const errEl=document.getElementById('chat-otp-err');
  const entered=(inp?.value||'').trim();
  if(errEl) errEl.style.display='none';
  if(!entered||entered.length!==6){ if(errEl){errEl.textContent='Enter the 6-digit code.';errEl.style.display='block';} return; }
  if(Date.now()>_chatOTP.expiry){ if(errEl){errEl.textContent='Code expired. Request a new one.';errEl.style.display='block';} return; }
  if(entered!==_chatOTP.code){ if(errEl){errEl.textContent='Incorrect code. Try again.';errEl.style.display='block';} return; }
  clearInterval(_chatOTPTimer);
  _chatOTP={code:'',expiry:0,email:'',step:1};
  const u=getU();
  const users=lu();
  const idx=users.findIndex(x=>x.id===u.id);
  if(idx>=0){ users[idx].chatEmailVerified=true; su(users); ss(users[idx]); }
  toast('Email verified! Welcome to squad chat 🎉','ok');
  _renderedMsgIds.clear();
  renderChat();
}

// ════════════════════════════
// RENDER SYSTEM
// ════════════════════════════

function renderChat(){
  const body=document.getElementById('chat-body');
  if(!body) return;
  const u=getU();

  // Not logged in
  if(!u){
    _renderedMsgIds.clear();
    body.innerHTML=`<div class="chat-locked">
      <div class="chat-locked-ico"><svg viewBox="0 0 24 24" fill="none" stroke="var(--gray)" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
      <h3>SIGN IN REQUIRED</h3>
      <p>Sign in to access the squad chat.</p>
    </div>`;
    return;
  }

  // Not a player/admin
  if(u.role!=='player'&&u.role!=='admin'){
    _renderedMsgIds.clear();
    body.innerHTML=`<div class="chat-locked">
      <div class="chat-locked-ico"><svg viewBox="0 0 24 24" fill="none" stroke="var(--gray)" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div>
      <h3>PLAYERS ONLY</h3>
      <p>Contact admin to get player access.</p>
    </div>`;
    return;
  }

  // Email not verified
  if(!u.chatEmailVerified){
    _renderedMsgIds.clear();
    body.innerHTML=_chatVerifyEmailUI();
    return;
  }

  // Already rendered — just append new messages
  if(document.getElementById('chat-msgs')){
    chatAppendNew();
    updateChatMsgCount();
    return;
  }

  // Full render
  _renderedMsgIds.clear();
  _newSepInserted=false;
  _firstUnreadId=null;
  const msgs=lc();
  const u2=getU();

  let html='', lastDate='', lastUid='', lastTs=0;
  const MAX=200;
  const slice=msgs.slice(-MAX);

  slice.forEach((msg,i)=>{
    const d=new Date(msg.ts);
    const ds=d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});
    if(ds!==lastDate){ html+=`<div class="chat-day-divider"><span>${ds}</span></div>`; lastDate=ds; lastUid=''; }
    const grouped=(msg.uid===lastUid&&(msg.ts-lastTs)<120000);
    html+=buildMsgHTML(msg,slice,u2,grouped);
    _renderedMsgIds.add(msg.id);
    lastUid=msg.uid; lastTs=msg.ts;
  });

  if(!msgs.length) html=`<div style="text-align:center;padding:60px 20px;color:var(--gray2);font-family:'Barlow Condensed';font-size:12px;letter-spacing:3px;opacity:.6;">NO MESSAGES YET — SAY SOMETHING 👋</div>`;

  body.innerHTML=`
    <div class="chat-msgs" id="chat-msgs" data-ld="${lastDate}" data-lu="" data-lt="0">${html}</div>
    <button class="chat-scroll-badge" id="chat-scroll-badge" onclick="scrollToBottom()">
      <svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
      <span id="chat-scroll-badge-txt">↓ New messages</span>
    </button>
    <div class="chat-reply-bar" id="chat-reply-bar">
      <div class="chat-reply-bar-icon"><svg viewBox="0 0 24 24"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 0 0-4-4H4"/></svg></div>
      <span class="chat-reply-preview" id="chat-reply-preview"></span>
      <button class="chat-reply-close" onclick="clearChatReply()"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="chat-edit-bar" id="chat-edit-bar">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      <span class="chat-edit-bar-lbl">Editing message</span>
      <span style="flex:1;"></span>
      <button class="chat-edit-cancel-btn" onclick="cancelChatEdit()">Cancel</button>
    </div>
    ${_buildInputBar()}`;

  // Scroll to bottom
  requestAnimationFrame(()=>{
    const el=document.getElementById('chat-msgs');
    if(el) el.scrollTop=el.scrollHeight;
    el?.addEventListener('scroll',_onMsgsScroll);
  });

  // Close emoji pickers on outside click
  document.addEventListener('click',_closeAllPickers);
  updateChatMsgCount();
}

function _buildInputBar(){
  const em1=EMOJI_SETS['⚽'];
  const em2=EMOJI_SETS['😂'];
  const tabHTML=(tab,active)=>`<div class="cemoji-tab${active?' on':''}" data-tab="${tab}" onclick="switchEmojiTab(this,'${tab}')">${tab}</div>`;
  const gridHTML=(emArr,hidden)=>`<div class="cemoji-grid" id="emoji-grid-${emArr[0]}" style="${hidden?'display:none':''}">
    ${emArr.map(e=>`<span onclick="insertEmoji('${e}');document.querySelector('.cemoji-picker.open')?.classList.remove('open')">${e}</span>`).join('')}
  </div>`;
  return `
    <input type="file" id="chat-file-input" accept="image/*,video/*" style="display:none" onchange="handleChatFile(this)">
    <div class="chat-input-area">
      <div class="chat-typing" id="chat-typing-bar"></div>
      <div class="chat-irow">
        <button class="chat-action-btn icon" onclick="document.getElementById('chat-file-input').click()" title="Upload photo/video">
          <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        </button>
        <div class="chat-input-main">
          <div class="ping-dropdown" id="ping-dropdown" style="display:none;"></div>
          <textarea id="chat-input" placeholder="Message the squad…" maxlength="500" rows="1"
            onkeydown="onChatKeyDown(event)"
            oninput="onChatInput(this);autoResizeTA(this);chatOnTyping();updateCharCounter(this)"></textarea>
          <span class="chat-char-counter" id="chat-char-counter">500</span>
        </div>
        <div class="cemoji-wrap">
          <button class="chat-action-btn icon" onclick="toggleEmojiPicker(event)" title="Emoji">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
          </button>
          <div class="cemoji-picker" id="cemoji-picker-main" onclick="event.stopPropagation()">
            <div class="cemoji-tabs">
              ${tabHTML('⚽',true)}${tabHTML('😂',false)}
            </div>
            ${gridHTML(em1,false)}${gridHTML(em2,true)}
          </div>
        </div>
        <button class="chat-action-btn send" id="chat-send-btn" onclick="sendChatMsg()" title="Send">
          <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>`;
}

function switchEmojiTab(el, tab){
  el.closest('.cemoji-picker').querySelectorAll('.cemoji-tab').forEach(t=>t.classList.remove('on'));
  el.classList.add('on');
  el.closest('.cemoji-picker').querySelectorAll('.cemoji-grid').forEach(g=>g.style.display='none');
  const grid=document.getElementById('emoji-grid-'+tab);
  if(grid) grid.style.display='';
}

function autoResizeTA(ta){
  ta.style.height='auto';
  ta.style.height=Math.min(ta.scrollHeight,100)+'px';
}

function updateCharCounter(ta){
  const remaining=500-(ta.value||'').length;
  const el=document.getElementById('chat-char-counter');
  if(!el) return;
  el.textContent=remaining;
  el.className='chat-char-counter'+(remaining<50?' warn':'')+(remaining<10?' danger':'');
}

// ════════════════════════════
// BUILD MESSAGE HTML
// ════════════════════════════

function buildMsgHTML(msg, msgs, u, grouped=false){
  const sender=lu().find(x=>x.id===msg.uid)||{username:msg.uname,role:'player'};
  const isOwn=msg.uid===u.id;
  const isAdm=sender.role==='admin';

  const teamId=msg.teamId||sender.playerProfile?.team||'';
  const team=teamId?(LALIGA_TEAMS||[]).find(t=>t.id===teamId):null;

  const d=new Date(msg.ts);
  const timeStr=d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});

  // Avatar
  const ppAva=sender.playerProfile?.avatar||sender.avatar||'';
  const dAva=sender.discordAvatar||(sender.discordId?`https://cdn.discordapp.com/avatars/${sender.discordId}/avatar.png`:'');
  const avaUrl=msg.senderAva||((ppAva&&ppAva.startsWith('http'))?ppAva:dAva);
  const defAva=sender.discordId?`https://cdn.discordapp.com/embed/avatars/${Number(BigInt(sender.discordId)%6n)}.png`:'';
  const avaHtml=avaUrl
    ?`<img src="${avaUrl}" onerror="this.onerror=null;this.src='${defAva}'">`
    :`<span>${(msg.uname||'?')[0].toUpperCase()}</span>`;

  // Badges
  const roleBadge=isAdm
    ?`<span class="chat-role-badge chat-role-admin">Admin</span>`
    :`<span class="chat-role-badge chat-role-player">Player</span>`;
  const teamBadge=team
    ?`<span class="chat-team-badge"><img src="${team.logo}" onerror="this.style.display='none'">${esc(team.name)}</span>`
    :'';

  // Reply quote
  let replyQuote='';
  if(msg.replyTo){
    const orig=msgs.find(m=>m.id===msg.replyTo);
    if(orig){
      const qtext=orig.media?'📷 Media':(orig.text||'').slice(0,60)+(orig.text?.length>60?'…':'');
      replyQuote=`<div class="cquote" onclick="scrollToMsg('${orig.id}')">
        <div class="cquote-sender">${esc(orig.uname)}</div>
        <div class="cquote-text">${esc(qtext)}</div>
      </div>`;
    }
  }

  // Media
  let mediaHtml='';
  if(msg.media){
    if(msg.mediaType==='video'){
      mediaHtml=`<div class="chat-media" onclick="openMediaFull('${msg.media}','video')">
        <video src="${msg.media}" playsinline muted style="pointer-events:none;"></video>
        <div class="chat-media-play"><svg viewBox="0 0 24 24" width="44" height="44"><circle cx="12" cy="12" r="12" fill="rgba(0,0,0,.5)"/><polygon points="10 8 16 12 10 16 10 8" fill="white"/></svg></div>
      </div>`;
    } else {
      mediaHtml=`<div class="chat-media" onclick="openMediaFull('${msg.media}','image')">
        <img src="${msg.media}" alt="image" loading="lazy">
      </div>`;
    }
  }

  // Text with @mentions highlighted + search highlight
  let renderText=(msg.text||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/@(\w+)/g,(m,name)=>{
      const isMe=name.toLowerCase()===u.username.toLowerCase();
      return `<span class="chat-ping${isMe?' me':''}">@${name}</span>`;
    });

  // Search highlight
  if(_chatSearchQuery){
    const q=_chatSearchQuery.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    renderText=renderText.replace(new RegExp(q,'gi'),m=>`<mark class="chat-search-hl">${m}</mark>`);
  }

  const editedTag=msg.edited?`<span class="chat-edited-tag"> · edited</span>`:'';

  // Reactions
  let reactHtml='';
  if(msg.reactions&&Object.keys(msg.reactions).length){
    reactHtml='<div class="chat-reactions">';
    Object.keys(msg.reactions).forEach(em=>{
      const voters=msg.reactions[em];
      if(!voters?.length) return;
      const mine=voters.includes(u.id);
      reactHtml+=`<button class="creact-btn${mine?' mine':''}" onclick="toggleReaction('${msg.id}','${em}',event)">${em}<span class="rcount">${voters.length}</span></button>`;
    });
    reactHtml+='</div>';
  }

  const canDel=isAdmin()||isOwn;
  const canEdit=isOwn;

  // Action buttons
  const actHTML=`<div class="cactions" id="cact-${msg.id}">
    <button class="cact" onclick="chatReply('${msg.id}')" title="Reply">
      <svg viewBox="0 0 24 24"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 0 0-4-4H4"/></svg>
    </button>
    <button class="cact" onclick="openReactPicker('${msg.id}',event)" title="React">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
    </button>
    ${canEdit?`<button class="cact" onclick="startChatEdit('${msg.id}')" title="Edit">
      <svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
    </button>`:''}
    ${canDel?`<button class="cact del" onclick="chatDeleteMsg('${msg.id}')" title="Delete">
      <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>
    </button>`:''}
  </div>`;

  return `<div class="cmsg${isOwn?' own':''}${grouped?' grouped':''}" id="chatmsg-${msg.id}" data-ts="${msg.ts}">
    <div class="cava" onclick="showUserCard('${sender.id||msg.uid}')">
      ${avaHtml}
    </div>
    <div class="cwrap">
      ${!grouped?`<div class="cmeta">
        <span class="csender">${esc(msg.uname)}</span>
        ${roleBadge}
        ${teamBadge}
        <span class="ctime">${timeStr}</span>
        ${editedTag}
      </div>`:''}
      <div class="cbubble" id="chatbubble-${msg.id}">
        ${replyQuote}
        ${msg.text?`<span>${renderText}</span>`:''}
        ${mediaHtml}
      </div>
      ${reactHtml}
      ${actHTML}
    </div>
  </div>`;
}

// ════════════════════════════
// APPEND NEW MESSAGES
// ════════════════════════════

function chatAppendNew(){
  const msgs=lc();
  const container=document.getElementById('chat-msgs');
  if(!container) return;
  const u=getU();
  if(!u||!canChat()) return;
  const atBottom=_isAtBottom();
  let lastDate=container.dataset.ld||'';
  let lastUid=container.dataset.lu||'';
  let lastTs=parseInt(container.dataset.lt||'0');
  let appended=false;

  msgs.slice(-200).forEach(msg=>{
    if(_renderedMsgIds.has(msg.id)) return;
    const d=new Date(msg.ts);
    const ds=d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});
    if(ds!==lastDate){
      const div=document.createElement('div');
      div.className='chat-day-divider';
      div.innerHTML=`<span>${ds}</span>`;
      container.appendChild(div);
      lastDate=ds; lastUid='';
    }
    // New-message separator (first message not by me since last visit)
    if(!_newSepInserted&&msg.uid!==u.id){
      _newSepInserted=true;
      _firstUnreadId=msg.id;
      const sep=document.createElement('div');
      sep.className='chat-new-sep';
      sep.id='chat-new-sep';
      sep.innerHTML='<span>New Messages</span>';
      container.appendChild(sep);
    }
    const grouped=(msg.uid===lastUid&&(msg.ts-lastTs)<120000);
    const div=document.createElement('div');
    div.innerHTML=buildMsgHTML(msg,msgs,u,grouped);
    const el=div.firstElementChild;
    if(el) container.appendChild(el);
    _renderedMsgIds.add(msg.id);
    lastUid=msg.uid; lastTs=msg.ts;
    appended=true;
  });

  container.dataset.ld=lastDate;
  container.dataset.lu=lastUid;
  container.dataset.lt=lastTs.toString();

  if(appended){
    updateChatMsgCount();
    if(atBottom) requestAnimationFrame(()=>{ container.scrollTop=container.scrollHeight; });
    else{
      _unreadCount++; _showScrollBadge();
    }
  }
}

function _isAtBottom(){
  const el=document.getElementById('chat-msgs');
  if(!el) return true;
  return el.scrollHeight-el.scrollTop-el.clientHeight<100;
}

function _onMsgsScroll(){
  const el=document.getElementById('chat-msgs');
  if(!el) return;
  const badge=document.getElementById('chat-scroll-badge');
  if(!badge) return;
  const atBottom=_isAtBottom();
  if(atBottom){ badge.style.display='none'; _unreadCount=0; }
}

function _showScrollBadge(){
  const badge=document.getElementById('chat-scroll-badge');
  if(!badge) return;
  const txt=document.getElementById('chat-scroll-badge-txt');
  if(txt) txt.textContent=`↓ ${_unreadCount} new message${_unreadCount>1?'s':''}`;
  badge.style.display='flex';
}

function scrollToBottom(){
  const el=document.getElementById('chat-msgs');
  if(el){ el.scrollTop=el.scrollHeight; }
  _unreadCount=0;
  const badge=document.getElementById('chat-scroll-badge');
  if(badge) badge.style.display='none';
  const sep=document.getElementById('chat-new-sep');
  if(sep) { sep.style.opacity='0'; setTimeout(()=>sep.remove(),400); }
}

function updateChatMsgCount(){
  const el=document.getElementById('chat-msg-count');
  if(el) el.textContent=lc().length+' messages';
}

// ════════════════════════════
// SEND MESSAGE
// ════════════════════════════

function sendChatMsg(mediaUrl, mediaType){
  if(!canChat()){ toast('Players only.','er'); return; }
  const inp=document.getElementById('chat-input');
  const text=(inp?.value||'').trim();
  if(!text&&!mediaUrl) return;

  // Block raw URLs
  if(text&&/https?:\/\/\S+/i.test(text)){ toast('Links are not allowed in chat.','er'); return; }

  const u=getU();
  const msgs=lc();
  const msg={id:uid(),uid:u.id,uname:u.username,ts:Date.now()};
  if(text) msg.text=text;
  if(mediaUrl){ msg.media=mediaUrl; msg.mediaType=mediaType||'image'; }
  if(_chatReplyId) msg.replyTo=_chatReplyId;
  if(u.playerProfile?.team) msg.teamId=u.playerProfile.team;
  const ppAva=u.playerProfile?.avatar||u.avatar||'';
  const dAva=u.discordAvatar||(u.discordId?`https://cdn.discordapp.com/avatars/${u.discordId}/avatar.png`:'');
  msg.senderAva=(ppAva&&ppAva.startsWith('http'))?ppAva:dAva;

  msgs.push(msg);
  if(msgs.length>500) msgs.splice(0,msgs.length-500);
  _cache[CK]=msgs;
  dbSave();
  ablyPublishMsg(msg);

  if(inp){ inp.value=''; inp.style.height='auto'; }
  const cc=document.getElementById('chat-char-counter');
  if(cc) cc.textContent='500';
  clearChatReply();
  hidePingDropdown();
  chatAppendNew();
}

// ════════════════════════════
// REPLY
// ════════════════════════════

function chatReply(msgId){
  const msg=lc().find(m=>m.id===msgId); if(!msg) return;
  _chatReplyId=msgId;
  const bar=document.getElementById('chat-reply-bar');
  const prev=document.getElementById('chat-reply-preview');
  if(bar&&prev){
    prev.innerHTML=`<strong>${esc(msg.uname)}</strong>: ${esc((msg.text||'[Media]').slice(0,60))}`;
    bar.classList.add('show');
  }
  document.getElementById('chat-input')?.focus();
}

function clearChatReply(){
  _chatReplyId=null;
  document.getElementById('chat-reply-bar')?.classList.remove('show');
}

function scrollToMsg(id){
  const el=document.getElementById('chatmsg-'+id);
  if(el){
    el.scrollIntoView({behavior:'smooth',block:'center'});
    const bubble=document.getElementById('chatbubble-'+id);
    if(bubble){
      bubble.classList.add('highlight');
      setTimeout(()=>bubble.classList.remove('highlight'),1400);
    }
  }
}

// ════════════════════════════
// EDIT
// ════════════════════════════

function startChatEdit(msgId){
  const u=getU();
  const msgs=lc();
  const msg=msgs.find(m=>m.id===msgId); if(!msg||msg.uid!==u.id) return;

  // Cancel previous edit
  if(_chatEditId&&_chatEditId!==msgId) cancelChatEdit();

  _chatEditId=msgId;
  const inp=document.getElementById('chat-input');
  if(inp){ inp.value=msg.text||''; inp.focus(); autoResizeTA(inp); updateCharCounter(inp); }
  const bar=document.getElementById('chat-edit-bar');
  if(bar) bar.classList.add('show');

  // Highlight the message being edited
  const bubble=document.getElementById('chatbubble-'+msgId);
  if(bubble){ bubble.classList.add('highlight'); }
}

function cancelChatEdit(){
  if(_chatEditId){
    const bubble=document.getElementById('chatbubble-'+_chatEditId);
    if(bubble) bubble.classList.remove('highlight');
  }
  _chatEditId=null;
  const bar=document.getElementById('chat-edit-bar');
  if(bar) bar.classList.remove('show');
  const inp=document.getElementById('chat-input');
  if(inp){ inp.value=''; inp.style.height='auto'; }
}

function saveChatEdit(){
  if(!_chatEditId) return;
  const inp=document.getElementById('chat-input');
  const newText=(inp?.value||'').trim();
  if(!newText){ toast('Cannot be empty.','er'); return; }
  if(/https?:\/\/\S+/i.test(newText)){ toast('Links are not allowed.','er'); return; }

  const msgs=lc();
  const idx=msgs.findIndex(m=>m.id===_chatEditId); if(idx<0) return;
  msgs[idx].text=newText; msgs[idx].edited=true;
  _cache[CK]=msgs; dbSave();
  ablyPublishEdit(_chatEditId,newText);

  // Update DOM
  const bubble=document.getElementById('chatbubble-'+_chatEditId);
  if(bubble){
    const u=getU();
    const rt=newText.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/@(\w+)/g,(m,n)=>`<span class="chat-ping${n.toLowerCase()===u?.username.toLowerCase()?' me':''}">${m}</span>`);
    const q=bubble.querySelector('.cquote')?.outerHTML||'';
    bubble.innerHTML=q+`<span>${rt}</span><span class="chat-edited-tag"> · edited</span>`;
  }

  cancelChatEdit();
  toast('Message edited.','ok');
}

// ════════════════════════════
// DELETE
// ════════════════════════════

function chatDeleteMsg(msgId){
  const u=getU();
  const msgs=lc();
  const msg=msgs.find(m=>m.id===msgId);
  if(!msg) return;
  if(!isAdmin()&&msg.uid!==u?.id){ toast('No permission.','er'); return; }

  _cache[CK]=msgs.filter(m=>m.id!==msgId);
  dbSave();
  ablyPublishDel(msgId);
  _renderedMsgIds.delete(msgId);
  const el=document.getElementById('chatmsg-'+msgId);
  if(el){
    el.style.opacity='0';
    el.style.transform='scale(.95)';
    el.style.transition='all .2s ease';
    setTimeout(()=>el.remove(),200);
  }
  updateChatMsgCount();
}

// ════════════════════════════
// MEDIA
// ════════════════════════════

function handleChatFile(input){
  const file=input.files[0]; if(!file) return;
  const isVideo=file.type.startsWith('video/');
  if(file.size>5*1024*1024){ toast('Max file size is 5MB.','er'); input.value=''; return; }
  const reader=new FileReader();
  reader.onload=e=>sendChatMsg(e.target.result,isVideo?'video':'image');
  reader.readAsDataURL(file);
  input.value='';
}

function openMediaFull(url, type){
  const ov=document.createElement('div');
  ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.94);z-index:9999;display:flex;align-items:center;justify-content:center;';
  ov.onclick=e=>{ if(e.target===ov||e.target.dataset.close) ov.remove(); };
  const closeBtn=`<button data-close="1" style="position:absolute;top:16px;right:16px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:50%;width:42px;height:42px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:1;color:white;font-size:18px;pointer-events:auto;">✕</button>`;
  if(type==='video'){
    ov.innerHTML=closeBtn+`<video src="${url}" controls autoplay style="max-width:95vw;max-height:90vh;border-radius:12px;outline:none;"></video>`;
  } else {
    ov.innerHTML=closeBtn+`<img src="${url}" style="max-width:95vw;max-height:90vh;border-radius:12px;object-fit:contain;cursor:zoom-out;" onclick="this.closest('div[style*=fixed]').remove()">`;
  }
  document.body.appendChild(ov);
}

// ════════════════════════════
// REACTIONS
// ════════════════════════════

function toggleReaction(msgId, emoji, e){
  e?.stopPropagation();
  const u=getU(); if(!u||!canChat()) return;
  const msgs=lc();
  const msg=msgs.find(m=>m.id===msgId); if(!msg) return;
  if(!msg.reactions) msg.reactions={};
  if(!msg.reactions[emoji]) msg.reactions[emoji]=[];
  const arr=msg.reactions[emoji];
  const add=!arr.includes(u.id);
  _pnPublish({type:'reaction',msgId,emoji,uid:u.id,add});
  _onReaction(msgId,emoji,u.id,add);
  dbSave();
}

function openReactPicker(msgId, e){
  e.stopPropagation();
  document.querySelectorAll('.chat-react-picker').forEach(p=>p.remove());
  const emojis=['😂','🔥','💪','⚽','🏆','👑','😤','🎯','🤝','❤️','😮','👏','🐐','💀','🤣','😭','🥶','🤌','😈','⭐','🔵','🟢'];
  const picker=document.createElement('div');
  picker.className='chat-react-picker';
  const rect=e.target.getBoundingClientRect();
  picker.style.cssText=`position:fixed;bottom:${window.innerHeight-rect.top+6}px;left:${Math.min(rect.left,window.innerWidth-210)}px;`;
  picker.innerHTML=emojis.map(em=>`<span onclick="toggleReaction('${msgId}','${em}',event);this.closest('.chat-react-picker').remove()">${em}</span>`).join('');
  document.body.appendChild(picker);
  setTimeout(()=>document.addEventListener('click',()=>picker.remove(),{once:true}),50);
}

function _onReaction(msgId, emoji, uid, add){
  const msgs=lc();
  const idx=msgs.findIndex(m=>m.id===msgId); if(idx<0) return;
  if(!msgs[idx].reactions) msgs[idx].reactions={};
  if(!msgs[idx].reactions[emoji]) msgs[idx].reactions[emoji]=[];
  const arr=msgs[idx].reactions[emoji];
  const uidIdx=arr.indexOf(uid);
  if(add&&uidIdx<0) arr.push(uid);
  if(!add&&uidIdx>=0) arr.splice(uidIdx,1);
  if(!arr.length) delete msgs[idx].reactions[emoji];
  _cache[CK]=msgs;
  // Update DOM
  const msgEl=document.getElementById('chatmsg-'+msgId);
  if(msgEl){
    const u=getU();
    const reactions=msgs[idx].reactions||{};
    let reactHtml='';
    Object.keys(reactions).forEach(em=>{
      const voters=reactions[em];
      if(!voters?.length) return;
      const mine=voters.includes(u?.id);
      reactHtml+=`<button class="creact-btn${mine?' mine':''}" onclick="toggleReaction('${msgId}','${em}',event)">${em}<span class="rcount">${voters.length}</span></button>`;
    });
    let reactDiv=msgEl.querySelector('.chat-reactions');
    if(!reactDiv&&reactHtml){
      reactDiv=document.createElement('div');
      reactDiv.className='chat-reactions';
      msgEl.querySelector('.cwrap')?.insertBefore(reactDiv,msgEl.querySelector('.cactions'));
    }
    if(reactDiv){ reactDiv.innerHTML=reactHtml; if(!reactHtml) reactDiv.remove(); }
  }
}

// ════════════════════════════
// EMOJI INPUT PICKER
// ════════════════════════════

function toggleEmojiPicker(e){
  e.stopPropagation();
  const picker=document.getElementById('cemoji-picker-main');
  if(!picker) return;
  picker.classList.toggle('open');
}

function _closeAllPickers(){
  document.querySelectorAll('.cemoji-picker').forEach(p=>p.classList.remove('open'));
}

function insertEmoji(em){
  const inp=document.getElementById('chat-input'); if(!inp) return;
  const pos=inp.selectionStart||inp.value.length;
  inp.value=inp.value.slice(0,pos)+em+inp.value.slice(pos);
  inp.focus();
  updateCharCounter(inp);
}

// ════════════════════════════
// PING AUTOCOMPLETE
// ════════════════════════════

function onChatInput(ta){
  const val=ta.value,pos=ta.selectionStart;
  const before=val.slice(0,pos);
  const match=before.match(/@(\w*)$/);
  if(match){
    const q=match[1].toLowerCase();
    const players=lu().filter(u=>(u.role==='player'||u.role==='admin')&&u.chatEmailVerified);
    const hits=players.filter(u=>u.username.toLowerCase().startsWith(q)).slice(0,6);
    if(hits.length){ showPingDropdown(hits,match[1]); return; }
  }
  hidePingDropdown();
}

function onChatKeyDown(e){
  if(e.key==='Enter'&&!e.shiftKey){
    e.preventDefault();
    if(_chatEditId) saveChatEdit();
    else sendChatMsg();
  }
  if(e.key==='Escape'){
    hidePingDropdown();
    if(_chatEditId) cancelChatEdit();
    else clearChatReply();
  }
}

function showPingDropdown(users, partial){
  const dd=document.getElementById('ping-dropdown'); if(!dd) return;
  dd.style.display='block';
  dd.innerHTML=users.map(u=>{
    const ava=(u.playerProfile?.avatar||u.discordAvatar)
      ?`<div class="po-ava"><img src="${u.playerProfile?.avatar||u.discordAvatar}" onerror="this.style.display='none'"></div>`
      :`<div class="po-ava">${u.username[0].toUpperCase()}</div>`;
    const role=u.role==='admin'?'Admin':'Player';
    return `<div class="ping-option" onclick="insertPing('${u.username}','${partial}')">
      ${ava}
      <div>
        <div>@${esc(u.username)}</div>
        <div class="po-role">${role}</div>
      </div>
    </div>`;
  }).join('');
}

function hidePingDropdown(){
  const dd=document.getElementById('ping-dropdown'); if(dd) dd.style.display='none';
}

function insertPing(username, partial){
  const ta=document.getElementById('chat-input'); if(!ta) return;
  const val=ta.value,pos=ta.selectionStart;
  const before=val.slice(0,pos-partial.length-1);
  const after=val.slice(pos);
  ta.value=before+'@'+username+' '+after;
  ta.focus();
  const newPos=before.length+username.length+2;
  ta.setSelectionRange(newPos,newPos);
  hidePingDropdown();
  updateCharCounter(ta);
}

// ════════════════════════════
// SEARCH
// ════════════════════════════

function toggleChatSearch(){
  const bar=document.getElementById('chat-search-bar');
  const btn=document.getElementById('chat-search-btn');
  if(!bar) return;
  const open=bar.classList.toggle('show');
  btn?.classList.toggle('active',open);
  if(open) document.getElementById('chat-search-inp')?.focus();
  else{ onChatSearch(''); }
}

function closeChatSearch(){
  const bar=document.getElementById('chat-search-bar');
  bar?.classList.remove('show');
  document.getElementById('chat-search-btn')?.classList.remove('active');
  onChatSearch('');
}

function onChatSearch(q){
  _chatSearchQuery=q.toLowerCase().trim();
  const msgs=lc();
  if(!_chatSearchQuery){
    _chatSearchHits=[];
    document.getElementById('chat-search-count').textContent='';
    // Remove all highlights
    document.querySelectorAll('.chat-search-hl').forEach(el=>{
      el.replaceWith(document.createTextNode(el.textContent));
    });
    return;
  }
  // Re-render messages with highlights
  _chatSearchHits=msgs.filter(m=>m.text&&m.text.toLowerCase().includes(_chatSearchQuery));
  document.getElementById('chat-search-count').textContent=_chatSearchHits.length?`${_chatSearchHits.length} result${_chatSearchHits.length>1?'s':''}`:' No results';
  // Scroll to first hit
  if(_chatSearchHits.length){
    const first=_chatSearchHits[_chatSearchHits.length-1];
    const el=document.getElementById('chatmsg-'+first.id);
    if(el) el.scrollIntoView({behavior:'smooth',block:'center'});
  }
  // Full re-render to apply highlights
  if(document.getElementById('chat-msgs')){
    const u=getU(); if(!u) return;
    const container=document.getElementById('chat-msgs');
    const msgsSlice=msgs.slice(-200);
    let lastDate='',lastUid='',lastTs=0;
    let html='';
    msgsSlice.forEach(msg=>{
      const d=new Date(msg.ts);
      const ds=d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'});
      if(ds!==lastDate){html+=`<div class="chat-day-divider"><span>${ds}</span></div>`;lastDate=ds;lastUid='';}
      const grouped=(msg.uid===lastUid&&(msg.ts-lastTs)<120000);
      html+=buildMsgHTML(msg,msgsSlice,u,grouped);
      lastUid=msg.uid;lastTs=msg.ts;
    });
    container.innerHTML=html;
    if(_chatSearchHits.length){
      const last=_chatSearchHits[_chatSearchHits.length-1];
      setTimeout(()=>{ const el=document.getElementById('chatmsg-'+last.id); if(el) el.scrollIntoView({behavior:'smooth',block:'center'}); },100);
    }
  }
}

// ════════════════════════════
// ONLINE USERS BAR
// ════════════════════════════

function toggleUsersBar(){
  const bar=document.getElementById('chat-users-bar');
  const btn=document.getElementById('chat-users-btn');
  if(!bar) return;
  const open=bar.classList.toggle('hidden');
  btn?.classList.toggle('active',!open);
}

function _renderOnlineBar(){
  const entries=Object.values(_onlineUsers);
  const count=entries.length;
  const txt=document.getElementById('chat-online-txt');
  if(txt) txt.textContent=count?`${count} online`:'Live';

  const list=document.getElementById('chat-users-list');
  if(!list) return;
  list.innerHTML=entries.slice(0,20).map(u=>{
    const ava=u.ava?`<img src="${u.ava}" onerror="this.style.display='none'">`:`<div class="cua-init">${(u.username||'?')[0].toUpperCase()}</div>`;
    return `<div class="chat-user-avatar">
      ${ava}
      <div class="cua-dot"></div>
      <div class="chat-user-tooltip">${esc(u.username)}</div>
    </div>`;
  }).join('');
}

// ════════════════════════════
// TYPING INDICATORS
// ════════════════════════════

function chatOnTyping(){
  const u=getU(); if(!u||!canChat()) return;
  clearTimeout(_typingTimeout);
  _pnPublish({type:'typing',username:u.username,uid:u.id});
  _typingTimeout=setTimeout(()=>{},3000);
}

function _onTyping(username,uid){
  const me=getU();
  if(uid===me?.id) return;
  clearTimeout(_typingUsers[username]);
  _typingUsers[username]=setTimeout(()=>{ delete _typingUsers[username]; _renderTypingBar(); },3500);
  _renderTypingBar();
}

function _renderTypingBar(){
  const bar=document.getElementById('chat-typing-bar');
  if(!bar) return;
  const names=Object.keys(_typingUsers);
  if(!names.length){bar.innerHTML='';return;}
  const label=names.length===1?`${esc(names[0])} is typing…`:names.length===2?`${esc(names[0])} & ${esc(names[1])} are typing…`:`${names.length} people are typing…`;
  bar.innerHTML=`<span class="typing-dots"><span></span><span></span><span></span></span> <span style="font-size:10px;">${label}</span>`;
}

// ════════════════════════════
// ABLY REAL-TIME — Persistent connection (like Discord, never drops)
// ════════════════════════════════════════════════════════════════════

let _ablyLoading   = false;   // prevent double-load of SDK
let _ablyChannel   = null;    // channel reference, kept alive
let _ablyReconnectTimer = null;
let _ablyHeartbeat = null;
let _ablyPresencePingInterval = null;
let _ablyPublishQueue = [];   // buffer messages while reconnecting

// ── Load SDK once, then init ──
function ablyConnect(){ pnConnect(); }

function pnConnect(){
  if(_pn) return;           // already exists
  if(_ablyLoading) return;  // SDK still loading
  _ablyLoading = true;
  if(typeof Ably !== 'undefined'){
    _ablyLoading = false;
    _pnInit();
  } else {
    const s = document.createElement('script');
    s.src = 'https://cdn.ably.com/lib/ably.min-2.js';
    s.onload  = () => { _ablyLoading = false; _pnInit(); };
    s.onerror = () => { _ablyLoading = false; _ablyScheduleReconnect(3000); };
    document.head.appendChild(s);
  }
}

function _pnInit(){
  if(_pn){
    // Already have a client — just make sure channel is attached
    _ablyEnsureChannel();
    return;
  }

  const u = getU();
  const clientId = (u?.id || 'anon-' + Math.random().toString(36).slice(2));

  _pn = new Ably.Realtime({
    key:                    ABLY_KEY,
    clientId:               clientId,
    // ── Resilience options ──────────────────────────────────
    disconnectedRetryTimeout:     2000,   // retry after 2 s when disconnected
    suspendedRetryTimeout:        5000,   // retry after 5 s when suspended
    channelRetryTimeout:          1000,   // channel attach retry
    httpMaxRetryCount:            10,
    realtimeRequestTimeout:       10000,
    connectTimeout:               15000,
    // Keep connection alive even when tab is in background
    closeOnUnload:                false,
  });

  // ── Connection state machine ──────────────────────────────
  _pn.connection.on('connected', () => {
    _pnConnected = true;
    clearTimeout(_ablyReconnectTimer);
    _updateConnDot('connected');
    _ablyEnsureChannel();
    _ablyFlushQueue();     // send any buffered messages
    _pnPresencePing();
    _ablyStartHeartbeat();
    // Re-sync messages missed while offline
    _ablyResync();
  });

  _pn.connection.on('connecting', () => {
    _updateConnDot('connecting');
  });

  _pn.connection.on('disconnected', (stateChange) => {
    _pnConnected = false;
    _updateConnDot('disconnected');
    // Ably SDK auto-retries but we also kick it manually after 4 s
    _ablyScheduleReconnect(4000);
  });

  _pn.connection.on('suspended', (stateChange) => {
    _pnConnected = false;
    _updateConnDot('suspended');
    // Longer backoff when suspended (network really offline)
    _ablyScheduleReconnect(8000);
  });

  _pn.connection.on('failed', () => {
    // Fatal — tear down and rebuild from scratch after 10 s
    _pnConnected = false;
    _updateConnDot('disconnected');
    _pn = null;
    _ablyChannel = null;
    _ablyScheduleReconnect(10000);
  });

  _pn.connection.on('closed', () => {
    // Page navigated away or explicit close — don't reconnect
    _pnConnected = false;
    _updateConnDot('disconnected');
  });

  _ablyEnsureChannel();
}

// ── Attach / reattach channel ─────────────────────────────────────
function _ablyEnsureChannel(){
  if(!_pn) return;
  if(_ablyChannel && _ablyChannel.state === 'attached') return;

  _ablyChannel = _pn.channels.get(ABLY_CH, {
    params: { rewind: '10' }   // get last 10 messages on attach (catch-up)
  });

  _ablyChannel.on('attached',  () => { /* channel healthy */ });
  _ablyChannel.on('suspended', () => { setTimeout(_ablyEnsureChannel, 3000); });
  _ablyChannel.on('failed',    () => { setTimeout(_ablyEnsureChannel, 5000); });
  _ablyChannel.on('detached',  () => { setTimeout(_ablyEnsureChannel, 2000); });

  _ablyChannel.subscribe('evt', evt => {
    const data = evt.data;
    if(!data?.type) return;
    switch(data.type){
      case 'msg':      _onIncomingMsg(data.data); break;
      case 'del':      _onIncomingDel(data.id);   break;
      case 'edit':     _onIncomingEdit(data.id, data.text); break;
      case 'typing':   _onTyping(data.username, data.uid); break;
      case 'presence': _onPresence(data.uid, data.username, data.ava); break;
      case 'reaction': _onReaction(data.msgId, data.emoji, data.uid, data.add); break;
    }
  });
}

// ── Publish with queue-on-disconnect ─────────────────────────────
function _pnPublish(payload){
  if(_pn && _pnConnected && _ablyChannel){
    _ablyChannel.publish('evt', payload).catch(() => {
      // publish failed — queue it for retry
      _ablyPublishQueue.push({payload, ts: Date.now()});
    });
  } else {
    // Offline: buffer (max 30 items, drop oldest, skip typing events)
    if(payload.type === 'typing') return;
    _ablyPublishQueue.push({payload, ts: Date.now()});
    if(_ablyPublishQueue.length > 30) _ablyPublishQueue.shift();
    // Try to reconnect now
    if(!_pn) pnConnect();
    else if(_pn.connection.state !== 'connected') _pn.connect();
  }
}

function _ablyFlushQueue(){
  const now = Date.now();
  // Drop anything older than 30 s (stale)
  _ablyPublishQueue = _ablyPublishQueue.filter(q => now - q.ts < 30000);
  const toSend = [..._ablyPublishQueue];
  _ablyPublishQueue = [];
  toSend.forEach(q => _pnPublish(q.payload));
}

// ── Schedule reconnect (deduped) ──────────────────────────────────
function _ablyScheduleReconnect(delay){
  clearTimeout(_ablyReconnectTimer);
  _ablyReconnectTimer = setTimeout(() => {
    if(!_pnConnected){
      if(_pn && _pn.connection.state !== 'connected'){
        _pn.connect();   // tell existing client to retry
      } else if(!_pn){
        pnConnect();     // rebuild from scratch
      }
    }
  }, delay);
}

// ── Heartbeat: keep connection alive every 25 s ───────────────────
function _ablyStartHeartbeat(){
  clearInterval(_ablyHeartbeat);
  _ablyHeartbeat = setInterval(() => {
    if(_pn && _pnConnected){
      // No-op ping: just checking the connection is still alive
      // Ably SDK handles keepalives internally, but we also ping presence
      _pnPresencePing();
    } else if(_pn && _pn.connection.state !== 'connecting'){
      _pn.connect();
    }
  }, 25000);
}

// ── Re-sync missed messages after reconnect ───────────────────────
async function _ablyResync(){
  try{
    const db = await Promise.race([
      dbFetch(),
      new Promise((_,rej) => setTimeout(() => rej('timeout'), 5000))
    ]);
    if(db && Array.isArray(db[CK])){
      const remote = db[CK];
      const local  = lc();
      // Merge: add any remote msgs not in local
      const localIds = new Set(local.map(m => m.id));
      const newMsgs  = remote.filter(m => !localIds.has(m.id));
      if(newMsgs.length){
        const merged = [...local, ...newMsgs].sort((a,b) => a.ts - b.ts).slice(-500);
        _cache[CK] = merged;
        chatAppendNew();
      }
    }
  }catch(e){}
}

// ── Tab visibility: reconnect immediately when tab comes back ─────
document.addEventListener('visibilitychange', () => {
  if(document.hidden) return;
  // Tab became visible
  if(!_pnConnected){
    if(_pn) _pn.connect();
    else    pnConnect();
  }
  // Always re-sync messages after returning to tab
  _ablyResync();
  renderNav();
});

// ── Online/offline browser events ────────────────────────────────
window.addEventListener('online', () => {
  if(!_pnConnected){
    if(_pn) _pn.connect();
    else    pnConnect();
  }
});

window.addEventListener('offline', () => {
  _pnConnected = false;
  _updateConnDot('disconnected');
});

// ── Connection status dot ──────────────────────────────────────────
function _updateConnDot(state){
  const dot = document.getElementById('chat-conn-dot');
  const txt = document.getElementById('chat-online-txt');
  if(dot){
    const colors = {
      connected:    ['#10b981', '0 0 8px rgba(16,185,129,.8)'],
      connecting:   ['#fbbf24', '0 0 6px rgba(251,191,36,.6)'],
      disconnected: ['#f87171', '0 0 6px rgba(239,68,68,.5)'],
      suspended:    ['#f87171', '0 0 6px rgba(239,68,68,.5)'],
    };
    const [bg, shadow] = colors[state] || colors.disconnected;
    dot.style.background  = bg;
    dot.style.boxShadow   = shadow;
    // Pulse animation when reconnecting
    dot.style.animation = (state === 'connecting') ? 'pulse-dot 0.8s ease-in-out infinite' : 'pulse-dot 2s ease-in-out infinite';
  }
  if(txt){
    const labels = {
      connected:    null,  // keep existing online count
      connecting:   'Reconnecting\u2026',
      disconnected: 'Offline \u2014 retrying\u2026',
      suspended:    'Connection lost \u2014 retrying\u2026',
    };
    if(labels[state] !== null) txt.textContent = labels[state];
  }
}

// ── Presence ping ─────────────────────────────────────────────────
function _pnPresencePing(){
  const u = getU(); if(!u) return;
  const ppAva = u.playerProfile?.avatar || u.avatar || '';
  const dAva  = u.discordAvatar || (u.discordId ? `https://cdn.discordapp.com/avatars/${u.discordId}/avatar.png` : '');
  const ava   = (ppAva && ppAva.startsWith('http')) ? ppAva : dAva;
  _pnPublish({type:'presence', uid:u.id, username:u.username, ava});
}

function _onPresence(uid, username, ava){
  _onlineUsers[uid] = {username, ava, ts: Date.now()};
  _renderOnlineBar();
  // Expire stale presence entries (90 s)
  clearTimeout(_onlineUsers[uid]?._timer);
  _onlineUsers[uid]._timer = setTimeout(() => {
    if(_onlineUsers[uid] && Date.now() - _onlineUsers[uid].ts > 85000){
      delete _onlineUsers[uid];
      _renderOnlineBar();
    }
  }, 90000);
}
function _onIncomingMsg(msg){
  if(!msg||_renderedMsgIds.has(msg.id)) return;
  const msgs=lc();
  msgs.push(msg);
  if(msgs.length>500) msgs.splice(0,msgs.length-500);
  _cache[CK]=msgs;
  chatAppendNew();
}

function _onIncomingDel(id){
  _renderedMsgIds.delete(id);
  const el=document.getElementById('chatmsg-'+id);
  if(el){ el.style.opacity='0'; el.style.transition='opacity .2s'; setTimeout(()=>el.remove(),200); }
  _cache[CK]=lc().filter(m=>m.id!==id);
  updateChatMsgCount();
}

function _onIncomingEdit(id,text){
  const msgs=lc();
  const idx=msgs.findIndex(m=>m.id===id);
  if(idx>=0){ msgs[idx].text=text; msgs[idx].edited=true; _cache[CK]=msgs; }
  const bubble=document.getElementById('chatbubble-'+id);
  if(bubble&&!bubble.classList.contains('highlight')){
    const u=getU();
    const rt=text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/@(\w+)/g,(m,n)=>`<span class="chat-ping${n.toLowerCase()===u?.username.toLowerCase()?' me':''}">${m}</span>`);
    const q=bubble.querySelector('.cquote')?.outerHTML||'';
    const med=bubble.querySelector('.chat-media')?.outerHTML||'';
    bubble.innerHTML=q+`<span>${rt}</span>`+med+`<span class="chat-edited-tag"> \xb7 edited</span>`;
  }
}
// Fallback poll — only runs when WebSocket is offline
setInterval(async()=>{
  if(!_pnConnected){
    // Try to reconnect
    if(_pn && _pn.connection.state !== 'connecting' && _pn.connection.state !== 'connected'){
      _pn.connect();
    }
    // Sync messages from DB
    if(document.getElementById('page-chat')?.classList.contains('on')){
      try{
        const db=await dbFetch();
        if(db&&Array.isArray(db[CK])){ _cache[CK]=db[CK]; chatAppendNew(); }
      }catch(e){}
    }
  }
},5000);

// Start Ably as soon as DOM is ready — before user opens chat
document.addEventListener('DOMContentLoaded',()=>{ setTimeout(pnConnect, 400); });

// User card (simple toast-style)
function showUserCard(uid){
  const u=lu().find(x=>x.id===uid); if(!u) return;
  toast(`@${u.username} · ${u.role}`,'ok');
}


// Auto-refresh other data (not chat)
const _origPollGlobal = pollGlobalData;

document.addEventListener('visibilitychange',()=>{
  if(!document.hidden){ pollGlobalData(); renderNav(); }
});


let tt;
function toast(msg,type='ok'){
  const t=document.getElementById('toast');
  document.getElementById('tico').textContent=type==='ok'?'+':'×';
  document.getElementById('tmsg').textContent=msg;
  t.className=`toast t${type} show`;
  clearTimeout(tt);
  tt=setTimeout(()=>t.classList.remove('show'),4000);
}

function showApprovalBanner(username){
  // Show a prominent approval overlay
  let banner=document.getElementById('approval-banner');
  if(!banner){
    banner=document.createElement('div');
    banner.id='approval-banner';
    banner.style.cssText='position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;padding:24px;';
    document.body.appendChild(banner);
  }
  banner.innerHTML=`<div style="background:linear-gradient(135deg,var(--card),var(--card2));border:2px solid rgba(16,185,129,.4);border-radius:20px;padding:36px 32px;max-width:380px;width:100%;text-align:center;box-shadow:0 0 60px rgba(16,185,129,.2);">
    <div style="font-size:64px;margin-bottom:16px;"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="1.5"><polyline points="20 6 9 17 4 12"/></svg></div>
    <div style="font-family:'Orbitron',monospace;font-size:20px;font-weight:900;color:#34d399;letter-spacing:3px;margin-bottom:10px;">APPROVED!</div>
    <div style="font-family:'Barlow Condensed';font-size:16px;color:var(--white);margin-bottom:6px;">Welcome, <strong>${esc(username)}</strong>!</div>
    <div style="font-size:12px;color:var(--gray);line-height:1.6;margin-bottom:24px;">Your account has been approved by an admin.<br>You now have full access to PHM.</div>
    <button onclick="document.getElementById('approval-banner').remove()" style="font-family:'Barlow Condensed';font-size:13px;font-weight:700;letter-spacing:3px;text-transform:uppercase;background:var(--green);color:#fff;border:none;padding:14px 36px;border-radius:50px;cursor:pointer;box-shadow:0 0 20px rgba(16,185,129,.4);">LET'S GO! →</button>
  </div>`;
}
</script>

<!-- APPROVE USER MODAL (set name + pfp) -->
<div class="ov" id="approve-ov" onclick="if(event.target===this)closeApproveModal()">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:420px;">
    <div class="mod-title">
      <span style="color:#34d399;">Approve Registration</span>
      <div class="cbtn" onclick="closeApproveModal()">&#10005;</div>
    </div>

    <!-- Avatar preview -->
    <div style="display:flex;align-items:center;gap:16px;padding:14px 16px;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.2);border-radius:12px;margin-bottom:16px;">
      <div id="approve-pfp-preview" style="flex-shrink:0;"></div>
      <div style="flex:1;">
        <div style="font-family:'Barlow Condensed';font-size:11px;font-weight:700;letter-spacing:2px;color:#34d399;margin-bottom:2px;">APPROVING USER</div>
        <div id="approve-discord-label" style="font-size:10px;color:var(--gray);"></div>
      </div>
    </div>

    <!-- Username -->
    <div class="fg" style="margin-bottom:14px;">
      <label class="flbl">Username <span style="color:var(--gray2);font-weight:400;">— lowercase, numbers, underscore only</span></label>
      <input class="finp" id="approve-username-inp" type="text" placeholder="e.g. johndoe_99" maxlength="20" autocomplete="off"
        oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9_]/g,'').slice(0,20)"
        onkeydown="if(event.key==='Enter')confirmApproveUser()">
    </div>

    <!-- PFP URL -->
    <div class="fg" style="margin-bottom:18px;">
      <label class="flbl">Profile Picture URL <span style="color:var(--gray2);font-weight:400;">— optional</span></label>
      <input class="finp" id="approve-pfp-inp" type="url" placeholder="https://cdn.discordapp.com/avatars/..." autocomplete="off"
        oninput="onApprovePfpChange()"
        onkeydown="if(event.key==='Enter')confirmApproveUser()">
      <div style="font-size:10px;color:var(--gray);margin-top:5px;">Paste any image URL. Leave blank to keep Discord default avatar.</div>
    </div>

    <div class="mod-acts">
      <button class="fcancel" onclick="closeApproveModal()">Cancel</button>
      <button class="fsave" onclick="confirmApproveUser()" style="background:var(--green);box-shadow:0 0 14px rgba(16,185,129,.3);">Approve User</button>
    </div>
  </div>
</div>

<!-- REJECT REASON MODAL -->
<div class="ov" id="rreason-ov" onclick="if(event.target===this)closeRejectReason()">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:400px;">
    <div class="mod-title">
      <span style="color:#f87171;">Reject Registration</span>
      <div class="cbtn" onclick="closeRejectReason()">&#10005;</div>
    </div>
    <div style="background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.18);border-radius:10px;padding:12px 14px;margin-bottom:16px;">
      <div style="font-family:'Barlow Condensed';font-size:13px;font-weight:700;color:#f87171;">Rejecting: <span id="rreason-name" style="color:var(--white);"></span></div>
      <div style="font-size:11px;color:rgba(248,113,113,.7);margin-top:4px;">This will delete the account permanently.</div>
    </div>
    <div class="fg" style="margin-bottom:16px;">
      <label class="flbl">Rejection Reason <span style="color:var(--gray2);font-weight:400;">(optional)</span></label>
      <textarea class="finp" id="rreason-input" placeholder="e.g. Not a server member, wrong account..." maxlength="200" rows="3" style="resize:none;font-family:inherit;font-size:13px;"></textarea>
    </div>
    <div class="mod-acts">
      <button class="fcancel" onclick="closeRejectReason()">Cancel</button>
      <button class="fsave" onclick="confirmRejectUser()" style="background:#ef4444;box-shadow:0 0 14px rgba(239,68,68,.3);">Confirm Reject</button>
    </div>
  </div>
</div>

<!-- DISCORD MEMBER IMPORT MODAL -->
<div class="ov" id="import-members-ov" onclick="if(event.target===this)closeImportMembers()">
  <div class="std-mod" onclick="event.stopPropagation()" style="max-width:520px;">
    <div class="mod-title">
      <span>Import Discord Members</span>
      <div class="cbtn" onclick="closeImportMembers()">&#10005;</div>
    </div>
    <div style="background:rgba(88,101,242,.07);border:1px solid rgba(88,101,242,.2);border-radius:10px;padding:14px;margin-bottom:16px;">
      <div style="font-family:'Barlow Condensed';font-size:12px;font-weight:700;letter-spacing:1px;color:#7289da;margin-bottom:6px;">HOW IT WORKS</div>
      <div style="font-size:12px;color:var(--gray);line-height:1.7;">
        1. Run the <strong style="color:var(--white);">phm_export_members.py</strong> bot on your PC<br>
        2. It generates a <strong style="color:var(--white);">phm_members.json</strong> file<br>
        3. Open that file, copy all the text, paste it below<br>
        4. Hit Import — done! Members can now register and see their real name &amp; avatar.
      </div>
    </div>
    <div class="fg" style="margin-bottom:6px;">
      <label class="flbl">Paste JSON from bot here</label>
      <textarea class="finp" id="import-json-input" placeholder='{"123456789012345678":{"username":"john","displayName":"John","avatarHash":"abc123","defaultIndex":0}, ...}' rows="7" style="font-family:monospace;font-size:11px;resize:vertical;min-height:130px;"></textarea>
    </div>
    <div id="import-members-err" style="font-size:11px;color:#f87171;margin-bottom:10px;display:none;padding:8px 12px;background:rgba(239,68,68,.08);border-radius:8px;border:1px solid rgba(239,68,68,.2);"></div>
    <div id="import-members-ok"  style="font-size:11px;color:#34d399;margin-bottom:10px;display:none;padding:8px 12px;background:rgba(16,185,129,.08);border-radius:8px;border:1px solid rgba(16,185,129,.2);"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
      <button onclick="clearImportedMembers()" style="font-family:'Barlow Condensed';font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;padding:8px 16px;border-radius:8px;border:1px solid rgba(239,68,68,.3);background:rgba(239,68,68,.08);color:#f87171;cursor:pointer;">Clear Saved Data</button>
      <div class="mod-acts" style="margin:0;padding:0;border:none;">
        <button class="fcancel" onclick="closeImportMembers()">Cancel</button>
        <button class="fsave" onclick="doImportMembers()">Import Members</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
